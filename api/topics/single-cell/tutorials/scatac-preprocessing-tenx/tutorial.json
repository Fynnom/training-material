{"layout":"tutorial_hands_on","title":"Pre-processing of 10X Single-Cell ATAC-seq Datasets","subtopic":"scmultiomics","priority":1,"redirect_from":["/topics/transcriptomics/tutorials/satac-preprocessing-tenx/tutorial","/short/single-cell/scatac-preprocessing-tenx","/short/T00335"],"zenodo_link":"https://zenodo.org/record/7855968","tags":["10x","epigenetics"],"questions":["What is 10X?","What are single-cell ATAC fragments and MTX files?","What is an Anndata file, and why is it important?"],"objectives":["Demultiplex single-cell FASTQ data from 10X Genomics","Learn about transparent matrix formats","Create a high-quality count matrix starting from scATAC-seq FASTQ files"],"time_estimation":"1h","key_points":["Bulk ATAC-seq like mapping and peak calling","Creating a scATAC-seq count matrix requires positions of open chromatin regions"],"requirements":[{"type":"internal","topic_name":"single-cell","tutorials":["scrna-preprocessing-tenx"]}],"follow_up_training":[{"type":"internal","topic_name":"single-cell","tutorials":["scrna-scanpy-pbmc3k"]}],"contributors":[{"name":"Pavankumar Videm","orcid":"0000-0002-5192-126X","joined":"2017-09","affiliations":["uni-freiburg","elixir-europe"],"id":"pavanvidem","url":"https://training.galaxyproject.org/training-material/api/contributors/pavanvidem.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/pavanvidem/"}],"gitter":"Galaxy-Training-Network/galaxy-single-cell","js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00335","url":"/topics/single-cell/tutorials/scatac-preprocessing-tenx/tutorial.html","topic_name":"single-cell","tutorial_name":"scatac-preprocessing-tenx","dir":"topics/single-cell/tutorials/scatac-preprocessing-tenx","symlink":null,"id":"single-cell/scatac-preprocessing-tenx","ref_tutorials":["<p>Similar to bulk ATAC-Seq, single-cell ATAC-Seq (scATAC-seq) leverages the hyperactive Tn5 Transposase to profile open chromatin regions but at single-cell resolution. Thus helps in understanding cell type-specific chromatin accessibility from a heterogeneous cell population.</p>\n\n<h2 id=\"era-of-10x-genomics\">Era of 10x Genomics</h2>\n\n<p>10x genomics has provided not only a cost-effective high-throughput solution to understanding sample heterogeneity at the individual cell level but has defined the standards of the field that many downstream analysis packages are now scrambling to accommodate. The gain in resolution reduces the granularity and noise issues that plagued the field of single-cell omics not long ago, where now individual clusters are much easier to decipher due to the added stability added by this gain in information.</p>\n\n<h2 id=\"library-preparation\">Library Preparation</h2>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/tenx_libprep_scatac.png\" alt=\"Library Preparation. \" width=\"890\" height=\"343\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/tenx_libprep_scatac.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> An overview of the 10x single-nuclei ATAC-seq library preparation</figcaption></figure>\n\n<p>The 10X barcoded gel beads consist of a pool of barcodes which are used to separately index each cell. The individual gel barcodes are delivered to each cell via flow cytometry, where each cell is fed single-file along a liquid tube and tagged with a 10X gel bead. The cells are then isolated from one another within thousands of nanoliter droplets, where each droplet is described by a unique 10x barcode that all reads in that droplet are associated with. The oil is then removed and all (now barcoded) DNA reads are pooled together to be sequenced.</p>\n\n<p>More information can be found in the <a href=\"https://www.10xgenomics.com/support/single-cell-atac/documentation/steps/library-prep/chromium-single-cell-atac-reagent-kits-user-guide-v-2-chemistry\">reagent kit documentation</a>.</p>\n\n<h2 id=\"10x-chemistries\">10x Chemistries</h2>\n\n<p>There are two main reagent kits used during the library preparation. Below we can see the layout of the primers used in both chemistries. We can ignore most of these as they are not relevant, namely: the P5 and P7 Illumina primers are used in the Illumina <a href=\"https://en.wikipedia.org/wiki/Illumina_dye_sequencing#Bridge_amplification\">bridge amplification</a> process; the Sample Index is an 8bp primer which is related to the Chromium system that balances nucleotide bias and ensures that there is no sample overlap during the multiplexed sequencing. The primer of interest to us is the Cell Barcode (CB). Unlike scRNA-seq, Unique Molecular Identifiers (UMIs) are not used in scATAC-seq.</p>\n\n<figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/tenx_primers_scatac.svg\" alt=\"chem. \" width=\"899\" height=\"213\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/tenx_primers_scatac.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> 10x scATAC-Seq sequencing library</figcaption></figure>\n\n<p>There are two major chemistries (v1 and v2) used in 10x scATAC-seq library construction. Technically, v2 chemistry is more sensitive and has better data yield. But the final sequencing library is the same. Hence, same the data analysis applies to both chemistries. Both chemistries generate the 4 FASTQ files containing:</p>\n<ul>\n  <li>8bp sample index sequence (I1)</li>\n  <li>50bp forward read (R1)</li>\n  <li>16bp barcode sequence (R2)</li>\n  <li>49bp reverse read (R3)</li>\n</ul>\n\n<p>The major differences to 10x scRNA-seq sequencing libraries are: (a) barcode sequences get a separate FASTQ file and (b) there are no UMIs. Note that as opposed to the traditional FASTQ naming, R3 contains reverse mate-pair and R2 contains barcode sequence.</p>\n\n<h1 id=\"analysis-strategy\">Analysis Strategy</h1>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will deal with:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#era-of-10x-genomics\" id=\"markdown-toc-era-of-10x-genomics\">Era of 10x Genomics</a></li>\n  <li><a href=\"#library-preparation\" id=\"markdown-toc-library-preparation\">Library Preparation</a></li>\n  <li><a href=\"#10x-chemistries\" id=\"markdown-toc-10x-chemistries\">10x Chemistries</a></li>\n  <li><a href=\"#analysis-strategy\" id=\"markdown-toc-analysis-strategy\">Analysis Strategy</a></li>\n  <li><a href=\"#fastq-processing-and-mapping\" id=\"markdown-toc-fastq-processing-and-mapping\">FASTQ processing and mapping</a>    <ol>\n      <li><a href=\"#data-upload-and-organization\" id=\"markdown-toc-data-upload-and-organization\">Data upload and organization</a></li>\n      <li><a href=\"#attach-cell-barcodes-to-fastq-headers\" id=\"markdown-toc-attach-cell-barcodes-to-fastq-headers\">Attach cell barcodes to FASTQ headers</a></li>\n      <li><a href=\"#fastq-quality-control\" id=\"markdown-toc-fastq-quality-control\">FASTQ Quality control</a></li>\n      <li><a href=\"#mapping-reads-to-a-reference-genome\" id=\"markdown-toc-mapping-reads-to-a-reference-genome\">Mapping reads to a reference genome</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#peak-calling\" id=\"markdown-toc-peak-calling\">Peak calling</a>    <ol>\n      <li><a href=\"#create-scatac-seq-fragments-file\" id=\"markdown-toc-create-scatac-seq-fragments-file\">Create scATAC-seq fragments file</a></li>\n      <li><a href=\"#call-peaks\" id=\"markdown-toc-call-peaks\">Call Peaks</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#count-matrix-creation\" id=\"markdown-toc-count-matrix-creation\">Count matrix creation</a>    <ol>\n      <li><a href=\"#anndata\" id=\"markdown-toc-anndata\">AnnData</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#producing-a-quality-count-matrix\" id=\"markdown-toc-producing-a-quality-count-matrix\">Producing a Quality Count Matrix</a>    <ol>\n      <li><a href=\"#initial-filtering-to-remove-potential-empty-features-and-cells\" id=\"markdown-toc-initial-filtering-to-remove-potential-empty-features-and-cells\">Initial filtering to remove potential empty features and cells</a></li>\n      <li><a href=\"#quality-control-and-visualization\" id=\"markdown-toc-quality-control-and-visualization\">Quality control and visualization</a></li>\n      <li><a href=\"#final-filtering-to-acquire-quality-cells-and-features\" id=\"markdown-toc-final-filtering-to-acquire-quality-cells-and-features\">Final filtering to acquire quality cells and features</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<p>The tutorial is structured into four parts. The first part deals with the preprocessing of FASTQ files, quality control and mapping. Then in the second part, we will identify the open chromatin regions. In the third part, we will create a count matrix using the cell barcode and open chromatin regions information. In the final part, we will filter out empty cells and less informative peaks to produce a high-quality count matrix.</p>\n\n<p>Here we will use a published data set from 10x genomics consisting of thousand peripheral blood mononuclear cells (PBMCs) extracted from a healthy donor. Analyzing these full datasets requires several hours of computation time. Hence, we subsampled the data so that the tutorial can be finished in a reasonable amount of time with sensible results. In the sub-sampled data, we have the reads that were mostly generated from chromosome 21. The original data has FASTQ files from two sequencing lanes <em>L001</em> and <em>L002</em>. We merged the sequences from both lanes. We also ignored the sample index FASTQ file as it is not useful for this analysis. Finally, we are left with three FASTQ files: <strong>R1</strong> (forward reads), <strong>R2</strong> (barcodes) and <strong>R3</strong> (reverse reads).</p>\n\n<ul>\n  <li>atac_pbmc_1k_nextgem_S1_<strong>R1</strong>_001_chr21.fastq.gz</li>\n  <li>atac_pbmc_1k_nextgem_S1_<strong>R2</strong>_001_chr21.fastq.gz</li>\n  <li>atac_pbmc_1k_nextgem_S1_<strong>R3</strong>_001_chr21.fastq.gz</li>\n</ul>\n\n<p>These files are provided in the <a href=\"https://zenodo.org/record/7855968\">Zenodo</a> data repository. To analyze the full datasets, get the original FASTQ files from <a href=\"https://www.10xgenomics.com/resources/datasets/1-k-peripheral-blood-mononuclear-cells-pbm-cs-from-a-healthy-donor-next-gem-v-1-1-1-1-standard-2-0-0\">10x genomics website</a></p>\n\n<h1 id=\"fastq-processing-and-mapping\">FASTQ processing and mapping</h1>\n\n<h2 id=\"data-upload-and-organization\">Data upload and organization</h2>\n\n<p>We import all three FASTQ files into a history.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Data upload and organization</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a new history and rename it (e.g. scATAC-seq 10X preprocessing tutorial)</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Import the sub-sampled FASTQ data from <a href=\"https://zenodo.org/record/7855968\"><code class=\"language-plaintext highlighter-rouge\">Zenodo</code></a> or from the data library (ask your instructor)</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-data-from-a-data-library\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-data-from-a-data-library\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing data from a data library</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>As an alternative to uploading the data from a URL or your computer, the files may also have been made available from a <em>shared data library</em>:</p>   <ol>   <li>Go into <strong>Shared data</strong> (top panel) then <strong>Data libraries</strong></li>   <li>Navigate to  the correct folder as indicated by your instructor.     <ul>       <li>On most Galaxies tutorial data will be provided in a folder named <strong>GTN - Material –&gt; Topic Name -&gt; Tutorial Name</strong>.</li>     </ul>   </li>   <li>Select the desired files</li>   <li>Click on <strong>Add to History</strong> <i class=\"fas fa-caret-down\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-dropdown</span> near the top and select <strong>as Datasets</strong> from the dropdown menu</li>   <li>     <p>In the pop-up window, choose</p>     <ul>       <li><em>“Select history”</em>: the history you want to import the data to (or create a new one)</li>     </ul>   </li>   <li>Click on <strong>Import</strong></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/7855968/files/atac_pbmc_1k_nextgem_S1_R1_001_chr21.fastq.gz\nhttps://zenodo.org/record/7855968/files/atac_pbmc_1k_nextgem_S1_R2_001_chr21.fastq.gz\nhttps://zenodo.org/record/7855968/files/atac_pbmc_1k_nextgem_S1_R3_001_chr21.fastq.gz\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n</blockquote>\n<blockquote class=\"question\">\n\n  <question-title></question-title>\n  <p>Inspect all the uploaded FASTQ files by clicking on the <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> symbol.</p>\n  <ol>\n    <li>Which FASTQ file contains the barcode sequence?</li>\n    <li>What is the length of the barcode?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <ol>\n      <li>In this case, R2 contains the cell barcodes</li>\n      <li>16bp</li>\n    </ol>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"attach-cell-barcodes-to-fastq-headers\">Attach cell barcodes to FASTQ headers</h2>\n\n<p>First, we will attach the barcodes from the barcodes FASTQ file to the ids of forward and reverse reads that carry the association between reads and barcodes throughout the analysis. We will use this information to demultiplex the cells at the end while creating the count matrix. We will be left with only two FASTQ files of forward and reverse reads after this step.</p>\n\n<blockquote class=\"comment\">\n  <comment-title></comment-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/sinto_barcode/sinto_barcode/0.9.0+galaxy1\" title=\"Sinto barcode tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Sinto barcode</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.9.0+galaxy1)</span>  consumes the barcode sequence from the <code class=\"language-plaintext highlighter-rouge\">atac_pbmc_1k_nextgem_S1_R2_001_chr21.fastq.gz</code> file and uses <code class=\"language-plaintext highlighter-rouge\">:</code> delimiter to prepend it to both the forward and reverse read ids. The tool expects the same number of reads in all three FASTQ files and should be present in the same order.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title></hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/sinto_barcode/sinto_barcode/0.9.0+galaxy1\" title=\"Sinto barcode tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Sinto barcode</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.9.0+galaxy1)</span>  with the following parameters:</p>\n  <ul>\n    <li><em>“FASTQ file containing cell barcode sequences”</em>: <code class=\"language-plaintext highlighter-rouge\">atac_pbmc_1k_nextgem_S1_R2_001_chr21.fastq.gz</code></li>\n    <li><em>“Single or Paired-end data”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired</code></li>\n    <li><em>“Forward reads FASTQ file”</em>: <code class=\"language-plaintext highlighter-rouge\">atac_pbmc_1k_nextgem_S1_R1_001_chr21.fastq.gz</code></li>\n    <li><em>“Reverse reads FASTQ file”</em>: <code class=\"language-plaintext highlighter-rouge\">atac_pbmc_1k_nextgem_S1_R3_001_chr21.fastq.gz</code></li>\n    <li><em>“Number of bases to extract from barcode-containing FASTQ”</em>: <code class=\"language-plaintext highlighter-rouge\">16</code></li>\n  </ul>\n\n  <blockquote class=\"comment\">\n    <comment-title>Sinto barcode output</comment-title>\n\n    <p>After a successful run, the barcode sequences from the barcode FASTQ file are prepended to the read names. We can inspect the output FASTQ files by clicking on the <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> symbol of the <em>barcoded read 1</em> file.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>Now let’s proceed with the next steps QC, mapping and peak calling as we do with the bulk ATAC-Seq data. For a thorough description of bulk ATAC-Seq analysis, please follow the bulk <a href=\"/training-material/topics/epigenetics/tutorials/atac-seq/tutorial.html\">ATAC-Seq data analysis tutorial</a>. Here we use a slightly different workflow. Here we map reads using <strong>BWA-MEM</strong> instead of <strong>Bowtie2</strong>, then create ATAC fragments file that also stores the cell barcode information and finally use <strong>MACS2</strong> for peak calling. Note that the workflow from bulk ATAC-seq tutorial should also result in similar set of peaks.</p>\n\n<h2 id=\"fastq-quality-control\">FASTQ Quality control</h2>\n<p>First things first. Let’s do a basic FASTQ quality control using <strong>FastQC</strong></p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title></hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/fastqc/fastqc/0.73+galaxy0\" title=\"FastQC tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>FastQC</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.73+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“Raw read data from your current history”</em>: Use <i class=\"far fa-copy\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-files</span> <strong>Multiple datasets</strong> to choose both <code class=\"language-plaintext highlighter-rouge\">barcoded read 1</code> and <code class=\"language-plaintext highlighter-rouge\">barcoded read 2</code> (outputs of <strong>Sinto barcode</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>).</li>\n      </ul>\n    </li>\n    <li>Inspect the web page output of <strong>FastQC</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> for the <code class=\"language-plaintext highlighter-rouge\">barcoded read 1</code> sample.</li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>How many reads are in the FASTQ?</li>\n      <li>Which sections have a warning?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <ol>\n        <li>There are 685686 reads.</li>\n        <li>\n          <p>The 2 steps below have warnings:</p>\n\n          <ol>\n            <li>\n              <p><strong>Per base sequence content</strong></p>\n\n              <p>It is well known that the Tn5 has a strong sequence bias at the insertion site. You can read more about it in <span class=\"citation\"><a href=\"#Green2012\">Green <i>et al.</i> 2012</a></span>.</p>\n            </li>\n            <li>\n              <p><strong>Sequence Duplication Levels</strong></p>\n\n              <p>The read library quite often has PCR duplicates that are introduced\nsimply by the PCR itself. We will remove these duplicates later on.</p>\n            </li>\n          </ol>\n        </li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<blockquote class=\"tip\">\n  <tip-title>Adapter trimming</tip-title>\n\n  <p>There is only a little amount of Nextera Transposase Sequence in the reads (see Adapter Content section of <strong>FastQC</strong> output). In this case, we skip the adapter trimming step and proceed to the mapping step. If your data has a significant amount of Nextera Transposase Sequences, then proceed to adapter trimming using either <strong>cutadapt</strong> or <strong>Trim Galore!</strong>. <strong>Trim Galore</strong> can automatically detect the adapter sequence. If you use <strong>Cutadapt</strong>, follow the bulk ATAC-Seq tutorial <a href=\"/training-material/topics/epigenetics/tutorials/atac-seq/tutorial.html\">Trimming Reads</a> step.</p>\n</blockquote>\n\n<h2 id=\"mapping-reads-to-a-reference-genome\">Mapping reads to a reference genome</h2>\n<p>Now we map the reads to a reference genome using <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2\" title=\"BWA-MEM tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>BWA-MEM</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.17.2)</span>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Mapping</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2\" title=\"Map with BWA-MEM tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Map with BWA-MEM</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.17.2)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“Using reference genome”</em>: <code class=\"language-plaintext highlighter-rouge\">hg38</code></li>\n    <li>In <em>“Single or Paired-end reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired</code>\n      <ul>\n        <li>In <em>“Select first set of reads “</em>: <code class=\"language-plaintext highlighter-rouge\">barcoded read 1</code> (output of <strong>Sinto barcode</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“Select second set of reads “</em>: <code class=\"language-plaintext highlighter-rouge\">barcoded read 2</code> (output of <strong>Sinto barcode</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n      </ul>\n    </li>\n    <li><em>“Select analysis mode”</em>: <code class=\"language-plaintext highlighter-rouge\">1.Simple Illumina mode</code></li>\n    <li><em>“BAM sorting mode”</em>: <code class=\"language-plaintext highlighter-rouge\">Sort by chromosomal coordinates</code></li>\n  </ul>\n</blockquote>\n\n<h1 id=\"peak-calling\">Peak calling</h1>\n<p>In scRNA-seq we always have the standard set of genes (usually downloaded from public databases) to quantify the expression levels. For scATAC-seq, there are no such reference open chromatin regions because the regions of chromatin accessibility are tissue dependent. Hence, we first have to detect open chromatin regions. There are several ways of doing this. The most common ways are the following:</p>\n<ul>\n  <li>Find a published bulk ATAC-seq data that is the closest to your scATAC-seq data and use the regions from the bulk ATAC-seq data</li>\n  <li>Chunk the genome into equal-sized bins and use these bins as reference locations for quantification</li>\n  <li>Combine the data from all the cells of the scATAC-seq data together and detect open chromatin regions from the data. Later use these detected regions for quantification</li>\n</ul>\n\n<p>In this tutorial, we opt for the 3rd option.</p>\n\n<h2 id=\"create-scatac-seq-fragments-file\">Create scATAC-seq fragments file</h2>\n<p>An ATAC-seq fragment file is a BED file with Tn5 integration sites, the cell barcode associated with the fragment, and the frequency of the sequenced fragment. PCR duplicates are collapsed. Here we filter out the alignments with low mapping quality.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>on Tn5 insertion</comment-title>\n\n  <p>When Tn5 cuts an accessible chromatin locus it inserts adapters separated by 9bp (<span class=\"citation\"><a href=\"#Kia2017\">Kia <i>et al.</i> 2017</a></span>):</p>\n  <figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/epigenetics/images/atac-seq/NexteraLibraryConstruction.jpg\" alt=\"Nextera_Library_Construction. \" width=\"378\" height=\"189\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/epigenetics/images/atac-seq/NexteraLibraryConstruction.jpg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> Nextera Library Construction</figcaption></figure>\n\n  <p>This means, to have the read start site reflecting the center of where Tn5 bound, the reads on the positive strand should be shifted 4 bp to the right and reads on the negative strands should be shifted 5 bp to the left as in <a href=\"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3959825\">Buenrostro et al. 2013</a>. <strong>Genrich</strong> can apply these shifts when ATAC-seq mode is selected. In most cases, we do not have 9bp resolution so we don’t take it into account but if you are interested in the footprint, this is important.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Create scATAC fragments</hands-on-title>\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/sinto_fragments/sinto_fragments/0.9.0+galaxy1\" title=\"Sinto fragments tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Sinto fragments</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.9.0+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Input BAM file”</em>: <code class=\"language-plaintext highlighter-rouge\">mapped reads in BAM format</code> (output of <strong>Map with BWA-MEM</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)`</li>\n        <li><em>“Minimum MAPQ required to retain fragment”</em>: <code class=\"language-plaintext highlighter-rouge\">30</code></li>\n        <li><em>“Regular expression used to extract cell barcode from read name”</em>: <code class=\"language-plaintext highlighter-rouge\">[^:]*</code> (matches all characters up to the first colon)</li>\n        <li><em>“Number of bases to shift Tn5 insertion position by on the forward strand”</em>: <code class=\"language-plaintext highlighter-rouge\">4</code></li>\n        <li><em>“Number of bases to shift Tn5 insertion position by on the reverse strand”</em>: <code class=\"language-plaintext highlighter-rouge\">-5</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/bedtools/bedtools_sortbed/2.30.0+galaxy2\" title=\"bedtools SortBED tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>bedtools SortBED</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.30.0+galaxy2)</span> with the following parameters:\n      <ul>\n        <li><em>“Sort the following BED/bedGraph/GFF/VCF/EncodePeak file *“</em>: <code class=\"language-plaintext highlighter-rouge\">fragments BED</code> (output of <strong>Sinto fragments</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)`</li>\n        <li><em>“Sort by”</em>: <code class=\"language-plaintext highlighter-rouge\">chromosome, then by start position (asc)</code></li>\n      </ul>\n    </li>\n    <li>Rename the dataset <code class=\"language-plaintext highlighter-rouge\">sorted fragments</code></li>\n  </ol>\n</blockquote>\n\n<h2 id=\"call-peaks\">Call Peaks</h2>\n\n<p>We have now finished the data preprocessing. Next, to find regions corresponding to potential open chromatin regions, we want to identify regions where reads have piled up (peaks) greater than the background read coverage. The tools which are currently used are <a href=\"https://github.com/jsh58/Genrich\">Genrich</a> and <a href=\"https://github.com/taoliu/MACS\">MACS2</a>. MACS2 is more widely used.\nAt this step, two approaches exist:</p>\n\n<ul>\n  <li>The first one is to select only pairs whose fragment length is below 100bp corresponding to nucleosome-free regions and to use a peak calling like you would do for a ChIP-seq, joining signal between mates. The disadvantage of this approach is that you can only use it if you have paired-end data and you will miss small open regions where only one Tn5 is bound.</li>\n  <li>The second one chosen here is to use all reads to be more exhaustive. In this approach, it is very important to re-center the signal of each read on the 5’ extremity (read start site) as this is where Tn5 cuts. Indeed, you want your peaks around the nucleosomes and not directly on the nucleosome:</li>\n</ul>\n\n<figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/epigenetics/images/atac-seq/schemeWithLegend.jpg\" alt=\"ATAC-Seq_reads_relative_to_nucleosomes. \" width=\"680\" height=\"378\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/epigenetics/images/atac-seq/schemeWithLegend.jpg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> Scheme of ATAC-Seq reads relative to nucleosomes</figcaption></figure>\n\n<p>If we only assess the coverage of the 5’ extremity of the reads, the data would be too sparse and it would be impossible to call peaks. Thus, we will extend the start sites of the reads by 200bp (100bp in each direction) to assess coverage. We call peaks with MACS2. In order to get the coverage centered on the 5’ extended 100bp on each side we will use <code class=\"language-plaintext highlighter-rouge\">--shift -100</code> and <code class=\"language-plaintext highlighter-rouge\">--extend 200</code>:</p>\n<figure id=\"figure-5\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/epigenetics/images/atac-seq/macs2Options.jpg\" alt=\"MACS2_peak_centering_options. \" width=\"643\" height=\"113\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/epigenetics/images/atac-seq/macs2Options.jpg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 5</strong>:</span> MACS2 options to get 100bp each side</figcaption></figure>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Call peaks with MACS2</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/macs2/macs2_callpeak/2.1.1.20160309.6\" title=\"MACS2 callpeak tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>MACS2 callpeak</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.1.1.20160309.6)</span> with the following parameters:\n      <ul>\n        <li><em>“Are you pooling Treatment Files?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“ChIP-Seq Treatment File”</em>: <code class=\"language-plaintext highlighter-rouge\">sorted fragments</code></li>\n        <li><em>“Do you have a Control File?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Format of Input Files”</em>: <code class=\"language-plaintext highlighter-rouge\">Single-end BED</code></li>\n        <li><em>“Effective genome size”</em>: <code class=\"language-plaintext highlighter-rouge\">H. sapiens (2.7e9)</code></li>\n        <li><em>“Build Model”</em>: <code class=\"language-plaintext highlighter-rouge\">Do not build the shifting model (--nomodel)</code>\n          <ul>\n            <li><em>“Set extension size”</em>: <code class=\"language-plaintext highlighter-rouge\">200</code></li>\n            <li><em>“Set shift size”</em>: <code class=\"language-plaintext highlighter-rouge\">-100</code>. It needs to be - half the extension size to be centered on the 5’.</li>\n          </ul>\n        </li>\n        <li><em>“Additional Outputs”</em>:\n          <ul>\n            <li>Check <code class=\"language-plaintext highlighter-rouge\">Peaks as tabular file (compatible with MultiQC)</code></li>\n            <li>Check <code class=\"language-plaintext highlighter-rouge\">Peak summits</code></li>\n            <li>Check <code class=\"language-plaintext highlighter-rouge\">Scores in bedGraph files</code></li>\n          </ul>\n        </li>\n        <li>In <em>“Advanced Options”</em>:\n          <ul>\n            <li><em>“Composite broad regions”</em>: <code class=\"language-plaintext highlighter-rouge\">No broad regions</code>\n              <ul>\n                <li><em>“Use a more sophisticated signal processing approach to find subpeak summits in each enriched peak region”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n              </ul>\n            </li>\n            <li><em>“How many duplicate tags at the exact same location are allowed?”</em>: <code class=\"language-plaintext highlighter-rouge\">all</code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"comment\">\n        <comment-title>Why keeping all duplicates is important</comment-title>\n\n        <p>We previously removed duplicates using <strong>Sinto fragment</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> using paired-end information. If two pairs had identical R1 but different R2, we knew it was not a PCR duplicate. Because we converted the BAM to BED we lost the pair information. If we keep the default (removing duplicates) one of the 2 identical R1 would be filtered out as duplicate.</p>\n      </blockquote>\n      <blockquote class=\"comment\">\n        <comment-title>BED / encode narrowPeak format</comment-title>\n        <p>If you are not familiar with BED format or encode narrowPeak format, see the <a href=\"https://genome.ucsc.edu/FAQ/FAQformat.html\">BED Format</a></p>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"count-matrix-creation\">Count matrix creation</h1>\n\n<p>Now we have ATAC fragments with cell barcode information as well as the peaks to create a scATAC count matrix. In the context of ATAC-seq, the peaks are also often called features. But the term <em>feature</em> is a generic term that denotes a <em>peak</em> in the case of scATAC-seq data and a <em>gene</em> in case of scRNA-seq data. So the count matrix we build is similar to that of scRNA-seq data with the exception that here we have open chromatin regions instead of genes. In this tutorial, both the terms <em>feature</em> and <em>peak</em> indicate an <em>open chromatin region</em>.</p>\n\n<p>For count matrix creation, we will use <strong>Build count matrix</strong> from <strong>EpiScanpy</strong> tool suite. It takes fragments file and the peaks in either BED format or directly a narrowPeak file of <strong>MACS2</strong> output. Regardless of file type, the tool only considers the first 3 columns which contain chromosome id, start and end positions of the peak regions. Parameters like <code class=\"language-plaintext highlighter-rouge\">--call-summits</code> from our MACS2 run can result in different peaks with the same peak boundaries. It is always a  good practice to remove duplicate peak regions so that our final count matrix will have unique features.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Extract unique peak regions</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_sorted_uniq/1.1.0\" title=\"Unique occurrences of each record tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Unique occurrences of each record</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.0)</span> with the following parameters:\n      <ul>\n        <li><em>“File to scan for unique values”</em>: <code class=\"language-plaintext highlighter-rouge\">narrow Peaks</code> (output of <strong>MACS2</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“Advanced Options”</em>: <code class=\"language-plaintext highlighter-rouge\">Show Advanced Options</code>\n          <ul>\n            <li><em>“Column start”</em>: <code class=\"language-plaintext highlighter-rouge\">Column: 1</code></li>\n            <li><em>“Column end”</em>: <code class=\"language-plaintext highlighter-rouge\">Column: 3</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>How many peak regions were duplicated?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <ol>\n        <li>There were initially 1064 regions in the <code class=\"language-plaintext highlighter-rouge\">narrow Peaks</code> file. Now there are 891 regions after deduplication. More than 15% (173) of regions have the same peak boundaries.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"anndata\">AnnData</h2>\n\n<p>The most common format, called <a href=\"https://anndata.readthedocs.io/en/stable/\"><code class=\"language-plaintext highlighter-rouge\">AnnData</code></a>, stores the matrix as well as gene and cell annotations in a concise, compressed and extremely readable manner:</p>\n\n<figure id=\"figure-6\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-pre-processing/tenx_anndata.png\" alt=\"Anndata format. \" width=\"1381\" height=\"1122\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-pre-processing/tenx_anndata.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 6</strong>:</span> <code>AnnData</code> format stores a count matrix <code>X</code> together with annotations of observations (i.e. cells) <code>obs</code>, variables (i.e. peaks) <code>var</code> and unstructured annotations <code>uns</code>.</figcaption></figure>\n\n<p>This format is used by <a href=\"https://scanpy.readthedocs.io/en/stable/index.html\">Scanpy</a> (<span class=\"citation\"><a href=\"#wolf2018scanpy\">Wolf <i>et al.</i> 2018</a></span>) and <a href=\"https://colomemaria.github.io/episcanpy_doc/index.html\">EpiScanpy</a> (<span class=\"citation\"><a href=\"#danese2021episcanpy\">Danese <i>et al.</i> 2021</a></span>) tool suites for analyzing single-cell omics data. So we need first to import the matrix and annotations of peaks and cells (present in fragments BED file) into an <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Build count matrix with EpiScanpy</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_build_matrix/episcanpy_build_matrix/0.3.2+galaxy1\" title=\"Build count matrix with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Build count matrix with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“ATAC fragments file”</em>: <code class=\"language-plaintext highlighter-rouge\">sorted fragments</code></li>\n        <li><em>“Features file”</em>: output of <strong>Unique</strong> tool <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Normalize peak sizes?”</em>: <code class=\"language-plaintext highlighter-rouge\">Keep the peaks as they are</code></li>\n        <li>In <em>“Select the chromosomes of the species you are considering”</em>: <code class=\"language-plaintext highlighter-rouge\">Custom list of chromosomes</code>\n          <ul>\n            <li><em>“Enter comma seperated list of chromosome ids (without chr prefix)”</em>: <code class=\"language-plaintext highlighter-rouge\">21</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Rename the generated file to <code class=\"language-plaintext highlighter-rouge\">PBMC 1k chr21 Anndata</code></li>\n    <li>Check that the format is <code class=\"language-plaintext highlighter-rouge\">h5ad</code></li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Chromosome selection</tip-title>\n\n    <p>In this example data, our reads are from the <em>chr21</em>. Hence, we input <code class=\"language-plaintext highlighter-rouge\">21</code> for chromosome ids. For human or mouse genomes, directly select from the dropdown list. Make sure that all the canonical chromosomes are present in the fragments file.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<p>Because the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> format is an extension of the HDF5 format, i.e. a binary format, an <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object can not be inspected directly in Galaxy by clicking on the <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> (<strong>View data</strong>) icon. Instead, we need to use a dedicated tool from the <strong>AnnData</strong> suite.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Inspect an AnnData object</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.5+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k chr21 Anndata</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">General information about the object</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>AnnData object with n_obs × n_vars = 18426 × 891\n</code></pre></div>        </div>\n\n        <ol>\n          <li>How many observations are there? What do they represent?</li>\n          <li>How many variables are there? What do they represent?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <ol>\n            <li>There are 18,426 observations, representing the cells.</li>\n            <li>There are 891 variables, representing the peaks.</li>\n          </ol>\n\n        </blockquote>\n\n      </blockquote>\n\n      <blockquote class=\"comment\">\n        <comment-title>Faster Method for General Information</comment-title>\n\n        <ul>\n          <li>To view general information of any <em>Anndata</em> file:\n            <ul>\n              <li>Click on the name of the dataset in the history to expand it.</li>\n              <li>\n                <p>General Anndata information would be given in the expanded box:</p>\n\n                <p>e.g.</p>\n\n                <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs x n_vars]\n-    18426 x 891\n</code></pre></div>                </div>\n              </li>\n            </ul>\n          </li>\n          <li>For more specific queries, <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.5+galaxy1)</span> is required.</li>\n        </ul>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.5+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k chr21 Anndata</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">The full data matrix</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\tchr21_10272276_10272566\tchr21_10330743_10330987\tchr21_10489276_10489476\tchr21_13979698_13980574\tchr21_14027127_14027558 ...\nAAAAAATACCCGAAGG\t0.0\t0.0\t0.0\t0.0\nAAAAACAAAAATATAC\t0.0\t0.0\t0.0\t0.0\nAAAAATAACAATGATA\t0.0\t0.0\t0.0\t0.0\nAAAACCGTGAGAGTCT\t0.0\t0.0\t0.0\t0.0\nAAAACCTCACCCAACA\t0.0\t0.0\t0.0\t0.0\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is a table with 18,426 lines (observations or cells) and 891 columns (variables or peaks): the count matrix for each of the 891 peaks and 18,426 cells. The 1st row contains the peak location as an annotation of the columns and the 1st column the barcodes of the cells as an annotation of the rows.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.5+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k chr21 Anndata</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed observations annotation (obs)</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>AAAAAATACCCGAAGG\nAAAAACAAAAATATAC\nAAAAATAACAATGATA\nAAAACCGTGAGAGTCT\nAAAACCTCACCCAACA\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is tabular with annotations of the observations. i.e. the cells. Here there are only the barcodes as annotation, so only one column, being also the index for the count matrix.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.5+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k chr21 Anndata</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed annotation of variables/features (var)</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>chr21_10272276_10272566\nchr21_10330743_10330987\nchr21_10489276_10489476\nchr21_13979698_13980574\nchr21_14027127_14027558\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is tabular with annotations of the variables, i.e. the peaks.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h1 id=\"producing-a-quality-count-matrix\">Producing a Quality Count Matrix</h1>\n<p>We just created a count matrix with all detected peaks and non-empty barcodes. In this section of the tutorial, we will filter the features and barcodes by a series of quality assessments to generate a high-quality count matrix. The final count matrix can be used for further downstream analysis like clustering, differential chromatin analysis and cell type annotation.</p>\n\n<p>The current matrix contains peaks from chromosome 21 only and is too small to carry out this type of analysis. From this step onwards we will use the full count matrix generated from the original FASTQ files. Please import the following anndata file to start:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/7855968/files/atac_pbmc_1k_uniq_peaks.h5ad\n</code></pre></div></div>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many barcodes and features are there?</li>\n    <li>What do you observe in comparison to a scRNA-seq count matrix?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>There are 441038 barcodes and 70120 features</li>\n      <li>The initial number of barcodes in this raw count matrix is in the same range as the scRNA-seq data. But there is roughly double the number of features compared to a scRNA-seq dataset. The number of features varies from dataset to dataset. Based on the tools and parameters used for peak calling, the size of the initial feature set can grow up to several hundred of thousands.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"initial-filtering-to-remove-potential-empty-features-and-cells\">Initial filtering to remove potential empty features and cells</h2>\n<p>First remove any potential empty features or barcodes. A non-empty cell should have a minimum number of non-empty features and a non-empty feature should be present in a minimum number of non-empty cells. Here we will different minimum thresholds for filtering cells and features.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Initial filtering</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">atac_pbmc_1k_uniq_peaks.h5ad</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter cell outliers based on counts and numbers of features expressed, using 'pp.filter_cells'</code></li>\n        <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of features expressed</code></li>\n        <li><em>“Minimum features”</em>: <code class=\"language-plaintext highlighter-rouge\">100</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”</em>: Output of the previous (<code class=\"language-plaintext highlighter-rouge\">pp.filter_cells</code>) step</li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter features based on counts and numbers of features expressed, using 'pp.filter_features'</code></li>\n        <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of cells expressed</code></li>\n        <li><em>“Minimum features”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>How much data was filtered out?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <p>The resulting matrix has dimensions of 1815 x 67766, i.e., more than 99.5% of the cells and less than 4% of features were filtered out. This indicates the high sparsity of the count matrix.</p>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"quality-control-and-visualization\">Quality control and visualization</h2>\n<p>We will first plot the number of features per cell. This information is stored as <code class=\"language-plaintext highlighter-rouge\">nb_features</code> layer of observations. As we are dealing with numbers with huge variances, it is sometimes hard to visualize them. Hence, we compute the <em>log</em> of <code class=\"language-plaintext highlighter-rouge\">nb_features</code> first then plot the absolute and log values together.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Violing plots of number of features</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”“</em>: Output of previous (<code class=\"language-plaintext highlighter-rouge\">pp.filter_features</code>) step</li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Compute log10 of nb_features</code></li>\n      </ul>\n    </li>\n    <li>Check if observations have an extra <code class=\"language-plaintext highlighter-rouge\">log_nb_features</code> in addition to <code class=\"language-plaintext highlighter-rouge\">nb_features</code> layer.</li>\n    <li>Rename the resulting dataset to <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.7.1+galaxy0\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.7.1+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Violin plot, using 'pl.violin'</code>\n          <ul>\n            <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">Subset of variables in 'adata.var_names' or fields of '.obs'</code>\n              <ul>\n                <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">nb_features, log_nb_features</code></li>\n              </ul>\n            </li>\n            <li>In <em>“Violin plot attributes”</em>:\n              <ul>\n                <li><em>“Add a stripplot on top of the violin plot”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n                  <ul>\n                    <li><em>“Add a jitter to the stripplot”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n                      <ul>\n                        <li><em>“Size of the jitter points”</em>: <code class=\"language-plaintext highlighter-rouge\">0.4</code></li>\n                      </ul>\n                    </li>\n                  </ul>\n                </li>\n                <li><em>“Display keys in multiple panels”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n              </ul>\n            </li>\n            <li>In <em>“Parameters for seaborn.violinplot”</em>:\n              <ul>\n                <li><em>“Color for all of the elements”</em>: <code class=\"language-plaintext highlighter-rouge\">DarkCyan</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>What trends of the data do you observe in the plots?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n      <figure id=\"figure-7\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/violin_after_initial_filtering.png\" alt=\"IntialViolin. \" width=\"1009\" height=\"490\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/violin_after_initial_filtering.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 7</strong>:</span> Violin plot of number of features per cell after initial filtering</figcaption></figure>\n      <p>Both plots indicate that there are two distinct sets of cells:</p>\n      <ol>\n        <li>Cells with an acceptable number of open chromatin regions.</li>\n        <li>Cells with only a few detected peaks. These cells are uninformative and should be excluded.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<p>To determine decent filtering thresholds, we will further look at some histograms of cell-peak coverage trends. We will plot histograms of the number of open features per cell and feature commonness in cells.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Coverage cells</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”“</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Coverage cells: Histogram of the number of open features (in the case of ATAC-seq data) per cell, using 'pp.coverage_cells'</code></li>\n        <li><em>“Binarized matrix?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Minimum number of cells or minimum number of features to be indicated in the plot”</em>: <code class=\"language-plaintext highlighter-rouge\">1000</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”“</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Coverage cells: Histogram of the number of open features (in the case of ATAC-seq data) per cell, using 'pp.coverage_cells'</code></li>\n        <li><em>“Binarized matrix?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Log transform?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Minimum number of cells or minimum number of features to be indicated in the plot”</em>: <code class=\"language-plaintext highlighter-rouge\">1000</code></li>\n      </ul>\n    </li>\n    <li>Now observe the plots</li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>What information do you see in these plots?</li>\n      <li>Do you think our minimum number of features threshold of 1000 indicated in the plot makes sense?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n      <figure id=\"figure-8\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_cells.png\" alt=\"CoverageCells. \" width=\"571\" height=\"432\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_cells.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 8</strong>:</span> Histogram of the number of open chromatin regions per cell</figcaption></figure>\n      <figure id=\"figure-9\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_cells_log.png\" alt=\"CoverageCellsLog. \" width=\"571\" height=\"432\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_cells_log.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 9</strong>:</span> Histogram of the number of open chromatin regions per cell in log scale</figcaption></figure>\n      <ol>\n        <li>The plots show the number of open chromatin regions per cell in 50 bins on the x-axis and the number of cells per bin on the y-axis. It is basically a histogram of the number of open chromatin regions per cell.</li>\n        <li>From the first plot with absolute counts, we see that with our threshold of 1000, we can separate between the cells with few detected peaks and cells with high chromatin accessibility.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Coverage features</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”“</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Coverage features: Distribution of the feature commonness in cells, using 'pp.coverage_features'</code></li>\n        <li><em>“Binarized matrix?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Minimum number of cells or minimum number of features to be indicated in the plot”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”“</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Coverage features: Distribution of the feature commonness in cells, using 'pp.coverage_features'</code></li>\n        <li><em>“Binarized matrix?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Log transform?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Minimum number of cells or minimum number of features to be indicated in the plot”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n      </ul>\n    </li>\n    <li>Now observe the plots</li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>What information do you see in these plots?</li>\n      <li>Do you think our minimum number of cells threshold of 5 indicated in the plot makes sense?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n      <figure id=\"figure-10\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_features.png\" alt=\"CoverageFeatures. \" width=\"589\" height=\"432\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_features.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 10</strong>:</span> Histogram of feature commonness in cells</figcaption></figure>\n      <figure id=\"figure-11\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_features_log.png\" alt=\"CoverageFeaturesLog. \" width=\"580\" height=\"432\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scatac-pre-processing/coverage_features_log.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 11</strong>:</span> Histogram of feature commonness in cells in log scale</figcaption></figure>\n      <ol>\n        <li>The plots show a histogram of the number of cells sharing a feature. As we initially pooled the data from all the cells to detect the peaks, it is expected to see only a small number of cells have more than 10000 peaks in common.</li>\n        <li>The red vertical line of our 5 cells threshold is nearly at the left end of the histogram representing the majority of the features have at least 5 cells in common.\nFrom the log scale plot it is also clear that there is a sharp increase in the feature commonness from at least 10 cells (x-axis 1.0).\nSo our threshold of 5 is a decent cutoff for filtering out the features. From the plots, only a very few non-informative features are left to be filtered out.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"final-filtering-to-acquire-quality-cells-and-features\">Final filtering to acquire quality cells and features</h2>\n\n<p>Based on the above QC plots, we will filter out all the cells with less than 1000 features and all the features that have less than 5 cells in common. Additionally, we will also filter out extreme outlier cells (which can be seen in the initial violin plot or coverage cells plot) with more than 12500 features.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Final filtering based on QC plots</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">PBMC 1k after initial filtering</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter cell outliers based on counts and numbers of features expressed, using 'pp.filter_cells'</code></li>\n        <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of features expressed</code></li>\n        <li><em>“Minimum features”</em>: <code class=\"language-plaintext highlighter-rouge\">1000</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”</em>: Output of previous (<code class=\"language-plaintext highlighter-rouge\">pp.filter_cells</code>) step</li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter cell outliers based on counts and numbers of features expressed, using 'pp.filter_cells'</code></li>\n        <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Maximum number of features expressed</code></li>\n        <li><em>“Minimum features”</em>: <code class=\"language-plaintext highlighter-rouge\">12500</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1\" title=\"scATAC-seq Preprocessing with EpiScanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>scATAC-seq Preprocessing with EpiScanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.3.2+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><em>“Annotated data matrix”</em>: Output of previous (<code class=\"language-plaintext highlighter-rouge\">pp.filter_cells</code>) step</li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter features based on counts and numbers of features expressed, using 'pp.filter_features'</code></li>\n        <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of cells expressed</code></li>\n        <li><em>“Minimum features”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>What are the dimensions of the count matrix after the final filtering?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <p>The resulting matrix has 1024 cells and 67719 peaks. The number of cells after filtering is close to what we expect in this dataset.</p>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>In this tutorial, we have learned how to map reads from 10X ATAC-seq data, identify open chromatin regions from aggregated cell data and generate a count matrix in <em>Anndata</em> format. We also performed quality control and filtered out empty and uninformative cells and features to generate a high-quality count matrix for downstream analysis.</p>\n\n<p>Galaxy workflows for generating <a href=\"workflows/scATAC-seq-FASTQ-to-Count-Matrix.ga\">Annadata from FASTQ files</a> and <a href=\"workflows/scATAC-seq-Count-Matrix-Filtering.ga\">quality filtering of raw count matrix</a> are provided.scatac_tenx.ga).</p>\n\n<p>This tutorial is part of the https://singlecell.usegalaxy.eu portal (<span class=\"citation\"><a href=\"#tekman2020single\">Tekman <i>et al.</i> 2020</a></span>).</p>\n"],"ref_slides":[],"video_library":{"tutorial":null,"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":false,"mod_date":"2023-11-03 14:30:27 +0000","pub_date":"2023-04-24 18:23:20 +0000","version":8,"workflows":[{"workflow":"scATAC-seq-Count-Matrix-Filtering.ga","tests":true,"url":"https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scatac-preprocessing-tenx/workflows/scATAC-seq-Count-Matrix-Filtering.ga","path":"topics/single-cell/tutorials/scatac-preprocessing-tenx/workflows/scATAC-seq-Count-Matrix-Filtering.ga","wfid":"single-cell-scatac-preprocessing-tenx","wfname":"scatac-seq-count-matrix-filtering","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/single-cell-scatac-preprocessing-tenx/versions/scatac-seq-count-matrix-filtering","license":"CC-BY-4.0","creators":[{"class":"Person","identifier":"0000-0002-5192-126X","name":"Pavankumar Videm"}],"name":"scATAC-seq Count Matrix Filtering","title":"scATAC-seq Count Matrix Filtering","test_results":null,"modified":"2024-06-13 10:00:06 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nscATAC-seq Anndata\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"scATAC-seq Preprocessing\"];\n  0 -->|output| 1;\n  2[\"scATAC-seq Preprocessing\"];\n  1 -->|anndata_out| 2;\n  3[\"scATAC-seq Preprocessing\"];\n  2 -->|anndata_out| 3;\n  4[\"Plot\"];\n  3 -->|anndata_out| 4;\n  5[\"scATAC-seq Preprocessing\"];\n  3 -->|anndata_out| 5;\n  6[\"scATAC-seq Preprocessing\"];\n  3 -->|anndata_out| 6;\n  7[\"scATAC-seq Preprocessing\"];\n  3 -->|anndata_out| 7;\n  8[\"scATAC-seq Preprocessing\"];\n  3 -->|anndata_out| 8;\n  9[\"scATAC-seq Preprocessing\"];\n  8 -->|anndata_out| 9;\n  10[\"scATAC-seq Preprocessing\"];\n  9 -->|anndata_out| 10;\n  11[\"scATAC-seq Preprocessing\"];\n  10 -->|anndata_out| 11;\n  12[\"Plot\"];\n  11 -->|anndata_out| 12;"},{"workflow":"scATAC-seq-FASTQ-to-Count-Matrix.ga","tests":true,"url":"https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scatac-preprocessing-tenx/workflows/scATAC-seq-FASTQ-to-Count-Matrix.ga","path":"topics/single-cell/tutorials/scatac-preprocessing-tenx/workflows/scATAC-seq-FASTQ-to-Count-Matrix.ga","wfid":"single-cell-scatac-preprocessing-tenx","wfname":"scatac-seq-fastq-to-count-matrix","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/single-cell-scatac-preprocessing-tenx/versions/scatac-seq-fastq-to-count-matrix","license":"CC-BY-4.0","creators":[{"class":"Person","identifier":"0000-0002-5192-126X","name":"Pavankumar Videm"}],"name":"scATAC-seq FASTQ to Count Matrix","title":"scATAC-seq FASTQ to Count Matrix","test_results":null,"modified":"2024-06-13 10:00:06 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nForward reads FASTQ R1\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"ℹ️ Input Dataset\\nBarcodes FASTQ R2\"];\n  style 1 stroke:#2c3143,stroke-width:4px;\n  2[\"ℹ️ Input Dataset\\nReverse reads FASTQ R3\"];\n  style 2 stroke:#2c3143,stroke-width:4px;\n  3[\"Sinto barcode\"];\n  1 -->|output| 3;\n  0 -->|output| 3;\n  2 -->|output| 3;\n  4[\"FastQC\"];\n  3 -->|read1_out| 4;\n  5[\"FastQC\"];\n  3 -->|read2_out| 5;\n  6[\"Map with BWA-MEM\"];\n  3 -->|read1_out| 6;\n  3 -->|read2_out| 6;\n  7[\"Sinto fragments\"];\n  6 -->|bam_output| 7;\n  8[\"bedtools SortBED\"];\n  7 -->|fragments| 8;\n  9[\"MACS2 callpeak\"];\n  8 -->|output| 9;\n  10[\"Unique\"];\n  9 -->|output_narrowpeaks| 10;\n  11[\"Build count matrix\"];\n  8 -->|output| 11;\n  10 -->|outfile| 11;\n  12[\"Inspect AnnData\"];\n  11 -->|anndata_out| 12;\n  13[\"Inspect AnnData\"];\n  11 -->|anndata_out| 13;\n  14[\"Inspect AnnData\"];\n  11 -->|anndata_out| 14;\n  15[\"Inspect AnnData\"];\n  11 -->|anndata_out| 15;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/single-cell/tutorials/scatac-preprocessing-tenx/tutorial.json","tools":["toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_sorted_uniq/1.1.0","toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2","toolshed.g2.bx.psu.edu/repos/devteam/fastqc/fastqc/0.73+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.7.5+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/bedtools/bedtools_sortbed/2.30.0+galaxy2","toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_build_matrix/episcanpy_build_matrix/0.3.2+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/episcanpy_preprocess/episcanpy_preprocess/0.3.2+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/macs2/macs2_callpeak/2.1.1.20160309.6","toolshed.g2.bx.psu.edu/repos/iuc/macs2/macs2_callpeak/2.2.7.1+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.7.1+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.7.1+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/sinto_barcode/sinto_barcode/0.9.0+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/sinto_fragments/sinto_fragments/0.9.0+galaxy1"],"supported_servers":{"exact":[{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.cz/","name":"UseGalaxy.cz","usegalaxy":false}]},"topic_name_human":"Single Cell","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"bwa","owner":"devteam","revisions":"e188dc7a68e6","tool_panel_section_label":"Mapping","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"fastqc","owner":"devteam","revisions":"3d0c7bdf12f5","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"anndata_inspect","owner":"iuc","revisions":"ee98d611afc6","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"bedtools","owner":"iuc","revisions":"a1a923cd89e8","tool_panel_section_label":"BED","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"episcanpy_build_matrix","owner":"iuc","revisions":"31a21ba2c5ea","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"episcanpy_preprocess","owner":"iuc","revisions":"29f5f25b9935","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"macs2","owner":"iuc","revisions":"424aefbd7777","tool_panel_section_label":"Peak Calling","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"macs2","owner":"iuc","revisions":"640d3af5d833","tool_panel_section_label":"Peak Calling","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_plot","owner":"iuc","revisions":"6adf98e782f3","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_plot","owner":"iuc","revisions":"aa0c474463c2","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"sinto_barcode","owner":"iuc","revisions":"d1b34ac42b8f","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"sinto_fragments","owner":"iuc","revisions":"29e6bfb2cf49","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: bwa\n  owner: devteam\n  revisions: e188dc7a68e6\n  tool_panel_section_label: Mapping\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: fastqc\n  owner: devteam\n  revisions: 3d0c7bdf12f5\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: anndata_inspect\n  owner: iuc\n  revisions: ee98d611afc6\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: bedtools\n  owner: iuc\n  revisions: a1a923cd89e8\n  tool_panel_section_label: BED\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: episcanpy_build_matrix\n  owner: iuc\n  revisions: 31a21ba2c5ea\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: episcanpy_preprocess\n  owner: iuc\n  revisions: 29f5f25b9935\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: macs2\n  owner: iuc\n  revisions: 424aefbd7777\n  tool_panel_section_label: Peak Calling\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: macs2\n  owner: iuc\n  revisions: 640d3af5d833\n  tool_panel_section_label: Peak Calling\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_plot\n  owner: iuc\n  revisions: 6adf98e782f3\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_plot\n  owner: iuc\n  revisions: aa0c474463c2\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: sinto_barcode\n  owner: iuc\n  revisions: d1b34ac42b8f\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: sinto_fragments\n  owner: iuc\n  revisions: 29e6bfb2cf49\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}