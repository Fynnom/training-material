{"layout":"tutorial_hands_on","title":"Clustering 3K PBMCs with Scanpy","subtopic":"firstsc","priority":2,"redirect_from":["/topics/transcriptomics/tutorials/scrna-scanpy-pbmc3k/tutorial","/short/single-cell/scrna-scanpy-pbmc3k","/short/T00254"],"zenodo_link":"https://zenodo.org/record/3581213","questions":["What are the steps to prepare single-cell RNA-Seq data for clustering?","How to cluster cells in single-cell RNA-Seq data?","How cell type annotation can be assigned to cell clusters?"],"objectives":["Describe an AnnData object to store single-cell data","Explain the preprocessing steps for single-cell data","Evaluate quality of single-cell data and apply steps to select and filter cells and genes based on QC","Execute data normalization and scaling","Identify highly variable genes","Construct and run a dimensionality reduction using Principal Component Analysis","Perform a graph-based clustering for cells","Identify marker genes for the clusters","Construct and run a cell type annotation for the clusters"],"time_estimation":"8H","key_points":["scRNA-seq data analysis is complex and exploratory process, still in development","Different tools and parameters should be tested for each step of the process"],"requirements":[{"type":"internal","topic_name":"single-cell","tutorials":["scrna-preprocessing","scrna-preprocessing-tenx"]}],"tags":["10x"],"contributors":[{"name":"Bérénice Batut","email":"berenice.batut@gmail.com","twitter":"bebatut","linkedin":"berenicebatut","matrix":"bebatut:matrix.org","orcid":"0000-0001-9852-1987","joined":"2017-09","elixir_node":"fr","contact_for_training":true,"location":{"country":"FR","lat":45.77,"lon":3.08},"fediverse":"https://piaille.fr/@bebatut","fediverse_flavor":"mastodon","affiliations":["gallantries","ifb","elixir-europe"],"id":"bebatut","url":"https://training.galaxyproject.org/training-material/api/contributors/bebatut.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/bebatut/"},{"name":"Hans-Rudolf Hotz","email":"hrhotz@googlemail.com","twitter":"hrhotz","fediverse":"https://genomic.social/@hrhotz","fediverse_flavor":"mastodon","matrix":"hrhotz:matrix.org","orcid":"0000-0002-2799-424X","linkedin":"hans-rudolf-hotz-542b31","joined":"2017-09","elixir_node":"ch","contact_for_training":true,"location":{"country":"CH","lat":47.57,"lon":7.6},"affiliations":["elixir-europe"],"id":"hrhotz","url":"https://training.galaxyproject.org/training-material/api/contributors/hrhotz.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hrhotz/"},{"name":"Mehmet Tekman","email":"mtekman89@gmail.com","joined":"2018-11","elixir_node":"de","affiliations":["uni-freiburg"],"former_affiliations":["elixir-europe"],"id":"mtekman","url":"https://training.galaxyproject.org/training-material/api/contributors/mtekman.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/mtekman/"},{"name":"Pavankumar Videm","orcid":"0000-0002-5192-126X","joined":"2017-09","affiliations":["uni-freiburg","elixir-europe"],"id":"pavanvidem","url":"https://training.galaxyproject.org/training-material/api/contributors/pavanvidem.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/pavanvidem/"}],"gitter":"Galaxy-Training-Network/galaxy-single-cell","js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00254","url":"/topics/single-cell/tutorials/scrna-scanpy-pbmc3k/tutorial.html","topic_name":"single-cell","tutorial_name":"scrna-scanpy-pbmc3k","dir":"topics/single-cell/tutorials/scrna-scanpy-pbmc3k","symlink":null,"id":"single-cell/scrna-scanpy-pbmc3k","ref_tutorials":["<p>Single-cell RNA-seq analysis is a rapidly evolving field at the forefront of transcriptomic research, used in high-throughput developmental studies and rare transcript studies to examine cell heterogeneity within a populations of cells. The cellular resolution and genome wide scope make it possible to draw new conclusions that are not otherwise possible with bulk RNA-seq.</p>\n\n<p>In this tutorial, we will investigate clustering of single-cell data from 10x Genomics, including preprocessing, clustering and the identification of cell types via known marker genes, using <a href=\"https://scanpy.readthedocs.io/en/stable/index.html\">Scanpy</a> (<span class=\"citation\"><a href=\"#wolf2018scanpy\">Wolf <i>et al.</i> 2018</a></span>). It will be illustrated using a dataset of Peripheral Blood Mononuclear Cells (PBMC), containing 2,700 single cells.</p>\n\n<blockquote class=\"comment\">\n  <comment-title></comment-title>\n\n  <p>This tutorial is significantly based on <a href=\"https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html#Clustering-3K-PBMCs\">“Clustering 3K PBMCs” tutorial from Scanpy</a>, <a href=\"https://satijalab.org/seurat/v3.1/pbmc3k_tutorial.html\">“Seurat - Guided Clustering Tutorial”</a> and <a href=\"https://osca.bioconductor.org/\">“Orchestrating Single-Cell Analysis with Bioconductor”</a> <span class=\"citation\"><a href=\"#amezquita2019orchestrating\">Amezquita <i>et al.</i> 2019</a></span>.</p>\n\n</blockquote>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#data\" id=\"markdown-toc-data\">Data</a>    <ol>\n      <li><a href=\"#data-upload\" id=\"markdown-toc-data-upload\">Data upload</a></li>\n      <li><a href=\"#anndata\" id=\"markdown-toc-anndata\">AnnData</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#preprocessing\" id=\"markdown-toc-preprocessing\">Preprocessing</a>    <ol>\n      <li><a href=\"#quality-control\" id=\"markdown-toc-quality-control\">Quality control</a></li>\n      <li><a href=\"#normalization-and-scaling\" id=\"markdown-toc-normalization-and-scaling\">Normalization and scaling</a></li>\n      <li><a href=\"#selection-of-features\" id=\"markdown-toc-selection-of-features\">Selection of features</a></li>\n      <li><a href=\"#scaling-the-data\" id=\"markdown-toc-scaling-the-data\">Scaling the data</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#dimensionality-reduction\" id=\"markdown-toc-dimensionality-reduction\">Dimensionality reduction</a>    <ol>\n      <li><a href=\"#principal-component-analysis\" id=\"markdown-toc-principal-component-analysis\">Principal Component Analysis</a></li>\n      <li><a href=\"#visualization-of-pca\" id=\"markdown-toc-visualization-of-pca\">Visualization of PCA</a></li>\n      <li><a href=\"#determination-of-the-number-of-pcs-to-keep\" id=\"markdown-toc-determination-of-the-number-of-pcs-to-keep\">Determination of the number of PCs to keep</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#clustering-of-the-cells\" id=\"markdown-toc-clustering-of-the-cells\">Clustering of the cells</a>    <ol>\n      <li><a href=\"#computation-of-a-neighborhood-graph\" id=\"markdown-toc-computation-of-a-neighborhood-graph\">Computation of a neighborhood graph</a></li>\n      <li><a href=\"#visualization-of-the-neighborhood-graph\" id=\"markdown-toc-visualization-of-the-neighborhood-graph\">Visualization of the neighborhood graph</a></li>\n      <li><a href=\"#clustering-of-the-neighborhood-graph\" id=\"markdown-toc-clustering-of-the-neighborhood-graph\">Clustering of the neighborhood graph</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#finding-marker-genes\" id=\"markdown-toc-finding-marker-genes\">Finding marker genes</a>    <ol>\n      <li><a href=\"#using-the-t-test\" id=\"markdown-toc-using-the-t-test\">Using the <em>t</em>-test</a></li>\n      <li><a href=\"#using-wilcoxon-rank-sum-test\" id=\"markdown-toc-using-wilcoxon-rank-sum-test\">Using Wilcoxon rank sum test</a></li>\n      <li><a href=\"#visualization-of-expression-of-the-marker-genes\" id=\"markdown-toc-visualization-of-expression-of-the-marker-genes\">Visualization of expression of the marker genes</a></li>\n      <li><a href=\"#comparison-of-the-marker-genes-between-clusters\" id=\"markdown-toc-comparison-of-the-marker-genes-between-clusters\">Comparison of the marker genes between clusters</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#cell-type-annotation\" id=\"markdown-toc-cell-type-annotation\">Cell type annotation</a></li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"data\">Data</h1>\n\n<p>For this tutorial, we analyze a dataset of Peripheral Blood Mononuclear Cells (PBMC) extracted from a healthy donor, freely available from 10X Genomics. The dataset contains 2,700 single cells sequenced using Illumina NextSeq 500. The raw sequences have been processed by the <a href=\"https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/what-is-cell-ranger\"><strong>cellranger</strong></a> pipeline from 10X to extract a unique molecular identifier (UMI) count matrix, in a similar way to that as explained in <a href=\"/training-material/topics/single-cell/tutorials/scrna-preprocessing-tenx/tutorial.html\">“Pre-processing of 10X Single-Cell RNA Datasets” tutorial</a>.</p>\n\n<p>In this matrix, the values represent the number for each feature (i.e. gene; row) that are detected in each cell (column). Such matrices can be quite large, where here there are 2,700 columns with 32,738 lines, with mostly zero values, i.e. an extremely sparse matrix. To optimize the storage of such a table and the information about the genes and cells, <strong>cellranger</strong> creates 3 files:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">genes.tsv</code>: a tabular file with information about the 32,738 genes in 2 columns (Ensembl gene id and the gene symbol)</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">barcodes.tsv</code>: a tabular file with the barcode for each of the 2,700 cells</li>\n  <li>\n    <p><code class=\"language-plaintext highlighter-rouge\">matrix.mtx</code>: a condensed version of the count matrix</p>\n\n    <p>The count matrix is therefore represented by its non-zero values. Each non-zero value is indicated by its line number (1st column), its column number (2nd column) and its value (3rd column). The first row gives indication about the number of lines, column and non-zero values. More information on the Matrix Market Exchange (mtx) format can be found <a href=\"https://math.nist.gov/MatrixMarket/formats.html\">in this documentation</a></p>\n  </li>\n</ul>\n\n<h2 id=\"data-upload\">Data upload</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Data upload</hands-on-title>\n\n  <ol>\n    <li>Create a new history for this tutorial</li>\n    <li>\n      <p>Import the <code class=\"language-plaintext highlighter-rouge\">genes.tsv</code>, <code class=\"language-plaintext highlighter-rouge\">barcodes.tsv</code> and <code class=\"language-plaintext highlighter-rouge\">matrix.mtx</code> from <a href=\"https://zenodo.org/record/3581213\">Zenodo</a> or from the shared data library</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/3581213/files/genes.tsv\nhttps://zenodo.org/record/3581213/files/barcodes.tsv\nhttps://zenodo.org/record/3581213/files/matrix.mtx\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-data-from-a-data-library\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-data-from-a-data-library\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing data from a data library</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>As an alternative to uploading the data from a URL or your computer, the files may also have been made available from a <em>shared data library</em>:</p>   <ol>   <li>Go into <strong>Shared data</strong> (top panel) then <strong>Data libraries</strong></li>   <li>Navigate to  the correct folder as indicated by your instructor.     <ul>       <li>On most Galaxies tutorial data will be provided in a folder named <strong>GTN - Material –&gt; Topic Name -&gt; Tutorial Name</strong>.</li>     </ul>   </li>   <li>Select the desired files</li>   <li>Click on <strong>Add to History</strong> <i class=\"fas fa-caret-down\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-dropdown</span> near the top and select <strong>as Datasets</strong> from the dropdown menu</li>   <li>     <p>In the pop-up window, choose</p>     <ul>       <li><em>“Select history”</em>: the history you want to import the data to (or create a new one)</li>     </ul>   </li>   <li>Click on <strong>Import</strong></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Rename the datasets</li>\n    <li>Inspect the <code class=\"language-plaintext highlighter-rouge\">matrix</code> file</li>\n  </ol>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>32738\t2700\t2286884\n32709\t1\t4\n32707\t1\t1\n32706\t1\t10\n32704\t1\t1\n</code></pre></div>  </div>\n\n  <ol>\n    <li>How many non-zero values are in the matrix?</li>\n    <li>How many counts are found for the 32,706th gene in the 1st cell?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>There are 2,286,884 (2.6%) non-zero values for the 88,392,600 possible counts of the 32,738 genes (rows) and 2,700 cells (columns).</li>\n      <li>10 counts are found for the 32,706th row and 1st column.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>The representation of the matrix with 3 files is convenient to share the data but not to process them. Single-cell analysis packages have attempted to solve the problem of storage and analysis by inventing their own standard, which has led to the proliferation of many different “standards” in the scRNA-seq package ecosystem.</p>\n\n<h2 id=\"anndata\">AnnData</h2>\n\n<p>The most common format, called <a href=\"https://anndata.readthedocs.io/en/stable/\"><code class=\"language-plaintext highlighter-rouge\">AnnData</code></a>, stores the matrix as well as gene and cell annotations in a concise, compressed and extremely readable manner:</p>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-pre-processing/tenx_anndata.svg\" alt=\"Anndata format. \" width=\"194\" height=\"158\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-pre-processing/tenx_anndata.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> <code>AnnData</code> format stores a count matrix <code>X</code> together with annotations of observations (i.e. cells) <code>obs</code>, variables (i.e. genes) <code>var</code> and unstructured annotations <code>uns</code>.</figcaption></figure>\n\n<p>This format is used by <a href=\"https://scanpy.readthedocs.io/en/stable/index.html\">Scanpy</a> (<span class=\"citation\"><a href=\"#wolf2018scanpy\">Wolf <i>et al.</i> 2018</a></span>), the tool suite for analyzing single-cell gene expression data that we will use in this tutorial. So we need first to import the matrix and annotations of genes and cells into an <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Transform matrix and all into AnnData object</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_import/anndata_import/0.10.3+galaxy0\" title=\"Import Anndata and loom tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Import Anndata and loom</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“hd5 format to be created”</em>: <code class=\"language-plaintext highlighter-rouge\">Anndata file</code></li>\n        <li><em>“Format for the annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Matrix Market (mtx), from Cell ranger or not</code>\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">matrix.mtx</code></li>\n            <li><em>“Use 10x Genomics formatted mtx”</em>: <code class=\"language-plaintext highlighter-rouge\">Output from Cell Ranger v2 or earlier versions</code>\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Genes”</em>: <code class=\"language-plaintext highlighter-rouge\">genes.tsv</code></li>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Barcodes”</em>: <code class=\"language-plaintext highlighter-rouge\">barcodes.tsv</code></li>\n                <li><em>“Variables index”</em>: <code class=\"language-plaintext highlighter-rouge\">gene_symbols</code></li>\n                <li><em>“Make the variable index unique by appending ‘-1’, ‘-2’?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated file to <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></p>\n    </li>\n    <li>Check that the format is <code class=\"language-plaintext highlighter-rouge\">h5ad</code></li>\n  </ol>\n</blockquote>\n\n<p>Because the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> format is an extension of the HDF5 format, i.e. a binary format, an <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object can not be inspected directly in Galaxy by clicking on the <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> (<strong>View data</strong>) icon. Instead we need to use a dedicated tool from the <strong>AnnData</strong> suite.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Inspect an AnnData object</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">General information about the object</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>AnnData object with n_obs × n_vars = 2700 × 32738\n    var: 'gene_ids'\n</code></pre></div>        </div>\n\n        <ol>\n          <li>How many observations are there? What do they represent?</li>\n          <li>How many variables are there? What do they represent?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <ol>\n            <li>There are 2,700 observations, representing the cells.</li>\n            <li>There are 32,738 variables, representing the genes.</li>\n          </ol>\n\n        </blockquote>\n\n      </blockquote>\n\n      <blockquote class=\"comment\">\n        <comment-title>Faster Method for General Information</comment-title>\n\n        <ul>\n          <li>The <strong>ScanPy</strong> toolset in Galaxy produces <em>AnnData</em> formats as\noutput, where general information is provided for each dataset:\n            <ul>\n              <li>Click on the name of the dataset in the history to expand it.</li>\n              <li>\n                <p>General Anndata information would be given in the expanded box:</p>\n\n                <p>e.g.</p>\n\n                <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs x n_vars]\n-    2700 x 32738\n</code></pre></div>                </div>\n              </li>\n            </ul>\n          </li>\n          <li>For more specific queries, <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> is required.</li>\n        </ul>\n      </blockquote>\n\n      <blockquote class=\"warning\">\n        <warning-title>Large compute resource consumption! Please run the next step responsibly.</warning-title>\n        <p>Extracting the complete matrix requires large compute resources and long time to finish. Use this step on matrices with less than 10k cells. To inspect \na subset of matrix contents on huge matrices, please change <em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Random chunk of defined size</code></p>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">The full data matrix</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\tMIR1302-10\tFAM138A\tOR4F5\tRP11-34P13.7\tRP11-34P13.8 ...\nAAACATACAACCAC-1\t0.0\t0.0\t0.0\t0.0\nAAACATTGAGCTAC-1\t0.0\t0.0\t0.0\t0.0\nAAACATTGATCAGC-1\t0.0\t0.0\t0.0\t0.0\nAAACCGTGCTTCCG-1\t0.0\t0.0\t0.0\t0.0\nAAACCGTGTATGCG-1\t0.0\t0.0\t0.0\t0.0\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is a table with 2,700 lines (observations or cells) and 32,738 columns (variables or genes): the count matrix for each of the 32,738 genes and 2,700 cells. The 1st row contains the gene symbol as annotation of the columns and the 1st column the barcodes of the cells as annotation of the rows.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed observations annotation (obs)</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\"\"\nAAACATACAACCAC-1\nAAACATTGAGCTAC-1\nAAACATTGATCAGC-1\nAAACCGTGCTTCCG-1\nAAACCGTGTATGCG-1\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is a tabular with annotations of the observations. i.e. the cells. Here there are only the barcodes as annotation, so only one column, being also the index for the count matrix.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed annotation of variables/features (var)</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>\tgene_ids\nMIR1302-10\tENSG00000243485\nFAM138A\tENSG00000237613\nOR4F5\tENSG00000186092\nRP11-34P13.7\tENSG00000238009\nRP11-34P13.8\tENSG00000239945\n</code></pre></div>        </div>\n\n        <p>What is stored in the generated file?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file is a tabular with annotations of the variables, i.e. the genes. Here the files has 2 columns: the gene symbols (also the index in the count matrix), <code class=\"language-plaintext highlighter-rouge\">gene_ids</code> or the Ensemble gene ids.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h1 id=\"preprocessing\">Preprocessing</h1>\n\n<p>The first step when we get our counts is to prepare them before we perform the clustering. This includes (<span class=\"citation\"><a href=\"#amezquita2019orchestrating\">Amezquita <i>et al.</i> 2019</a></span>):</p>\n\n<ol>\n  <li>\n    <p><strong>Selection and filtration of cells and genes based on quality metrics</strong></p>\n\n    <p>Low-quality cells would interfere with downstream analyses. These cells may have been damaged during processing and may not have been fully captured by the sequencing protocol.</p>\n  </li>\n  <li>\n    <p><strong>Data normalization and scaling</strong></p>\n\n    <p>It will eliminate cell-specific biases (e.g., in capture efficiency), allowing us to perform explicit comparisons across cells afterwards. Some transformations, typically log, are also applied to adjust for the mean-variance relationship.</p>\n  </li>\n  <li>\n    <p><strong>Selection of features</strong></p>\n\n    <p>This selection picks a subset of interesting features for downstream analysis, by modelling the variance across cells for each gene and retaining genes that are highly variable. This step is done to reduce computational overhead and noise from uninteresting genes.</p>\n  </li>\n</ol>\n\n<h2 id=\"quality-control\">Quality control</h2>\n\n<p>Genes that appear in less than a few cells can be considered noise and thus removed.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Remove genes found in less than 3 cells</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_filter/scanpy_filter/1.9.6+galaxy1\" title=\"Filter with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Filter with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">Input 3k PBMC</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter genes based on number of cells or counts, using 'pp.filter_genes'</code>\n          <ul>\n            <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of cells expressed</code>\n              <ul>\n                <li><em>“Minimum number of cells expressed required for a gene to pass filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">3k PBMC</code></li>\n    <li>\n      <p>Inspect the dataset.</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2700 × 13714\n[var]\n-    gene_ids\n-    n_cells\n</code></pre></div>        </div>\n\n        <p>How many genes have been removed because they are expressed in less than 3 expressed cells?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>There are now 13,714 genes. So 19,024 (32,738 - 13,714) genes have been removed.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<p>Low-quality cells may be due to a variety of sources such as cell damage during dissociation or failure in library preparation (e.g., inefficient reverse transcription or PCR amplification, <span class=\"citation\"><a href=\"#ilicic2016classification\">Ilicic <i>et al.</i> 2016</a></span>). Usually these low-quality cells have low total counts, few expressed genes and high mitochondrial or spike-in proportions. Low-quality cells are problematic for downstream analyses and may contribute to misleading results.</p>\n\n<blockquote class=\"details\">\n  <details-title>Impact of low-quality cells on the downstream analyses</details-title>\n\n  <h4 id=\"formation-of-their-own-distinct-clusters\">Formation of their own distinct cluster(s)</h4>\n\n  <p>Increased mitochondrial proportions or enrichment for nuclear RNAs after cell damage are the most obvious causes for this phenomenon. Low-quality cells in different cell types can, in the worst case, cluster together (because of similarities in the damage-induced expression profiles) leading to artificial intermediate states or trajectories between subpopulations that should be otherwise distinct. This phenomenon makes the results difficult to interpret.</p>\n\n  <h4 id=\"distortion-of-population-heterogeneity-during-variance-estimation-or-principal-components-analysis\">Distortion of population heterogeneity during variance estimation or principal components analysis</h4>\n\n  <p>With low-quality cells, the main differences captured by the first few principal components will be based on quality rather than biology, reducing then the effectiveness of dimensionality reduction. Similarly, differences between low- and high-quality cells will create genes with the largest variances. For example, in low-quality cells with very low counts, the scaling normalization increases the variance of genes that happen to have a non-zero count in those cells.</p>\n\n  <h4 id=\"misidentification-of-upregulated-genes\">Misidentification of upregulated genes</h4>\n\n  <p>Due to aggressive scaling to normalize for small cell sizes, low-quality cells shows genes that appear to be strongly “upregulated”. For example, contaminating transcripts may be present in all cells with a low but constant levels. With the increased scaling normalization in low-quality cells, the small counts for these transcripts may become large normalized expression values, i.e. an apparent upregulation compared to other cells.</p>\n\n</blockquote>\n\n<p>To mitigate these problems, we need to remove these low-quality cells at the start of the analysis. Several common QC metrics can be used to identify these cells based on their expression profile:</p>\n\n<ul>\n  <li>\n    <p><strong>Cell size</strong>, i.e. the total sum of counts across all genes for each cells</p>\n\n    <p>When cells are very degraded or absent from the library preparation, the number of reads sequenced from that library will be very low. Cells with small sizes are then considered to be of low quality: the RNA has been lost during the library preparation (cell lysis, inefficient cDNA capture and amplification, etc.)</p>\n  </li>\n  <li>\n    <p><strong>Number of expressed genes</strong>, i.e. the number of genes with non-zero counts for each cells</p>\n\n    <p>A low number of expressed genes may be a result of poor-quality cells (e.g. dying, degraded, damaged, etc.), followed by high PCR amplification of the remaining RNA. The diverse transcript population has not been successfully captured so the cell is considered of low quality. Cell doublets or multiplets may also exhibit an aberrantly high gene count.</p>\n  </li>\n  <li>\n    <p><strong>Proportion of reads mapped to genes in the mitochondrial genome</strong></p>\n\n    <p>High concentrations of mitochondrial genes is often a result of damaged cells (<span class=\"citation\"><a href=\"#islam2014quantitative\">Islam <i>et al.</i> 2014</a></span>, <span class=\"citation\"><a href=\"#ilicic2016classification\">Ilicic <i>et al.</i> 2016</a></span>) where the endogenous RNA escapes or degrades. As mitochondria has its own cell membranes, it is often the last DNA/RNA in damaged cells to degrade and hence occurs in high quantities during sequencing.</p>\n  </li>\n</ul>\n\n<p>We will make the key assumption that these metrics are independent of the biological state of each cell. Technical factors rather than biological processes are presumed to drive poor values (e.g., low cell sizes, high mitochondrial proportions). The subsequent removal of impacted cells do not misrepresent the biology in downstream analyses.</p>\n\n<p>To identify low-quality cells, the simplest approach is to apply thresholds on the QC metrics. This strategy, while simple, is required to determine appropriate thresholds that will change given the experimental protocol and the biological system.</p>\n\n<h3 id=\"computation-of-qc-metrics\">Computation of QC metrics</h3>\n\n<p>To estimate the thresholds, we first need to look at the distribution of QC metrics for our dataset.</p>\n\n<p>The first 2 QC metrics (cell size and number of expressed genes) can be easily estimated from the count table. For the third metric (proportion of reads mapped to genes in the mitochondrial genome), we need the information about which genes are mitochondrial or not.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Extract gene annotation</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed annotation of variables/features (var)</code></li>\n      </ul>\n    </li>\n    <li>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">Gene annotation</code></li>\n  </ol>\n</blockquote>\n\n<p>In the gene annotation, we currently have the gene symbol the Ensembl gene ids and the number of cells in which the genes are expressed, but have no information on whether a gene is mitochondrial. This can be extracted from the gene symbol as all mitochondrial genes have a name starting with <code class=\"language-plaintext highlighter-rouge\">MT-</code> and added to the <code class=\"language-plaintext highlighter-rouge\">var</code> of the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object using <strong>Manipulate AnnData</strong> tool.</p>\n\n<p>A new annotation for <code class=\"language-plaintext highlighter-rouge\">var</code> should be a table with the same number of lines as <code class=\"language-plaintext highlighter-rouge\">var</code> (i.e. one line per genes) and as many columns as new annotations, with their names on the 1st line. In our case, we would need to create a 1 column table with <code class=\"language-plaintext highlighter-rouge\">mito</code> on the 1st line and then <code class=\"language-plaintext highlighter-rouge\">True</code> for mitochondrial gene or <code class=\"language-plaintext highlighter-rouge\">False</code> for non mitochondrial genes.</p>\n\n<p>To create this table, we need to:</p>\n\n<ol>\n  <li>Remove the first line. We will add another header later.</li>\n  <li>\n    <p>Create a file with gene symbols from <code class=\"language-plaintext highlighter-rouge\">Gene annotation</code> and a column with <code class=\"language-plaintext highlighter-rouge\">1</code> indicating mitochondrial genes and <code class=\"language-plaintext highlighter-rouge\">0</code> for other genes.</p>\n\n    <p>Using the <code class=\"language-plaintext highlighter-rouge\">awk</code> program, we would like to print for every line the 1st column and a 2nd column with <code class=\"language-plaintext highlighter-rouge\">1</code> if the 1st column starts with <code class=\"language-plaintext highlighter-rouge\">MT-</code> or <code class=\"language-plaintext highlighter-rouge\">0</code> if not, using the regular expression <code class=\"language-plaintext highlighter-rouge\">$1 ~ /^MT-/</code></p>\n  </li>\n  <li>Replace the <code class=\"language-plaintext highlighter-rouge\">0</code> by <code class=\"language-plaintext highlighter-rouge\">False</code> and <code class=\"language-plaintext highlighter-rouge\">1</code> by <code class=\"language-plaintext highlighter-rouge\">True</code></li>\n  <li>Add <code class=\"language-plaintext highlighter-rouge\">mito</code> on the 1st line</li>\n</ol>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Add mitochondrial gene annotation</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_tail_tool/1.1.0\" title=\"Select last tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Select last</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Text file”</em>: <code class=\"language-plaintext highlighter-rouge\">Gene annotation</code></li>\n        <li><em>“Operation”</em>: <code class=\"language-plaintext highlighter-rouge\">Keep everything from this line on</code></li>\n        <li><em>“Number of lines”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Check the format of mitochondrial genes names</tip-title>\n    <p>Mitochondrial gene names start with mt. Since the tool for flagging the mitochondrial genes is case-sensitive, it might be a good idea to check what is the formatting of mitochondrial gene names in our dataset.</p>\n\n    <ol>\n      <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_grep_tool/1.1.1\" title=\"Search in textfiles tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Search in textfiles</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.1)</span> with the following parameters:\n        <ul>\n          <li><em>“Select lines from”</em>: output of <strong>Select</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n          <li><em>“that”</em>: <code class=\"language-plaintext highlighter-rouge\">Match</code></li>\n          <li><em>“Regular Expression”</em>: <code class=\"language-plaintext highlighter-rouge\">^mt</code></li>\n          <li><em>“Match type”</em>: <code class=\"language-plaintext highlighter-rouge\">case insensitive</code></li>\n          <li><em>“Output”</em>: <code class=\"language-plaintext highlighter-rouge\">Highlighted HTML (for easier viewing)</code></li>\n        </ul>\n      </li>\n    </ol>\n\n    <p>If you click on that dataset, you will see all the genes containing ‘mt’ in their name. We can now clearly see that mitochondrial genes in thid dataset start with <code class=\"language-plaintext highlighter-rouge\">MT-</code>, i.e., upper case. Keep that in mind, we will use it in a moment!</p>\n  </blockquote>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_awk_tool/1.1.2\" title=\"Text reformatting tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Text reformatting</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.2)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: output of <strong>Select</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“AWK Program”</em>: <code class=\"language-plaintext highlighter-rouge\">{print $1 ~ /^MT-/}</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How many genes are found as mitochondrial?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>To evaluate the number of non mitochondrial, we need to extract all lines for which the 2nd column is 1. This can be done using the <span class=\"tool\" data-tool=\"Filter1\" title=\"Filter tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Filter</strong></span> tool:</p>\n\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Filter”</em>: output of <strong>Text reformatting</strong></li>\n            <li><em>“With following condition”</em>: <code class=\"language-plaintext highlighter-rouge\">c1!=0</code></li>\n            <li><em>“Number of header lines to skip”</em>: <code class=\"language-plaintext highlighter-rouge\">0</code></li>\n          </ul>\n\n          <p>There are 13 genes found as mitochondrial (0.10% of the 13,714 genes).</p>\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_replace_in_line/1.1.2\" title=\"Replace text in entire line tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace text in entire line</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.2)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: output of <strong>Text reformatting</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li>In <em>“Replacement”</em>:\n          <ul>\n            <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Replacement”</em>\n              <ul>\n                <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">0</code></li>\n                <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">False</code></li>\n              </ul>\n            </li>\n            <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Replacement”</em>\n              <ul>\n                <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n                <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">True</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n\n      <p><small><strong>Note</strong>: <em>Ensure that you have selected the same column for both replacements.</em></small></p>\n    </li>\n    <li>\n      <p>Create a new <strong>tabular</strong> file from the following</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>mito\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-file\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-file\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new file</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong> at the bottom</li>   <li>Paste the file contents into the text field</li>   <li>Change <strong>Type</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">tabular</code>* Press <strong>Start</strong> and <strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"cat1\" title=\"Concatenate datasets tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Concatenate datasets</strong></span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Datasets to concatenate”</em>: <code class=\"language-plaintext highlighter-rouge\">Pasted entry</code> dataset</li>\n        <li>In <em>“Dataset”</em>:\n          <ul>\n            <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Dataset”</em>\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Select”</em>: output of <strong>Replace</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">Mitochondrial annotation</code> and ensure that the datatype is <code class=\"language-plaintext highlighter-rouge\">tabular</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0\" title=\"Manipulate Anndata tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Manipulate Anndata</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC</code></li>\n        <li><em>“Function to manipulate the object”</em>: <code class=\"language-plaintext highlighter-rouge\">Add new annotation(s) for observations or variables</code>\n          <ul>\n            <li><em>“What to annotate?”</em>: <code class=\"language-plaintext highlighter-rouge\">Variables (var)</code></li>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Table with new annotations”</em>: <code class=\"language-plaintext highlighter-rouge\">Mitochondrial annotation</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed annotation of variables/features (var)</code></li>\n      </ul>\n    </li>\n    <li>Inspect the generated file and check if the mitochondrial annotation has been added</li>\n  </ol>\n</blockquote>\n\n<p>We can now compute QC metrics on the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Compute QC metrics</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation</code></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Calculate quality control metrics, using 'pp.calculate_qc_metrics'</code>\n          <ul>\n            <li><em>“Name of kind of values in X”</em>: <code class=\"language-plaintext highlighter-rouge\">counts</code></li>\n            <li><em>“The kind of thing the variables are”</em>: <code class=\"language-plaintext highlighter-rouge\">genes</code></li>\n            <li><em>“Keys for boolean columns of <code class=\"language-plaintext highlighter-rouge\">.var</code> which identify variables you could want to control for”</em>: <code class=\"language-plaintext highlighter-rouge\">mito</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation and qc metrics</code></p>\n    </li>\n    <li>\n      <p>Inspect the dataset</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2700 × 13714\n[obs]\n-    n_genes_by_counts\n-    log1p_n_genes_by_counts\n-    total_counts\n-    log1p_total_counts\n-    pct_counts_in_top_50_genes\n-    pct_counts_in_top_100_genes\n-    pct_counts_in_top_200_genes\n-    pct_counts_in_top_500_genes\n-    total_counts_mito\n-    log1p_total_counts_mito\n-    pct_counts_mito\n[var]\n-    gene_ids\n-    n_cells\n-    mito\n-    n_cells_by_counts\n-    mean_counts\n-    log1p_mean_counts\n-    pct_dropout_by_counts\n-    total_counts\n-    log1p_total_counts\n</code></pre></div>        </div>\n\n        <p>Which QC metrics have been computed?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The tool computed several QC metrics at both cell and gene levels. These metrics are added to the annotation tables.</p>\n\n          <p>At gene levels (stored in <code class=\"language-plaintext highlighter-rouge\">var</code>):</p>\n          <ul>\n            <li><code class=\"language-plaintext highlighter-rouge\">total_counts</code>: sum of counts for a gene</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">mean_counts</code>: mean expression for a gene over all cells</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">n_cells_by_counts</code>: number of cells with non-zero counts for a gene</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_dropout_by_counts</code>: percentage of cells this gene does not appear in</li>\n          </ul>\n\n          <p>At cell levels (stored in <code class=\"language-plaintext highlighter-rouge\">obs</code>):</p>\n          <ul>\n            <li><code class=\"language-plaintext highlighter-rouge\">total_counts</code>: total number of counts for a cell</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">total_counts_mito</code>: total number of counts for the mitochondrial genes in a cell</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts</code>: number of genes with non-zero counts</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_counts_mito</code>: proportion of total counts for a cell which are from mitochondrial genes</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_counts_in_top_50_genes</code>: cumulative percentage of counts for 50 most expressed genes in a cell</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_counts_in_top_100_genes</code>: cumulative percentage of counts for 100 most expressed genes in a cell</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_counts_in_top_200_genes</code>: cumulative percentage of counts for 200 most expressed genes in a cell</li>\n            <li><code class=\"language-plaintext highlighter-rouge\">pct_counts_in_top_500_genes</code>: cumulative percentage of counts for 500 most expressed genes in a cell</li>\n          </ul>\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<p>We would like to visualize 3 of the more informative QC metrics:</p>\n\n<ul>\n  <li>the cell size, i.e. <code class=\"language-plaintext highlighter-rouge\">total_counts</code></li>\n  <li>the number of expressed genes, i.e. <code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts</code></li>\n  <li>the proportion of reads mapped to mitochondrial genes, i.e. <code class=\"language-plaintext highlighter-rouge\">pct_counts_mito</code></li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Visualize QC metrics</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation and qc metrics</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Violin plot, using 'pl.violin'</code>\n          <ul>\n            <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">Subset of variables in 'adata.var_names' or fields of '.obs'</code>\n              <ul>\n                <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts, total_counts, pct_counts_mito</code></li>\n              </ul>\n            </li>\n            <li>In <em>“Violin plot attributes”</em>:\n              <ul>\n                <li><em>“Display keys in multiple panels”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p><a href=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_violin_plot.png\" rel=\"noopener noreferrer\"><img src=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_violin_plot.png\" alt=\"QC violin plot. \" width=\"889\" height=\"265\" loading=\"lazy\" /></a>\n<!-- To update... --></p>\n\n        <p>How do the distributions of the 3 QC metrics look?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>For the cell size, i.e. <code class=\"language-plaintext highlighter-rouge\">total_counts</code>, most of the values are between 1,000 reads and 4,000 reads, with some extremely high values skewing the distribution.</p>\n\n          <p>The numbers of expressed genes, i.e. <code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts</code>, are mostly between 500 genes and 1,200 genes, with also some extremely high values skewing the distribution.</p>\n\n          <p>The distribution of the proportions of reads mapped to mitochondrial genes, i.e. <code class=\"language-plaintext highlighter-rouge\">pct_counts_mito</code>, is even more narrow with some cells having no counts from mitochondrial genes but also having some really extreme values (above 5%).</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation and qc metrics</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Scatter plot along observations or variables axes, using 'pl.scatter'</code>\n          <ul>\n            <li><em>“Plotting tool that computed coordinates”</em>: <code class=\"language-plaintext highlighter-rouge\">Using coordinates</code>\n              <ul>\n                <li><em>“x coordinate”</em>: <code class=\"language-plaintext highlighter-rouge\">total_counts</code></li>\n                <li><em>“y coordinate”</em>: <code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts</code></li>\n                <li><em>“Use the layers attribute?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p><a href=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_scatter_total_counts_n_genes_by_counts.png\" rel=\"noopener noreferrer\"><img src=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_scatter_total_counts_n_genes_by_counts.png\" alt=\"QC total_counts n_genes_by_counts. \" width=\"630\" height=\"417\" loading=\"lazy\" /></a></p>\n\n        <p>Is there any relationship between the cell size and the number of expressed genes?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>On the plot, we can see a strong correlation between the total number of counts for a cell and the number of genes with positive counts.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation and qc metrics</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Scatter plot along observations or variables axes, using 'pl.scatter'</code>\n          <ul>\n            <li><em>“Plotting tool that computed coordinates”</em>: <code class=\"language-plaintext highlighter-rouge\">Using coordinates</code>\n              <ul>\n                <li><em>“x coordinate”</em>: <code class=\"language-plaintext highlighter-rouge\">n_genes_by_counts</code></li>\n                <li><em>“y coordinate”</em>: <code class=\"language-plaintext highlighter-rouge\">pct_counts_mito</code></li>\n                <li><em>“Use the layers attribute?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p><a href=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_scatter_n_genes_by_counts_pct_counts_mito.png\" rel=\"noopener noreferrer\"><img src=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/qc_scatter_n_genes_by_counts_pct_counts_mito.png\" alt=\"QC total_counts pct_counts_mito. \" width=\"617\" height=\"417\" loading=\"lazy\" /></a></p>\n\n        <ol>\n          <li>Is there any relationship between the number of expressed genes and the proportion of reads mapped to mitochondrial genes?</li>\n          <li>What could be a good threshold to filter for cells with high concentrations of mitochondrial genes?</li>\n          <li>What could be good thresholds to filter for cells based on the number of expressed genes?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <ol>\n            <li>Cells with a high proportion of mitochondrial genes are not also cells that have many expressed genes. There is no visible correlation.</li>\n            <li>The cells with a percentage of mitochondrial counts above 5% have also few genes. So 5% may be a good threshold.</li>\n            <li>As discussed before, a low number of expressed genes may be a sign of poor-quality cells. Any cells with less than 200 genes is definitely out of the main distribution so this could be a good threshold to use. High gene count may also be a sign for cell multiplets. We will choose here a threshold of 2,500 genes.</li>\n          </ol>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h3 id=\"filtering-of-low-quality-cells\">Filtering of low-quality cells</h3>\n\n<p>As explained before, we would like now to filter for low-quality cells based on the 3 previous metrics (cell size, number of expressed genes, and proportion of reads mapped to mitochondrial genes). As the cell size is highly correlated with the number expressed genes, we can focus only on the number expressed genes and the proportion of reads mapped to mitochondrial genes.</p>\n\n<p>Based on the previous plot, we would like to remove cells that have:</p>\n\n<ul>\n  <li>a number of expressed genes below 200 or above 2,500</li>\n  <li>a percentage of reads mapped to mitochondrial genes above 5%</li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Remove low-quality cells</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_filter/scanpy_filter/1.9.6+galaxy1\" title=\"Filter with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Filter with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with mito annotation and qc metrics</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter cell outliers based on counts and numbers of genes expressed, using 'pp.filter_cells'</code>\n          <ul>\n            <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Minimum number of genes expressed</code>\n              <ul>\n                <li><em>“Minimum number of genes expressed required for a cell to pass filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">200</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the dataset</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2700 × 13714\n</code></pre></div>        </div>\n\n        <p>How many cells have been removed because they have less than 200 expressed genes?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>There are still 2,700 cells. So no cells have been removed because they have less than 200 expressed genes.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_filter/scanpy_filter/1.9.6+galaxy1\" title=\"Filter with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Filter with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of <strong>Filter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter cell outliers based on counts and numbers of genes expressed, using 'pp.filter_cells'</code>\n          <ul>\n            <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Maximum number of genes expressed</code>\n              <ul>\n                <li><em>“Maximum number of genes expressed required for a cell to pass filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">2500</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Inspect the dataset\n      <blockquote class=\"question\">\n\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2695 × 13714\n</code></pre></div>        </div>\n\n        <p>How many cells have been removed because they have more than 2,500 expressed genes?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>There are now 2,695 cells. So 5 cells have been removed because they have more than 2,500 expressed genes.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0\" title=\"Manipulate Anndata tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Manipulate Anndata</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of <strong>Filter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Function to manipulate the object”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter observations or variables</code>\n          <ul>\n            <li><em>“What to filter?”</em>: <code class=\"language-plaintext highlighter-rouge\">Observations (obs)</code></li>\n            <li><em>“Type of filtering?”</em>: <code class=\"language-plaintext highlighter-rouge\">By key (column) values</code>\n              <ul>\n                <li><em>“Key to filter”</em>: <code class=\"language-plaintext highlighter-rouge\">pct_counts_mito</code></li>\n                <li><em>“Type of value to filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Number</code>\n                  <ul>\n                    <li><em>“Filter”</em>: <code class=\"language-plaintext highlighter-rouge\">less than</code></li>\n                    <li><em>“Value”</em>: <code class=\"language-plaintext highlighter-rouge\">5.0</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated file <code class=\"language-plaintext highlighter-rouge\">3k PBMC after QC filtering</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC after QC filtering</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">General information about the object</code></li>\n      </ul>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>AnnData object with n_obs × n_vars = 2638 × 13714\n</code></pre></div>        </div>\n\n        <p>How many cells have been removed because they have more than 5% of reads mapped to mitochondrial genes?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>There are now 2,638 cells. So 57 cells have been removed because they have more than 5% of reads mapped to mitochondrial genes.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"normalization-and-scaling\">Normalization and scaling</h2>\n\n<p>In scRNA-seq, we can observe systematic differences in sequencing coverage between cells (<span class=\"citation\"><a href=\"#stegle2015computational\">Stegle <i>et al.</i> 2015</a></span>), because of technical differences in cDNA capture or PCR amplification efficiency across cells, attributable to the difficulty of achieving consistent library preparation with minimal starting material. After removing low-quality cells, normalization of the counts removes these differences to avoid that they interfere with comparisons of the expression profiles between cells. Any observed heterogeneity or differential expression within the cell population after normalization are then driven by biology and not technical biases.</p>\n\n<p>Scaling normalization is the simplest and most commonly-used class of normalization strategies. All counts for each cell are divided by a cell-specific scaling factor, often called a “size factor”. The assumption behind this process is that any technical biases tend to affect genes in a similar manner. The relative bias for each cell is represented by the size factor for that cell. Dividing the cell counts by its size factor should then remove the bias.</p>\n\n<p>The simplest strategy for scaling normalization is the cell size normalization, i.e. similar total sum of counts across all genes for each cell. The “cell size factor” for each cell is computed directly for its cell size and transformed such that the mean size factor across all cells is equal to 1. The normalized expression values are then kept on the same scale as the original counts.</p>\n\n<p>Here we would to normalize our count table such that each cell have 10,000 reads.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Normalize for cell size</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_normalize/scanpy_normalize/1.9.6+galaxy1\" title=\"Normalize with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Normalize with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC after QC filtering</code></li>\n        <li><em>“Method used for normalization”</em>: <code class=\"language-plaintext highlighter-rouge\">Normalize counts per cell, using 'pp.normalize_total'</code>\n          <ul>\n            <li><em>“Target sum”</em>: <code class=\"language-plaintext highlighter-rouge\">10000.0</code></li>\n            <li><em>“Exclude (very) highly expressed genes for the computation of the normalization factor (size factor) for each cell”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n            <li><em>“Name of the field in ‘adata.obs’ where the normalization factor is stored”</em>: <code class=\"language-plaintext highlighter-rouge\">norm</code></li>\n            <li><em>“How to normalize layers?”</em>: <code class=\"language-plaintext highlighter-rouge\">After: for each layer in layers each cell has a total count equal to target_sum.</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>The normalized counts should be log-transformed afterwards to adjust for the mean-variance relationship.</p>\n\n<p>With log-transformation, the differences in the log-values represent log-fold changes in expression. Log-transformation focuses on promoting contributions from genes with strong relative differences (e.g. a gene that is expressed at an average count of 50 in cell type A and 10 in cell type B rather than a gene that is expressed at an average count of 1100 in A and 1000 in B).</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Log-transform the counts</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of <strong>Normalize</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Logarithmize the data matrix, using 'pp.log1p'</code></li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p>We will freeze the current state of the AnnData object, i.e. the logarithmized raw gene expression, in the a <code class=\"language-plaintext highlighter-rouge\">raw</code> attribute. This information will be used later in differential testing and visualizations of gene expression.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Freeze the state of the AnnData object</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0\" title=\"Manipulate Anndata tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Manipulate Anndata</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of <strong>Inspect and manipulate</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Function to manipulate the object”</em>: <code class=\"language-plaintext highlighter-rouge\">Freeze the current state into the 'raw' attribute</code></li>\n      </ul>\n    </li>\n    <li>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC after QC filtering and normalization</code></li>\n  </ol>\n</blockquote>\n\n<h2 id=\"selection-of-features\">Selection of features</h2>\n\n<p>Data from scRNA-Seq is often used in exploratory analyses to characterize heterogeneity across cells. With clustering and dimensionality reduction, cells are compared based on their gene expression profiles. The choice of genes to use may have a major impact on the behaviour of the clustering and the dimensionality reduction. We need then to remove genes with random noise while keeping genes containing useful information about the biology of the system. This reduces the data size but still highlights any interesting biological signal without the noise that obscures that structure.</p>\n\n<p>Selecting the most variable genes based on their expression across the cells (i.e. genes highly expressed in some cells, and lowly expressed in others) is the simplest approach for feature selection. With this approach, we assume that increased variation in some genes compared to other genes are genuine biological differences and not technical noise or a baseline level of “uninteresting” biological variation.</p>\n\n<p>To quantify the per-gene variation, the simplest approach consists of computing the variance of the log-normalized expression values for each gene across all cells in the population. With this approach, the feature selection is based on the same log-values as the ones used in clustering, ensuring then that the quantitative definition of heterogeneity is consistent throughout the entire analysis.</p>\n\n<p>Calculation of the per-gene variance is simple but feature selection requires modelling of the mean-variance relationship, as done in the Seurat procedure (<span class=\"citation\"><a href=\"#stuart2019comprehensive\">Stuart <i>et al.</i> 2019</a></span>) we will use.</p>\n\n<p>Once the per-gene variation has been quantified, we need to select the subset of highly variable genes that we will use in downstream analyses. A large subset reduces the risk of discarding any interesting biological signal, but increases the noise from irrelevant genes on the signal. The optimal trade-off is difficult to determine but there are several common strategies routinely used. You can read the <a href=\"https://osca.bioconductor.org/feature-selection.html#hvg-selection\">Chapter 8 from “Orchestrating Single-Cell Analysis with Bioconductor”</a> for a nice presentation of the different strategies. Here, we will define the set of highly variable genes as those which, after normalization, have a normalized dispersion amount higher than 0.5.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Identify the highly variable genes</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_filter/scanpy_filter/1.9.6+galaxy1\" title=\"Filter with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Filter with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC after QC filtering and normalization</code></li>\n        <li><em>“Method used for filtering”</em>: <code class=\"language-plaintext highlighter-rouge\">Annotate (and filter) highly variable genes, using 'pp.highly_variable_genes'</code>\n          <ul>\n            <li><em>“Flavor for computing normalized dispersion”</em>: <code class=\"language-plaintext highlighter-rouge\">seurat</code>\n              <ul>\n                <li><em>“Minimal mean cutoff”</em>: <code class=\"language-plaintext highlighter-rouge\">0.0125</code></li>\n                <li><em>“Maximal mean cutoff”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                <li><em>“Minimal normalized dispersion cutoff”</em>: <code class=\"language-plaintext highlighter-rouge\">0.5</code></li>\n              </ul>\n            </li>\n            <li><em>“Inplace subset to highly-variable genes?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of the last <strong>Filter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Preprocessing: Plot dispersions versus means for genes, using 'pl.highly_variable_genes'</code></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/feature_selection_highly_variable_genes.png\" rel=\"noopener noreferrer\"><img src=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/feature_selection_highly_variable_genes.png\" alt=\"Highly variable genes. \" width=\"1061\" height=\"432\" loading=\"lazy\" /></a></p>\n\n<p>Both highly variable genes and other genes are still in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object. We can now actually keep only the highly variable genes.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Keep the highly variable genes</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Inspect the output of the last <strong>Filter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2638 × 13714\n[obs]\n-    n_genes_by_counts\n-    log1p_n_genes_by_counts\n-    total_counts\n-    log1p_total_counts\n-    pct_counts_in_top_50_genes\n-    pct_counts_in_top_100_genes\n-    pct_counts_in_top_200_genes\n-    pct_counts_in_top_500_genes\n-    total_counts_mito\n-    log1p_total_counts_mito\n-    pct_counts_mito\n-    n_genes\n-    norm\n[var]\n-    gene_ids\n-    n_genes\n-    mito\n-    n_cells_by_counts\n-    mean_counts\n-    log1p_mean_counts\n-    pct_dropout_by_counts\n-    total_counts\n-    log1p_total_counts\n-    highly_variable\n-    means\n-    dispersions\n-    dispersions_norm\n</code></pre></div>        </div>\n\n        <ol>\n          <li>How many genes are in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</li>\n          <li>Where is the stored the information about the genes and if they are highly variable or not?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <ol>\n            <li>There are now 13,714 genes, as before.</li>\n            <li>Extra annotations have been added to <code class=\"language-plaintext highlighter-rouge\">var</code>, whose a boolean annotation <code class=\"language-plaintext highlighter-rouge\">highly_variable</code> for highly variable genes.</li>\n          </ol>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0\" title=\"Manipulate Anndata tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Manipulate Anndata</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of the last <strong>Filter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Function to manipulate the object”</em>: <code class=\"language-plaintext highlighter-rouge\">Filter observations or variables</code>\n          <ul>\n            <li><em>“What to filter?”</em>: <code class=\"language-plaintext highlighter-rouge\">Variables (var)</code>\n              <ul>\n                <li><em>“Type of filtering?”</em>: <code class=\"language-plaintext highlighter-rouge\">By key (column) values</code>\n                  <ul>\n                    <li><em>“Key to filter”</em>: <code class=\"language-plaintext highlighter-rouge\">highly_variable</code></li>\n                    <li><em>“Type of value to filter”</em>: <code class=\"language-plaintext highlighter-rouge\">Boolean</code></li>\n                    <li><em>“Value to keep”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">General information about the object</code></li>\n      </ul>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>AnnData object with n_obs × n_vars = 2638 × 1838\n</code></pre></div>        </div>\n\n        <p>How many genes have been removed?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>Only 1,838 (over the 13,714) genes are kept.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"scaling-the-data\">Scaling the data</h2>\n\n<p>Prior to any downstream analysis like dimensional reduction, we need to apply a linear transformation or scaling to:</p>\n\n<ol>\n  <li>Regress out unwanted sources of variation in the total counts per cell and the percentage of mitochondrial genes expressed.</li>\n  <li>Scale data to unit variance and zero mean, i.e. the variance across cells is 1 and the mean expression is 0, in order to give equal weight in downstream analyses and ensure that highly-expressed genes do not dominate.</li>\n</ol>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Scale the data</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_remove_confounders/scanpy_remove_confounders/1.9.6+galaxy1\" title=\"Remove confounders with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Remove confounders with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Regress out unwanted sources of variation, using 'pp.regress_out'</code>\n          <ul>\n            <li><em>“Keys for observation annotation on which to regress on”</em>: <code class=\"language-plaintext highlighter-rouge\">total_counts, pct_counts_mito</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span>\n with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: output of <strong>Remove confounders</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Scale data to unit variance and zero mean, using 'pp.scale'</code>\n          <ul>\n            <li><em>“Zero center?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li>\n              <p><em>“Maximum value”</em>: <code class=\"language-plaintext highlighter-rouge\">10.0</code></p>\n\n              <p>It clips values exceeding a standard deviation of 10.</p>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling</code></li>\n  </ol>\n</blockquote>\n\n<h1 id=\"dimensionality-reduction\">Dimensionality reduction</h1>\n\n<p>We aim in scRNA-seq to compare cells based on their expressions across genes, e.g. to identify similar transcriptomic profiles. Each gene represents then a dimension of the data.</p>\n\n<p>With a dataset of 2 genes, we could make a 2-dimensional plot where each point is a cell and each axis is the expression of one gene. For datasets with thousands of genes, the concept is the same: each cell’s expression profile defines its location in the high-dimensional expression space.</p>\n\n<p>Expressions of different genes are correlated if they are affected by the same biological process. The separate information for these individual genes do not need to be stored, but can instead be compressed into a single dimension, e.g. an “eigengene”. Dimensionality reduction aims then to reduce the number of separate dimensions in the data and then:</p>\n\n<ul>\n  <li>reduces the computational work in downstream analyses to only a few dimensions</li>\n  <li>reduces noise by averaging across multiple genes to obtain a more precise representation of the patterns in the data</li>\n  <li>enables effective plotting of the data.</li>\n</ul>\n\n<h2 id=\"principal-component-analysis\">Principal Component Analysis</h2>\n\n<p>Principal Component Analysis (PCA) is a dimensionality reduction technique consisting in the identification of axes in high-dimensional space that capture the largest amount of variation. This simple, highly effective strategy is widely used in data science.</p>\n\n<p>In PCA, the first axis (or Principal Component (PC)) is chosen such that it captures the greatest variance across cells. The next PC should be orthogonal to the first and capture the greatest remaining amount of variation, and so on.</p>\n\n<p>By applying PCA to scRNA-Seq, we assume that multiple genes are affected by the same biological processes in a coordinated way and random technical or biological noise affects each gene independently. As more variation can be captured by considering the correlated behaviour of many genes, the top PCs are likely to represent the biological signal and the noise are concentrated into the later PCs. The dominant factors of heterogeneity are then captured by the top PCs. Restricting downstream analyses to the top PCs will then reduce the dimensionality of the data whilst focusing on the biological signal and removing the noise.</p>\n\n<p>Here we perform the PCA on the log-normalized expression values and compute the first 50 PCs.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Perform the PCA</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_cluster_reduce_dimension/scanpy_cluster_reduce_dimension/1.9.6+galaxy1\" title=\"Cluster, infer trajectories and embed with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster, infer trajectories and embed with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span>\nwith the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Computes PCA (principal component analysis) coordinates, loadings and variance decomposition, using 'tl.pca'</code>\n          <ul>\n            <li><em>“Number of principal components to compute”</em>: <code class=\"language-plaintext highlighter-rouge\">50</code></li>\n            <li><em>“Type of PCA?”</em>: <code class=\"language-plaintext highlighter-rouge\">Full PCA</code>\n              <ul>\n                <li><em>“Compute standard PCA from covariance matrix?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n                <li><em>“SVD solver to use”</em>: <code class=\"language-plaintext highlighter-rouge\">ARPACK wrapper in SciPy</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"details\">\n  <details-title>Storage of PCA information in `AnnData` objects</details-title>\n\n  <p>PCA information are stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object in a quite complex way.</p>\n\n  <blockquote class=\"hands_on\">\n    <hands-on-title>Inspect the PCA inside an `AnnData` object</hands-on-title>\n\n    <ol>\n      <li>\n        <p>Inspect the <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code> dataset</p>\n\n        <blockquote class=\"question\">\n          <question-title></question-title>\n\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[n_obs × n_vars]\n-    2638 × 1838\n[obs]\n-    n_genes_by_counts\n-    log1p_n_genes_by_counts\n-    total_counts\n-    log1p_total_counts\n-    pct_counts_in_top_50_genes\n-    pct_counts_in_top_100_genes\n-    pct_counts_in_top_200_genes\n-    pct_counts_in_top_500_genes\n-    total_counts_mito\n-    log1p_total_counts_mito\n-    pct_counts_mito\n-    n_genes\n-    norm\n[var]\n-    gene_ids\n-    mito\n-    n_cells_by_counts\n-    mean_counts\n-    log1p_mean_counts\n-    pct_dropout_by_counts\n-    total_counts\n-    log1p_total_counts\n-    highly_variable\n-    means\n-    dispersions\n-    dispersions_norm\n[uns]\n-    pca\n[obsm]\n-    X_pca\n[varm]\n-    PCs\n</code></pre></div>          </div>\n\n          <p>How is the PCA stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</p>\n\n          <blockquote class=\"solution\">\n            <solution-title></solution-title>\n\n            <p>3 new objects (<code class=\"language-plaintext highlighter-rouge\">uns</code>, <code class=\"language-plaintext highlighter-rouge\">obsm</code>, <code class=\"language-plaintext highlighter-rouge\">varm</code>) have been added to the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object with information that seem related to PCA.</p>\n\n            <p><code class=\"language-plaintext highlighter-rouge\">uns</code> is an unstructured annotation, <code class=\"language-plaintext highlighter-rouge\">obsm</code> multi-dimensional annotation of the observations (i.e. genes) and <code class=\"language-plaintext highlighter-rouge\">varm</code> multi-dimensional annotation of the variables (i.e. cells).</p>\n          </blockquote>\n\n        </blockquote>\n      </li>\n      <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n        <ul>\n          <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n          <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Unstructured annotation (uns)</code>\n            <ul>\n              <li><em>“What to inspect in uns?”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA</code></li>\n            </ul>\n          </li>\n        </ul>\n\n        <blockquote class=\"question\">\n          <question-title></question-title>\n\n          <p>What information is stored in <code class=\"language-plaintext highlighter-rouge\">uns</code> regarding the PCA?</p>\n\n          <blockquote class=\"solution\">\n            <solution-title></solution-title>\n\n            <p><code class=\"language-plaintext highlighter-rouge\">uns</code> is storing:</p>\n\n            <ul>\n              <li>the ratio of explained variance by the PCs, sorted by PC, as a one-column table</li>\n              <li>the explained variance for each PCs, equivalent to the eigenvalues of the covariance matrix, as a one-column table</li>\n            </ul>\n          </blockquote>\n\n        </blockquote>\n      </li>\n      <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n        <ul>\n          <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n          <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Multi-dimensional observations annotation (obsm)</code>\n            <ul>\n              <li><em>“Which annotation to inspect for the observations?”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA coordinates (X_pca)</code></li>\n            </ul>\n          </li>\n        </ul>\n\n        <blockquote class=\"question\">\n          <question-title></question-title>\n\n          <p>What are the information stored in <code class=\"language-plaintext highlighter-rouge\">obsm</code> regarding the PCA?</p>\n\n          <blockquote class=\"solution\">\n            <solution-title></solution-title>\n\n            <p><code class=\"language-plaintext highlighter-rouge\">obsm</code> is storing the PCA coordinates for the cells as a table with the rows being the cells, the columns the PCs and the values the PCs coordinate for cell and PC.</p>\n          </blockquote>\n\n        </blockquote>\n      </li>\n      <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n        <ul>\n          <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n          <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Multi-dimensional variables annotation (varm)</code>\n            <ul>\n              <li><em>“Which annotation to inspect for the variables?”</em>: <code class=\"language-plaintext highlighter-rouge\">Principal components containing the loadings</code></li>\n            </ul>\n          </li>\n        </ul>\n\n        <blockquote class=\"question\">\n          <question-title></question-title>\n\n          <p>What information is stored in <code class=\"language-plaintext highlighter-rouge\">varm</code> regarding the PCA?</p>\n\n          <blockquote class=\"solution\">\n            <solution-title></solution-title>\n\n            <p><code class=\"language-plaintext highlighter-rouge\">varm</code> is storing the PCA coordinates for the genes as a table with the rows being the genes, the columns the PCs and the values the PCs coordinate for gene and PC.</p>\n          </blockquote>\n\n        </blockquote>\n      </li>\n    </ol>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"visualization-of-pca\">Visualization of PCA</h2>\n\n<p>One application of dimensionality reduction and PCA is to compress the data for plotting into 2 (sometimes 3) dimensions with the most salient features of the data.</p>\n\n<p>Scanpy provides several useful ways of visualizing both cells and genes that define the PCA. The simplest approach for visualization is to plot the top 3 PCs on 2D plots (PC1 vs PC2 and PC2 vs PC3)</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot the top 2 PCs the PCA</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA: Plot PCA results, using 'pl.pca_overview'</code>\n          <ul>\n            <li>In <em>“Plot attributes”</em>\n              <ul>\n                <li>In <em>“Component”</em>\n                  <ul>\n                    <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Component”</em></li>\n                    <li>In <em>“1: Component”</em>\n                      <ul>\n                        <li><em>“X-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n                        <li><em>“Y-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                      </ul>\n                    </li>\n                    <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Component”</em></li>\n                    <li>In <em>“1: Component”</em>\n                      <ul>\n                        <li><em>“X-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                        <li><em>“Y-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                      </ul>\n                    </li>\n                  </ul>\n                </li>\n                <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p><a href=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/pca_overview.png\" rel=\"noopener noreferrer\"><img src=\"/training-material/topics/single-cell/images/scrna-scanpy-pbmc3k/pca_overview.png\" alt=\"PCA overview. \" width=\"1158\" height=\"409\" loading=\"lazy\" /></a></p>\n\n<p>On these plots we see the different cells projected onto the first 3 PCs. We can already see subpopulations of cells, but only 3 PCs are represented there and plot like these are not so informative. It may be more interesting to project also the values for the genes, since perhaps these are the genes most involved in the 3 PCs.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Visualize the top genes associated with PCs</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA: Rank genes according to contributions to PCs, using 'pl.pca_loadings'</code>\n          <ul>\n            <li><em>“List of comma-separated components”</em>: <code class=\"language-plaintext highlighter-rouge\">1,2,3</code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p><a href=\"../../images/scrna-scanpy-pbmc3k/pca_loadings.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/pca_loadings.png\" alt=\"PCA loadings. \" width=\"1601\" height=\"430\" loading=\"lazy\" /></a></p>\n\n        <p>What are the top genes for each of the 3 first PCs? What do they represent?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>CST3 is the gene the most associated with the 1st PC, NKG7 the one for the 2nd PC, and PF4 and PPBP for the 3rd PC (for consistency with the published <a href=\"https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html\">scanpy</a> and <a href=\"https://satijalab.org/seurat/v3.1/pbmc3k_tutorial.html\">Seurat</a> documentation, we will use PPBP).</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA: Plot PCA results, using 'pl.pca_overview'</code>\n          <ul>\n            <li><em>“Keys for annotations of observations/cells or variables/genes”</em>: <code class=\"language-plaintext highlighter-rouge\">CST3, NKG7, PPBP</code></li>\n            <li>In <em>“Plot attributes”</em>\n              <ul>\n                <li>In <em>“Component”</em>\n                  <ul>\n                    <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Component”</em></li>\n                    <li>In <em>“1: Component”</em>\n                      <ul>\n                        <li><em>“X-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n                        <li><em>“Y-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                      </ul>\n                    </li>\n                    <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Insert Component”</em></li>\n                    <li>In <em>“1: Component”</em>\n                      <ul>\n                        <li><em>“X-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                        <li><em>“Y-axis”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                      </ul>\n                    </li>\n                  </ul>\n                </li>\n                <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/pca_scatter.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/pca_scatter.png\" alt=\"PCA scatter for CST3, NKG7 and PPBP. \" width=\"1171\" height=\"1264\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>Where are the differences in expression for CST3, NKG7, and PPBP?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ul>\n      <li>For CST3, the differences are mostly projected on PC1 (expected as CST3 is the top gene for PC1), and not visible on the PC3 vs PC2 plot.</li>\n      <li>For NKG7, the differences in expression are seen on PC2.</li>\n      <li>For PPBP, the differences in expression are seen on PC3.</li>\n    </ul>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"determination-of-the-number-of-pcs-to-keep\">Determination of the number of PCs to keep</h2>\n\n<p>We performed the PCA analyses using 50 PCS. They represent a robust compression of the dataset, but we may not need to keep all of them. How many components should we choose to include?</p>\n\n<p>The choice of the number of PCs is a similar question to the choice of the number of highly variable genes to keep. More PCs means more noise but also more biological signal.</p>\n\n<p>A simple heuristic for choosing the number of PCs generates an “Elbow plot”: a ranking of the PCs based on the percentage of variance they explain.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Generate an Elbow plot</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">PCA: Scatter plot in PCA coordinates, using 'pl.pca_variance_ratio'</code>\n          <ul>\n            <li><em>“Use the log of the values?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/pca_variance_ratio.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/pca_variance_ratio.png\" alt=\"PCA variance ratio. \" width=\"569\" height=\"453\" loading=\"lazy\" /></a></p>\n\n<p>To determine the elbow point, we assume that each of the PCs should explain much more variance than the remaining PCS. So after the last PCs we choose, the percentage of variance explained should not drop much.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>How many PCs should we keep given the previous plot?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>We choose here to keep 10 PCs.</p>\n\n  </blockquote>\n</blockquote>\n\n<p>We encourage users to repeat downstream analyses with different number of PCs.</p>\n\n<h1 id=\"clustering-of-the-cells\">Clustering of the cells</h1>\n\n<p>In the PC projection, we saw some subpopulations of cells emerging. We would like now to empirically define these subpopulation of cells with similar expression profiles using unsupervised clustering.</p>\n\n<p>Clustering summarizes the data and allows us to describe the population heterogeneity in terms of discrete and easily understandable labels. The subpopulations can be afterwards treated as proxies for biological objects like cell types or states.</p>\n\n<p>Graph-based clustering has been popularized for clustering large scRNA-Seq datasets by its use in Seurat (<span class=\"citation\"><a href=\"#butler2018integrating\">Butler <i>et al.</i> 2018</a></span>, <span class=\"citation\"><a href=\"#stuart2019comprehensive\">Stuart <i>et al.</i> 2019</a></span>). Such approaches like the K-nearest neighbor (KNN) graph works in 2 steps:</p>\n\n<ol>\n  <li>\n    <p><strong>Computation of a neighborhood graph</strong></p>\n\n    <p>A graph is first built with each node being a cell connected to its nearest neighbours having similar expression patterns. Edges are weighted based on the similarity between the cells: higher weight is given to cells that are more closely related, i.e. have similar expression profiles.</p>\n  </li>\n  <li>\n    <p><strong>Clustering of the neighborhood graph</strong></p>\n\n    <p>The graph is then partitioned into highly interconnected “quasi-cliques” or “communities”, i.e. cells that are more connected to cells in the same community than they are to cells of different communities. Each community represents a cluster that we can use for downstream interpretation.</p>\n  </li>\n</ol>\n\n<h2 id=\"computation-of-a-neighborhood-graph\">Computation of a neighborhood graph</h2>\n\n<p>When running graph-based clustering, we need to think about:</p>\n\n<ul>\n  <li>How many neighbors are considered when constructing the graph.</li>\n  <li>What scheme is used to weight the edges.</li>\n</ul>\n\n<p>Here, to reproduce original results, we choose 10 neighbors for a KNN graph, the Euclidian distance metrics and the UMAP method (<span class=\"citation\"><a href=\"#mcinnes2018umap\">McInnes <i>et al.</i> 2018</a></span>) to compute the connectivities. The values will change depending on the data and can not easily predefined: testing different values is the only solution.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Compute the neighborhood graph</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling and PCA</code></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Compute a neighborhood graph of observations, using 'pp.neighbors'</code>\n          <ul>\n            <li><em>“The size of local neighborhood (in terms of number of neighboring data points) used for manifold approximation”</em>: <code class=\"language-plaintext highlighter-rouge\">10</code></li>\n            <li><em>“Number of PCs to use”</em>: <code class=\"language-plaintext highlighter-rouge\">10</code></li>\n            <li><em>“Use a hard threshold to restrict the number of neighbors to n_neighbors?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Method for computing connectivities”</em>: <code class=\"language-plaintext highlighter-rouge\">umap (McInnes et al, 2018)</code></li>\n            <li><em>“Distance metric”</em>: <code class=\"language-plaintext highlighter-rouge\">euclidean</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA and KNN graph</code></p>\n    </li>\n    <li>\n      <p>Inspect the dataset</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How is the neighborhood graph stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>An extra object <code class=\"language-plaintext highlighter-rouge\">neighbors</code> has been added to <code class=\"language-plaintext highlighter-rouge\">uns</code> with 2 mtx objects (similar format to the original count table):</p>\n\n          <ul>\n            <li>Distance between each cells</li>\n            <li>Weighted adjacency matrix between cells</li>\n          </ul>\n\n          <p>This information can be accessed using <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:</p>\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA and KNN graph</code></li>\n            <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Unstructured annotation (uns)</code>\n              <ul>\n                <li><em>“What to inspect in uns?”</em>: <code class=\"language-plaintext highlighter-rouge\">Neighbors</code></li>\n              </ul>\n            </li>\n          </ul>\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"visualization-of-the-neighborhood-graph\">Visualization of the neighborhood graph</h2>\n\n<p>To visualize and explore the neighborhood graph, we can apply an extra step of non-linear dimensional reduction techniques to learn the underlying manifold of the data in order to place similar cells together in low-dimensional space. Cells that will be in the same clusters, i.e. cells with similar local neighborhoods in high-dimensional space, should co-localize on these low-dimensional plots.</p>\n\n<p>Two techniques are commonly used for the non-linear dimensional reduction: <em>t</em>-SNE (t-distributed stochastic neighbor embedding) and UMAP. Scanpy authors recommend to use here UMAP as it better preserves trajectories (check <span class=\"citation\"><a href=\"#becht2019dimensionality\">Becht <i>et al.</i> 2019</a></span> for a review) and easily accommodates new data.</p>\n\n<p>Here, we will reduce the neighborhood to 2 UMAP components and then we will check to see how the cells are projected on them given the top genes</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Embed and plot the neighborhood graph</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_cluster_reduce_dimension/scanpy_cluster_reduce_dimension/1.9.6+galaxy1\" title=\"Cluster, infer trajectories and embed with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster, infer trajectories and embed with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA and KNN graph</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Embed the neighborhood graph using UMAP, using 'tl.umap'</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP</code></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How is the UMAP reduction stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>An extra object <code class=\"language-plaintext highlighter-rouge\">X_umap</code> has been added to <code class=\"language-plaintext highlighter-rouge\">obsm</code> with the 2 UMAP coordinates for each cell, as a table of 2 columns and 2,638 lines.</p>\n\n          <p>This information can be accessed using:</p>\n          <ol>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Generalinformation about the object</code></li>\n              </ul>\n            </li>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA and KNN graph, UMAP</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Multi-dimensional observations annotation (obsm)</code></li>\n                <li><em>“What to inspect in for the observations?”</em>: <code class=\"language-plaintext highlighter-rouge\">UMAP coordinates (X_umap)</code></li>\n              </ul>\n            </li>\n          </ol>\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Embeddings: Scatter plot in UMAP basis, using 'pl.umap'</code>\n          <ul>\n            <li><em>“Keys for annotations of observations/cells or variables/genes”</em>: <code class=\"language-plaintext highlighter-rouge\">CST3, NKG7, PPBP</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/umap_before_clustering.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/umap_before_clustering.png\" alt=\"UMAP coordinates before clustering. \" width=\"1719\" height=\"429\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>Are clusters identifiable on these graphs? Might they be linked to PCs?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>There seem to be at least 3 big clusters (the 3 blobs) before looking at the expression of some representative genes.</p>\n\n    <p>With the plot colored with NKG7 expression, we clearly see that the blob on the bottom right could be divided in 3 sub-clusters (light green, blue, purple). Given the expression of PPBP, the “arm” on the blob on the left should be a different cluster.</p>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"clustering-of-the-neighborhood-graph\">Clustering of the neighborhood graph</h2>\n\n<p>Given the first visualization, we can now cluster the cells within a neighborhood graph.</p>\n\n<p>Which community detection algorithm should we use to define the clusters? Several modularity optimization techniques such as the SLM (<span class=\"citation\"><a href=\"#blondel2008fast\">Blondel <i>et al.</i> 2008</a></span>), Louvain algorithm (<span class=\"citation\"><a href=\"#levine2015data\">Levine <i>et al.</i> 2015</a></span>) or the Leiden algorithm (<span class=\"citation\"><a href=\"#traag2019louvain\">Traag <i>et al.</i> 2019</a></span>) are available to iteratively group cells together while optimizing the standard modularity function.</p>\n\n<p>Currently, the Louvain graph-clustering method (community detection based on optimizing modularity) is the one recommended. We need to define a value for the resolution parameter, i.e. the ‘granularity’ of the downstream clustering. High values lead to a greater number of clusters. For single-cell datasets of around 3K cells, we recommend to use a value between 0.4 and 1.2. For larger datasets, the optimal resolution will be higher.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Cluster the neighborhood graph</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_cluster_reduce_dimension/scanpy_cluster_reduce_dimension/1.9.6+galaxy1\" title=\"Cluster, infer trajectories and embed with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster, infer trajectories and embed with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Cluster cells into subgroups, using 'tl.louvain'</code>\n          <ul>\n            <li><em>“Flavor for the clustering”</em>: <code class=\"language-plaintext highlighter-rouge\">vtraag (much more powerful)</code>\n              <ul>\n                <li><em>“Resolution”</em>: <code class=\"language-plaintext highlighter-rouge\">0.45</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How is the clustering information stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>An extra column <code class=\"language-plaintext highlighter-rouge\">louvain</code> has been added to the <code class=\"language-plaintext highlighter-rouge\">obs</code> object with the cluster id for each cell.</p>\n\n          <p>This information can be accessed using:</p>\n          <ol>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Generalinformation about the object</code></li>\n              </ul>\n            </li>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed observations annotation (obs)</code></li>\n              </ul>\n            </li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<p>The cells in the same clusters should be co-localized in the UMAP coordinate plots.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot the neighborhood graph and the clusters</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Embeddings: Scatter plot in UMAP basis, using 'pl.umap'</code>\n          <ul>\n            <li><em>“Keys for annotations of observations/cells or variables/genes”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain, CST3, NKG7, PPBP</code></li>\n            <li>In <em>“Plot attributes”</em>\n              <ul>\n                <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/umap_after_clustering.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/umap_after_clustering.png\" alt=\"UMAP coordinates after clustering. \" width=\"1158\" height=\"847\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many clusters have been identified? Do they fit with the ones quickly identified with UMAP plots?</li>\n    <li>In which clusters do you expected to have CST3, NKG7 and PPBP as representative?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>8 clusters are identified, more or less corresponding to the ones we could see on the UMAP plots.</li>\n      <li>We expect that:\n        <ul>\n          <li>CST3 should be representative of clusters 1, 3, 4, 6</li>\n          <li>NKG7 for clusters 0, 3 and 5</li>\n          <li>PPBP for cluster 7</li>\n        </ul>\n      </li>\n    </ol>\n  </blockquote>\n</blockquote>\n\n<h1 id=\"finding-marker-genes\">Finding marker genes</h1>\n\n<p>To give sense to the clusters, we need to identify the genes that drive separation between clusters. These marker genes can then be used to assign biological sense (e.g. cell type) to each cluster based on their functional annotation, but also to identify subtle differences between clusters (e.g., changes in activation or differentiation state) based on the behaviour of genes in the affected pathways.</p>\n\n<p>Marker genes are usually detected by their differential expression between clusters, as the more strongly DE genes are more likely to have caused separate clustering of cells. To quantify the differences in expression profiles, several different statistical tests can be used.</p>\n\n<p>The identification of the marker genes for each cluster is made not only on the highly variable genes, but on the whole set (currently stored in the <code class=\"language-plaintext highlighter-rouge\">raw</code> attribute).</p>\n\n<h2 id=\"using-the-t-test\">Using the <em>t</em>-test</h2>\n\n<p>The simplest and fastest method is the Welch <em>t</em>-test. It has good statistical properties for large numbers of cells (<span class=\"citation\"><a href=\"#soneson2018bias\">Soneson and Robinson 2018</a></span>).</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Rank the highly differential genes using t-test</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank genes for characterizing groups, using 'tl.rank_genes_groups'</code>\n          <ul>\n            <li><em>“The key of the observations grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Comparison”</em>: <code class=\"language-plaintext highlighter-rouge\">Compare each group to the union of the rest of the group</code></li>\n            <li><em>“The number of genes that appear in the returned tables”</em>: <code class=\"language-plaintext highlighter-rouge\">100</code></li>\n            <li><em>“Method”</em>: <code class=\"language-plaintext highlighter-rouge\">t-test</code>\n              <ul>\n                <li><em>“P-value correction method”</em>: <code class=\"language-plaintext highlighter-rouge\">Benjamini-Hochberg</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with t-test</code></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How is the marker gene information stored in the <code class=\"language-plaintext highlighter-rouge\">AnnData</code> object?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>An extra object <code class=\"language-plaintext highlighter-rouge\">rank_genes_groups</code> has been added to the <code class=\"language-plaintext highlighter-rouge\">uns</code> object with 5 tables for the 100 top ranked genes (rows) for each cluster (column):</p>\n\n          <ul>\n            <li>Names of the rank genes</li>\n            <li>Z-scores for the rank genes</li>\n            <li>Log2 Fold changes</li>\n            <li>P-values</li>\n            <li>Adjusted p-values</li>\n          </ul>\n\n          <p>This information can be accessed using:</p>\n          <ol>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with t-test</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Generalinformation about the object</code></li>\n              </ul>\n            </li>\n            <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n              <ul>\n                <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with t-test</code></li>\n                <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Unstructured annotation (uns)</code>\n                  <ul>\n                    <li><em>“What to inspect in uns?”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank gene groups (rank_genes_groups)</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with t-test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Marker genes: Plot ranking of genes using dotplot plot, using 'pl.rank_genes_groups'</code>\n          <ul>\n            <li><em>“Number of genes to show”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n            <li><em>“Should the y-axis of each panels be shared?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with t-test</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Unstructured annotation (uns)</code>\n          <ul>\n            <li><em>“What to inspect in uns?”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank gene groups (rank_genes_groups)</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Inspect the <code class=\"language-plaintext highlighter-rouge\">Names for rank genes</code> file</li>\n  </ol>\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_t-test.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_t-test.png\" alt=\"Rank genes with t-test. \" width=\"1555\" height=\"1192\" loading=\"lazy\" /></a></p>\n\n<p>We can quickly look at the 5 top ranked genes per cluster:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>0</th>\n      <th>1</th>\n      <th>2</th>\n      <th>3</th>\n      <th>4</th>\n      <th>5</th>\n      <th>6</th>\n      <th>7</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>LDHB</td>\n      <td>LYZ</td>\n      <td>CD74</td>\n      <td>CCL5</td>\n      <td>LST1</td>\n      <td>NKG7</td>\n      <td>CD74</td>\n      <td>GPX1</td>\n    </tr>\n    <tr>\n      <td>CD3D</td>\n      <td>FTL</td>\n      <td>HLA-DRA</td>\n      <td>NKG7</td>\n      <td>AIF1</td>\n      <td>GZMB</td>\n      <td>HLA-DRA</td>\n      <td>PF4</td>\n    </tr>\n    <tr>\n      <td>RPS12</td>\n      <td>TYROBP</td>\n      <td>HLA-DPB1</td>\n      <td>B2M</td>\n      <td>FCER1G</td>\n      <td>PRF1</td>\n      <td>CST3</td>\n      <td>PPBP</td>\n    </tr>\n    <tr>\n      <td>RPS27</td>\n      <td>CST3</td>\n      <td>CD79A</td>\n      <td>IL32</td>\n      <td>FTL</td>\n      <td>CTSW</td>\n      <td>HLA-DPA1</td>\n      <td>CALM3</td>\n    </tr>\n    <tr>\n      <td>RPS25</td>\n      <td>S100A9</td>\n      <td>HLA-DRB1</td>\n      <td>CST7</td>\n      <td>FTH1</td>\n      <td>GNLY</td>\n      <td>HLA-DRB1</td>\n      <td>NRGN</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>Are CST3, NKG7 and PPBP in the set of marker genes? If yes, are they assigned to the clusters we guessed before?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ul>\n      <li>CST3 is a marker gene for clusters 1, 4, 6 (not 3 as guessed previously)</li>\n      <li>NKG7 for clusters 3 and 5 (not 0 as guessed previously)</li>\n      <li>PPBP for cluster 7, as guessed previously</li>\n    </ul>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"using-wilcoxon-rank-sum-test\">Using Wilcoxon rank sum test</h2>\n\n<p>Another widely used method for pairwise comparisons between groups of observations is the Wilcoxon rank sum test (also known as the Wilcoxon-Mann-Whitney test). This test directly assesses separation between the expression distributions of different clusters. It is the recommended approach to use in publication (<span class=\"citation\"><a href=\"#soneson2018bias\">Soneson and Robinson 2018</a></span>).</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Rank the highly differential genes using Wilcoxon rank sum</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li>\n          <p><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering</code></p>\n\n          <p><small><strong>Note:</strong> <em>Please pay attention to the dataset name.</em></small></p>\n        </li>\n        <li>\n          <p><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank genes for characterizing groups, using 'tl.rank_genes_groups'</code></p>\n          <ul>\n            <li><em>“The key of the observations grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Comparison”</em>: <code class=\"language-plaintext highlighter-rouge\">Compare each group to the union of the rest of the group</code></li>\n            <li><em>“The number of genes that appear in the returned tables”</em>: <code class=\"language-plaintext highlighter-rouge\">100</code></li>\n            <li><em>“Method”</em>: <code class=\"language-plaintext highlighter-rouge\">Wilcoxon-Rank-Sum</code>\n              <ul>\n                <li><em>“P-value correction method”</em>: <code class=\"language-plaintext highlighter-rouge\">Benjamini-Hochberg</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Marker genes: Plot ranking of genes using dotplot plot, using 'pl.rank_genes_groups'</code>\n          <ul>\n            <li><em>“Number of genes to show”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n            <li><em>“Should the y-axis of each panels be shared?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Unstructured annotation (uns)</code>\n          <ul>\n            <li><em>“What to inspect in uns?”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank gene groups (rank_genes_groups)</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>Rename the <code class=\"language-plaintext highlighter-rouge\">Names for rank genes</code> file to <code class=\"language-plaintext highlighter-rouge\">Ranked genes with Wilcoxon test</code></li>\n    <li>Inspect <code class=\"language-plaintext highlighter-rouge\">Ranked genes with Wilcoxon test</code> file</li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_wilcoxon.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_wilcoxon.png\" alt=\"Rank genes with Wilcoxon. \" width=\"1559\" height=\"1192\" loading=\"lazy\" /></a></p>\n\n<p>We can quickly look at the 5 top ranked genes per cluster:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>0</th>\n      <th>1</th>\n      <th>2</th>\n      <th>3</th>\n      <th>4</th>\n      <th>5</th>\n      <th>6</th>\n      <th>7</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>LDHB</td>\n      <td>LYZ</td>\n      <td>CD74</td>\n      <td>CCL5</td>\n      <td>LST1</td>\n      <td>NKG7</td>\n      <td>HLA-DPA1</td>\n      <td>PF4</td>\n    </tr>\n    <tr>\n      <td>RPS12</td>\n      <td>S100A9</td>\n      <td>CD79A</td>\n      <td>NKG7</td>\n      <td>FCER1G</td>\n      <td>GZMB</td>\n      <td>HLA-DPB1</td>\n      <td>GNG11</td>\n    </tr>\n    <tr>\n      <td>RPS25</td>\n      <td>S100A8</td>\n      <td>HLA-DRA</td>\n      <td>CST7</td>\n      <td>AIF1</td>\n      <td>PRF1</td>\n      <td>HLA-DRB1</td>\n      <td>SDPR</td>\n    </tr>\n    <tr>\n      <td>RPS27</td>\n      <td>TYROBP</td>\n      <td>CD79B</td>\n      <td>CTSW</td>\n      <td>COTL1</td>\n      <td>GNLY</td>\n      <td>HLA-DRA</td>\n      <td>PPBP</td>\n    </tr>\n    <tr>\n      <td>RPS6</td>\n      <td>FTL</td>\n      <td>HLA-DPB1</td>\n      <td>B2M</td>\n      <td>FCGR3A</td>\n      <td>CTSW</td>\n      <td>CD74</td>\n      <td>NRGN</td>\n    </tr>\n    <tr>\n      <td>RPS3</td>\n      <td>CST3</td>\n      <td>HLA-DQA1</td>\n      <td>GZMA</td>\n      <td>IFITM2</td>\n      <td>GZMA</td>\n      <td>CST3</td>\n      <td>SPARC</td>\n    </tr>\n    <tr>\n      <td>CD3D</td>\n      <td>FCN1</td>\n      <td>MS4A1</td>\n      <td>HLA-C</td>\n      <td>FTH1</td>\n      <td>CST7</td>\n      <td>HLA-DQA1</td>\n      <td>GPX1</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n  <ol>\n    <li>Are the 5 top ranked genes different than the one for the <em>t</em>-test?</li>\n    <li>Are CST3, NKG7 and PPBP in the marker genes? If yes, are they assigned to the clusters we guessed before?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>The 5 top ranked genes are slightly different, at least in their order.</li>\n      <li>We see that:\n        <ul>\n          <li>CST3 is a ranked genes for clusters 1, 4, 6 (not 3 as guessed previously)</li>\n          <li>NKG7 for clusters 3 and 5 (not 0 as guessed previously)</li>\n          <li>PPBP for cluster 7, as we guessed previously.</li>\n        </ul>\n      </li>\n    </ol>\n\n  </blockquote>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Compare differential expression for CST3, NKG7 and PPBP in the different clusters</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Violin plot, using 'pl.violin'</code>\n          <ul>\n            <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">Subset of variables in 'adata.var_names' or fields in '.obs'</code>\n              <ul>\n                <li><em>“Keys for accessing variables”</em>: <code class=\"language-plaintext highlighter-rouge\">CST3, NKG7, PPBP</code></li>\n              </ul>\n            </li>\n            <li><em>“The key of the observation grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/violin_plot_rank_genes_groups_CST3_NKG7_PPBP.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/violin_plot_rank_genes_groups_CST3_NKG7_PPBP.png\" alt=\"Violin plot for CST3, NKG7 and PPBP after clustering. \" width=\"2009\" height=\"413\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n  <p>Are CST3, NKG7 and PPBP more expressed in the clusters for which they are marker genes?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ul>\n      <li>CST3 is more expressed in clusters 1, 4, 6, the ones for which it was previously found as a marker gene, but also in cluster 7, which is unexpected.</li>\n      <li>NKG7 is more expressed in clusters 3 and 5, the ones for which it was previously found as a marker gene.</li>\n      <li>PPBP is very pronounced in cluster 7, for which it was previously found as a marker gene.</li>\n    </ul>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"visualization-of-expression-of-the-marker-genes\">Visualization of expression of the marker genes</h2>\n\n<p>The marker genes should be more expressed in the clusters for which they are markers. We would like to confirm this idea using some visualization.</p>\n\n<h3 id=\"expression-of-the-top-marker-genes-in-each-cluster\">Expression of the top marker genes in each cluster</h3>\n\n<p>The assumption should be even more true for the top marker genes. The first way to visualize the expression of the top marker genes is to look at the distribution of the expression of each marker gene in cells for each cluster.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot expression probability distributions across clusters of top marker genes</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Stacked violin plot, using 'pl.stacked_violin'</code>\n          <ul>\n            <li><em>“Variables to plot (columns of the heatmaps)”</em>: <code class=\"language-plaintext highlighter-rouge\">Subset of variables in 'adata.var_names'</code>\n              <ul>\n                <li><em>“List of variables to plot”</em>: <code class=\"language-plaintext highlighter-rouge\">LDHB, LYZ, CD74, CCL5, LST1, NKG7, HLA-DPA1, PF4</code></li>\n              </ul>\n            </li>\n            <li><em>“The key of the observation grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Number of categories”</em>: <code class=\"language-plaintext highlighter-rouge\">8</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Custom figure size</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Swap axes?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li>In <em>“Violin plot attributes”</em>:\n              <ul>\n                <li><em>“Add a stripplot on top of the violin plot”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/violin_plot_marker_genes.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/violin_plot_marker_genes.png\" alt=\"Violin plot for top marker genes. \" width=\"723\" height=\"812\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n  <p>Are the top marker genes only expressed in the cluster for which they are markers?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ul>\n      <li>\n        <p>LDHB, LYZ and CD74, even if they are top markers genes for the cluster 0, 1, 2 respectively, are also expressed in all other clusters (and also found in the top 100 marker genes for other clusters), but with higher level in the cluster for they are markers.</p>\n      </li>\n      <li>\n        <p>CCL5, LST1, NKG7 and HLA-DPA1 are not expressed in all clusters but also not only in the one they are markers.</p>\n      </li>\n      <li>\n        <p>PF4 is only expressed in cluster 7.</p>\n      </li>\n    </ul>\n\n  </blockquote>\n</blockquote>\n\n<p>Another approach consists of displaying the mean expression of the marker genes for the cells on the neighborhood graph.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot top marker gene expression on an UMAP plot</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Embeddings: Scatter plot in UMAP basis, using 'pl.umap'</code>\n          <ul>\n            <li><em>“Keys for annotations of observations/cells or variables/genes”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain, LDHB, LYZ, CD74, CCL5, LST1, NKG7, HLA-DPA1, PF4</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li>In <em>“Plot attributes”</em>\n              <ul>\n                <li><em>“Number of panels per row”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/umap_plot_marker_genes.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/umap_plot_marker_genes.png\" alt=\"Top marker gene expression on a UMAP plot. \" width=\"1146\" height=\"2099\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n  <p>Are the top marker genes clearly associated to their clusters?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>For most genes, we can clearly see for which cluster they are marker genes. But for physically close clusters, the differences are not so obvious.</p>\n\n  </blockquote>\n</blockquote>\n\n<h3 id=\"expression-of-the-top-20-markers-genes-in-cells-for-each-cluster\">Expression of the top 20 markers genes in cells for each cluster</h3>\n\n<p>We would like now to have a look at the expression of the top 20 marker genes in the different cells for each cluster</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot heatmap of the gene expression in cells</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Marker genes: Plot ranking of genes as heatmap plot, using 'pl.rank_genes_groups_heatmap'</code>\n          <ul>\n            <li><em>“Number of genes to show”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Compute and plot a dendrogram?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/plot_rank_genes_groups_heatmap.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/plot_rank_genes_groups_heatmap.png\" alt=\"Heatmap of the gene expression in cells. \" width=\"788\" height=\"505\" loading=\"lazy\" /></a></p>\n\n<p>Each cells is shown in a row and in columns are the marker genes for each cluster.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n  <p>How are clusters close to each other in terms of expression of the top 20 marker genes?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ul>\n      <li>\n        <p>Clusters 0, 3, and 5 are similar in term of expression. This was expected as they are physically close on the neighborhood graph.</p>\n      </li>\n      <li>\n        <p>Clusters 1 and 4 are together and then 2 and 6 are together after 7. These observations are less expected given the neighborhood graph: 1 and 4 are physically close, but 2 is far from 7 and 6.</p>\n      </li>\n    </ul>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"comparison-of-the-marker-genes-between-clusters\">Comparison of the marker genes between clusters</h2>\n\n<p>Previously we identified marker genes by taking gene expression in cells for each cluster individually and comparing them to all remaining cells.</p>\n\n<p>In some cases, it may also be interesting to find marker genes distinguishing one given cluster from one or several clusters. For example, the marker genes distinguishing cluster 0 from cluster 1.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Identify the marker genes distinguishing cluster 0 from cluster 1 using Wilcoxon rank sum</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1\" title=\"Inspect and Manipulate with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect and Manipulate with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></li>\n        <li><em>“Method used for inspecting”</em>: <code class=\"language-plaintext highlighter-rouge\">Rank genes for characterizing groups, using 'tl.rank_genes_groups'</code>\n          <ul>\n            <li><em>“The key of the observations grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Subset of groups to which comparison shall be restricted”</em>: <code class=\"language-plaintext highlighter-rouge\">0</code></li>\n            <li><em>“Comparison”</em>: <code class=\"language-plaintext highlighter-rouge\">Compare with respect to a specific group</code>\n              <ul>\n                <li><em>“Group identifier with respect to which compare”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n              </ul>\n            </li>\n            <li><em>“The number of genes that appear in the returned tables”</em>: <code class=\"language-plaintext highlighter-rouge\">100</code></li>\n            <li><em>“Method”</em>: <code class=\"language-plaintext highlighter-rouge\">Wilcoxon-Rank-Sum</code>\n              <ul>\n                <li><em>“P-value correction method”</em>: <code class=\"language-plaintext highlighter-rouge\">Benjamini-Hochberg</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes for 0 vs 1 with Wilcoxon test</code></p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes for 0 vs 1 with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Marker genes: Plot ranking of genes using dotplot plot, using 'pl.rank_genes_groups'</code>\n          <ul>\n            <li><em>“Number of genes to show”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Should the y-axis of each panels be shared?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_wilcoxon_0_vs_1.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_wilcoxon_0_vs_1.png\" alt=\"Rank genes 0 vs 1 with Wilcoxon. \" width=\"563\" height=\"453\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>How can we interpret this plot?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>In this graph are the marker genes distinguishing cluster 0 from cluster 1, ranked based on their difference of expression of the genes between cells in both clusters. So MALAT1 is the most differentially expressed gene between cells in cluster 0 and cells in cluster 1, even though it was not in the set of  top marker genes for cluster 0.</p>\n\n  </blockquote>\n</blockquote>\n\n<p>The marker genes distinguishing cluster 0 from cluster 1 are extracted based on their differences in expression, which can be easily visualized.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot expression difference for the marker genes distinguishing cluster 0 from cluster 1</hands-on-title>\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes for 0 vs 1 with Wilcoxon test</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Marker genes: Plot ranking of genes as violin plot, using 'pl.rank_genes_groups_violin'</code>\n          <ul>\n            <li><em>“Which genes to plot?”</em>: <code class=\"language-plaintext highlighter-rouge\">A number of genes</code>\n              <ul>\n                <li><em>“Number of genes to show”</em>: <code class=\"language-plaintext highlighter-rouge\">10</code></li>\n              </ul>\n            </li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_violin_wilcoxon_0_vs_1.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/rank_genes_groups_violin_wilcoxon_0_vs_1.png\" alt=\"Violin plot for marker genes for clusters 0 vs 1 with Wilcoxon. \" width=\"554\" height=\"494\" loading=\"lazy\" /></a></p>\n\n<p>Previous visualizations like the heatmap can also be used to represent the differential expression of the marker genes between both clusters.</p>\n\n<p>In the next steps, we are mostly interested in the marker genes for each cluster individually by comparison one cluster to the rest, instead of a 1-to-1 comparison. So we will use again the AnnData object called <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code>.</p>\n\n<h1 id=\"cell-type-annotation\">Cell type annotation</h1>\n\n<p>Obtaining clusters of cells is quite straightforward. Determining what biological state is represented by each of those clusters is likely the most challenging task in scRNA-Seq data analysis. To do so, we need to bridge the gap between our current dataset and prior biological knowledge.</p>\n\n<p>This biological knowledge is not always available in a consistent and quantitative manner. For example, the concept of “cell type” is not clearly defined. The interpretation of scRNA-seq data is often then quite manual.</p>\n\n<p>Fortunately in the case of our dataset, we can use canonical markers to known cell types:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Cell type</th>\n      <th>Marker genes</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>CD4+ T cells</td>\n      <td>IL7R, CCR7</td>\n    </tr>\n    <tr>\n      <td>CD8+ T cells</td>\n      <td>CD8A</td>\n    </tr>\n    <tr>\n      <td>CD14+ Monocytes</td>\n      <td>CD14, LYZ</td>\n    </tr>\n    <tr>\n      <td>B cells</td>\n      <td>MS4A1, CD79A</td>\n    </tr>\n    <tr>\n      <td>Natural killer (NK) cells</td>\n      <td>GNLY, NKG7, KLRB1</td>\n    </tr>\n    <tr>\n      <td>Dendritic Cells</td>\n      <td>FCER1A, CST3</td>\n    </tr>\n    <tr>\n      <td>Megakaryocytes</td>\n      <td>PPBP</td>\n    </tr>\n    <tr>\n      <td>FCGR3A+ Monocytes</td>\n      <td>FCGR3A, MS4A7</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"tip\">\n  <tip-title>How to find canonical markers?</tip-title>\n\n  <p>Canonical markers are usually found in the literature and are also aggregated into dedicated database like the <a href=\"https://panglaodb.se/markers.html\">PanglaoDB</a> <span class=\"citation\"><a href=\"#franzen2019panglaodb\">Franzén <i>et al.</i> 2019</a></span></p>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>Is it possible to match the clusters to cell types using the previous table?</p>\n\n  <p><em>Hint</em>: search for the marker genes in the table in the <code class=\"language-plaintext highlighter-rouge\">Ranked genes with Wilcoxon test</code> dataset</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>By searching the marker genes in the the <code class=\"language-plaintext highlighter-rouge\">Ranked genes with Wilcoxon test</code> dataset:</p>\n\n    <table>\n      <thead>\n        <tr>\n          <th>Marker genes</th>\n          <th>Cell type</th>\n          <th>Cluster</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr>\n          <td>IL7R</td>\n          <td>CD4+ T cells</td>\n          <td>0</td>\n        </tr>\n        <tr>\n          <td>CCR7</td>\n          <td>CD4+ T cells</td>\n          <td>0</td>\n        </tr>\n        <tr>\n          <td>CD8A</td>\n          <td>CD8+ T cells</td>\n          <td>3</td>\n        </tr>\n        <tr>\n          <td>CD14</td>\n          <td>CD14+ Monocytes</td>\n          <td>1</td>\n        </tr>\n        <tr>\n          <td>LYZ</td>\n          <td>CD14+ Monocytes</td>\n          <td>1 (6)</td>\n        </tr>\n        <tr>\n          <td>MS4A1</td>\n          <td>B cells</td>\n          <td>2</td>\n        </tr>\n        <tr>\n          <td>CD79A</td>\n          <td>B cells</td>\n          <td>2</td>\n        </tr>\n        <tr>\n          <td>GNLY</td>\n          <td>Natural killer (NK) cells</td>\n          <td>5</td>\n        </tr>\n        <tr>\n          <td>NKG7</td>\n          <td>Natural killer (NK) cells</td>\n          <td>5 (3)</td>\n        </tr>\n        <tr>\n          <td>KLRB1</td>\n          <td>Natural killer (NK) cells</td>\n          <td>-</td>\n        </tr>\n        <tr>\n          <td>FCER1A</td>\n          <td>Dendritic cells</td>\n          <td>6</td>\n        </tr>\n        <tr>\n          <td>CST3</td>\n          <td>Dendritic cells</td>\n          <td>6 (4)</td>\n        </tr>\n        <tr>\n          <td>PPBP</td>\n          <td>Megakaryocytes</td>\n          <td>7</td>\n        </tr>\n        <tr>\n          <td>FCGR3A</td>\n          <td>FCGR3A+ Monocytes</td>\n          <td>4 (5)</td>\n        </tr>\n      </tbody>\n    </table>\n\n    <p>We can then aggregate the results by clusters</p>\n\n    <table>\n      <thead>\n        <tr>\n          <th>Cell type</th>\n          <th>Marker genes</th>\n          <th>Cluster</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr>\n          <td>CD4+ T cells</td>\n          <td>IL7R, CCR7</td>\n          <td>0</td>\n        </tr>\n        <tr>\n          <td>CD8+ T cells</td>\n          <td>CD8A</td>\n          <td>3</td>\n        </tr>\n        <tr>\n          <td>CD14+ Monocytes</td>\n          <td>CD14, LYZ</td>\n          <td>1</td>\n        </tr>\n        <tr>\n          <td>B cells</td>\n          <td>MS4A1, CD79A</td>\n          <td>2</td>\n        </tr>\n        <tr>\n          <td>Natural killer (NK) cells</td>\n          <td>GNLY, NKG7, KLRB1</td>\n          <td>5</td>\n        </tr>\n        <tr>\n          <td>Dendritic Cells</td>\n          <td>FCER1A, CST3</td>\n          <td>6</td>\n        </tr>\n        <tr>\n          <td>Megakaryocytes</td>\n          <td>PPBP</td>\n          <td>7</td>\n        </tr>\n        <tr>\n          <td>FCGR3A+ Monocytes</td>\n          <td>FCGR3A, MS4A7</td>\n          <td>4</td>\n        </tr>\n      </tbody>\n    </table>\n\n  </blockquote>\n</blockquote>\n\n<p>These canonical marker genes can be easily match the clusters to known cell types:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Cluster</th>\n      <th>Cell type</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>0</td>\n      <td>CD4+ T cells</td>\n    </tr>\n    <tr>\n      <td>1</td>\n      <td>CD14+ Monocytes</td>\n    </tr>\n    <tr>\n      <td>2</td>\n      <td>B cells</td>\n    </tr>\n    <tr>\n      <td>3</td>\n      <td>CD8+ T cells</td>\n    </tr>\n    <tr>\n      <td>4</td>\n      <td>FCGR3A+ Monocytes</td>\n    </tr>\n    <tr>\n      <td>5</td>\n      <td>Natural killer (NK) cells</td>\n    </tr>\n    <tr>\n      <td>6</td>\n      <td>Dendritic Cells</td>\n    </tr>\n    <tr>\n      <td>7</td>\n      <td>Megakaryocytes</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Add the cell type as cluster names</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0\" title=\"Manipulate Anndata tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Manipulate Anndata</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:\n      <ul>\n        <li>\n          <p><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test</code></p>\n\n          <p><small><strong>Note</strong>: <em>Take note that this is not the “0 vs 1 Wilcoxon” dataset</em></small></p>\n        </li>\n        <li>\n          <p><em>“Function to manipulate the object”</em>: <code class=\"language-plaintext highlighter-rouge\">Rename categories of annotation</code></p>\n          <ul>\n            <li><em>“Key for observations or variables annotation”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Comma-separated list of new categories”</em>: <code class=\"language-plaintext highlighter-rouge\">CD4+ T, CD14+, B, CD8+ T, FCGR3A+, NK, Dendritic, Megakaryocytes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Rename the generated output <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test, annotation</code></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How can we check that the cell type has been correctly added?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The cluster information is available in the <code class=\"language-plaintext highlighter-rouge\">obs</code> attribute of the AnnData object. So to check, we should run <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0\" title=\"Inspect AnnData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Inspect AnnData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.10.3+galaxy0)</span> with the following parameters:</p>\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA and KNN graph</code></li>\n            <li><em>“What to inspect?”</em>: <code class=\"language-plaintext highlighter-rouge\">Key-indexed observations annotation (obs)</code></li>\n          </ul>\n\n          <p>In the last column (called <code class=\"language-plaintext highlighter-rouge\">louvain</code>), we should now have cell type.</p>\n        </blockquote>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test, annotation</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Embeddings: Scatter plot in UMAP basis, using 'pl.umap'</code>\n          <ul>\n            <li><em>“Keys for annotations of observations/cells or variables/genes”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li>In <em>“Plot attributes”</em>\n              <ul>\n                <li><em>“Location of legend”</em>: <code class=\"language-plaintext highlighter-rouge\">on data</code></li>\n                <li><em>“Draw a frame around the scatter plot?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/umap_annotated_clusters.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/umap_annotated_clusters.png\" alt=\"UMAP plot with annotated clusters. \" width=\"515\" height=\"409\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>How well are the cell types clustered in the neighborhood graph?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>T cells (CD4+ and CD8+) are clustered together with NK cells. Monocytes cells (CD14+ and FCGR3A+) are close to each others, with Dendritic and Megakaryocytes. B cells are physically independent.</p>\n\n  </blockquote>\n</blockquote>\n\n<p>With the annotated cell types, we can also visualize the expression of their canonical marker genes.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Plot expression of canonical marker genes for the annotated cell types</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1\" title=\"Plot with scanpy tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Plot with scanpy</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.9.6+galaxy1)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Annotated data matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">3k PBMC with only HVG, after scaling, PCA, KNN graph, UMAP, clustering, marker genes with Wilcoxon test, annotation</code></li>\n        <li><em>“Method used for plotting”</em>: <code class=\"language-plaintext highlighter-rouge\">Generic: Makes a dot plot of the expression values, using 'pl.dotplot'</code>\n          <ul>\n            <li><em>“Variables to plot (columns of the heatmaps)”</em>: <code class=\"language-plaintext highlighter-rouge\">Subset of variables in 'adata.var_names'</code>\n              <ul>\n                <li><em>“List of variables to plot”</em>: <code class=\"language-plaintext highlighter-rouge\">IL7R, CCR7, CD8A, CD14, LYZ, MS4A1, CD79A, GNLY, NKG7, KLRB1, FCER1A, CST3, PPBP, FCGR3A</code></li>\n              </ul>\n            </li>\n            <li><em>“The key of the observation grouping to consider”</em>: <code class=\"language-plaintext highlighter-rouge\">louvain</code></li>\n            <li><em>“Number of categories”</em>: <code class=\"language-plaintext highlighter-rouge\">8</code></li>\n            <li><em>“Use ‘raw’ attribute of input if present”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Compute and plot a dendrogram?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li>In <em>“Group of variables to highlight”</em>\n              <ul>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“1: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">0</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">CD4+ T</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“2: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">CD8+</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“3: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">4</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">CD14+</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“4: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">6</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">B</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“5: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">7</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">9</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">NK</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“6: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">10</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">11</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">Dendritic</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“7: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">12</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">12</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">Megakaryocytes</code></li>\n                  </ul>\n                </li>\n                <li>Click on <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“Group of variables to highlight”</em></li>\n                <li>In <em>“8: Group of variables to highlight”</em>\n                  <ul>\n                    <li><em>“Start”</em>: <code class=\"language-plaintext highlighter-rouge\">13</code></li>\n                    <li><em>“End”</em>: <code class=\"language-plaintext highlighter-rouge\">13</code></li>\n                    <li><em>“Label”</em>: <code class=\"language-plaintext highlighter-rouge\">FCGR3A+</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><a href=\"../../images/scrna-scanpy-pbmc3k/dotplot_annotated_clusters.png\" rel=\"noopener noreferrer\"><img src=\"../../images/scrna-scanpy-pbmc3k/dotplot_annotated_clusters.png\" alt=\"Dotplot plot with annotated clusters. \" width=\"704\" height=\"421\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>Are the canonical marker genes only expressed in their cell type?</li>\n    <li>Are the previous physical cluster (UMAP graph) confirmed?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>Some canonical marker genes like LYZ or CST3 are not only highly expressed in their cell type but also on closely related other cell types.</li>\n      <li>As seen on the UMAP graph, T cells (CD4+ and CD8+) are clustered together with NK cells, but NK cells and CD8+ closer to each other. Monocytes cells (CD14+ and FCGR3A+) are close to each others, but B cells are close to Dendritic and then Megakaryocytes despite B cells being physically independent on the neighborhood graph.</li>\n    </ol>\n\n  </blockquote>\n</blockquote>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n<p><i class=\"far fa-thumbs-up\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">congratulations</span> Well done, you’ve made it to the end! You might want to consult your results with this <a href=\"https://singlecell.usegalaxy.eu/u/videmp/h/clustering-3k-pbmcs-with-scanpy-196\">control history</a>, or check out the <a href=\"https://singlecell.usegalaxy.eu/u/videmp/w/clustering-3k-pbmc-with-scanpy\">full workflow</a> for this tutorial.</p>\n\n<p>In this tutorial, we investigated clustering and annotation of single-cell data from 10x Genomics using Scanpy. This workflow used here was typical for scRNA-seq data analysis:</p>\n\n<ol>\n  <li>Preprocessing with\n    <ol>\n      <li>Selection and filtration of cells and genes based on quality metrics</li>\n      <li>Data normalization and scaling</li>\n      <li>Selection of features, i.e. marker genes</li>\n    </ol>\n  </li>\n  <li>Reduction of the dimensionality via a Principal Component Analysis</li>\n  <li>Clustering of the cells by\n    <ol>\n      <li>Computation of a neighborhood graph</li>\n      <li>Clustering of the neighborhood graph into 8 clusters of cells</li>\n    </ol>\n  </li>\n  <li>Identification of marker genes for the clusters</li>\n  <li>Annotation of the clusters with cell types</li>\n</ol>\n\n<p>This tutorial is part of the https://singlecell.usegalaxy.eu portal (<span class=\"citation\"><a href=\"#tekman2020single\">Tekman <i>et al.</i> 2020</a></span>).</p>\n"],"ref_slides":["### Single Cell RNA Pre-processing\n\n![fig01](../../images/scrna-scanpy-pbmc3k/scrna_preproc.svg)\n\n???\n1. Barcode Extraction\n1. Mapping\n1. Gene Annotation\n1. Batch count matrices\n\n\n---\n\n### Single Cell RNA Downstream Analysis\n\n![fig10](../../images/scrna-scanpy-pbmc3k/scrna_downstream.svg)\n\n???\n1. Filtering\n1. Normalising\n   * Confounder Removal\n1. Dimension Reduction\n1. Clustering\n   * Annotation\n\n\n---\n\n### Barcoding Cells\n\n![fig1](../../images/scrna-intro/scrna_pbb_barcodes_add.svg)\n\n---\n\n### Filtering: Cell and Gene\n\n![fig2](../../images/scrna-raceid/libsize.svg)\n\n---\n\n### Normalisation: Technical Variation\n\n![fig3](../../images/scrna-raceid/technical_variation.svg)\n\n---\n\n### Normalisation: Biological Variation\n\n\n![fig4](../../images/scrna-raceid/cellcycle.svg)\n\n---\n\n### Dimension Reduction: Relatedness of Cells\n\n![fig5](../../images/scrna-intro/scrna_knn.svg)\n\n\n???\nBuild a KNN graph from distance matrix:\n  * If P and q share distance which is\n\n---\n\n### Dimension Reduction: Projection\n\n![fig6](../../images/scrna-raceid/dimred.svg)\n\n???\n- Can use tSNE, PCA, UMAP\n\n---\n\n### Community Clustering: Louvain\n\nAim: Maximise internal links and minimise external links\n\n![fig7](../../images/scrna-intro/commgraph1.svg)\n\n\n---\n\n### Community Clustering: Louvain\n\nPick a cell, place in neighbour, and accept if *internal:external* increases\n\n\n![fig8](../../images/scrna-intro/commgraph2.svg)\n\n\n---\n\n### Cell Type: Identifying Cluster Types\n\n.left-column50[.image-100[![fig9](../../images/scrna-scanpy-pbmc3k/singlecellplot3.png)]]\n.left-column50[.image-100[![fig10](../../images/scrna-scanpy-pbmc3k/singlecellplot4.png)]]\n\n---\n\n### Clustering: Hard vs Soft\n\n.pull-left[\n\n<br />\n\n.image-100[![fig11](../../images/scrna-scanpy-pbmc3k/singlecellplot3.png)]\n\n*Hard*\n  * Big spaces between clusters\n  * Cell types are well defined and the clustering reflects that\n\n]\n\n--\n\n.pull-right[\n.image-100[![fig12](../../images/scrna-intro/10xdata.png)]\n\n*Soft*\n  * Clusters bleed into one another\n  * Cell types seem to intermingle with one another.\n\n]\n\n???\nWhy? Why would there be clusters so close to one another?\n\n---\n\n### Continuous Phenotypes:\n\n.image-100[![fig13](../../images/scrna-raceid/contpheno.svg)]\n\n???\n* Cells aren't discrete, they transition\n\n* Continuously changing over time from a less mature type to more mature type\n\n\n---\n\n### Interactive Environments: live.usegalaxy.eu\n\n<br/>\n\n<video style=\"width:100%;height:auto;\" controls>\n    <source src=\"https://zenodo.org/record/3687100/files/live_cellxgene.mp4\" />\n</video>\n\n???\nWhat is Differential Expression in scRNA-seq?\n\n---\n\n### CellxGene Local Test\n\n* We can probe clusters to see how they are so differentially expressed\n\n        pip3 install cellxgene\n        cellxgene launch https://cellxgene-example-data.czi.technology/pbmc3k.h5ad\n\n* Launch locally: http://127.0.0.1:5005\n"],"video_library":{"tutorial":{"description":"In this tutorial, we will investigate clustering of single-cell data from 10x Genomics, including preprocessing, clustering and the identification of cell types via known marker genes, using Scanpy. It will be illustrated using a dataset of Peripheral Blood Mononuclear Cells (PBMC), containing 2,700 single cells. Please work through the full tutorial yourself to get all the details.","materials":[{"link":"topics/single-cell/tutorials/scrna-scanpy-pbmc3k/tutorial.html","type":"Tutorial"}],"tags":["transcriptomics","single-cell"],"title":"Clustering 3K PBMCs with Scanpy","type":"Demo","versions":[{"captions":["hrhotz"],"date":"2021-03-18","length":"45M","link":"nefB35Bi1l4","speakers":["nomadscientist"]}],"gtn_id":"single-cell/scrna-scanpy-pbmc3k","captioned":true},"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":true,"mod_date":"2023-11-22 14:16:22 +0000","pub_date":"2019-12-19 19:40:33 +0000","version":15,"workflows":[{"workflow":"Clustering-3k-PBMC-with-Scanpy.ga","tests":true,"url":"https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-scanpy-pbmc3k/workflows/Clustering-3k-PBMC-with-Scanpy.ga","path":"topics/single-cell/tutorials/scrna-scanpy-pbmc3k/workflows/Clustering-3k-PBMC-with-Scanpy.ga","wfid":"single-cell-scrna-scanpy-pbmc3k","wfname":"clustering-3k-pbmc-with-scanpy","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/single-cell-scrna-scanpy-pbmc3k/versions/clustering-3k-pbmc-with-scanpy","license":"CC-BY-4.0","creators":[{"class":"Person","identifier":"0000-0001-9852-1987","name":"Bérénice Batut"},{"class":"Person","identifier":"0000-0002-2799-424X","name":"Hans-Rudolf Hotz"},{"class":"Person","identifier":"0000-0002-4181-2676","name":"Mehmet Tekman"},{"class":"Person","identifier":"0000-0002-5192-126X","name":"Pavankumar Videm"}],"name":"Clustering 3k PBMC with Scanpy","title":"Clustering 3k PBMC with Scanpy","test_results":null,"modified":"2024-06-13 10:00:06 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nBarcodes\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"ℹ️ Input Dataset\\nGenes\"];\n  style 1 stroke:#2c3143,stroke-width:4px;\n  2[\"ℹ️ Input Dataset\\nMatrix\"];\n  style 2 stroke:#2c3143,stroke-width:4px;\n  3[\"ℹ️ Input Dataset\\nmito header\"];\n  style 3 stroke:#2c3143,stroke-width:4px;\n  4[\"Import Anndata and loom\"];\n  2 -->|output| 4;\n  0 -->|output| 4;\n  1 -->|output| 4;\n  5[\"Inspect AnnData\"];\n  4 -->|anndata| 5;\n  6[\"Inspect AnnData\"];\n  4 -->|anndata| 6;\n  7[\"Inspect AnnData\"];\n  4 -->|anndata| 7;\n  8[\"Filter\"];\n  4 -->|anndata| 8;\n  9[\"Inspect AnnData\"];\n  4 -->|anndata| 9;\n  10[\"Inspect AnnData\"];\n  8 -->|anndata_out| 10;\n  11[\"Select last\"];\n  10 -->|var| 11;\n  12[\"Text reformatting\"];\n  11 -->|outfile| 12;\n  13[\"Search in textfiles\"];\n  11 -->|outfile| 13;\n  14[\"Replace Text\"];\n  12 -->|outfile| 14;\n  15[\"Concatenate datasets\"];\n  3 -->|output| 15;\n  14 -->|outfile| 15;\n  16[\"Manipulate AnnData\"];\n  8 -->|anndata_out| 16;\n  15 -->|out_file1| 16;\n  17[\"Inspect and manipulate\"];\n  16 -->|anndata| 17;\n  18[\"Inspect AnnData\"];\n  16 -->|anndata| 18;\n  19[\"Plot\"];\n  17 -->|anndata_out| 19;\n  4ab8b810-4e79-46b2-b740-74e267f5e209[\"Output\\nout_png\"];\n  19 --> 4ab8b810-4e79-46b2-b740-74e267f5e209;\n  style 4ab8b810-4e79-46b2-b740-74e267f5e209 stroke:#2c3143,stroke-width:4px;\n  20[\"Filter\"];\n  17 -->|anndata_out| 20;\n  21[\"Plot\"];\n  17 -->|anndata_out| 21;\n  02478047-eb04-4a4e-b1ff-f3cb3c7673d5[\"Output\\nout_png\"];\n  21 --> 02478047-eb04-4a4e-b1ff-f3cb3c7673d5;\n  style 02478047-eb04-4a4e-b1ff-f3cb3c7673d5 stroke:#2c3143,stroke-width:4px;\n  22[\"Plot\"];\n  17 -->|anndata_out| 22;\n  3eb66a4a-79fe-43a3-889b-d43daeae5e17[\"Output\\nout_png\"];\n  22 --> 3eb66a4a-79fe-43a3-889b-d43daeae5e17;\n  style 3eb66a4a-79fe-43a3-889b-d43daeae5e17 stroke:#2c3143,stroke-width:4px;\n  23[\"Filter\"];\n  20 -->|anndata_out| 23;\n  24[\"Manipulate AnnData\"];\n  23 -->|anndata_out| 24;\n  25[\"Normalize\"];\n  24 -->|anndata| 25;\n  26[\"Inspect and manipulate\"];\n  25 -->|anndata_out| 26;\n  27[\"Manipulate AnnData\"];\n  26 -->|anndata_out| 27;\n  28[\"Filter\"];\n  27 -->|anndata| 28;\n  29[\"Manipulate AnnData\"];\n  28 -->|anndata_out| 29;\n  30[\"Plot\"];\n  28 -->|anndata_out| 30;\n  31[\"Remove confounders\"];\n  29 -->|anndata| 31;\n  32[\"Inspect and manipulate\"];\n  31 -->|anndata_out| 32;\n  33[\"Cluster, infer trajectories and embed\"];\n  32 -->|anndata_out| 33;\n  96cbb37e-e755-4479-9f14-f0e14f689868[\"Output\\nanndata_out\"];\n  33 --> 96cbb37e-e755-4479-9f14-f0e14f689868;\n  style 96cbb37e-e755-4479-9f14-f0e14f689868 stroke:#2c3143,stroke-width:4px;\n  34[\"Plot\"];\n  33 -->|anndata_out| 34;\n  35[\"Plot\"];\n  33 -->|anndata_out| 35;\n  5dc45ef9-c56e-4dbd-9817-367c981a2041[\"Output\\nout_png\"];\n  35 --> 5dc45ef9-c56e-4dbd-9817-367c981a2041;\n  style 5dc45ef9-c56e-4dbd-9817-367c981a2041 stroke:#2c3143,stroke-width:4px;\n  36[\"Inspect and manipulate\"];\n  33 -->|anndata_out| 36;\n  37[\"Plot\"];\n  33 -->|anndata_out| 37;\n  38[\"Plot\"];\n  33 -->|anndata_out| 38;\n  39[\"Cluster, infer trajectories and embed\"];\n  36 -->|anndata_out| 39;\n  40[\"Cluster, infer trajectories and embed\"];\n  39 -->|anndata_out| 40;\n  41[\"Plot\"];\n  39 -->|anndata_out| 41;\n  29513947-d16c-48b2-93ff-dd78cd99ecb7[\"Output\\nout_png\"];\n  41 --> 29513947-d16c-48b2-93ff-dd78cd99ecb7;\n  style 29513947-d16c-48b2-93ff-dd78cd99ecb7 stroke:#2c3143,stroke-width:4px;\n  42[\"Inspect and manipulate\"];\n  40 -->|anndata_out| 42;\n  43[\"Inspect and manipulate\"];\n  40 -->|anndata_out| 43;\n  da91ad5a-dd9c-482e-accc-8e42d645e7b1[\"Output\\nanndata_out\"];\n  43 --> da91ad5a-dd9c-482e-accc-8e42d645e7b1;\n  style da91ad5a-dd9c-482e-accc-8e42d645e7b1 stroke:#2c3143,stroke-width:4px;\n  44[\"Plot\"];\n  40 -->|anndata_out| 44;\n  45[\"Inspect AnnData\"];\n  42 -->|anndata_out| 45;\n  868797a3-ab74-45bf-96d1-84451a16f882[\"Output\\nuns_rank_genes_groups_names\"];\n  45 --> 868797a3-ab74-45bf-96d1-84451a16f882;\n  style 868797a3-ab74-45bf-96d1-84451a16f882 stroke:#2c3143,stroke-width:4px;\n  46[\"Plot\"];\n  42 -->|anndata_out| 46;\n  47[\"Plot\"];\n  43 -->|anndata_out| 47;\n  2d042636-8fd1-42e3-af8d-83b4d613f075[\"Output\\nout_png\"];\n  47 --> 2d042636-8fd1-42e3-af8d-83b4d613f075;\n  style 2d042636-8fd1-42e3-af8d-83b4d613f075 stroke:#2c3143,stroke-width:4px;\n  48[\"Manipulate AnnData\"];\n  43 -->|anndata_out| 48;\n  51289df3-101f-4c6c-ae85-a8f46c2f33ea[\"Output\\nanndata\"];\n  48 --> 51289df3-101f-4c6c-ae85-a8f46c2f33ea;\n  style 51289df3-101f-4c6c-ae85-a8f46c2f33ea stroke:#2c3143,stroke-width:4px;\n  49[\"Inspect and manipulate\"];\n  43 -->|anndata_out| 49;\n  50[\"Inspect AnnData\"];\n  43 -->|anndata_out| 50;\n  e617acd1-e59d-4f20-b39d-9dc0f832b0db[\"Output\\nuns_rank_genes_groups_names\"];\n  50 --> e617acd1-e59d-4f20-b39d-9dc0f832b0db;\n  style e617acd1-e59d-4f20-b39d-9dc0f832b0db stroke:#2c3143,stroke-width:4px;\n  51[\"Plot\"];\n  43 -->|anndata_out| 51;\n  983e7cee-7028-456c-9db2-bf0ad3e52de5[\"Output\\nout_png\"];\n  51 --> 983e7cee-7028-456c-9db2-bf0ad3e52de5;\n  style 983e7cee-7028-456c-9db2-bf0ad3e52de5 stroke:#2c3143,stroke-width:4px;\n  52[\"Inspect clusters\"];\n  43 -->|anndata_out| 52;\n  53[\"Plot\"];\n  43 -->|anndata_out| 53;\n  734099bb-f454-4d8c-bc78-a269b0570c41[\"Output\\nout_png\"];\n  53 --> 734099bb-f454-4d8c-bc78-a269b0570c41;\n  style 734099bb-f454-4d8c-bc78-a269b0570c41 stroke:#2c3143,stroke-width:4px;\n  54[\"Plot\"];\n  43 -->|anndata_out| 54;\n  55[\"Plot\"];\n  43 -->|anndata_out| 55;\n  39f2d4b6-f2e8-41b3-a00a-a2c5b54face2[\"Output\\nout_png\"];\n  55 --> 39f2d4b6-f2e8-41b3-a00a-a2c5b54face2;\n  style 39f2d4b6-f2e8-41b3-a00a-a2c5b54face2 stroke:#2c3143,stroke-width:4px;\n  56[\"Plot\"];\n  48 -->|anndata| 56;\n  e0979d1e-eb87-4a7b-904f-a5116c7b8fff[\"Output\\nout_svg\"];\n  56 --> e0979d1e-eb87-4a7b-904f-a5116c7b8fff;\n  style e0979d1e-eb87-4a7b-904f-a5116c7b8fff stroke:#2c3143,stroke-width:4px;\n  57[\"Plot\"];\n  48 -->|anndata| 57;\n  58[\"Plot\"];\n  48 -->|anndata| 58;\n  bd14e644-2a32-4a81-bd83-042ee46d118a[\"Output\\nout_png\"];\n  58 --> bd14e644-2a32-4a81-bd83-042ee46d118a;\n  style bd14e644-2a32-4a81-bd83-042ee46d118a stroke:#2c3143,stroke-width:4px;\n  59[\"Plot\"];\n  49 -->|anndata_out| 59;\n  e9cf90db-ac42-4876-8abd-183fea271666[\"Output\\ncollection_png\"];\n  59 --> e9cf90db-ac42-4876-8abd-183fea271666;\n  style e9cf90db-ac42-4876-8abd-183fea271666 stroke:#2c3143,stroke-width:4px;\n  60[\"Plot\"];\n  49 -->|anndata_out| 60;\n  aef215b1-dbb4-447b-9297-c90536842c8e[\"Output\\nout_png\"];\n  60 --> aef215b1-dbb4-447b-9297-c90536842c8e;\n  style aef215b1-dbb4-447b-9297-c90536842c8e stroke:#2c3143,stroke-width:4px;\n  61[\"Datamash\"];\n  52 -->|obs| 61;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/single-cell/tutorials/scrna-scanpy-pbmc3k/tutorial.json","tools":["Filter1","cat1","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_awk_tool/1.1.2","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_grep_tool/1.1.1","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_replace_in_line/1.1.2","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_tail_tool/1.1.0","toolshed.g2.bx.psu.edu/repos/iuc/anndata_import/anndata_import/0.10.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/anndata_inspect/anndata_inspect/0.10.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.10.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/datamash_ops/datamash_ops/1.8+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_cluster_reduce_dimension/scanpy_cluster_reduce_dimension/1.9.6+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_filter/scanpy_filter/1.9.6+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_inspect/scanpy_inspect/1.9.6+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_normalize/scanpy_normalize/1.9.6+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_plot/scanpy_plot/1.9.6+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/scanpy_remove_confounders/scanpy_remove_confounders/1.9.6+galaxy1"],"supported_servers":{"exact":[{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true},{"url":"https://usegalaxy.org.au","name":"UseGalaxy.org.au","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.be/","name":"UseGalaxy.be","usegalaxy":false},{"url":"https://usegalaxy.cz/","name":"UseGalaxy.cz","usegalaxy":false},{"url":"https://usegalaxy.no/","name":"UseGalaxy.no","usegalaxy":false}]},"topic_name_human":"Single Cell","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"anndata_import","owner":"iuc","revisions":"93dd15e13e6a","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"anndata_inspect","owner":"iuc","revisions":"6f0d0c784f09","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"anndata_manipulate","owner":"iuc","revisions":"ed4996a16f7f","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"datamash_ops","owner":"iuc","revisions":"4c07ddedc198","tool_panel_section_label":"Join, Subtract and Group","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_cluster_reduce_dimension","owner":"iuc","revisions":"6acb08931836","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_filter","owner":"iuc","revisions":"a03ff8633507","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_inspect","owner":"iuc","revisions":"3081ff5c84a3","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_normalize","owner":"iuc","revisions":"94c19fb1281c","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_plot","owner":"iuc","revisions":"9b0cdb8cf6be","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"scanpy_remove_confounders","owner":"iuc","revisions":"458e8f43a775","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: anndata_import\n  owner: iuc\n  revisions: 93dd15e13e6a\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: anndata_inspect\n  owner: iuc\n  revisions: 6f0d0c784f09\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: anndata_manipulate\n  owner: iuc\n  revisions: ed4996a16f7f\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: datamash_ops\n  owner: iuc\n  revisions: 4c07ddedc198\n  tool_panel_section_label: Join, Subtract and Group\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_cluster_reduce_dimension\n  owner: iuc\n  revisions: 6acb08931836\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_filter\n  owner: iuc\n  revisions: a03ff8633507\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_inspect\n  owner: iuc\n  revisions: 3081ff5c84a3\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_normalize\n  owner: iuc\n  revisions: 94c19fb1281c\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_plot\n  owner: iuc\n  revisions: 9b0cdb8cf6be\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: scanpy_remove_confounders\n  owner: iuc\n  revisions: 458e8f43a775\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}