{"layout":"tutorial_hands_on","title":"Downstream Single-cell RNA analysis with RaceID","subtopic":"end-to-end","priority":2,"redirect_from":["/topics/transcriptomics/tutorials/scrna-raceid/tutorial","/short/single-cell/scrna-raceid","/short/T00253"],"zenodo_link":"https://zenodo.org/record/1511582","tags":null,"questions":["What is normalisation and why is it necessary?","How many types of unwanted variation are there?","How are biological phenotypes clustered?","What is the difference between PCA and tSNE?","What is the difference between cell trajectory and cell fate?"],"objectives":["Filtering, normalising, and clustering cells in a matrix","Assessing the quality of individual clusters","Inferring cell type lineages","Examining gene expression","Determining the top most expressive genes per cluster","Correcting for unwanted variation"],"requirements":[{"type":"internal","topic_name":"single-cell","tutorials":["scrna-scater-qc"]}],"follow_up_training":[{"type":"internal","topic_name":"single-cell","tutorials":["scrna-preprocessing-tenx"]}],"time_estimation":"3H","key_points":["Clustering single-cell RNA-seq data is often noisy","RaceID can be used to cluster cells based on the their gene expression profiles","StemID describes a hierarchical relationship between clusters to find multipotent progenitor stem cells to provide an understanding of cell development","FateID predicts the potential lineages that cells within specific clusters are inclined towards"],"contributors":[{"name":"Mehmet Tekman","email":"mtekman89@gmail.com","joined":"2018-11","elixir_node":"de","affiliations":["uni-freiburg"],"former_affiliations":["elixir-europe"],"id":"mtekman","url":"https://training.galaxyproject.org/training-material/api/contributors/mtekman.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/mtekman/"},{"name":"Alex Ostrovsky","email":"a.ostrovsky@mac.com","orcid":"0000-0002-7901-7109","joined":"2019-06","id":"astrovsky01","url":"https://training.galaxyproject.org/training-material/api/contributors/astrovsky01.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/astrovsky01/"}],"gitter":"Galaxy-Training-Network/galaxy-single-cell","js_requirements":{"mathjax":10933,"mermaid":false},"short_id":"T00253","url":"/topics/single-cell/tutorials/scrna-raceid/tutorial.html","topic_name":"single-cell","tutorial_name":"scrna-raceid","dir":"topics/single-cell/tutorials/scrna-raceid","symlink":null,"id":"single-cell/scrna-raceid","ref_tutorials":["<!-- TODO: Subset analysis to validate prior cell labelling -->\n<!-- TODO: Replace sort/unique with datamash -->\n\n<p>The data provided here as part of this tutorial analyses single-cell RNA-seq data from a study published by <span class=\"citation\"><a href=\"#Gr_n_2016\">Grün <i>et al.</i> 2016</a></span>. The data was used to cluster cells from <em>Lgr5</em>-positive intestinal stem cells of C57BL6/J mice, with the aim of discovering distinct cell sub-populations and deriving a lineage tree between them to find out how these sub-populations relate (or are derived from) one another.</p>\n\n<p>The input data consists of a single count matrix consisting of ~21,000 genes (rows) and ~400 cells (columns) in tidy data format, generated via <a href=\"/training-material/topics/single-cell/tutorials/scrna-preprocessing/tutorial.html\">scRNA pre-processing methods</a> using the <a href=\"/training-material/topics/single-cell/tutorials/scrna-umis/tutorial.html\">CelSeq2 protocol</a>.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>Tidy Data</comment-title>\n  <p>The <a href=\"https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html\">tidy data</a> convention prevalent amongst the R data analysis community assigns every value to a variable and an observation. The values are the number of reads which are assigned to a particular gene (a variable) that was measured within a specific cell (an observation).</p>\n\n</blockquote>\n\n<blockquote class=\"details\">\n  <details-title>Count Correction</details-title>\n  <p>Normally a count matrix consists of integers, but this matrix has undergone an UMI-to-transcript <a href=\"https://www.nature.com/articles/nmeth.2930#methods\">count alteration</a> to correct against UMI errors, yielding decimal values instead. This correction is not that necessary in most datasets but it is used here.</p>\n\n</blockquote>\n\n<p>This tutorial will perform cell clustering and lineage construction, as well as exploring some genes of interest.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#initial-count-matrix\" id=\"markdown-toc-initial-count-matrix\">Initial Count Matrix</a>    <ol>\n      <li><a href=\"#get-data\" id=\"markdown-toc-get-data\">Get data</a></li>\n      <li><a href=\"#inspecting-the-cell-labelling\" id=\"markdown-toc-inspecting-the-cell-labelling\">Inspecting the Cell Labelling</a></li>\n      <li><a href=\"#inspecting-the-quality-of-the-count-matrix\" id=\"markdown-toc-inspecting-the-quality-of-the-count-matrix\">Inspecting the Quality of the Count Matrix</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#normalising-and-clustering-cells\" id=\"markdown-toc-normalising-and-clustering-cells\">Normalising and Clustering Cells</a>    <ol>\n      <li><a href=\"#biological-variation\" id=\"markdown-toc-biological-variation\">Biological Variation</a></li>\n      <li><a href=\"#technical-variation\" id=\"markdown-toc-technical-variation\">Technical Variation</a></li>\n      <li><a href=\"#performing-the-clustering\" id=\"markdown-toc-performing-the-clustering\">Performing the Clustering</a></li>\n      <li><a href=\"#outlier-detection\" id=\"markdown-toc-outlier-detection\">Outlier Detection</a></li>\n      <li><a href=\"#heatmaps\" id=\"markdown-toc-heatmaps\">Heatmaps</a></li>\n      <li><a href=\"#visualising-all-clusters\" id=\"markdown-toc-visualising-all-clusters\">Visualising All Clusters</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#individual-cluster-inspection\" id=\"markdown-toc-individual-cluster-inspection\">Individual Cluster Inspection</a>    <ol>\n      <li><a href=\"#differential-gene-analysis-between-two-clusters\" id=\"markdown-toc-differential-gene-analysis-between-two-clusters\">Differential Gene Analysis Between Two Clusters</a></li>\n      <li><a href=\"#differential-gene-expression-across-all-clusters\" id=\"markdown-toc-differential-gene-expression-across-all-clusters\">Differential Gene Expression Across All Clusters</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#trajectory-and-lineage-analysis\" id=\"markdown-toc-trajectory-and-lineage-analysis\">Trajectory and Lineage Analysis</a>    <ol>\n      <li><a href=\"#computing-the-lineage-tree\" id=\"markdown-toc-computing-the-lineage-tree\">Computing the Lineage Tree</a></li>\n      <li><a href=\"#specific-trajectory-lineage-analysis-stemid\" id=\"markdown-toc-specific-trajectory-lineage-analysis-stemid\">Specific Trajectory Lineage Analysis (StemID)</a></li>\n      <li><a href=\"#specific-trajectory-fate-analysis-fateid\" id=\"markdown-toc-specific-trajectory-fate-analysis-fateid\">Specific Trajectory Fate Analysis (FateID)</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"initial-count-matrix\">Initial Count Matrix</h1>\n\n<p>Every single-cell RNA analysis begins with a count matrix, which contains the raw data required for the downstream analysis. Annotation data such as cell phenotype or gene annotations are often used to enrich and validate the analysis. Cell annotations can sometimes be encoded directly in the cell labelling, as we will later explore in this count matrix.</p>\n\n<p>First, let’s setup our history and initial dataset.</p>\n\n<h2 id=\"get-data\">Get data</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Data upload</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a new history for this tutorial and name it “RaceID on scRNA”</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Click on <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name (which by default is “Unnamed history”)</li>   <li>Type the new name</li>   <li>Click on <strong>Save</strong></li> </ol>   <p>If you do not have the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name:</p>   <ol>   <li>Click on <strong>Unnamed history</strong> (or the current name of the history) (<strong>Click to rename history</strong>) at the top of your history panel</li>   <li>Type the new name</li>   <li>Press <kbd>Enter</kbd></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Import the file from <a href=\"https://zenodo.org/record/1511582\">Zenodo</a> or from the shared data library</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/1511582/files/intestinalData.tsv\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-data-from-a-data-library\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-data-from-a-data-library\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing data from a data library</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>As an alternative to uploading the data from a URL or your computer, the files may also have been made available from a <em>shared data library</em>:</p>   <ol>   <li>Go into <strong>Shared data</strong> (top panel) then <strong>Data libraries</strong></li>   <li>Navigate to  the correct folder as indicated by your instructor.     <ul>       <li>On most Galaxies tutorial data will be provided in a folder named <strong>GTN - Material –&gt; Topic Name -&gt; Tutorial Name</strong>.</li>     </ul>   </li>   <li>Select the desired files</li>   <li>Click on <strong>Add to History</strong> <i class=\"fas fa-caret-down\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-dropdown</span> near the top and select <strong>as Datasets</strong> from the dropdown menu</li>   <li>     <p>In the pop-up window, choose</p>     <ul>       <li><em>“Select history”</em>: the history you want to import the data to (or create a new one)</li>     </ul>   </li>   <li>Click on <strong>Import</strong></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Rename the dataset to <em>“intestinal”</em></li>\n    <li>\n      <p>Check that the datatype is a tab-separated file</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-changing-the-datatype\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-changing-the-datatype\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Changing the datatype</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, click <i class=\"fas fa-database\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-chart-select-data</span> <strong>Datatypes</strong> tab on the top</li>   <li>In the <i class=\"fas fa-database\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-chart-select-data</span> <strong>Assign Datatype</strong>, select <code class=\"language-plaintext highlighter-rouge\">tabular</code> from “<em>New type</em>” dropdown     <ul>       <li>Tip: you can start typing the datatype into the field to filter the dropdown menu</li>     </ul>   </li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many genes are in the count matrix?</li>\n    <li>How many cells?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>A summary of our dataset is given by expanding the file preview window by clicking on the file name.</p>\n\n    <ol>\n      <li>20,269 lines, where lines/rows denote our genes.</li>\n      <li>Scroll the mini-preview window to the right to see that the number of cells are 431</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"inspecting-the-cell-labelling\">Inspecting the Cell Labelling</h2>\n\n<p>Cell labels usually encode which plate, batch, or cell barcode was used to delineate cell. Sometimes all three sources of information are used, which can be valuable information to have when looking for batch effects.</p>\n\n<p>We can inspect the labels of this dataset by clicking on the <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> symbol. Immediately we can see that the header of this file contains cell names, following a naming convention that separates the cells into 5 batches: <em>I5d, II5d, III5d, IV5d</em>, and <em>V5d</em></p>\n\n<p>Is each batch equally populated? We can investigate this ourselves by extracting the headers, and reformatting them to see how many unique types we can detect:</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Task description</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_head_tool/1.1.0\" title=\"Select first tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Select first</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to select”</em>: imported tabular file</li>\n        <li><em>“Operation”</em>: <code class=\"language-plaintext highlighter-rouge\">Keep first lines</code></li>\n        <li><em>“Number of lines”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/datamash_transpose/datamash_transpose/1.1.0\" title=\"Transpose tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Transpose</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.0)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input tabular dataset”</em>: output of <strong>Select first</strong></li>\n      </ul>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What did this transpose step do? Why is it necessary?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>The sole purpose of the Transpose tool is to switch columns with rows (and vice versa), which will make it easier to inspect and sort data.</p>\n        </blockquote>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_sed_tool/1.1.1\" title=\"Text transformation tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Text transformation</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.1)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: output of <strong>Transpose</strong></li>\n        <li>\n          <p><em>“SED Program”</em>: <code class=\"language-plaintext highlighter-rouge\">s/_[0-9]+//</code></p>\n\n          <p>The above text is a regular expression used to match on anything that contains a <code class=\"language-plaintext highlighter-rouge\">_</code> followed by a number, and removing it.</p>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Inspect the generated file and verify that we have the 5 phenotypes without <code class=\"language-plaintext highlighter-rouge\">_</code> followed by a number</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How many rows remain after the <strong>Text transformation</strong> step?</p>\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>The number of rows has not changed since the last step, but the cell names have lost their numbering and are identified purely by their phenotype.</p>\n        </blockquote>\n      </blockquote>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/datamash_ops/datamash_ops/1.1.0\" title=\"Datamash tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Datamash</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input tabular dataset”</em>: output of <strong>Text transformation</strong></li>\n        <li><em>“Group by fields”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n        <li><em>“Input file has a header line”</em> : <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Print header line”</em>:<code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Sort input”</em>:<code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Print all fields from input file”</em>:<code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Ignore case when grouping”</em>:<code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li>In <em>“Operation to perform on each group”</em>\n          <ul>\n            <li>In <em>“1: Operation to perform on each group”</em>\n              <ul>\n                <li><em>“Type”</em>: <code class=\"language-plaintext highlighter-rouge\">count</code></li>\n                <li><em>“On column”</em>: <code class=\"language-plaintext highlighter-rouge\">Column: 1</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many unique cell phenotypes were identified in the cell headers?</li>\n    <li>Which cell phenotype is least represented in the count matrix?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>There are 5 types of cells in our count matrix: <em>I5d</em>, <em>II5d</em>, <em>III5d</em>, <em>IV5d</em>, and <em>V5d</em>.</li>\n      <li>There are only 48 <em>IV5d</em> cells compared to the other types which have 95 or 96.</li>\n    </ol>\n  </blockquote>\n\n</blockquote>\n\n<p>With these types already labelled in the header of our data, we can validate the clustering that we will perform later. Ideally, the cells described by these 5 different labels should group into 5 separate clusters, with varying degrees of proximity to one another.</p>\n\n<h2 id=\"inspecting-the-quality-of-the-count-matrix\">Inspecting the Quality of the Count Matrix</h2>\n\n<p>Low quality cells and genes are often caught at the pre-processing stage and removed, but sometimes more filtering is required to remove unwanted noise from the data.</p>\n\n<p>A gene with a low number of total counts across multiple cells might be differentially expressed across those cells, however differential gene expression and log fold change do not necessarily denote significant change. 1 count in CellA and 10 counts in CellB yields an LFC of 10, but is not as significant as an LFC of 10 from 100 counts in CellA vs 1000 counts in CellB.</p>\n\n<p>We can refine filtering thresholds by examining how much a histogram of our plots change before and after filtering using standard parameters.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Unique Cell Types</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_filtnormconf/raceid_filtnormconf/0.2.3+galaxy0\" title=\"Initial processing using RaceID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Initial processing using RaceID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Count Matrix”</em>: <code class=\"language-plaintext highlighter-rouge\">intestinal</code> (Input dataset)</li>\n        <li>In <em>“Filtering”</em>:\n          <ul>\n            <li><em>“Min Transcripts”</em>: <code class=\"language-plaintext highlighter-rouge\">3000</code></li>\n            <li><em>“Min Expression”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n            <li><em>“Min Cells”</em>: <code class=\"language-plaintext highlighter-rouge\">5</code></li>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>The tool provides metrics on the library size and the number of detected features.</p>\n\n<blockquote class=\"details\">\n  <details-title>Library Size and Number of Features (Definitions)</details-title>\n\n  <figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/libsize.svg\" alt=\"Library Size and Detected Genes. \" width=\"576\" height=\"437\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/libsize.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> Library Size and Number of Features</figcaption></figure>\n\n  <ul>\n    <li><strong>Library Size</strong>: The total number of transcripts in a cell, or a column sum. <em>The minimum threshold for this can be set by “Min Transcripts” (= 3000)</em>.</li>\n    <li><strong>Gene Transcripts</strong>: The total number of transcripts for a gene, or a row sum.</li>\n    <li><strong>Detectability</strong>: This is how many values above a certain threshold exist in a given row/column.\n      <ul>\n        <li><strong>Number of Features</strong>: The number of genes detected above a certain threshold.\n          <ul>\n            <li><em>&gt;0</em>: This is the default threshold when the term <em>Number of Features</em> is used, because it counts any genes with non-zero counts for that cell, and are therefore ‘detected’ during sequencing.</li>\n            <li><em>&gt;N</em>: Depending on how lowly sequenced the cells are, sometimes it is useful to set a higher threshold of detectability to guard against sequencing errors or other noise-related factors. <em>The minimum threshold for this can be set by “Min Expression” (= 5)</em>.</li>\n          </ul>\n        </li>\n        <li><strong>Number of Cells</strong>:\n          <ul>\n            <li><em>&gt;0</em>: This is the default threshold when the term <em>Detected in X number of Cells</em> is used, because it counts any cells with non-zero counts for that gene.</li>\n            <li><em>&gt;N</em>: This raises the detectability threshold to any cell count above N. <em>The minimum threshold for this can be set by “Min Cells” (= 5)</em>.</li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ul>\n\n</blockquote>\n\n<p>Four histograms are generated with the top line giving the raw expression data fed into the tool, and the bottom line giving the filtered data (cells with at least 3,000 transcripts in total and genes with at least 5 transcripts in at least 5 cells).</p>\n\n<figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/filter_plots.png\" alt=\"Histograms of raw and filtered data. \" width=\"915\" height=\"883\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/filter_plots.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> RaceID Histograms of raw and filtered data</figcaption></figure>\n\n<ul>\n  <li>\n    <p>(Top-Left) Library Size (total number of transcripts per cell)</p>\n  </li>\n  <li>\n    <p>(Top-Right) Feature Set (total number of detectable genes per cell)</p>\n  </li>\n  <li>\n    <p>(Bottom-Left) Filtered Library Size (minimum 3000 transcripts per cell)</p>\n  </li>\n  <li>\n    <p>(Bottom-Right) Filtered Feature Set</p>\n  </li>\n</ul>\n\n<blockquote class=\"details\">\n  <details-title>RaceID Histograms</details-title>\n\n  <p>The top row shows the count distributions of the Library Size and Number of Features of the raw data using a Log scale on the x-axis (e.g. 2.5 on the Log10 x-axis = \\(10^{2.5}\\) = 316 counts).</p>\n\n  <ul>\n    <li>\n      <p>(Top-Left) A lower-tail heavy distribution centred around 3-4 Log10 (~3000) counts per cell , with a few cells having library sizes containing a handful of counts (0-1000).</p>\n    </li>\n    <li>\n      <p>(Top-Right) Another lower-tail heavy distribution with a peak centred around \\(10^{3.5}\\) counts. Cells with a low number of features are hard to compare with other cells due to incomplete data. It is possible that these low feature cells (&lt; 100 genes) are rare types and that we should impute their missing values, but it is often more likely the case that these are simply just low-quality cells that will add noise to the clustering.</p>\n    </li>\n  </ul>\n\n  <p>The bottom row shows the count distributions of the Library Size and Number of Features of the filtered data</p>\n\n  <ul>\n    <li>\n      <p>(Bottom-Left) The lower-tail of our previous distribution has been trimmed off, which gives an even normal-looking distribution centred around \\(10^{3.4}\\) transcripts per cell.</p>\n    </li>\n    <li>\n      <p>(Bottom-Right) Instead of a distribution we have a single bar that indicates that all of our cells have the exact number of features. The red line displays the number of features across all cells (~ \\(10^{3.3}\\)).</p>\n    </li>\n  </ul>\n\n</blockquote>\n\n<blockquote class=\"comment\">\n  <comment-title>Choosing Filtering Thresholds</comment-title>\n\n  <p>The minimum total filtering threshold of 3000 chosen for this dataset is derived from analysing the <em>Cross-Contamination Plots</em> from the <a href=\"/training-material/topics/single-cell/tutorials/scrna-preprocessing/tutorial.html\">Pre-processing of Single-Cell RNA Data</a>.</p>\n\n  <p>This threshold is dependent primarily on the capture efficiency of the cells that were sequenced, with some cell types being easier to capture than others. For example, neuron cells would have a lower filtering threshold of ~1500 compared to the ~3000 used for hematopoietic cells.</p>\n\n</blockquote>\n\n<blockquote class=\"details\">\n  <details-title>Why the Same Number of Features?</details-title>\n\n  <ul>\n    <li>\n      <p>RaceID normalises the data to compare all cells using the same set of features. Selected features must be <em>meaningful</em>, describing or contributing to the biological variation in the data. Therefore features should be the most differentially expressed genes across different cells.</p>\n    </li>\n    <li>\n      <p>The cells that still remain after filtering will have some genes with count values of zero. In some cases this will give a median value of zero, which can make normalisation strategies difficult (e.g. dividing by the median value of a gene may require dividing by zero). For this reason, a value of 0.1 is added to the count data so that these features are not lost during the analysis.</p>\n    </li>\n    <li>\n      <p>It should be noted that this then assumes that the gene <em>is</em> detectable for that cell (i.e. no errors during sequencing), but that the transcript was very lowly expressed.</p>\n    </li>\n    <li>\n      <p>The flat square plot (bottom-right) for the post-filtered number of features is square because it shows that the dataset is still a rectangular matrix with C number of cells and G number of genes. For a more ‘realistic’ distribution of features, re-run the tool with <em>“Count filtered features greater than or equal to 1”</em> enabled.</p>\n    </li>\n  </ul>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many cells remain after filtering?</li>\n    <li>How many genes remain after filtering?</li>\n    <li>Are these numbers to be expected?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>The answer to the first two questions can be seen in log file generated <strong>Initial processing using RaceID</strong></p>\n\n    <ol>\n      <li>287 cells remain (66%)</li>\n      <li>2089 genes remain (10%)</li>\n      <li><strong>Yes</strong>\n        <ul>\n          <li><em>Cells:</em>\nThese are the observations of your dataset, and the more observations you have, the better the model will be. At minimum, 60% of your initial cells should be retained, though this will depend on the quality of your dataset.</li>\n          <li><em>Genes:</em>\nAs the variables of the dataset, the more genes included, the more complex the model. Discovering the few variables that are relevant to the final model, then,  is the aim. Genes <em>not</em> differentially expressed between cells will not affect the final model, but serve as stable background metrics against which to measure significantly differentially expressed genes in the initial matrix. It is perfectly acceptable to perform a single-cell RNA-seq analysis with as few as 500 (differentially expressed) genes.</li>\n        </ul>\n      </li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>The filtered distributions are what are expected of a properly filtered and normalised dataset (i.e. a count matrix with all observations having roughly the same number of transcripts, but distributed differently across different sets of common features). With this we can now perform initial clustering to see whether we can cluster any of our cells into distinct cell types.</p>\n\n<h1 id=\"normalising-and-clustering-cells\">Normalising and Clustering Cells</h1>\n\n<p>Normalisation permits the comparison of different samples by refactoring out uninformative variability relating to the size of sample, and other sources of unwanted variability. Clustering, which groups or categorises cells based on their similarity, and is a crucial stage in the analysis after normalisation.</p>\n\n<p>The effectiveness of the clustering relies on the normalisation. The ideal method to normalise single cell RNA-seq data is still a field of active research as  it is not a straightforward process due to two potential sources of uncertainty: technological and biological variability.</p>\n\n<h2 id=\"biological-variation\">Biological Variation</h2>\n\n<figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/cellcycle.svg\" alt=\"Sources of variation. \" width=\"830\" height=\"406\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/cellcycle.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> Sources of unwanted biological variation: (Left) Transcriptional Bursting, and (Right) Cell-cycle Variation</figcaption></figure>\n\n<p>Transcriptional bursting is a stochastic model for the transcription process in a cell, where transcription does not occur as a smooth or continuous process but occurs in spontaneous and discrete ‘bursts’ thought to be only loosely associated with chromatin conformation/availability. It is an effect that is not seen in bulk RNA-seq due to the smoothing effect of measuring average gene expression across a tissue. The effect is more pronounced in single-cell and is hard to model against.</p>\n\n<p>On the other hand, cell-cycle variation is well defined and can be modelled against. As the cell grows from the G1 to the M phase, the amount of mRNA transcribed grows, meaning that cells in the later stages of their cycle are more likely to produce more transcripts of a given gene. Such differences can give false variation that would cluster two cells of the same type but at different time-points separately. Fortunately, there are a well-defined set of genes whose expression is known  to co-vary with the cell-cycle, thus this effect can be modelled out.</p>\n\n<h2 id=\"technical-variation\">Technical Variation</h2>\n\n<figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/technical_variation.svg\" alt=\"Sources of variation. \" width=\"862\" height=\"426\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/technical_variation.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> Sources of unwanted technical variation</figcaption></figure>\n\n<p>Technical variation appears in three main forms: <em>Library size variation</em>, <em>Amplification bias</em>, and <em>Dropout events</em>.</p>\n\n<blockquote class=\"details\">\n  <details-title>Technical Variation</details-title>\n  <ol>\n    <li>\n      <p><strong>Library size variation</strong> occurs where two cells of the same cell type may produce a different amount of total transcripts than one another (e.g. due to cell-cycle effects, or differing capture efficiencies), but have a similar <em>proportion</em> of transcripts for specific genes. For example, a neural cell with 10 counts of SOX2 and a library size of 100 and one with 20 counts and a library size of 200 have the same proportion of SOX2. The two cells have different library sizes, but harbour the same expression for that gene because they are of the same cell type.</p>\n    </li>\n    <li>\n      <p><strong>Amplification bias</strong> stems from an uneven amplification of certain transcripts of a cell over others, giving a false number of reads for the number of mRNA molecules actually observed in the cell. Unique Molecular Identifiers can significantly reduce this bias, and are covered more extensively in the <a href=\"/training-material/topics/single-cell/tutorials/scrna-umis/tutorial.html\"><em>Understanding Barcodes</em></a> hands-on.</p>\n    </li>\n    <li>\n      <p><strong>Dropout events</strong> are the zero counts that are prevalent in the data due to the reduced sequencing sensitivity in detecting reads, which yields many false negatives in the detection of genes, often resulting in over 80% of the count values in the count matrix being zero. A major point to take into account is that some of these zeroes are <em>real</em> (i.e. no transcripts of that gene were detected in that cell) and some of these are <em>false</em> (i.e. the transcripts were never captured due to the low sequencing depth). Modelling this duality in the data and mitigating against it is one of the biggest challenges of normalising single-cell data.</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"performing-the-clustering\">Performing the Clustering</h2>\n\n<p>We will attempt to perform some normalisation and clustering using the recommended default settings to see if we can detect different cell types.</p>\n\n<p>Here we assume that there is no unwanted technical or biological variability in the data and that the cells will cluster purely based on their phenotypes. This assumption is not completely without merit, since often the biological signal is strong enough to counter the lesser unwanted variation.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Task description</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_clustering/raceid_clustering/0.2.3+galaxy0\" title=\"Clustering using RaceID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Clustering using RaceID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RaceID RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Initial processing using RaceID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“Clustering”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n        <li>In <em>“Outliers”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n        <li>In <em>“tSNE and FR”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"details\">\n  <details-title>Clustering on a Distance Matrix</details-title>\n\n  <p>In order to perform clustering, the proximity of cells to one another are first defined by a distance metric\nsuch as <a href=\"https://en.wikipedia.org/wiki/Metric_(mathematics)\">Euclidean distance or other</a>.</p>\n\n  <figure id=\"figure-5\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/distance.svg\" alt=\"Distances. \" width=\"571\" height=\"349\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/distance.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 5</strong>:</span> Euclidean distance between three points (R, P, V) across three features (G1, G2, G3)</figcaption></figure>\n\n  <p>The clustering then tries to find groupings of cells using this distance matrix.</p>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>Why are there zeroes along the diagonal of the above example distance matrix?</li>\n      <li>Is there any symmetry in this matrix?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <ol>\n        <li>The distance between a point to itself is - nothing!</li>\n        <li>The distance between point <em>a</em> to point <em>b</em> is the same as the distance between point <em>b</em> to point <em>a</em> using the Euclidean distance metric.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n\n</blockquote>\n\n<p>The first three plots in the PDF report tell us about the stability/reliability of our clusters, and are more important indicators for the quality of our clustering than any of the resultant graph projections, such as PCA or tSNE.</p>\n\n<figure id=\"figure-6\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/sat_jacc.png\" alt=\"Stability Plots. \" width=\"896\" height=\"842\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/sat_jacc.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 6</strong>:</span> RaceID Saturation and Jaccard Distance Plots</figcaption></figure>\n\n<ul>\n  <li>\n    <p>(Top-Left) Dispersion within each cluster for given K values, with mean change in dispersion for said K value overlayed.</p>\n  </li>\n  <li>\n    <p>(Top-Right) Same as top-left, but with the actual dispersion plotted instead of the relative change of dispersion.</p>\n  </li>\n  <li>\n    <p>(Bottom-Left) Stability for each cluster using <a href=\"https://en.wikipedia.org/wiki/Jaccard_index\">Jaccard distance</a>.</p>\n  </li>\n</ul>\n\n<blockquote class=\"details\">\n  <details-title>RaceID Plots</details-title>\n  <ul>\n    <li>\n      <p>The first plot measures the levels of dispersion within each cluster and displays the mean dispersion over all clusters for each k value. The grey points indicate the mean change in dispersion for that k values, and the red bars show this dispersion as a box plot, which get smaller and smaller until a “saturation point” (blue) is reached where the change in dispersion no longer decreases for an increase in k.</p>\n    </li>\n    <li>\n      <p>For example, if <em>k=2</em>, then all cells will be sorted into 2 clusters, and the variance of the gene expression in each cluster will be measured and averaged to give a score for the clustering at that k value. Certain values of <em>k</em> may cluster the cells of the same type better, with the expectation that the average dispersion of expression values across all clusters will be minimised for some value of <em>k</em>. As <em>k</em> increases, the reduction in this dispersion is measured for each increase of <em>k</em> until the change in the mean within-cluster dispersion no longer changes. Here we can see that reduction saturates at <em>k=12</em>, which is chosen to the be the number of clusters detected in our data for all further analysis.</p>\n    </li>\n    <li>\n      <p>The third plot measures the direct stability of each of the derived (in this case, 12) clusters using the Jaccard distance, which is a fractional quantity that measures the dissimilarity between two sets as measured by overlap divided by the union of both sets.</p>\n    </li>\n  </ul>\n\n</blockquote>\n\n<blockquote class=\"details\">\n  <details-title>Jaccard Distance</details-title>\n\n  <p>Jaccard distance is measured by the intersection of the two or more sets divided by the union of those sets.</p>\n\n  <p>\\(d\\_J(X,Y) = 1 - J(X,Y) = \\frac{|X \\cup  Y| - |X \\cap Y|}{|X \\cup Y|}\\)\n<!-- This seems to be visible when collapsed...? --></p>\n\n  <p>In the case of single-cell data, sets are defined as the cells contained within a given cluster, and the Jaccard similarity score provides a quantitative measure for how distinct a given cluster is, based on its similarity to other sets.</p>\n\n  <figure id=\"figure-7\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/jaccard.svg\" alt=\"Jaccard. \" width=\"836\" height=\"607\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/jaccard.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 7</strong>:</span> Example Jaccard Distance calculation</figcaption></figure>\n\n</blockquote>\n\n<p>Here, for each of the 12 clusters, the (top N) genes expressed by the cells in each cluster are intersected with the (top N) genes expressed by the cells in all other clusters to measure how unique the expression profile is to that specific cluster. The scales given by the plot are actually measuring the dissimilarity between sets, which is one minus the index, therefore a higher y-value is better.</p>\n\n<p>Ideally the Jaccard distance should have above 0.6 in most clusters, but it is acceptable to have one or two more poorly defined clusters.</p>\n\n<h2 id=\"outlier-detection\">Outlier Detection</h2>\n\n<p>Outlier detection attempts to refine the initially detected clusters to find smaller (sub-)clusters that could be used to define rarer cell types.</p>\n\n<p>The next three plots attempts to do this by describing the variation of the gene expression, given by; a Background plot, a Sensitivity plot, and an Outlier probability plot.</p>\n\n<figure id=\"figure-8\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/gexpr.png\" alt=\"Gene Expression Plots. \" width=\"907\" height=\"812\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/gexpr.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 8</strong>:</span> RaceID Gene Expression Plots</figcaption></figure>\n\n<ul>\n  <li>\n    <p>(Top-Left) Outlier identification via background model based on distribution of transcript counts within a cluster.</p>\n  </li>\n  <li>\n    <p>(Top-Right) Outlier cells are detected if the probability for that cell \\(c\\) that a minimum number of genes \\(G\\_{min}\\) of observing total counts \\(T\\_{G\\_{min}}\\) is less than a specific threshold \\(P\\_{thr}\\), as given by the red dotted line.</p>\n  </li>\n  <li>\n    <p>(Bottom-Left) Outlier probabilities of all cells in all clusters.</p>\n  </li>\n</ul>\n\n<blockquote class=\"details\">\n  <details-title>RaceID Outlier Identification</details-title>\n  <ul>\n    <li>(Top-Left) A background model is calibrated and outliers are identified based on the distribution of transcript counts within a cluster. The counts for each gene are assumed to follow a negative binomial distribution determined by the average expression of a gene across all cells in a cluster, along with a dispersion parameter.\n      <ul>\n        <li>The dispersion is derived from the average variance-mean dependence, modelled as a logarithmic second order polynomial under the assumption that:\n          <ol>\n            <li>Most genes are not differentially expressed between clusters</li>\n            <li>True biological variability is located within a handful of genes</li>\n          </ol>\n        </li>\n        <li>In the background model, the upper and lower (violet and red) regression of the variance on the mean (as approximated by a second-order polynomial in logarithmic space) is higher than the variance of most genes (all grey dots below the red curve). This is expected since they are not differentially expressed, and so the genes above the background regression are therefore significant in the detection of outlier cells. The orange line is the local regression (moving average variance per mean) and is used purely for illustrative purposes. <!-- See: https://github.com/dgrun/RaceID3_StemID2_package/blob/master/R/RaceID.R#L280 --></li>\n      </ul>\n    </li>\n    <li>(Top-Right) Outlier cells are detected if the probability for that cell \\(c\\) that a minimum number of genes \\(G\\_{min}\\) of observing total counts \\(T\\_{G\\_{min}}\\) is less than a specific threshold \\(P\\_{thr}\\), as given by the red dotted line.\n      <ul>\n        <li>This is shown in the chart above as the number of outliers as a function of the probability threshold, which is set to \\(1 \\cdot 10^{-3}\\) by default. Ideally, this threshold should be chosen so that the lower tail of the distribution contains as few outliers as possible (i.e. lower than the steep rise in outliers towards the higher end of the plot) to ensure a maximum sensitivity of this method. If the sensitivity of the sequencing was low, then only a few highly expressed genes would be reliably quantified, so the outlier probability threshold would need to be higher (e.g. up to 1).</li>\n      </ul>\n    </li>\n    <li>(Bottom-Left) A bar plot of the outlier probabilities of all cells across all clusters. All outlier cells are merged into their own clusters if their similarity exceeds a quantile threshold of the similarity distribution for all pairs of cells within one of the original clusters. After the outlier cells are merged, then the new cluster centres are defined for the original clusters after removing the outliers. Then, each cell is assigned to the nearest cluster centre using k-partitioning.</li>\n  </ul>\n\n</blockquote>\n\n<p>The most differentially expressed genes (below a maximum p-value cutoff) in each of the clusters can be seen in the output file <em>Clustering using RaceID on data: Cluster - Genes per Cluster</em>, with 7 columns describing:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Column</th>\n      <th>Description</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td><strong>.</strong></td>\n      <td>Gene Name</td>\n    </tr>\n    <tr>\n      <td><strong>n</strong></td>\n      <td>Cluster number</td>\n    </tr>\n    <tr>\n      <td><strong>mean.ncl</strong></td>\n      <td>Mean expression of gene across cells <em>outside</em> the cluster</td>\n    </tr>\n    <tr>\n      <td><strong>mean.cl</strong></td>\n      <td>Mean expression of gene across cells <em>inside</em> the cluster</td>\n    </tr>\n    <tr>\n      <td><strong>fc</strong></td>\n      <td>Fold-change of mean expression in the cluster, against all remaining cells</td>\n    </tr>\n    <tr>\n      <td><strong>pv</strong></td>\n      <td>Inferred p-value for differential expression</td>\n    </tr>\n    <tr>\n      <td><strong>padj</strong></td>\n      <td>Adjusted p-value using the Benjami-Hochberg correction for the false discovery rate</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>What is the most significant differentially expressed gene in Cluster 5?</li>\n    <li>Which cluster has the most genes with a fold-change greater than 30?\n      <blockquote class=\"tip\">\n        <tip-title></tip-title>\n        <p>One way to answer is this is to scroll through the list and make a mental note of all the genes with a high fold-change value…</p>\n\n        <p>…but a <em>better</em> way is to sort the data in descending order on Column 5 using the <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> <strong>Sort</strong> tool.</p>\n\n      </blockquote>\n    </li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <ol>\n      <li>The <em>Genes per Cluster</em> dataset is already sorted by cluster number and then by the adjusted p-value. Scrolling down to the first gene that is in cluster 5, we see that <em>Dmbt11</em> is the most significant gene in that cluster with an adjusted p-value of <code class=\"language-plaintext highlighter-rouge\">2e-30</code>.</li>\n      <li>Cluster 11 appears to have the most genes with a fold-change greater than 30.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"heatmaps\">Heatmaps</h2>\n\n<p>The remainder of the plots are heatmaps derived from k-medoids clustering, showing the similarity between clusters for both the initial clustering and the final (post outlier detection) clustering.</p>\n\n<blockquote class=\"details\">\n  <details-title>K-medoids and K-means Clustering</details-title>\n\n  <p>The k-medoids algorithm relates to the k-means algorithm of clustering, by which</p>\n\n  <ul>\n    <li>Initialise:\n      <ol>\n        <li>A value of k is chosen, e.g <em>k=3</em>.</li>\n        <li>k points are chosen at random in the dataset (or initialised in some rational way)</li>\n      </ol>\n    </li>\n    <li>Step:\n      <ol>\n        <li>Each datapoint in the dataset is assigned to the closest k point using some distance metric.</li>\n        <li>The mean (or in this case, the median) of all points assigned to a specific k point are computed for each k point.</li>\n        <li>The k-points take on the new position of the mean (or median) values just computed</li>\n        <li>Repeat Step until convergence reached or after N number of iterations</li>\n      </ol>\n    </li>\n  </ul>\n\n  <figure id=\"figure-9\" style=\"max-width: 90%;\"><img src=\"https://upload.wikimedia.org/wikipedia/commons/e/ea/K-means_convergence.gif\" alt=\"K-means. \" loading=\"lazy\" /><a target=\"_blank\" href=\"https://upload.wikimedia.org/wikipedia/commons/e/ea/K-means_convergence.gif\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 9</strong>:</span> K-means convergence (Wikimedia Commons)</figcaption></figure>\n\n  <p>In terms of single-cell data, for <em>G</em> genes, each datapoint is a G-dimensional cell. The distances between cells are computed using a <a href=\"#performing-the-clustering\">given metric</a>, and the k points are G-dimensional points indicating the centre of cluster. The k points are then updated for each iteration of the algorithm.</p>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>Why use G dimensions?</p>\n\n    <p>Why not use 2 dimensions as given in the graphic above?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <p>Using 2 dimensions will not capture all the variability in the data, and so the clustering will be based on whatever those 2 chosen dimensions are biased towards.</p>\n\n      <p>For example, if we performed a PCA first on the data and used only the first two (most variable) components of the data to perform clustering upon, we might be clustering cells based on cell-cycle variation which might be stronger than the actual biological signal that is perhaps hidden away in the higher PCA components.</p>\n\n    </blockquote>\n\n  </blockquote>\n\n</blockquote>\n\n<figure id=\"figure-10\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/heatmaps.png\" alt=\"Heatmaps. \" width=\"2019\" height=\"940\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/heatmaps.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 10</strong>:</span> RaceID Heatmaps for initial and final clusters</figcaption></figure>\n\n<p>The difference shown between the initial and final clustering is sometimes subtle depending which of the clusters the new clusters have been extracted from.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>Which new clusters have been added?</li>\n    <li>From which cells are these new clusters derived from?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li><code class=\"language-plaintext highlighter-rouge\">c13</code> and <code class=\"language-plaintext highlighter-rouge\">c14</code></li>\n      <li><code class=\"language-plaintext highlighter-rouge\">c13</code> appears between <code class=\"language-plaintext highlighter-rouge\">c8</code> and <code class=\"language-plaintext highlighter-rouge\">c1</code>, suggesting that the cells in <code class=\"language-plaintext highlighter-rouge\">c13</code> share a closer similarity to the cells in these clusters, which they were most likely extracted from. The other new cluster <code class=\"language-plaintext highlighter-rouge\">c14</code> is between <code class=\"language-plaintext highlighter-rouge\">c11</code> and <code class=\"language-plaintext highlighter-rouge\">c6</code>, suggesting similar points of extraction.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>All the following plots are heatmaps for the individual genes expressed in each cluster.</p>\n\n<figure id=\"figure-11\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/geneheatmaps.png\" alt=\"Gene Heatmaps. \" width=\"6500\" height=\"6500\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/geneheatmaps.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 11</strong>:</span> RaceID Individual (final) heatmaps for the top 10 significant genes in clusters 1 to 4</figcaption></figure>\n\n<p>The top 10 defining genes from each cluster (above only <code class=\"language-plaintext highlighter-rouge\">c1</code>-<code class=\"language-plaintext highlighter-rouge\">c4</code> are shown) give us an idea of how unique these genes are to the cluster.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>Which clusters are <em>Gstm3</em>, <em>St3gal4</em>, and <em>Gna11</em> highly expressed in?</li>\n    <li>Where is <em>Eef1a1</em> expressed?</li>\n    <li>Which cluster is poorly defined?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>(Top-Left Heatmap) <em>Gstm3</em>, <em>St3gal4</em>, and <em>Gna11</em> are highly expressed in <code class=\"language-plaintext highlighter-rouge\">c1</code> and <code class=\"language-plaintext highlighter-rouge\">c6</code></li>\n      <li><em>Eef1a1</em> is highly expressed everywhere, and so is not a very differentially expressed gene.</li>\n      <li><code class=\"language-plaintext highlighter-rouge\">c4</code> appears to be a not so well-defined cluster with no genes specifically bound to it.</li>\n    </ol>\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"visualising-all-clusters\">Visualising All Clusters</h2>\n\n<p>The previous section produced plots that spoke about the quality of the clustering without really showing us the clusters projected into an understandable 2D space. To perform this, we must feed the clustered data into the cluster inspection tool.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Task description</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspectclusters/raceid_inspectclusters/0.2.3+galaxy0\" title=\"Cluster Inspection using RaceID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster Inspection using RaceID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RaceID RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Clustering using RaceID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li><em>“Plot All Clusters?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Perform Subset Analysis?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Examine Genes of Interest”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Differential Gene Testing”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n      </ul>\n\n      <blockquote class=\"comment\">\n        <comment-title></comment-title>\n\n        <p>This tool can perform multiple different modes of inspection upon clustered scRNA data, and users are encouraged to explore the different modes.</p>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>The main issue with visualising this data is that as before, we have C cells that serve as our observations which are described by G genes. Representing G dimensional data in the 2 or 3 dimensional plots that we are more familiar falls under the problem of <a href=\"https://en.wikipedia.org/wiki/Dimensionality_reduction\"><em>dimensional reduction</em></a>.</p>\n\n<blockquote class=\"details\">\n  <details-title>Dimension Reduction</details-title>\n  <figure id=\"figure-12\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/dimred.svg\" alt=\"Dim red. \" width=\"854\" height=\"265\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/dimred.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 12</strong>:</span> Reducing a set of 4 observations from 3D to 2D space, whilst approximating the 3D relationships</figcaption></figure>\n\n  <p>Dimension reduction aims to preserve the distances and relationship of the higher dimensional (G-dimensional) data in a lower dimensional (usually 2D) space.</p>\n\n</blockquote>\n\n<p>Preserving these higher dimensional distances in lower dimensional space is a complex and ongoing challenge in computer science, but there are various commonly-used methods such as PCA and tSNE often encountered in single cell RNA-seq datasets. For more information, see the box below.</p>\n\n<blockquote class=\"details\">\n  <details-title>PCA, tSNE, and Force-Directed Graphs</details-title>\n\n  <ul>\n    <li><strong>PCA</strong> (Principle Component Analysis)\n      <ul>\n        <li>This linearly separates the N-dimensional data into N distinct components (or ‘axes’) of variability, sorted in descending order of variability (i.e. the first component explains most of the variation in the data, the second component contributes the second most amount of variation in the data, etc). For more information on how these components are derived, see <a href=\"https://en.wikipedia.org/wiki/Eigendecomposition_of_a_matrix\"><em>Eigendecomposition of a matrix</em></a>.</li>\n        <li>PCA has the benefit of being deterministic, uncostly to implement, and usually good enough to find clear differences in the data if the data is not complex.</li>\n      </ul>\n    </li>\n    <li><strong>tSNE</strong> (T-distributed Stochastic Neighbour Embedding)\n      <ul>\n        <li>PCA rests on the assumption that each of its N components are independent of one another, but this is often rarely the case and data usually exhibits more complexity than that of a linearly separable dataset. In these situations, tSNE outshines PCA, by modelling a more complex relationship between datapoints, and often produces better looking plots with more clearly defined clusters. This is especially the case in single-cell RNA-seq data which tends to describe a continuous blend of cell phenotypes, instead of discrete rigidly-defined types.</li>\n      </ul>\n    </li>\n    <li><strong>Force-Directed</strong> Graphs\n      <ul>\n        <li>These graphs can be better thought of as particle simulations, instead of performing any dimensional reduction, since all that is required is a connected graph. Forces are added to the connections between the nodes on the graph based on the strength of the connection, and then the whole system simulates the interplay of these forces for a number of iterations or until the system comes to rest. In general, these tend to yield much more nicely separated plots than tSNE, but it is not always the case and so it is always good practice to compare both force-directed and tSNE plots.</li>\n      </ul>\n    </li>\n  </ul>\n\n</blockquote>\n\n<p><strong>RaceID</strong> makes use of tSNE and force-directed (Fruchterman-Reingold) graph layouts to space the clusters in a visually meaningful manner to show the separation and relative proximity of clusters to one another.</p>\n\n<figure id=\"figure-13\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/tsne_umap_fr.png\" alt=\"Clusters. \" width=\"3758\" height=\"5491\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/tsne_umap_fr.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 13</strong>:</span> RaceID Initial and Final clusters using tSNE, UMAP and F-R projections</figcaption></figure>\n\n<p>The figure above displays the initial (left top/bottom) clusters detected during the clustering stage, as well as the final (right top/bottom) clusters determined during the outlier detection stage, projected using tSNE and Fruchterman-Rheingold graph layouts.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>What has changed between the initial and final plots?</li>\n    <li>Which clusters appear to be well defined? Are they consistent between projections?</li>\n    <li>Does this agree with the heatmaps we have seen previously?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>Two extra clusters are added in the final plots <code class=\"language-plaintext highlighter-rouge\">c13</code> and <code class=\"language-plaintext highlighter-rouge\">c14</code></li>\n      <li>For example, <code class=\"language-plaintext highlighter-rouge\">c11</code> appears to be an isolated well-defined cluster of cells, distinct in both projections. At the edge of the main cluster body in both projections lies <code class=\"language-plaintext highlighter-rouge\">c1</code>, but seems to be in closer proximity to <code class=\"language-plaintext highlighter-rouge\">c13</code> in the tSNE map than in the F-R layout. In both projections, <code class=\"language-plaintext highlighter-rouge\">c2</code>, <code class=\"language-plaintext highlighter-rouge\">c3</code>, and <code class=\"language-plaintext highlighter-rouge\">c4</code> are large noisy clusters, but <code class=\"language-plaintext highlighter-rouge\">c2</code> and <code class=\"language-plaintext highlighter-rouge\">c4</code> appear to be closer to one another in the F-R layout.</li>\n      <li><code class=\"language-plaintext highlighter-rouge\">c1</code> was better defined by a smaller set of genes than <code class=\"language-plaintext highlighter-rouge\">c2</code>, <code class=\"language-plaintext highlighter-rouge\">c3</code>, or <code class=\"language-plaintext highlighter-rouge\">c4,</code> which listed less differentially expressed genes as their most significant genes.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h3 id=\"is-this-expected\">Is this expected?</h3>\n\n<p>One pervasive thought when analysing single-cell RNA data, is “<em>is this actually good clustering?</em>”</p>\n\n<p>To answer this question, we must understand the nature of the data which <em>does</em> contain clear cell type phenotypes, but that these cell phenotypes are driven by continuous cell-cycle and cell developmental processes. As a result it is quite normal to see clusters ‘blending’ into one another, since these suggest intermediate cell types that are transitioning from one cell type to another.</p>\n\n<blockquote class=\"details\">\n  <details-title>Continuous Phenotypes vs Discrete Clustering Methods</details-title>\n\n  <figure id=\"figure-14\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/contpheno.svg\" alt=\"Continuous Phenotypes. \" width=\"869\" height=\"332\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/contpheno.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 14</strong>:</span> The continuous phenotypes along a red blood cell development trajectory</figcaption></figure>\n\n  <p>The gene expression profile for Reticulocytes is distinct from the gene expression profile for the mature Red Blood Cells that they will become, but the cells that are actually undergoing this short-lived transition from Reticulocyte to Red Blood Cell will not fit neatly into the two aforementioned gene expression profiles, instead having their own profile which lies somewhere in between.</p>\n\n  <p>As a result it is often false to think of cell clustering as an exercise in classification, but better to be thought of as a desire to find the relatedness between expression profiles. A helpful visual example of this is to not think of assigning cells to different disconnected ‘peaks’ of expression, but to place cells along an expression peak landscape that describes not only which expression profile they resemble the most, but along which gradient (or development trajectory) they adhere to, allowing transient cell types to be better assigned.</p>\n\n  <figure id=\"figure-15\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/mountains.svg\" alt=\"Discrete vs Continuous. \" width=\"652\" height=\"557\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/mountains.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 15</strong>:</span> (Above) Cells assigned to discrete profiles, compared to (Below) Cells placed along a continuous expression profile landscape.</figcaption></figure>\n\n  <p>The clustering of cells with single-cell RNA-seq data, is therefore not a classification problem, but a <em>manifold</em> detection one, where the manifold ultimately describes the topology of the data, and allows us to see relatedness between clusters.</p>\n\n</blockquote>\n\n<h1 id=\"individual-cluster-inspection\">Individual Cluster Inspection</h1>\n\n<p>To really understand the dynamics in the shifting profiles of gene expressions between different clusters, it is often useful to see specifically which genes are differentially expressed, and which clusters and cells they align to or define the most.</p>\n\n<p>There are three ways to do this in RaceID:</p>\n\n<ol>\n  <li>\n    <p><strong>MA Plot</strong></p>\n\n    <p>Perform a pairwise comparison between two clusters (or two sets of clusters) to see specifically which genes are differentially expressed between them.</p>\n  </li>\n  <li>\n    <p><strong>Subset Cell Analysis</strong></p>\n\n    <p>If the cell headers have names that contain information prior to the clustering about the different cell phenotypes, then it might be interesting to see if the cells do cluster as expected.</p>\n  </li>\n  <li>\n    <p><strong>Specific Expression Plots</strong></p>\n\n    <p>It may be of interest to look at how specific genes which may be markers for a cell type are expressed across different clusters, with the expectation that they are localised to a specific cluster depending on how specific the marker is.</p>\n  </li>\n</ol>\n\n<h2 id=\"differential-gene-analysis-between-two-clusters\">Differential Gene Analysis Between Two Clusters</h2>\n\n<p>We will generate an <a href=\"https://en.wikipedia.org/wiki/MA_plot\">MA Plot</a> between the two clusters, which looks at the differences between two samples by comparing the <em>M</em> (log ratio) against the <em>A</em> (mean average) of the sets.</p>\n\n<p>Here we will compare how the cells in cluster 1 are differentially expressed compared to the cell of cluster 3.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>MA plot</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspectclusters/raceid_inspectclusters/0.2.3+galaxy0\" title=\"Cluster Inspection using RaceID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster Inspection using RaceID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RaceID RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Clustering using RaceID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li><em>“Plot All Clusters?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Perform Subset Analysis?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Examine Genes of Interest”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Differential Gene Testing”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n          <ul>\n            <li>In <em>“Cells in Set A”</em>:\n              <ul>\n                <li><em>“Name of Set”</em>: <code class=\"language-plaintext highlighter-rouge\">Cells in 1</code></li>\n                <li><em>“Selection method”</em>: <code class=\"language-plaintext highlighter-rouge\">Cluster Numbers</code>\n                  <ul>\n                    <li><em>“List of clusters”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n            <li>In <em>“Cells in Set B”</em>:\n              <ul>\n                <li><em>“Name of Set”</em>: <code class=\"language-plaintext highlighter-rouge\">Cells in 3</code></li>\n                <li><em>“Selection method”</em>: <code class=\"language-plaintext highlighter-rouge\">Cluster Numbers</code>\n                  <ul>\n                    <li><em>“List of clusters”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<figure id=\"figure-16\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/clustinspect_cells.png\" alt=\"Cluster Inspection of Cells. \" width=\"886\" height=\"821\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/clustinspect_cells.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 16</strong>:</span> RaceID MA plot of cells in cluster 1 and cluster 3</figcaption></figure>\n\n<p>The genes shown as grey dots are not labelled because they are not so differentially expressed between the two clusters, but the genes as labelled red dots on the fringes do display significant variability between the clusters.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How do we interpret this plot?</li>\n    <li>Is <em>Gstm3</em> (at position 1.5, -2.7 on the MA plot) more significantly differentially expressed than <em>Ptma</em> (at position 3.6, 1.2)?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>Interpretation of plot:\n        <ul>\n          <li>The vertical axis displays the difference between cluster 3 and cluster 1, where the total counts of a gene in cluster 3 are subtracted by the total counts of a gene in cluster 1. Therefore, a gene which is in the negative portion of the vertical axis has more expression in cluster 1.</li>\n          <li>The horizontal axis displays the average expression of a gene in both clusters, and so serves as a yardstick to estimate how expressive that gene is overall.</li>\n        </ul>\n      </li>\n      <li><em>Gstm3</em> has a lower average expression in both clusters, than <em>Ptma</em> which is higher on the horizontal axis. However, <em>Gstm3</em> is expressed significantly more in Cluster 1, whereas <em>Ptma</em> is expressed only slightly more in Cluster 3. Overall, <em>Gstm3</em> is more differentially expressed than <em>Ptma</em>, and is up-regulated in Cluster 3, although with fewer total mRNA counts.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"differential-gene-expression-across-all-clusters\">Differential Gene Expression Across All Clusters</h2>\n\n<p>We will now look at some genes of interest to see how prevalent or unique they are across clusters. Usually known marker genes are used to identify clusters by their cell type and not just a number, but any gene of interest can be used if it is believed to characterise a cluster of cells.</p>\n\n<p>Here we will look at the combined expression of <em>Gstm3</em>, <em>St3gal4</em>, and <em>Gna11</em> which all had adjusted P-values of less than \\(1 \\cdot 10^{-15}\\) in cluster 1.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Task description</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspectclusters/raceid_inspectclusters/0.2.3+galaxy0\" title=\"Cluster Inspection using RaceID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Cluster Inspection using RaceID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RaceID RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Clustering using RaceID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li><em>“Plot All Clusters?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Perform Subset Analysis?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Examine Genes of Interest”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n          <ul>\n            <li><em>“Genes to Examine”</em>: <code class=\"language-plaintext highlighter-rouge\">Gstm3, St3gal4, Gna11</code></li>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n        <li><em>“Differential Gene Testing”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<figure id=\"figure-17\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/goi.png\" alt=\"Expression Plot. \" width=\"5993\" height=\"5408\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/goi.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 17</strong>:</span> RaceID Expression plot of genes of interest across different cells.</figcaption></figure>\n\n<p>The above figure shows where the combined expression of <em>Gstm3</em>, <em>St3gal4</em>, and <em>Gna11</em> is centred, which from the tSNE plot (top-left) appears to be concentrated in cluster 6. The log expression plot (top-right) changes the scale so that lesser expression in other clusters is still visible. The bottom images provide the same information but using the F-R layout.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>Observe the above expression plot and the clustering plot generated during the “<em>Visualising All Clusters</em>” step.</p>\n\n  <p>Are these genes (the top 3 DE genes from cluster 1) expressed where we expect them to be?</p>\n\n  <!--SNIPPET-->\n  <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-using-the-window-manager-to-view-multiple-datasets\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-using-the-window-manager-to-view-multiple-datasets\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Using the Window Manager to view multiple datasets</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>If you would like to view two or more datasets at once, you can use the <strong>Window Manager</strong> feature in Galaxy:</p>   <ol>   <li><strong>Click</strong> on the <em>Window Manager</em> icon <i class=\"fas fa-th\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-scratchbook</span> on the top menu bar.     <ul>       <li>You should see a little checkmark on the icon now</li>     </ul>   </li>   <li><strong>View</strong> <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> a dataset by clicking on the eye icon <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> to view the output     <ul>       <li>You should see the output in a window overlayed over Galaxy</li>       <li>You can resize this window by dragging the bottom-right corner</li>     </ul>   </li>   <li><strong>Click</strong> outside the file to exit the Window Manager</li>   <li><strong>View</strong> <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> a second dataset from your history     <ul>       <li>You should now see a second window with the new dataset</li>       <li>This makes it easier to compare the two outputs</li>     </ul>   </li>   <li>Repeat this for as many files as you would like to compare</li>   <li>You can turn off the <strong>Window Manager</strong> <i class=\"fas fa-th\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-scratchbook</span> by clicking on the icon again</li> </ol> </blockquote>\n  <p><!--END_SNIPPET--></p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>They appear to overlap <code class=\"language-plaintext highlighter-rouge\">c6</code> which is in close proximity to <code class=\"language-plaintext highlighter-rouge\">c1</code>. There are two reasons why this might be the case:</p>\n    <ol>\n      <li><code class=\"language-plaintext highlighter-rouge\">c1</code> is a small cluster and noisy cluster surrounded by more stably defined neighbours.</li>\n      <li>The three genes are more differentially expressed in <code class=\"language-plaintext highlighter-rouge\">c1</code> than in <code class=\"language-plaintext highlighter-rouge\">c6</code>, but they are more highly expressed in <code class=\"language-plaintext highlighter-rouge\">c6</code>. That is, their expression is more significant in <code class=\"language-plaintext highlighter-rouge\">c1</code> compared to the rest of the genes in that cluster.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h1 id=\"trajectory-and-lineage-analysis\">Trajectory and Lineage Analysis</h1>\n\n<p>It was <a href=\"#details-continuous-phenotypes-vs-discrete-clustering-methods\">mentioned previously</a> that the clusters displayed are not discrete entities, but are related through some continuous topology as inferred by intermediate cell types.</p>\n\n<p><strong>StemID</strong> is a tool (part of the <strong>RaceID</strong> package) that makes use of this topology to derive a hierarchy of these cell types by constructing a cell lineage tree, rooted at the cluster(s) believed to best describe multipotent progenitor stem cells, and terminating at the clusters which describe more mature cell types. Cell trajectories are identified as a sequence of links between the medoids of different clusters, where the links between clusters are assigned scores that reflect the level of multipotency of the cell type indicated by the cluster.</p>\n\n<h2 id=\"computing-the-lineage-tree\">Computing the Lineage Tree</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title></hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_trajectory/raceid_trajectory/0.2.3+galaxy0\" title=\"Lineage computation using StemID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Lineage computation using StemID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Clustering using RaceID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“Compute transcriptome entropy of each cell”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n        <li>In <em>“Compute Cell Projections for Randomised Background Distribution”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n        <li>In <em>“StemID2 Lineage Graph”</em>:\n          <ul>\n            <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>This tool has three main functions:</p>\n    <ol>\n      <li>Estimate the entropy (variability) of a cell</li>\n      <li>Estimate links/trajectories between clusters of cells</li>\n      <li>Generate a <a href=\"https://en.wikipedia.org/wiki/Minimum_spanning_tree\">minimum spanning tree</a> for the connected graph of links.</li>\n    </ol>\n\n    <p>We use the defaults in this section, but leave the fine-tuning of these parameters as an exercise for the more the statistically enthusiastic users.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<figure id=\"figure-18\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_lineage.png\" alt=\"Lineage Computation Plots. \" width=\"5843\" height=\"5720\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_lineage.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 18</strong>:</span> StemID Lineage Tree and Branches of significance.</figcaption></figure>\n\n<ul>\n  <li>\n    <p>(Top-Left) Minimum spanning tree showing most likely connections between clusters</p>\n  </li>\n  <li>\n    <p>(Top-Right) Minimum spanning tree with projected time series</p>\n  </li>\n  <li>\n    <p>(Bottom-Left) Significance between clusters</p>\n  </li>\n  <li>\n    <p>(Bottom-Right) Link scores between cluster-cluster pairs</p>\n  </li>\n</ul>\n\n<blockquote class=\"details\">\n  <details-title>StemID Lineage Plots</details-title>\n\n  <ul>\n    <li>(Top-Left) A minimum spanning tree that summarises the most likely connections between clusters.</li>\n    <li>(Top-Right) The same tree but with cells projected along the links given by StemID.\n      <ul>\n        <li>Ordering the cells along each link in such a way to suggest a time series, or <em>pseudo-time</em> analysis of each link. By ordering the cells by lineage pseudo-time we can trace the up/down regulation of a gene as discrete time points. The interval between each time point is hard to accurately determine, but the order of events is still important.</li>\n      </ul>\n    </li>\n    <li>(Bottom-Left) The degree of significance between clusters, with:\n      <ol>\n        <li>Node Colour, indicating the level of significance between clusters\n          <ul>\n            <li>Blue: Higher level of cluster entropy (associated with progenitor cell types)</li>\n            <li>Red: Lower level of cluster entropy (associated with mature types)</li>\n          </ul>\n        </li>\n        <li>Link Width, indicating the link score computed by <strong>StemID</strong>.\n          <ul>\n            <li>Indicates the number of cells in the cluster sharing the link to other.</li>\n          </ul>\n        </li>\n        <li>Link Colour, indicating link significance\n          <ul>\n            <li>Red: Stronger link level</li>\n            <li>Green: Weaker link level</li>\n          </ul>\n        </li>\n      </ol>\n    </li>\n    <li>(Bottom-Right) The link scores between each cluster-cluster pair.</li>\n  </ul>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>Which cluster pairs are likely to be biologically significant?</li>\n    <li>Based on the above plots, which cluster is most likely to be the main progenitor of the others?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>The thick red link between clusters 2-4, 3-5, and 3-1-6 are assumed to have a high level of biological significance.</li>\n      <li>\n        <p>On first glance, it appears that <code class=\"language-plaintext highlighter-rouge\">c2</code> would be the progenitor, due to the number of links it has and its more central position in the cluster plot.</p>\n\n        <ul>\n          <li>\n            <p><em>Cluster Tree Diagram:</em></p>\n\n            <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  c2\n  ├─ c4\n  ├─ c9\n  ├─ c8\n  │  ├─ c11\n  │  └─ c12\n  │     └─ c10\n  └─ c3\n     ├─ c5\n     └─ c1\n        └─ c6\n</code></pre></div>            </div>\n          </li>\n        </ul>\n      </li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>To see how the link score is actually calculated, the image below provides some context:</p>\n\n<figure id=\"figure-19\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_linkscores.png\" alt=\"Link scores. \" width=\"2996\" height=\"2996\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_linkscores.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 19</strong>:</span> StemID Link scores between branches.</figcaption></figure>\n\n<p>The top of the three charts shows the number of links above a threshold that each cluster exhibits to another. The more links a cluster has, the more evidence that the cluster describes a progenitor cell type that gives rise to other more mature types.</p>\n\n<p>The middle chart describes the “Delta-Entropy” which measures the variability of gene expression values within a cluster as the number of potential states (or cell types) it could produce, where clusters with more variability are less likely to be mature cell types due to the sheer “noise” that they exhibit that is to be expected of a cell type that could potentially give rise to other types.</p>\n\n<p>The bottom chart is simply the top chart multiplied by the middle chart, which adds both pieces of evidence together to yield the link score.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <p>With this new information, which cluster is now most likely to be the sole progenitor?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p><code class=\"language-plaintext highlighter-rouge\">c3</code> has both the most number of links as well as the most entropy that one would expect a multipotent progenitor cell type to exhibit, and therefore must be the root of the lineage tree, despite having the same number of links as <code class=\"language-plaintext highlighter-rouge\">c2</code>. The more centred position of <code class=\"language-plaintext highlighter-rouge\">c2</code> in the plots has no bearing on it being the initial progenitor type.</p>\n\n    <ul>\n      <li>\n        <p><em>Cluster Tree Diagram:</em></p>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  c3\n  ├─ c5\n  ├─ c1\n  │  └─ c6\n  └─ c2\n     ├─ c4\n     ├─ c9\n     └─ c8\n        ├─ c11\n        └─ c12\n            └─ c10\n</code></pre></div>        </div>\n      </li>\n    </ul>\n\n  </blockquote>\n\n</blockquote>\n\n<!--\n<figure id=\"figure-20\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_other.png\"  alt=\"Other link scores. \"  width=\"6500\" height=2996 loading=\"lazy\"><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_other.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br/><br/><figcaption><span class=\"figcaption-prefix\"><strong>Figure 20</strong>:</span> Other link scores between branches.</figcaption></figure>\n-->\n\n<p>In a similar vein to how clusters were explored individually in RaceID, we can also explore individual branches of the lineage tree to see how some genes are up or down regulated.</p>\n\n<h2 id=\"specific-trajectory-lineage-analysis-stemid\">Specific Trajectory Lineage Analysis (StemID)</h2>\n\n<p>Here we will explore one branching point of interest; <code class=\"language-plaintext highlighter-rouge\">c3</code> giving rise to <code class=\"language-plaintext highlighter-rouge\">c1</code> and <code class=\"language-plaintext highlighter-rouge\">c5</code>. Will we be able to find an up or down regulation of genes between these two branches?</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Comparing trajectory paths 3 to 1, and 3 to 5</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspecttrajectory/raceid_inspecttrajectory/0.2.3+galaxy0\" title=\"Lineage Branch Analysis using StemID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Lineage Branch Analysis using StemID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Lineage computation using StemID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“StemID Branch Link Examine”</em>:\n          <ul>\n            <li><em>“Perform StemID?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n              <ul>\n                <li><em>“Cluster Number”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n                <li><em>“Trajectory Path i, j, k”</em>: <code class=\"language-plaintext highlighter-rouge\">1,3,5</code></li>\n                <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li>In <em>“FateID Branch Link Examine”</em>:\n          <ul>\n            <li><em>“Perform FateID?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>This tool requires trajectories to be numerical order, hence the “<em>1,3,5</em>” ordering.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<figure id=\"figure-21\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_cells.png\" alt=\"Heatmap Cells. \" width=\"2955\" height=\"5672\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/stemid_cells.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 21</strong>:</span> (Top) StemID Minimal spanning tree of all cells projected along the links between clusters. (Bottom) StemID Heatmap of Cluster 3 cells compared to other clusters.</figcaption></figure>\n\n<p>The vertical names along the heatmap are the cells from <code class=\"language-plaintext highlighter-rouge\">c3</code> being compared to all other clusters.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How does the heatmap correlate to the minimum spanning tree (MST)?</li>\n    <li>How many <code class=\"language-plaintext highlighter-rouge\">c3</code> cells are strongly <em>dissimilar</em> to cells in <code class=\"language-plaintext highlighter-rouge\">c2</code>, <code class=\"language-plaintext highlighter-rouge\">c4</code>, <code class=\"language-plaintext highlighter-rouge\">c9</code>, <code class=\"language-plaintext highlighter-rouge\">c8</code>, and <code class=\"language-plaintext highlighter-rouge\">c11</code>. Where are they plotted on the MST?</li>\n    <li>Many <code class=\"language-plaintext highlighter-rouge\">c3</code> cells appear to have stronger (red/orange) correlation to <code class=\"language-plaintext highlighter-rouge\">c2</code> and <code class=\"language-plaintext highlighter-rouge\">c4</code>, instead of the expected <code class=\"language-plaintext highlighter-rouge\">c5</code> and <code class=\"language-plaintext highlighter-rouge\">c1</code> shown in the MST, yet <code class=\"language-plaintext highlighter-rouge\">c2</code> is further away than <code class=\"language-plaintext highlighter-rouge\">c5</code> or <code class=\"language-plaintext highlighter-rouge\">c1</code>. Why is this?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>Each <code class=\"language-plaintext highlighter-rouge\">c3</code> cell in the heatmap is “pulled” towards different clusters along a straight line in the MST. The degree to which it is pulled is given by the strength of the correlation of that cell to that cluster. For example cell <em>I5d_45</em> has a very strong correlation to <code class=\"language-plaintext highlighter-rouge\">c12</code> and <code class=\"language-plaintext highlighter-rouge\">c10</code>, and so it appears on the MST as a single (3) lying in between the <code class=\"language-plaintext highlighter-rouge\">c3</code>,<code class=\"language-plaintext highlighter-rouge\">c12</code>,<code class=\"language-plaintext highlighter-rouge\">c10</code> triangle.</li>\n      <li>10 <code class=\"language-plaintext highlighter-rouge\">c3</code> cells (III5d-53 to I5d-48) show negative (blue) correlation to these clusters, and these same cells have a strong correlation to <code class=\"language-plaintext highlighter-rouge\">c5</code> or <code class=\"language-plaintext highlighter-rouge\">c1</code> clusters. We can see these cells plotted along the links to these two clusters.</li>\n      <li>The <code class=\"language-plaintext highlighter-rouge\">c3</code> cells strongly correlated to <code class=\"language-plaintext highlighter-rouge\">c2</code> and <code class=\"language-plaintext highlighter-rouge\">c4</code> are also strongly correlated to <code class=\"language-plaintext highlighter-rouge\">c9</code>, <code class=\"language-plaintext highlighter-rouge\">c8</code>, and <code class=\"language-plaintext highlighter-rouge\">c11</code> - i.e. these cells have noisy profiles and are outliers in <code class=\"language-plaintext highlighter-rouge\">c3</code>. Note that the 10 cells we identified in the previous question are not strongly correlated to other clusters except <code class=\"language-plaintext highlighter-rouge\">c5</code> and <code class=\"language-plaintext highlighter-rouge\">c1</code>, meaning they have very clear trajectories.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<!--  This table is confusing and I doubt anyone will use it.\n\nThe *Differential Genes* tabular file provides an ordered list of z-scores indicating the degree of up-regulation from the link 3 to 1 compared to 3 to 5, for `c3` cells.\n\n\n | Gene | Z-score |\n |------|---------------------------|\n | Chmp1a | 1.35614489404017 |\n | Prpsap1 | 1.27561406917734 |\n | Cyb5r3 | 1.24373637026355 |\n | St3gal4 | 1.07824983159662 |\n | Atp5g1 | 1.07747110336794 |\n | Abcb1a | 1.06445701695433 |\n | Tlr3 | 1.05483917876983 |\n | Mrpl9 | 1.04546441547305 |\n | Ces2a | 1.03563183389053 |\n | Dgat1 | 0.996275665669355 |\n\nUnsurprisingly, there is a higher score for the 3 to 1 trajectory for `c1` cells.\n-->\n\n<h2 id=\"specific-trajectory-fate-analysis-fateid\">Specific Trajectory Fate Analysis (FateID)</h2>\n\n<p>One final trajectory analysis that can be performed uses <strong>FateID</strong>, which tries to quantify the cell fate bias a progenitor type might exhibit to indicate which lineage path it will pursue.</p>\n\n<p>Where <strong>StemID</strong> utilises a bottom-up approach by starting from mature cell types and working up to the multi-potent progenitor, <strong>FateID</strong> uses top-down approach that starts from the progenitor and works its way down.</p>\n\n<p>Here we will see if we can see any pseudo-time dynamics taking place between the branching point (3 to 1, and 3 to 5) that we explored previously.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title></hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspecttrajectory/raceid_inspecttrajectory/0.2.3+galaxy0\" title=\"Lineage Branch Analysis using StemID tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Lineage Branch Analysis using StemID</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.2.3+galaxy0)</span>  with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input RDS”</em>: <code class=\"language-plaintext highlighter-rouge\">outrdat</code> (output of <strong>Lineage computation using StemID</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li>In <em>“StemID Branch Link Examine”</em>:\n          <ul>\n            <li><em>“Perform StemID?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n          </ul>\n        </li>\n        <li>In <em>“FateID Branch Link Examine”</em>:\n          <ul>\n            <li><em>“Perform FateID?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n              <ul>\n                <li><em>“Cells from Clusters”</em>: <code class=\"language-plaintext highlighter-rouge\">1,3,5</code></li>\n                <li><em>“Use Defaults?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n                <li><em>“Perform Additional FateID Analysis with Self-Organised Map?”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<figure id=\"figure-22\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/fateid.png\" alt=\"Heatmap FateID. \" width=\"6098\" height=\"6026\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/fateid.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 22</strong>:</span> FateID Heatmap</figcaption></figure>\n\n<p>The heatmaps generated depict the same data, but at different “heat” scales to better colourise the map. The genes here are not genes, but are gene expression modules, which can be interpreted as gene motifs that are present in both <code class=\"language-plaintext highlighter-rouge\">c1</code> and <code class=\"language-plaintext highlighter-rouge\">c5</code>, but at different levels of expression.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>To which trajectory are gene modules 1-17 up regulated?</li>\n    <li>Do modules 18-40 exhibit a similar pattern?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>We can see a significant up-regulation in the expression of the 1-17 modules along the 3 to 1 trajectory, which does not exist in the 3 to 5 trajectory.</li>\n      <li>The 18-40 modules are down-regulation in the 3 to 1 trajectory, and constant expression along the 3 to 5 trajectory.</li>\n    </ol>\n  </blockquote>\n\n</blockquote>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>In this tutorial we have learned to filter, normalise, and cluster cells from heterogeneous single-cell RNA-seq data. We have explored the expression of marker genes and performed a differential gene expression analysis between two sets of clusters. We have also constructed a lineage tree from these clusters, and analysed different branching points of interest to infer a pseudo-time ordering of cells as determined by the regulation of their genes.</p>\n\n<p>The steps of this workflow can be found in the related workflow.</p>\n\n<figure id=\"figure-23\" style=\"max-width: 90%;\"><img src=\"/training-material/topics/single-cell/images/scrna-raceid/workflow.png\" alt=\"Workflow. \" width=\"1111\" height=\"707\" loading=\"lazy\" /><a target=\"_blank\" href=\"/training-material/topics/single-cell/images/scrna-raceid/workflow.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 23</strong>:</span> RaceID Workflow</figcaption></figure>\n\n<p>All steps of the workflow have produced an R Data object (RDS) that serves as an input into the next step, but these objects can also be loaded into an R environment and analysed using any desired library.</p>\n\n<p>This tutorial is part of the https://singlecell.usegalaxy.eu portal (<span class=\"citation\"><a href=\"#tekman2020single\">Tekman <i>et al.</i> 2020</a></span>).</p>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-11-03 14:30:27 +0000","pub_date":"2019-03-25 16:14:31 +0000","version":7,"workflows":[{"workflow":"main_workflow.ga","tests":false,"url":"https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-raceid/workflows/main_workflow.ga","path":"topics/single-cell/tutorials/scrna-raceid/workflows/main_workflow.ga","wfid":"single-cell-scrna-raceid","wfname":"main_workflow","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/single-cell-scrna-raceid/versions/main_workflow","license":null,"creators":[],"name":"RaceID Workflow","title":"RaceID Workflow","test_results":null,"modified":"2024-06-24 07:44:30 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nTabular Matrix\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"Initial processing using RaceID\"];\n  0 -->|output| 1;\n  2[\"Clustering using RaceID\"];\n  1 -->|outrdat| 2;\n  3[\"Lineage computation using StemID\"];\n  2 -->|outrdat| 3;\n  4[\"Cluster Inspection using RaceID\"];\n  2 -->|outrdat| 4;\n  5[\"Cluster Inspection using RaceID\"];\n  2 -->|outrdat| 5;\n  6[\"Cluster Inspection using RaceID\"];\n  2 -->|outrdat| 6;\n  7[\"Lineage Branch Analysis using StemID\"];\n  3 -->|outrdat| 7;\n  8[\"Lineage Branch Analysis using StemID\"];\n  3 -->|outrdat| 8;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/single-cell/tutorials/scrna-raceid/tutorial.json","tools":["raceid_clustering","raceid_filtnormconf","raceid_inspectclusters","raceid_inspecttrajectory","raceid_trajectory","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_head_tool/1.1.0","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_sed_tool/1.1.1","toolshed.g2.bx.psu.edu/repos/iuc/datamash_ops/datamash_ops/1.1.0","toolshed.g2.bx.psu.edu/repos/iuc/datamash_transpose/datamash_transpose/1.1.0","toolshed.g2.bx.psu.edu/repos/iuc/raceid_clustering/raceid_clustering/0.2.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/raceid_filtnormconf/raceid_filtnormconf/0.2.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspectclusters/raceid_inspectclusters/0.2.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/raceid_inspecttrajectory/raceid_inspecttrajectory/0.2.3+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/raceid_trajectory/raceid_trajectory/0.2.3+galaxy0"],"supported_servers":{"exact":[],"inexact":[]},"topic_name_human":"Single Cell","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"datamash_ops","owner":"iuc","revisions":"562f3c677828","tool_panel_section_label":"Join, Subtract and Group","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"datamash_transpose","owner":"iuc","revisions":"22c2a1ac7ae3","tool_panel_section_label":"Join, Subtract and Group","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raceid_clustering","owner":"iuc","revisions":"a4b734cd253b","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raceid_filtnormconf","owner":"iuc","revisions":"43c146e25a43","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raceid_inspectclusters","owner":"iuc","revisions":"41f34e925bd5","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raceid_inspecttrajectory","owner":"iuc","revisions":"c8434a623268","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raceid_trajectory","owner":"iuc","revisions":"72979cac22b2","tool_panel_section_label":"Single-cell","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: datamash_ops\n  owner: iuc\n  revisions: 562f3c677828\n  tool_panel_section_label: Join, Subtract and Group\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: datamash_transpose\n  owner: iuc\n  revisions: 22c2a1ac7ae3\n  tool_panel_section_label: Join, Subtract and Group\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raceid_clustering\n  owner: iuc\n  revisions: a4b734cd253b\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raceid_filtnormconf\n  owner: iuc\n  revisions: 43c146e25a43\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raceid_inspectclusters\n  owner: iuc\n  revisions: 41f34e925bd5\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raceid_inspecttrajectory\n  owner: iuc\n  revisions: c8434a623268\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raceid_trajectory\n  owner: iuc\n  revisions: 72979cac22b2\n  tool_panel_section_label: Single-cell\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}