{"layout":"tutorial_hands_on","title":"SQL with Python","level":"Intermediate","zenodo_link":null,"requirements":[{"type":"internal","topic_name":"data-science","tutorials":["sql-advanced"]}],"follow_up_training":[],"questions":["How can I access databases from programs written in Python?"],"objectives":["Write short programs that execute SQL queries.","Trace the execution of a program that contains an SQL query.","Explain why most database applications are written in a general-purpose language rather than in SQL."],"time_estimation":"45M","key_points":["General-purpose languages have libraries for accessing databases.","To connect to a database, a program must use a library specific to that database manager.","These libraries use a connection-and-cursor model.","Programs can read query results in batches or all at once.","Queries should be written using parameter substitution, not string formatting."],"contributors":[{"name":"The Carpentries","joined":"2021-09","id":"carpentries","url":"https://training.galaxyproject.org/training-material/api/organisations/carpentries.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/carpentries/"},{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"},{"name":"Avans Hogeschool","joined":"2020-11","url":"https://training.galaxyproject.org/training-material/api/organisations/avans-atgm.json","avatar":"/training-material/shared/images/logo-avans.png","members":["bazante1"],"former_members":["dirowa","hexylena"],"id":"avans-atgm","page":"https://training.galaxyproject.org/training-material/hall-of-fame/avans-atgm/"}],"subtopic":"sql","notebook":{"language":"python"},"tags":["SQL","Python","jupyter-notebook"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00109","url":"/topics/data-science/tutorials/sql-python/tutorial.html","topic_name":"data-science","tutorial_name":"sql-python","dir":"topics/data-science/tutorials/sql-python","symlink":null,"id":"data-science/sql-python","ref_tutorials":["<p>This tutorial will introduce you to accessing a SQL database from within Python. Experience with both SQL and Python is a pre-requisite.</p>\n\n<blockquote class=\"comment\">\n  <comment-title></comment-title>\n\n  <p>This tutorial is <strong>significantly</strong> based on <a href=\"https://carpentries.org\">the Carpentries</a> <a href=\"https://github.com/swcarpentry/sql-novice-survey/\">Databases and SQL</a> lesson, which is licensed CC-BY 4.0.</p>\n\n  <p>Abigail Cabunoc and Sheldon McKay (eds): “Software Carpentry: Using Databases and SQL.”  Version 2017.08, August 2017,\n<a href=\"https://github.com/swcarpentry/sql-novice-survey\">github.com/swcarpentry/sql-novice-survey</a>, <a href=\"https://doi.org/10.5281/zenodo.838776\">https://doi.org/10.5281/zenodo.838776</a></p>\n\n  <p>Adaptations have been made to make this work better in a GTN/Galaxy environment.</p>\n</blockquote>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#programming-with-databases---python\" id=\"markdown-toc-programming-with-databases---python\">Programming with Databases - Python</a></li>\n</ol>\n\n</blockquote>\n\n<p>For this tutorial we need to download a database that we will use for the queries.</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"err\">!</span><span class=\"n\">wget</span> <span class=\"o\">-</span><span class=\"n\">c</span> <span class=\"n\">http</span><span class=\"p\">:</span><span class=\"o\">//</span><span class=\"n\">swcarpentry</span><span class=\"p\">.</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">/</span><span class=\"n\">sql</span><span class=\"o\">-</span><span class=\"n\">novice</span><span class=\"o\">-</span><span class=\"n\">survey</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">survey</span><span class=\"p\">.</span><span class=\"n\">db</span>\n</code></pre></div></div>\n\n<h1 id=\"programming-with-databases---python\">Programming with Databases - Python</h1>\n\n<p>Let’s have a look at how to access a database from\na general-purpose programming language like Python.\nOther languages use almost exactly the same model:\nlibrary and function names may differ,\nbut the concepts are the same.</p>\n\n<p>Here’s a short Python program that selects latitudes and longitudes\nfrom an SQLite database stored in a file called <code class=\"language-plaintext highlighter-rouge\">survey.db</code>:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sqlite3</span>\n\n<span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">survey.db</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n<span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n<span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">SELECT Site.lat, Site.long FROM Site;</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n<span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">fetchall</span><span class=\"p\">()</span>\n<span class=\"k\">for</span> <span class=\"n\">r</span> <span class=\"ow\">in</span> <span class=\"n\">results</span><span class=\"p\">:</span>\n    <span class=\"nf\">print</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n<span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n<span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n</code></pre></div></div>\n\n<p>The program starts by importing the <code class=\"language-plaintext highlighter-rouge\">sqlite3</code> library.\nIf we were connecting to MySQL, DB2, or some other database,\nwe would import a different library,\nbut all of them provide the same functions,\nso that the rest of our program does not have to change\n(at least, not much)\nif we switch from one database to another.</p>\n\n<p>Line 2 establishes a connection to the database.\nSince we’re using SQLite,\nall we need to specify is the name of the database file.\nOther systems may require us to provide a username and password as well.\nLine 3 then uses this connection to create a cursor.\nJust like the cursor in an editor,\nits role is to keep track of where we are in the database.</p>\n\n<p>On line 4, we use that cursor to ask the database to execute a query for us.\nThe query is written in SQL,\nand passed to <code class=\"language-plaintext highlighter-rouge\">cursor.execute</code> as a string.\nIt’s our job to make sure that SQL is properly formatted;\nif it isn’t,\nor if something goes wrong when it is being executed,\nthe database will report an error.</p>\n\n<p>The database returns the results of the query to us\nin response to the <code class=\"language-plaintext highlighter-rouge\">cursor.fetchall</code> call on line 5.\nThis result is a list with one entry for each record in the result set;\nif we loop over that list (line 6) and print those list entries (line 7),\nwe can see that each one is a tuple\nwith one element for each field we asked for.</p>\n\n<p>Finally, lines 8 and 9 close our cursor and our connection,\nsince the database can only keep a limited number of these open at one time.\nSince establishing a connection takes time,\nthough,\nwe shouldn’t open a connection,\ndo one operation,\nthen close the connection,\nonly to reopen it a few microseconds later to do another operation.\nInstead,\nit’s normal to create one connection that stays open for the lifetime of the program.</p>\n\n<p>Queries in real applications will often depend on values provided by users.\nFor example,\nthis function takes a user’s ID as a parameter and returns their name:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sqlite3</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">person_id</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">SELECT personal || </span><span class=\"sh\">'</span><span class=\"s\"> </span><span class=\"sh\">'</span><span class=\"s\"> || family FROM Person WHERE id=</span><span class=\"sh\">'\"</span> <span class=\"o\">+</span> <span class=\"n\">person_id</span> <span class=\"o\">+</span> <span class=\"sh\">\"'</span><span class=\"s\">;</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n    <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">results</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n<span class=\"nf\">print</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">Full name for dyer:</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">dyer</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n</code></pre></div></div>\n\n<p>We use string concatenation on the first line of this function\nto construct a query containing the user ID we have been given.\nThis seems simple enough,\nbut what happens if someone gives us this string as input?</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dyer'; DROP TABLE Survey; SELECT '\n</code></pre></div></div>\n\n<p>It looks like there’s garbage after the user’s ID,\nbut it is very carefully chosen garbage.\nIf we insert this string into our query,\nthe result is:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>SELECT personal || ' ' || family FROM Person WHERE id='dyer'; DROP TABLE Survey; SELECT '';\n</code></pre></div></div>\n\n<p>If we execute this,\nit will erase one of the tables in our database.</p>\n\n<p>This is called an SQL injection attack,\nand it has been used to attack thousands of programs over the years.\nIn particular,\nmany web sites that take data from users insert values directly into queries\nwithout checking them carefully first.\nA very <a href=\"https://xkcd.com/327/\">relevant XKCD</a> that explains the\ndangers of using raw input in queries a little more succinctly:</p>\n\n<p><a href=\"../../images/xkcd/exploits_of_a_mom.png\" rel=\"noopener noreferrer\"><img src=\"../../images/xkcd/exploits_of_a_mom.png\" alt=\"A 4 panel comic, in the first panel a person is shown answering the phone, hearing that their son's school has some computer trouble. In panel 2 they apologises asking if their child broke something. In panel 3, the unseen person on the other end of the phone call asks if they really named their son Robert'); Drop table students;--? They respond saying 'oh yes. little bobby tables we call him.' In the 4th panel the caller says 'well we have lost this years student records, I hope you're happy.' They respond 'And I hope you've learned to sanitize your database inputs'.\" width=\"666\" height=\"205\" loading=\"lazy\" /></a></p>\n\n<p>Since a villain might try to smuggle commands into our queries in many different ways,\nthe safest way to deal with this threat is\nto replace characters like quotes with their escaped equivalents,\nso that we can safely put whatever the user gives us inside a string.\nWe can do this by using a prepared statement\ninstead of formatting our statements as strings.\nHere’s what our example program looks like if we do this:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sqlite3</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">person_id</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">SELECT personal || </span><span class=\"sh\">'</span><span class=\"s\"> </span><span class=\"sh\">'</span><span class=\"s\"> || family FROM Person WHERE id=?;</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">person_id</span><span class=\"p\">])</span>\n    <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">results</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n<span class=\"nf\">print</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">Full name for dyer:</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">dyer</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n</code></pre></div></div>\n\n<p>The key changes are in the query string and the <code class=\"language-plaintext highlighter-rouge\">execute</code> call.\nInstead of formatting the query ourselves,\nwe put question marks in the query template where we want to insert values.\nWhen we call <code class=\"language-plaintext highlighter-rouge\">execute</code>,\nwe provide a list\nthat contains as many values as there are question marks in the query.\nThe library matches values to question marks in order,\nand translates any special characters in the values\ninto their escaped equivalents\nso that they are safe to use.</p>\n\n<p>We can also use <code class=\"language-plaintext highlighter-rouge\">sqlite3</code>’s cursor to make changes to our database,\nsuch as inserting a new name.\nFor instance, we can define a new function called <code class=\"language-plaintext highlighter-rouge\">add_name</code> like so:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sqlite3</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">add_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">new_person</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">INSERT INTO Person (id, personal, family) VALUES (?, ?, ?);</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">new_person</span><span class=\"p\">))</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">person_id</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">SELECT personal || </span><span class=\"sh\">'</span><span class=\"s\"> </span><span class=\"sh\">'</span><span class=\"s\"> || family FROM Person WHERE id=?;</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">person_id</span><span class=\"p\">])</span>\n    <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">results</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n<span class=\"c1\"># Insert a new name\n</span><span class=\"nf\">add_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">barrett</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">Mary</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">Barrett</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n<span class=\"c1\"># Check it exists\n</span><span class=\"nf\">print</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">Full name for barrett:</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">barrett</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n</code></pre></div></div>\n\n<p>Note that in versions of sqlite3 &gt;= 2.5, the <code class=\"language-plaintext highlighter-rouge\">get_name</code> function described\nabove will fail with an <code class=\"language-plaintext highlighter-rouge\">IndexError: list index out of range</code>,\neven though we added Mary’s\nentry into the table using <code class=\"language-plaintext highlighter-rouge\">add_name</code>.\nThis is because we must perform a <code class=\"language-plaintext highlighter-rouge\">connection.commit()</code> before closing\nthe connection, in order to save our changes to the database.</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sqlite3</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">add_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">new_person</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">INSERT INTO Person (id, personal, family) VALUES (?, ?, ?);</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">new_person</span><span class=\"p\">))</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">commit</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">,</span> <span class=\"n\">person_id</span><span class=\"p\">):</span>\n    <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">SELECT personal || </span><span class=\"sh\">'</span><span class=\"s\"> </span><span class=\"sh\">'</span><span class=\"s\"> || family FROM Person WHERE id=?;</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">sqlite3</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"n\">database_file</span><span class=\"p\">)</span>\n    <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">person_id</span><span class=\"p\">])</span>\n    <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">fetchall</span><span class=\"p\">()</span>\n    <span class=\"n\">cursor</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n    <span class=\"n\">connection</span><span class=\"p\">.</span><span class=\"nf\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">results</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n<span class=\"c1\"># Insert a new name\n</span><span class=\"nf\">add_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">barrett</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">Mary</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">Barrett</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n<span class=\"c1\"># Check it exists\n</span><span class=\"nf\">print</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">Full name for barrett:</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"nf\">get_name</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">survey.db</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">barrett</span><span class=\"sh\">'</span><span class=\"p\">))</span>\n</code></pre></div></div>\n\n<blockquote class=\"question\">\n  <question-title>Filling a Table vs. Printing Values</question-title>\n\n  <p>Write a Python program that creates a new database in a file called\n<code class=\"language-plaintext highlighter-rouge\">original.db</code> containing a single table called <code class=\"language-plaintext highlighter-rouge\">Pressure</code>, with a\nsingle field called <code class=\"language-plaintext highlighter-rouge\">reading</code>, and inserts 100,000 random numbers\nbetween 10.0 and 25.0.  How long does it take this program to run?\nHow long does it take to run a program that simply writes those\nrandom numbers to a file?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <div class=\"language-plaintext python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import sqlite3\n# import random number generator\nfrom numpy.random import uniform\n\nrandom_numbers = uniform(low=10.0, high=25.0, size=100000)\n\nconnection = sqlite3.connect(\"original.db\")\ncursor = connection.cursor()\ncursor.execute(\"CREATE TABLE Pressure (reading float not null)\")\nquery = \"INSERT INTO Pressure (reading) VALUES (?);\"\n\nfor number in random_numbers:\n    cursor.execute(query, [number])\n\ncursor.close()\nconnection.commit() # save changes to file for next exercise\nconnection.close()\n</code></pre></div>    </div>\n\n    <p>For comparison, the following program writes the random numbers\ninto the file <code class=\"language-plaintext highlighter-rouge\">random_numbers.txt</code>:</p>\n\n    <div class=\"language-plaintext python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>from numpy.random import uniform\n\nrandom_numbers = uniform(low=10.0, high=25.0, size=100000)\nwith open('random_numbers.txt', 'w') as outfile:\n    for number in random_numbers:\n        # need to add linebreak \\n\n        outfile.write(\"{}\\n\".format(number))\n</code></pre></div>    </div>\n  </blockquote>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title>Filtering in SQL vs. Filtering in Python</question-title>\n\n  <p>Write a Python program that creates a new database called\n<code class=\"language-plaintext highlighter-rouge\">backup.db</code> with the same structure as <code class=\"language-plaintext highlighter-rouge\">original.db</code> and copies all\nthe values greater than 20.0 from <code class=\"language-plaintext highlighter-rouge\">original.db</code> to <code class=\"language-plaintext highlighter-rouge\">backup.db</code>.\nWhich is faster: filtering values in the query, or reading\neverything into memory and filtering in Python?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <p>The first example reads all the data into memory and filters the\nnumbers using the if statement in Python.</p>\n\n    <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import sqlite3\n\nconnection_original = sqlite3.connect(\"original.db\")\ncursor_original = connection_original.cursor()\ncursor_original.execute(\"SELECT * FROM Pressure;\")\nresults = cursor_original.fetchall()\ncursor_original.close()\nconnection_original.close()\n\nconnection_backup = sqlite3.connect(\"backup.db\")\ncursor_backup = connection_backup.cursor()\ncursor_backup.execute(\"CREATE TABLE Pressure (reading float not null)\")\nquery = \"INSERT INTO Pressure (reading) VALUES (?);\"\n\nfor entry in results:\n    # number is saved in first column of the table\n    if entry[0] &gt; 20.0:\n        cursor_backup.execute(query, entry)\n\ncursor_backup.close()\nconnection_backup.commit()\nconnection_backup.close()\n</code></pre></div>    </div>\n\n    <p>In contrast the following example uses the conditional <code class=\"language-plaintext highlighter-rouge\">SELECT</code> statement\nto filter the numbers in SQL.\nThe only lines that changed are in line 5, where the values are fetched\nfrom <code class=\"language-plaintext highlighter-rouge\">original.db</code> and the for loop starting in line 15 used to insert\nthe numbers into <code class=\"language-plaintext highlighter-rouge\">backup.db</code>.\nNote how this version does not require the use of Python’s if statement.</p>\n\n    <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import sqlite3\n\nconnection_original = sqlite3.connect(\"original.db\")\ncursor_original = connection_original.cursor()\ncursor_original.execute(\"SELECT * FROM Pressure WHERE reading &gt; 20.0;\")\nresults = cursor_original.fetchall()\ncursor_original.close()\nconnection_original.close()\n\nconnection_backup = sqlite3.connect(\"backup.db\")\ncursor_backup = connection_backup.cursor()\ncursor_backup.execute(\"CREATE TABLE Pressure (reading float not null)\")\nquery = \"INSERT INTO Pressure (reading) VALUES (?);\"\n\nfor entry in results:\n    cursor_backup.execute(query, entry)\n\ncursor_backup.close()\nconnection_backup.commit()\nconnection_backup.close()\n</code></pre></div>    </div>\n\n  </blockquote>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title>Generating Insert Statements</question-title>\n\n  <p>One of our colleagues has sent us a\nCSV\nfile containing\ntemperature readings by Robert Olmstead, which is formatted like\nthis:</p>\n\n  <div class=\"language-plaintext output highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Taken,Temp\n619,-21.5\n622,-15.5\n</code></pre></div>  </div>\n\n  <p>Write a small Python program that reads this file in and prints out\nthe SQL <code class=\"language-plaintext highlighter-rouge\">INSERT</code> statements needed to add these records to the\nsurvey database.  Note: you will need to add an entry for Olmstead\nto the <code class=\"language-plaintext highlighter-rouge\">Person</code> table.  If you are testing your program repeatedly,\nyou may want to investigate SQL’s <code class=\"language-plaintext highlighter-rouge\">INSERT or REPLACE</code> command.</p>\n</blockquote>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-11-15 11:27:38 +0000","pub_date":"2021-10-11 14:22:29 +0000","version":9,"api":"https://training.galaxyproject.org/training-material/api/topics/data-science/tutorials/sql-python/tutorial.json","tools":[],"supported_servers":{"exact":[],"inexact":[{"name":"UseGalaxy.eu","url":"https://usegalaxy.eu","id":"eu","human":"Galaxy Europe","usegalaxy":true},{"name":"UseGalaxy.org","url":"https://usegalaxy.org","id":"us","human":"Galaxy Main","usegalaxy":true},{"name":"UseGalaxy.org.au","url":"https://usegalaxy.org.au","id":"au","human":"Galaxy Australia","usegalaxy":true},{"name":"UseGalaxy.fr","url":"https://usegalaxy.fr","id":"fr","human":"Galaxy France","usegalaxy":true}]},"topic_name_human":"Foundations of Data Science","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}