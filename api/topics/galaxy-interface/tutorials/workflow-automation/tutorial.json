{"layout":"tutorial_hands_on","title":"Automating Galaxy workflows using the command line","tags":["workflows","variant-analysis","covid19"],"zenodo_link":"","questions":["How can I schedule and run tens or hundreds of Galaxy workflows easily?","How can I automate my analyses when large amounts of data are being produced daily?"],"objectives":["Learn to use the `planemo run` subcommand to run workflows from the command line.","Be able to write simple shell scripts for running multiple workflows concurrently or sequentially.","Learn how to use Pangolin to assign annotated variants to lineages."],"time_estimation":"2h","key_points":["Workflows can be executed not only through the web browser, but also via the command line.","Executing workflows programmatically allows automation of analyses."],"requirements":[{"title":"Familiarity with Galaxy and basic associated concepts, in particular workflows","type":"none"},{"title":"Basic knowledge of the command line","type":"none"}],"contributors":[{"name":"Simon Bray","joined":"2019-05","elixir_node":"de","former_affiliations":["uni-freiburg","elixir-europe"],"id":"simonbray","url":"https://training.galaxyproject.org/training-material/api/contributors/simonbray.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/simonbray/"},{"name":"Wolfgang Maier","orcid":"0000-0002-9464-6640","matrix":"wm75:matrix.org","joined":"2017-09","elixir_node":"de","fediverse":"https://scholar.social/@zerodivision","fediverse_flavor":"mastodon","affiliations":["by-covid","uni-freiburg","elixir-europe"],"id":"wm75","url":"https://training.galaxyproject.org/training-material/api/contributors/wm75.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/wm75/"}],"subtopic":"workflows","recordings":[{"captioners":["simonbray"],"date":"2021-02-15","galaxy_version":"21.01","length":"30M","youtube_id":"o39QjVnLG68","speakers":["simonbray"]}],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00162","url":"/topics/galaxy-interface/tutorials/workflow-automation/tutorial.html","topic_name":"galaxy-interface","tutorial_name":"workflow-automation","dir":"topics/galaxy-interface/tutorials/workflow-automation","symlink":null,"id":"galaxy-interface/workflow-automation","ref_tutorials":["<p>Galaxy is well-known as a web-based data analysis platform which provides a graphical interface for executing common bioinformatics tools in a reproducible manner. However, Galaxy is not just a user-friendly interface for executing one tool at a time. It provides two very useful features which allow scaling data analyses up to a high-throughput level: dataset collections and workflows.</p>\n\n<ul>\n  <li>\n    <p>Dataset collections represent groups of similar datasets. This doesn’t sound especially exciting, but it gets interesting when a tool is executed using a collection as input, where a single dataset would normally be created. In this case, Galaxy creates a new job for every dataset contained within the collection, and stores the tool outputs in a new collection (or collections, if there are multiple outputs) with the same size and structure as the input. This process is referred to as ‘mapping over’ the input collection.</p>\n  </li>\n  <li>\n    <p>Workflows are pipelines made up of multiple Galaxy tools executed in sequence. When a workflow is executed, Galaxy schedules all the jobs which need to be run to produce the workflow outputs. They will remain scheduled (represented by the familiar grey color in the Galaxy history) until the required inputs become available. After they complete, they will make their outputs available, which allows the next set of jobs to begin.</p>\n  </li>\n</ul>\n\n<p>Between them, collections and workflows make it possible to scale-up from running a single tool on a single dataset to running multiple tools on multiple datasets.</p>\n\n<h2 id=\"why-use-the-command-line\">Why use the command line?</h2>\n\n<p>All the functionality described so far is available through the graphical interface. So why use the command line? Let’s consider a couple of scenarios:</p>\n\n<ol>\n  <li>\n    <p>You want to run some molecular dynamics simulations to perform free energy calculations for protein-ligand binding. You have a compound library of 1000 ligands and would like to run an ensemble of 10 simulations for each. You would like to have the analysis for each ligand in a separate history, with the ensembles represented as dataset collections, which means you need to invoke your workflow 1000 times - theoretically possible to do in the graphical interface, but you probably want to avoid it if possible.</p>\n  </li>\n  <li>\n    <p>You are conducting research on a virus which is responsible for a deadly pandemic. New genomic data from the virus is being produced constantly, and you have a variant calling workflow which will tell you if a particular sample contains new mutations. You would like to run this workflow as soon as the data appears - every day perhaps, or even every hour. This will be quite tough if you have to click a button each time yourself.</p>\n  </li>\n</ol>\n\n<p>If you are encountering similar problems as these in your research with Galaxy, this tutorial is for you! We will explain how to trigger workflow execution via the command line using Planemo, and provide some tips on how to write scripts to automate the process. The result will be a bot which takes care of the the whole analysis process for you.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#why-use-the-command-line\" id=\"markdown-toc-why-use-the-command-line\">Why use the command line?</a></li>\n  <li><a href=\"#get-workflows-and-data\" id=\"markdown-toc-get-workflows-and-data\">Get workflows and data</a></li>\n  <li><a href=\"#a-short-guide-to-planemo\" id=\"markdown-toc-a-short-guide-to-planemo\">A short guide to Planemo</a>    <ol>\n      <li><a href=\"#get-the-workflow-and-prepare-the-job-file\" id=\"markdown-toc-get-the-workflow-and-prepare-the-job-file\">Get the workflow and prepare the job file</a></li>\n      <li><a href=\"#running-the-workflow\" id=\"markdown-toc-running-the-workflow\">Running the workflow</a></li>\n      <li><a href=\"#using-galaxy-workflow-and-dataset-ids\" id=\"markdown-toc-using-galaxy-workflow-and-dataset-ids\">Using Galaxy workflow and dataset IDs</a></li>\n      <li><a href=\"#using-planemo-profiles\" id=\"markdown-toc-using-planemo-profiles\">Using Planemo profiles</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#automated-runs-of-a-workflow-for-sars-cov-2-lineage-assignment\" id=\"markdown-toc-automated-runs-of-a-workflow-for-sars-cov-2-lineage-assignment\">Automated runs of a workflow for SARS-CoV-2 lineage assignment</a>    <ol>\n      <li><a href=\"#scientific-background\" id=\"markdown-toc-scientific-background\">Scientific background</a></li>\n      <li><a href=\"#setting-up-the-bot\" id=\"markdown-toc-setting-up-the-bot\">Setting up the bot</a></li>\n      <li><a href=\"#more-advanced-solutions\" id=\"markdown-toc-more-advanced-solutions\">More advanced solutions</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"get-workflows-and-data\">Get workflows and data</h1>\n\n<p>Workflows and data for this tutorial are hosted on <a href=\"https://github.com/usegalaxy-eu/workflow-automation-tutorial\">GitHub</a>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Download workflow and data</hands-on-title>\n  <p>Download the workflows and data for this tutorial using <code class=\"language-plaintext highlighter-rouge\">git clone</code>.</p>\n\n  <blockquote class=\"code-in\">\n    <code-in-title>git clone</code-in-title>\n    <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone https://github.com/usegalaxy-eu/workflow-automation-tutorial.git\n</code></pre></div>    </div>\n  </blockquote>\n\n  <p>Next, step into the cloned folder and take a look around.</p>\n\n  <blockquote class=\"code-in\">\n    <code-in-title></code-in-title>\n    <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">cd </span>workflow-automation-tutorial\n<span class=\"nb\">ls</span>\n</code></pre></div>    </div>\n  </blockquote>\n\n  <blockquote class=\"code-out\">\n    <code-out-title>Folder contents</code-out-title>\n    <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>example  LICENSE  pangolin  README.md\n</code></pre></div>    </div>\n  </blockquote>\n\n  <p>Of the two subfolders, <code class=\"language-plaintext highlighter-rouge\">example/</code> contains just a toy workflow used in the following to guide you through the basics of running workflows from the command line.</p>\n\n  <p>The <code class=\"language-plaintext highlighter-rouge\">pangolin/</code> folder holds the workflow and other material you will use in the second part of the tutorial, in which you will be setting up an automated system for assigning batches of SARS-CoV-2 variant data to viral lineages.</p>\n\n</blockquote>\n\n<h1 id=\"a-short-guide-to-planemo\">A short guide to Planemo</h1>\n\n<p>The main tool we will use in this tutorial is <a href=\"https://planemo.readthedocs.io/en/latest/readme.html\">Planemo</a>, a command-line tool with a very wide range of functionality. If you ever developed a Galaxy tool, you probably encountered the <code class=\"language-plaintext highlighter-rouge\">planemo test</code>, <code class=\"language-plaintext highlighter-rouge\">planemo serve</code> and <code class=\"language-plaintext highlighter-rouge\">planemo lint</code> subcommands. In this tutorial we will be using a different subcommand: <code class=\"language-plaintext highlighter-rouge\">planemo run</code>.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>Note</comment-title>\n  <p>Planemo provides a more detailed tutorial on the <code class=\"language-plaintext highlighter-rouge\">planemo run</code> functionality <a href=\"https://planemo.readthedocs.io/en/latest/running.html\">here</a>. The pages on ‘<a href=\"https://planemo.readthedocs.io/en/latest/best_practices_workflows.html\">Best Practices for Maintaining Galaxy Workflows</a>’ and ‘<a href=\"https://planemo.readthedocs.io/en/latest/test_format.html\">Test Format</a>’ also contain a lot of useful information.</p>\n</blockquote>\n\n<p>For the purposes of this tutorial, we assume you have a recent version of Planemo (0.74.4 or later) installed in a virtual environment. If you don’t, please follow the <a href=\"https://planemo.readthedocs.io/en/latest/installation.html#pip\">installation instructions</a>.</p>\n\n<h2 id=\"get-the-workflow-and-prepare-the-job-file\">Get the workflow and prepare the job file</h2>\n\n<p>For this section, we will use a very simple workflow consisting of two text manipulation tools chained together.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Step into and explore the example folder</hands-on-title>\n\n  <blockquote class=\"code-2col\">\n    <blockquote class=\"code-in\">\n      <code-in-title></code-in-title>\n      <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">cd </span>example\n<span class=\"nb\">ls</span>\n</code></pre></div>      </div>\n    </blockquote>\n\n    <blockquote class=\"code-out\">\n      <code-out-title>Folder contents</code-out-title>\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>tutorial.ga\n</code></pre></div>      </div>\n    </blockquote>\n  </blockquote>\n\n</blockquote>\n\n<p>The <code class=\"language-plaintext highlighter-rouge\">tutorial.ga</code> file defines the workflow in JSON format; if we are confident we have a functional workflow, we don’t need to worry about its contents or modify it. However, we need a second file, the so-called ‘job file’, which specifies the particular dataset and parameter inputs which should be used to execute the workflow. We can create a template for this file using the <code class=\"language-plaintext highlighter-rouge\">planemo workflow_job_init</code> subcommand.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Creating the job file</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Run the <code class=\"language-plaintext highlighter-rouge\">planemo workflow_job_init</code> subcommand.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>workflow_job_init</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo workflow_job_init tutorial.ga <span class=\"nt\">-o</span> tutorial-init-job.yml\n<span class=\"c\"># Now let's view the contents</span>\n<span class=\"nb\">cat </span>tutorial-init-job.yml\n</code></pre></div>        </div>\n        <p>The <code class=\"language-plaintext highlighter-rouge\">planemo workflow_job_init</code> command identifies the inputs of the workflow provided and creates a template job file with placeholder values for each.</p>\n      </blockquote>\n\n      <blockquote class=\"code-out\">\n        <code-out-title>File contents</code-out-title>\n        <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Dataset 1</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">Dataset 2</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">Number of lines</span><span class=\"pi\">:</span> <span class=\"s\">todo_param_value</span>\n</code></pre></div>        </div>\n\n        <p>The job file contains three inputs: two dataset inputs and one integer (parameter input).</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Create two files which can be used as inputs:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Creating the input files</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">printf</span> <span class=\"s2\">\"hello</span><span class=\"se\">\\n</span><span class=\"s2\">world\"</span> <span class=\"o\">&gt;</span> dataset1.txt\n<span class=\"nb\">printf</span> <span class=\"s2\">\"hello</span><span class=\"se\">\\n</span><span class=\"s2\">universe!\"</span> <span class=\"o\">&gt;</span> dataset2.txt\n<span class=\"nb\">ls</span>\n</code></pre></div>        </div>\n\n      </blockquote>\n\n      <blockquote class=\"code-out\">\n        <code-out-title></code-out-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>dataset1.txt  dataset2.txt  tutorial.ga  tutorial-init-job.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>\n      <p>Replace the placeholder values in the job file, so that it looks like the following:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Dataset 1</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">dataset1.txt</span>\n<span class=\"na\">Dataset 2</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">dataset2.txt</span>\n<span class=\"na\">Number of lines</span><span class=\"pi\">:</span> <span class=\"m\">3</span>\n</code></pre></div>      </div>\n    </li>\n  </ol>\n\n  <p>Now we are ready to execute the workflow with our chosen parameters!</p>\n</blockquote>\n\n<h2 id=\"running-the-workflow\">Running the workflow</h2>\n\n<p>Now we have a simple workflow, we can run it using <code class=\"language-plaintext highlighter-rouge\">planemo run</code>. At this point you need to choose a Galaxy server on which you want the workflow to run. One of the big public servers would be a possible choice. You could also use a local Galaxy instance. Either way, once you’ve chosen a server, the next step is to get your API key.</p>\n\n<!--SNIPPET-->\n<blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-getting-your-api-key\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-getting-your-api-key\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Getting your API key</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>In your browser, open your Galaxy homepage</li>   <li>Log in, or register a new account, if it’s the first time you’re logging in</li>   <li>Go to <code class=\"language-plaintext highlighter-rouge\">User -&gt; Preferences</code> in the top menu bar, then click on <code class=\"language-plaintext highlighter-rouge\">Manage API key</code></li>   <li>If there is no current API key available, click on <code class=\"language-plaintext highlighter-rouge\">Create a new key</code> to generate it</li>   <li>Copy your API key to somewhere convenient, you will need it throughout this tutorial</li> </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Running our workflow</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Run the <code class=\"language-plaintext highlighter-rouge\">planemo run</code> subcommand.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>planemo run</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo run tutorial.ga tutorial-init-job.yml <span class=\"nt\">--galaxy_url</span> &lt;SERVER_URL&gt; <span class=\"nt\">--galaxy_user_key</span> &lt;YOUR_API_KEY&gt; <span class=\"nt\">--history_name</span> <span class=\"s2\">\"Test Planemo WF\"</span> <span class=\"nt\">--tags</span> <span class=\"s2\">\"planemo-tutorial\"</span>\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>\n      <p>Navigate to the web browser - you should be able to see a new history has been created with the chosen name and tag.<br />One potential disadvantage of the previous command is that it waits until the invoked workflow has fully completed. For our very small example, this doesn’t matter, but for a workflow which takes hours or days to finish, it might be undesirable. Fortunately, <code class=\"language-plaintext highlighter-rouge\">planemo run</code> provides a <code class=\"language-plaintext highlighter-rouge\">--no_wait</code> flag which exits as soon as the workflow has been successfully scheduled.</p>\n    </li>\n    <li>\n      <p>Run the <code class=\"language-plaintext highlighter-rouge\">planemo run</code> subcommand with the <code class=\"language-plaintext highlighter-rouge\">--no_wait</code> flag.</p>\n      <blockquote class=\"code-in\">\n        <code-in-title>planemo run</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo run tutorial.ga tutorial-init-job.yml <span class=\"nt\">--galaxy_url</span> &lt;SERVER_URL&gt; <span class=\"nt\">--galaxy_user_key</span> &lt;YOUR_API_KEY&gt; <span class=\"nt\">--history_name</span> <span class=\"s2\">\"Test Planemo WF with no_wait\"</span> <span class=\"nt\">--tags</span> <span class=\"s2\">\"planemo-tutorial\"</span> <span class=\"nt\">--no_wait</span>\n</code></pre></div>        </div>\n        <p>This time you should see that the <code class=\"language-plaintext highlighter-rouge\">planemo run</code> command exits as soon as the two datasets have been uploaded and the workflow has been scheduled.</p>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"using-galaxy-workflow-and-dataset-ids\">Using Galaxy workflow and dataset IDs</h2>\n\n<p>We’ve now executed the same workflow twice. If you inspect your histories and workflows through the Galaxy web interface, you will see that a new workflow was created on the server for each invocation, and both <code class=\"language-plaintext highlighter-rouge\">Dataset 1</code> and <code class=\"language-plaintext highlighter-rouge\">Dataset 2</code> were uploaded twice. This is undesirable - we are creating a lot of clutter and the uploads are creating additional unnecessary work for the Galaxy server.</p>\n\n<p>Every object associated with Galaxy, including workflows, datasets and dataset collections, have hexadecimal IDs associated with them, which look something like <code class=\"language-plaintext highlighter-rouge\">6b15dfc0393f172c</code>. Once the datasets and workflows we need have been uploaded to Galaxy once, we can use these IDs in our subsequent workflow invocations.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Running our workflow using dataset and workflow IDs</hands-on-title>\n\n  <ol>\n    <li>Navigate to one of the histories to get dataset IDs for the input datasets. For each one:\n      <ol>\n        <li>Click on the <i class=\"fas fa-info-circle\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-info</span> <em>View details</em> icon on the dataset in the history.</li>\n        <li>Under the heading <code class=\"language-plaintext highlighter-rouge\">Dataset Information</code>, find the row <code class=\"language-plaintext highlighter-rouge\">History Content API ID</code> and copy the hexadecimal ID next to it.</li>\n      </ol>\n    </li>\n    <li>\n      <p>Modify <code class=\"language-plaintext highlighter-rouge\">tutorial-init-job.yml</code> to look like the following:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Dataset 1</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"c1\"># path: dataset1.txt</span>\n  <span class=\"na\">galaxy_id</span><span class=\"pi\">:</span> <span class=\"s\">&lt;ID OF DATASET 1&gt;</span>\n<span class=\"na\">Dataset 2</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"c1\"># path: dataset2.txt</span>\n  <span class=\"na\">galaxy_id</span><span class=\"pi\">:</span> <span class=\"s\">&lt;ID OF DATASET 2&gt;</span>\n<span class=\"na\">Number of lines</span><span class=\"pi\">:</span> <span class=\"m\">3</span>\n</code></pre></div>      </div>\n    </li>\n    <li>Now we need to get the workflow ID:\n      <ol>\n        <li>Go to the workflows panel in Galaxy and find one of the workflows that have just been uploaded.</li>\n        <li>From the dropdown menu, select <code class=\"language-plaintext highlighter-rouge\">Edit</code>, to take you to the workflow editing interface.</li>\n        <li>The URL in your browser will look something like <code class=\"language-plaintext highlighter-rouge\">https://usegalaxy.eu/workflow/editor?id=34d18f081b73cb15</code>. Copy the part after <code class=\"language-plaintext highlighter-rouge\">?id=</code> - this is the workflow ID.</li>\n      </ol>\n    </li>\n    <li>\n      <p>Run the <code class=\"language-plaintext highlighter-rouge\">planemo run</code> subcommand using the new workflow ID.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>planemo run</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo run &lt;WORKFLOW ID&gt; tutorial-init-job.yml <span class=\"nt\">--galaxy_url</span> &lt;SERVER_URL&gt; <span class=\"nt\">--galaxy_user_key</span> &lt;YOUR_API_KEY&gt; <span class=\"nt\">--history_name</span> <span class=\"s2\">\"Test Planemo WF with Planemo\"</span> <span class=\"nt\">--tags</span> <span class=\"s2\">\"planemo-tutorial\"</span> <span class=\"nt\">--no_wait</span>\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"using-planemo-profiles\">Using Planemo profiles</h2>\n\n<p>Planemo provides a useful profile feature which can help simplify long commands. The idea is that flags which need to be used multiple times in different invocations can be combined together and run as a single profile. Let’s see how this works below.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Creating and using Planemo profiles</hands-on-title>\n\n  <ol>\n    <li>Create a Planemo profile with the following command:\n      <blockquote class=\"code-in\">\n        <code-in-title>planemo run</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo profile_create planemo-tutorial <span class=\"nt\">--galaxy_url</span> &lt;SERVER_URL&gt; <span class=\"nt\">--galaxy_user_key</span> &lt;YOUR_API_KEY&gt;\n</code></pre></div>        </div>\n      </blockquote>\n\n      <blockquote class=\"code-out\">\n        <code-out-title>Terminal</code-out-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Profile <span class=\"o\">[</span>planemo-tutorial] created.\n</code></pre></div>        </div>\n        <p>You can view and delete existing profiles using the <code class=\"language-plaintext highlighter-rouge\">profile_list</code> and <code class=\"language-plaintext highlighter-rouge\">profile_delete</code> subcommands.</p>\n      </blockquote>\n    </li>\n    <li>Now we can run our workflow yet again using the profile we have created:\n      <blockquote class=\"code-in\">\n        <code-in-title>planemo run</code-in-title>\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo run &lt;WORKFLOW ID&gt; tutorial-init-job.yml <span class=\"nt\">--profile</span> planemo-tutorial <span class=\"nt\">--history_name</span> <span class=\"s2\">\"Test Planemo WF with profile\"</span> <span class=\"nt\">--tags</span> <span class=\"s2\">\"planemo-tutorial\"</span>\n</code></pre></div>        </div>\n        <p>This invokes the workflow with all the parameters specified in the profile <code class=\"language-plaintext highlighter-rouge\">planemo-tutorial</code>.</p>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h1 id=\"automated-runs-of-a-workflow-for-sars-cov-2-lineage-assignment\">Automated runs of a workflow for SARS-CoV-2 lineage assignment</h1>\n\n<p>It’s now time to apply your newly acquired knowledge of workflow execution with Planemo to a relevant scientific problem.</p>\n\n<h2 id=\"scientific-background\">Scientific background</h2>\n\n<p>The SARS-CoV-2 pandemic has been accompanied by unprecedented world-wide sequencing efforts. One of the accepted goals behind sequencing hundreds of thousands of individual viral isolates is to monitor the evolution and spreading of viral lineages in as close as real time as possible. Viral lineages are characterized by defining patterns of mutations that make them different from each other and from the original virus that started the pandemic at the beginning of 2020. Examples of viral lineages are B.1.1.7, first observed in the UK in the fall of 2020 and now termed <em>variant of concern (VOC) alpha</em> according to the WHO’s classification system, and B.1.617.2, first seen in India at the beginning of 2021 and now recognized as <em>VOC delta</em>.</p>\n\n<p><a href=\"https://cov-lineages.org/pangolin.html\">Pangolin</a> is a widely used tool for assigning newly sequenced viral isolates to established viral lineages, and in this final section of this tutorial you are going to run a workflow that:</p>\n\n<ol>\n  <li>\n    <p>takes a collection of variant datasets in the <em>variant call format</em> VCF,</p>\n\n    <p>where you can think of a collection as representing a batch of freshly sequenced viral isolates with each of its VCF datasets listing the nucleotide differences between one sample and the sequence of an original SARS-CoV-2 reference isolate</p>\n  </li>\n  <li>\n    <p>reconstructs the viral genome sequence of each sample by incorporating its variants into the reference isolate’s sequence</p>\n  </li>\n  <li>\n    <p>uses Pangolin to classify the resulting collection of genome sequences in FASTA format and to create a report of lineage assignments for all samples.</p>\n  </li>\n</ol>\n\n<p>Just like in a real world situation, you will receive VCF files for several batches of samples and you will face the challenge of uploading the files from each batch as a collection into Galaxy and of triggering a run of the workflow for each of them.</p>\n\n<h2 id=\"setting-up-the-bot\">Setting up the bot</h2>\n\n<p>Unlike for the previous toy example you will not get complete step-by-step instructions, but you are supposed to try yourself to transfer the knowledge from part 1 to this new, more complex task.</p>\n\n<p>Every step along the way comes with solutions, which you can expand at any time, but you’re encouraged to give each problem some thought first.</p>\n\n<p>As a very first step, however, let’s look at how the material for this part is arranged.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Step into and explore the pangolin folder</hands-on-title>\n\n  <blockquote class=\"code-in\">\n    <code-in-title></code-in-title>\n    <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">cd</span> ../pangolin\n<span class=\"nb\">ls</span>\n</code></pre></div>    </div>\n  </blockquote>\n\n  <blockquote class=\"code-out\">\n    <code-out-title>Folder contents</code-out-title>\n    <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>data  solutions  vcf2lineage.ga\n</code></pre></div>    </div>\n  </blockquote>\n\n</blockquote>\n\n<p>The file <code class=\"language-plaintext highlighter-rouge\">vcf2lineage.ga</code> defines the workflow just described, while the <code class=\"language-plaintext highlighter-rouge\">data/</code> folder holds the batches of VCF files we would, ultimately, like to run the workflow on.</p>\n\n<p>Now, as a start, let’s get the workflow running on the first batch of files in the <code class=\"language-plaintext highlighter-rouge\">data/batch1/</code> subfolder.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>An initial workflow run</hands-on-title>\n\n  <ol>\n    <li>Create a template job file for the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage.ga</code> workflow.\n      <blockquote class=\"details\">\n        <details-title>Solution</details-title>\n        <p>We need to run <code class=\"language-plaintext highlighter-rouge\">workflow_job_init</code> on the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage.ga</code> workflow.</p>\n        <blockquote class=\"code-in\">\n          <code-in-title>workflow_job_init</code-in-title>\n          <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo workflow_job_init vcf2lineage.ga <span class=\"nt\">-o</span> vcf2lineage-job.yml\n<span class=\"c\"># Now let's view the contents</span>\n<span class=\"nb\">cat </span>vcf2lineage-job.yml\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title>File contents</code-out-title>\n          <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Reference genome</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">Variant calls</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">Collection</span>\n  <span class=\"na\">collection_type</span><span class=\"pi\">:</span> <span class=\"s\">list</span>\n  <span class=\"na\">elements</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">todo_element_name</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">min-AF for consensus variant</span><span class=\"pi\">:</span> <span class=\"s\">todo_param_value</span>\n</code></pre></div>          </div>\n        </blockquote>\n\n        <p>The job file contains three inputs: the <code class=\"language-plaintext highlighter-rouge\">Reference genome</code>, a collection of VCF files (<code class=\"language-plaintext highlighter-rouge\">Variant calls</code>) and a float parameter for the minimum allele frequency (<code class=\"language-plaintext highlighter-rouge\">min-AF for consensus variant</code>). Later, we will need to specify each element of the collection under <code class=\"language-plaintext highlighter-rouge\">elements</code> - currently there is just a single placeholder element.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Replace the placeholder values: <code class=\"language-plaintext highlighter-rouge\">Reference genome</code> should point to <code class=\"language-plaintext highlighter-rouge\">data/NC_045512.2_reference_sequence.fasta</code>, <code class=\"language-plaintext highlighter-rouge\">Variant calls</code> should contain all the VCF files in <code class=\"language-plaintext highlighter-rouge\">data/batch1</code>, and <code class=\"language-plaintext highlighter-rouge\">min-AF for consensus variant</code> should be set to <code class=\"language-plaintext highlighter-rouge\">0.7</code>.</p>\n\n      <blockquote class=\"tip\">\n        <tip-title>Hint: Creating the `Variant calls` collection</tip-title>\n        <p>This is the trickiest part and you should consider writing a script to solve it. The entry in the job file should look something like this at the end:</p>\n\n        <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Variant calls</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">Collection</span>\n  <span class=\"na\">collection_type</span><span class=\"pi\">:</span> <span class=\"s\">list</span>\n  <span class=\"na\">elements</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">ERR5879218</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">data/batch1/ERR5879218.vcf</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">ERR5879219</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">data/batch1/ERR5879219.vcf</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"s\">...</span>\n</code></pre></div>        </div>\n        <p>There should be one entry under <code class=\"language-plaintext highlighter-rouge\">elements</code> for each of the 312 files under <code class=\"language-plaintext highlighter-rouge\">data/batch1</code>.</p>\n      </blockquote>\n\n      <blockquote class=\"details\">\n        <details-title>Solution</details-title>\n        <p>Adding the <code class=\"language-plaintext highlighter-rouge\">Reference genome</code> dataset and <code class=\"language-plaintext highlighter-rouge\">min-AF for consensus variant</code> parameter is straightforward. Modify the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage-job.yml</code> file and save it:</p>\n\n        <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Reference genome</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">data/NC_045512.2_reference_sequence.fasta</span>\n<span class=\"na\">Variant calls</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">Collection</span>\n  <span class=\"na\">collection_type</span><span class=\"pi\">:</span> <span class=\"s\">list</span>\n  <span class=\"na\">elements</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">todo_element_name</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">min-AF for consensus variant</span><span class=\"pi\">:</span> <span class=\"m\">0.7</span>\n</code></pre></div>        </div>\n\n        <p>To add entries for every element of the <code class=\"language-plaintext highlighter-rouge\">Variant calling </code> collection we should write a script. There are many possible solutions; here is an example:</p>\n        <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">sys</span>\n<span class=\"kn\">from</span> <span class=\"n\">glob</span> <span class=\"kn\">import</span> <span class=\"n\">glob</span>\n<span class=\"kn\">from</span> <span class=\"n\">pathlib</span> <span class=\"kn\">import</span> <span class=\"n\">Path</span>\n\n<span class=\"kn\">import</span> <span class=\"n\">yaml</span>\n\n<span class=\"n\">job_file_path</span> <span class=\"o\">=</span> <span class=\"n\">sys</span><span class=\"p\">.</span><span class=\"n\">argv</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n<span class=\"n\">batch_directory</span> <span class=\"o\">=</span> <span class=\"n\">sys</span><span class=\"p\">.</span><span class=\"n\">argv</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span>\n\n<span class=\"k\">with</span> <span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"n\">job_file_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n    <span class=\"n\">job</span> <span class=\"o\">=</span> <span class=\"n\">yaml</span><span class=\"p\">.</span><span class=\"nf\">load</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">Loader</span><span class=\"o\">=</span><span class=\"n\">yaml</span><span class=\"p\">.</span><span class=\"n\">CLoader</span><span class=\"p\">)</span>\n\n<span class=\"n\">vcf_paths</span> <span class=\"o\">=</span> <span class=\"nf\">glob</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"sh\">'</span><span class=\"si\">{</span><span class=\"n\">batch_directory</span><span class=\"si\">}</span><span class=\"s\">/*.vcf</span><span class=\"sh\">'</span><span class=\"p\">)</span>\n<span class=\"n\">elements</span> <span class=\"o\">=</span> <span class=\"p\">[{</span><span class=\"sh\">'</span><span class=\"s\">class</span><span class=\"sh\">'</span><span class=\"p\">:</span> <span class=\"sh\">'</span><span class=\"s\">File</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">identifier</span><span class=\"sh\">'</span><span class=\"p\">:</span> <span class=\"nc\">Path</span><span class=\"p\">(</span><span class=\"n\">vcf_path</span><span class=\"p\">).</span><span class=\"n\">stem</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">path</span><span class=\"sh\">'</span><span class=\"p\">:</span> <span class=\"n\">vcf_path</span><span class=\"p\">}</span> <span class=\"k\">for</span> <span class=\"n\">vcf_path</span> <span class=\"ow\">in</span> <span class=\"n\">vcf_paths</span><span class=\"p\">]</span>\n<span class=\"n\">job</span><span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">Variant calls</span><span class=\"sh\">'</span><span class=\"p\">][</span><span class=\"sh\">'</span><span class=\"s\">elements</span><span class=\"sh\">'</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">elements</span>\n\n<span class=\"k\">with</span> <span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"n\">job_file_path</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">w</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n    <span class=\"n\">yaml</span><span class=\"p\">.</span><span class=\"nf\">dump</span><span class=\"p\">(</span><span class=\"n\">job</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">)</span>\n</code></pre></div>        </div>\n\n        <p>Save this as <code class=\"language-plaintext highlighter-rouge\">create_job_file.py</code> and run it with <code class=\"language-plaintext highlighter-rouge\">python create_job_file.py vcf2lineage-job.yml data/batch1</code>. This has the effect of updating the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage-job.yml</code> with all the VCF files in the <code class=\"language-plaintext highlighter-rouge\">data/batch1</code> directory.</p>\n      </blockquote>\n    </li>\n    <li>Now that we have a complete job file, let’s run the workflow.\n      <blockquote class=\"details\">\n        <details-title>Solution</details-title>\n        <blockquote class=\"code-in\">\n          <code-in-title>workflow_job_init</code-in-title>\n          <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>planemo run vcf2lineage.ga vcf2lineage-job.yml <span class=\"nt\">--profile</span> planemo-tutorial <span class=\"nt\">--history_name</span> <span class=\"s2\">\"vcf2lineage test\"</span>\n</code></pre></div>          </div>\n        </blockquote>\n        <p>You should see the new invocation in the Galaxy interface.</p>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<p>We have now performed a test invocation of the vcf2lineage workflow. It was already more challenging than the first example; for the first time, we needed to resort to writing a script to achieve a task, in this case the construction of the job file.</p>\n\n<p>The next step is to automate this process so we can run the workflow on each of the 10 <code class=\"language-plaintext highlighter-rouge\">batch*/</code> directories in the <code class=\"language-plaintext highlighter-rouge\">data/</code> folder. We can imagine that these are newly produced data released at regular intervals, which need to be analysed.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Automating vcf2lineage execution</hands-on-title>\n\n  <ol>\n    <li>\n      <p>If we want to execute the workflow multiple times, we will once again encounter the issue that the datasets and workflow will be reuploaded each time. To avoid this, let’s obtain the dataset ID for the <code class=\"language-plaintext highlighter-rouge\">Reference genome</code> (which stays the same for each invocation) and the workflow ID for the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage.ga</code> workflow.</p>\n    </li>\n    <li>\n      <p>Now let’s create a template job file <code class=\"language-plaintext highlighter-rouge\">vcf2lineage-job-template.yml</code> which we can modify at each invocation as necessary. We can start with the output of <code class=\"language-plaintext highlighter-rouge\">workflow_job_init</code> and add the <code class=\"language-plaintext highlighter-rouge\">Reference genome</code> dataset ID and set <code class=\"language-plaintext highlighter-rouge\">min-AF for consensus variant</code> to <code class=\"language-plaintext highlighter-rouge\">0.7</code> again.</p>\n\n      <blockquote class=\"details\">\n        <details-title>Solution</details-title>\n        <p>We need to run <code class=\"language-plaintext highlighter-rouge\">workflow_job_init</code> on the <code class=\"language-plaintext highlighter-rouge\">vcf2lineage.ga</code> workflow.</p>\n        <blockquote class=\"code-in\">\n          <code-in-title>Original output of workflow_job_init</code-in-title>\n          <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Reference genome</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">Variant calls</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">Collection</span>\n  <span class=\"na\">collection_type</span><span class=\"pi\">:</span> <span class=\"s\">list</span>\n  <span class=\"na\">elements</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">todo_element_name</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">min-AF for consensus variant</span><span class=\"pi\">:</span> <span class=\"s\">todo_param_value</span>\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title>Prepared `vcf2lineage-job-template.yml` file contents</code-out-title>\n          <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">Reference genome</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n  <span class=\"na\">galaxy_id</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">1234567890abcdef'</span> <span class=\"c1\"># replace with the ID you got from your own server</span>\n<span class=\"na\">Variant calls</span><span class=\"pi\">:</span>\n  <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">Collection</span>\n  <span class=\"na\">collection_type</span><span class=\"pi\">:</span> <span class=\"s\">list</span>\n  <span class=\"na\">elements</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">class</span><span class=\"pi\">:</span> <span class=\"s\">File</span>\n    <span class=\"na\">identifier</span><span class=\"pi\">:</span> <span class=\"s\">todo_element_name</span>\n    <span class=\"na\">path</span><span class=\"pi\">:</span> <span class=\"s\">todo_test_data_path.ext</span>\n<span class=\"na\">min-AF for consensus variant</span><span class=\"pi\">:</span> <span class=\"m\">0.7</span>\n</code></pre></div>          </div>\n        </blockquote>\n        <p>We can copy and modify this new <code class=\"language-plaintext highlighter-rouge\">vcf2lineage-job-template.yml</code> file iteratively to invoke the workflow on each of the data batches.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Write a shell script to iterate over all the batches, create a job file and invoke with <code class=\"language-plaintext highlighter-rouge\">planemo run</code>. After execution, move the processed batch to <code class=\"language-plaintext highlighter-rouge\">data/complete</code>.</p>\n\n      <blockquote class=\"details\">\n        <details-title>Solution</details-title>\n        <p>Once again, there is no single exact solution. Here is one possibility:</p>\n\n        <div class=\"language-shell highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">for </span>batch <span class=\"k\">in</span> <span class=\"sb\">`</span><span class=\"nb\">ls</span> <span class=\"nt\">-d</span> data/batch<span class=\"k\">*</span><span class=\"sb\">`</span><span class=\"p\">;</span> <span class=\"k\">do\n    </span><span class=\"nv\">batch_name</span><span class=\"o\">=</span><span class=\"sb\">`</span><span class=\"nb\">basename</span> <span class=\"nv\">$batch</span><span class=\"sb\">`</span>\n    <span class=\"nb\">cp </span>vcf2lineage-job-template.yml vcf2lineage-<span class=\"k\">${</span><span class=\"nv\">batch_name</span><span class=\"k\">}</span><span class=\"nt\">-job</span>.yml\n    python create_job_file.py vcf2lineage-<span class=\"k\">${</span><span class=\"nv\">batch_name</span><span class=\"k\">}</span><span class=\"nt\">-job</span>.yml <span class=\"nv\">$batch</span>\n    <span class=\"c\"># replace with your own workflow ID below</span>\n    planemo run f4b02af7e642e75b vcf2lineage-<span class=\"k\">${</span><span class=\"nv\">batch_name</span><span class=\"k\">}</span><span class=\"nt\">-job</span>.yml <span class=\"nt\">--profile</span> planemo-tutorial\n    <span class=\"nb\">sleep </span>300\n    <span class=\"nb\">mv</span> <span class=\"nv\">$batch</span> data/complete/\n<span class=\"k\">done</span>\n</code></pre></div>        </div>\n\n        <p>Save this as <code class=\"language-plaintext highlighter-rouge\">run_vcf2lineage.sh</code>.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Run your script. Do you notice any issues? What could be improved?</p>\n\n      <blockquote class=\"tip\">\n        <tip-title>Upload problems</tip-title>\n        <p>Uploads can cause several issues:</p>\n        <ul>\n          <li>The default planemo behavior is to upload datasets one at a time, which ensures the server cannot be overloaded, but is slow. To upload all datasets simultaneously, you could use the <code class=\"language-plaintext highlighter-rouge\">--simultaneous_uploads</code> flag.</li>\n          <li>If one of the upload jobs fails, the workflow will by default not be invoked - Planemo will just upload the datasets and finish. To override this behavior and start a workflow even if one or more uploads fail, you can use the <code class=\"language-plaintext highlighter-rouge\">--no_check_uploads_ok</code> flag.</li>\n          <li>For a more complex solution to the issue of failed uploads, see <a href=\"https://github.com/usegalaxy-eu/ena-cog-uk-wfs/blob/main/bioblend-scripts/ftp_links_to_yaml.py\">this script</a> from the <code class=\"language-plaintext highlighter-rouge\">ena-cog-uk-wfs</code> repo.</li>\n        </ul>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"more-advanced-solutions\">More advanced solutions</h2>\n\n<p>This was a very basic example of a workflow. Perhaps for your case, you need a more customized solution.</p>\n\n<p>For example, it might be the case that you want to run multiple different workflows, one after another. In this case you would need to implement some sort of check to verify if one invocation had finished, before beginning with the next one. Planemo will probably not be enough for a task like this; you will need to resort to using the lower-level <a href=\"https://bioblend.readthedocs.io/\">BioBlend</a> library to interact directly with the Galaxy API.</p>\n\n<p>The <a href=\"https://github.com/usegalaxy-eu/ena-cog-uk-wfs/\">Galaxy SARS-CoV-2 genome surveillance bot</a> provides an example of a more advanced customized workflow execution solution, combining Planemo commands, custom BioBlend scripts and bash scripts, which then get run automatically via continuous integration (CI) on a Jenkins server.</p>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>You should now have a better idea about how to run Galaxy workflows from the command line and how to apply the ideas you have learnt to your own project.</p>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2024-05-29 15:37:52 +0000","pub_date":"2021-06-08 08:34:12 +0000","version":13,"workflows":[{"workflow":"main_workflow.ga","tests":false,"url":"https://training.galaxyproject.org/training-material/topics/galaxy-interface/tutorials/workflow-automation/workflows/main_workflow.ga","path":"topics/galaxy-interface/tutorials/workflow-automation/workflows/main_workflow.ga","wfid":"galaxy-interface-workflow-automation","wfname":"main_workflow","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/galaxy-interface-workflow-automation/versions/main_workflow","license":"MIT","creators":[{"class":"Person","identifier":"https://orcid.org/0000-0002-9464-6640","name":"Wolfgang Maier"}],"name":"vcf2lineage","title":"vcf2lineage","test_results":null,"modified":"2024-06-14 09:58:03 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Collection\\nVariant calls\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"ℹ️ Input Parameter\\nmin-AF for consensus variant\"];\n  style 1 fill:#ded,stroke:#393,stroke-width:4px;\n  2[\"ℹ️ Input Dataset\\nReference genome\"];\n  style 2 stroke:#2c3143,stroke-width:4px;\n  3[\"Compose text parameter value\"];\n  1 -->|output| 3;\n  4[\"SnpSift Filter\"];\n  3 -->|out1| 4;\n  0 -->|output| 4;\n  ee67c5ed-ff7c-404b-ad20-19259edbc671[\"Output\\nconsensus_variants\"];\n  4 --> ee67c5ed-ff7c-404b-ad20-19259edbc671;\n  style ee67c5ed-ff7c-404b-ad20-19259edbc671 stroke:#2c3143,stroke-width:4px;\n  5[\"bcftools consensus\"];\n  4 -->|output| 5;\n  2 -->|output| 5;\n  9028f80e-4112-40d8-9a49-f671677d304f[\"Output\\nconsensus\"];\n  5 --> 9028f80e-4112-40d8-9a49-f671677d304f;\n  style 9028f80e-4112-40d8-9a49-f671677d304f stroke:#2c3143,stroke-width:4px;\n  6[\"Collapse Collection\"];\n  5 -->|output_file| 6;\n  1dd7978e-b907-42d6-8fc4-f6fadeefcad1[\"Output\\nmultisample_consensus_fasta\"];\n  6 --> 1dd7978e-b907-42d6-8fc4-f6fadeefcad1;\n  style 1dd7978e-b907-42d6-8fc4-f6fadeefcad1 stroke:#2c3143,stroke-width:4px;\n  7[\"Pangolin\"];\n  6 -->|output| 7;\n  e02d2cfb-9842-4069-957c-6cf4ec197056[\"Output\\npangolin_results\"];\n  7 --> e02d2cfb-9842-4069-957c-6cf4ec197056;\n  style e02d2cfb-9842-4069-957c-6cf4ec197056 stroke:#2c3143,stroke-width:4px;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/galaxy-interface/tutorials/workflow-automation/tutorial.json","tools":["toolshed.g2.bx.psu.edu/repos/iuc/bcftools_consensus/bcftools_consensus/1.10","toolshed.g2.bx.psu.edu/repos/iuc/compose_text_param/compose_text_param/0.1.1","toolshed.g2.bx.psu.edu/repos/iuc/pangolin/pangolin/2.3.8","toolshed.g2.bx.psu.edu/repos/iuc/snpsift/snpSift_filter/4.3+t.galaxy1","toolshed.g2.bx.psu.edu/repos/nml/collapse_collections/collapse_dataset/4.2"],"supported_servers":{"exact":[{"url":"https://usegalaxy.be/","name":"UseGalaxy.be","usegalaxy":false},{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true},{"url":"https://usegalaxy.org.au","name":"UseGalaxy.org.au","usegalaxy":true}],"inexact":[{"url":"https://mississippi.sorbonne-universite.fr","name":"MISSISSIPPI","usegalaxy":false},{"url":"https://usegalaxy.fr/","name":"UseGalaxy.fr","usegalaxy":false}]},"topic_name_human":"Using Galaxy and Managing your Data","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"bcftools_consensus","owner":"iuc","revisions":"e522022137f6","tool_panel_section_label":"Variant Calling","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"compose_text_param","owner":"iuc","revisions":"e188c9826e0f","tool_panel_section_label":"Expression Tools","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"pangolin","owner":"iuc","revisions":"b6abccb1f25b","tool_panel_section_label":"Phylogenetics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"snpsift","owner":"iuc","revisions":"5fab4f81391d","tool_panel_section_label":"Variant Calling","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"collapse_collections","owner":"nml","revisions":"830961c48e42","tool_panel_section_label":"Collection Operations","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: bcftools_consensus\n  owner: iuc\n  revisions: e522022137f6\n  tool_panel_section_label: Variant Calling\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: compose_text_param\n  owner: iuc\n  revisions: e188c9826e0f\n  tool_panel_section_label: Expression Tools\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: pangolin\n  owner: iuc\n  revisions: b6abccb1f25b\n  tool_panel_section_label: Phylogenetics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: snpsift\n  owner: iuc\n  revisions: 5fab4f81391d\n  tool_panel_section_label: Variant Calling\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: collapse_collections\n  owner: nml\n  revisions: 830961c48e42\n  tool_panel_section_label: Collection Operations\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}