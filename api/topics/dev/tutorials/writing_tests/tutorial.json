{"layout":"tutorial_hands_on","title":"Writing Automated Tests for Galaxy","objectives":["Learn about the different types of automated tests in Galaxy","Learn to write API tests","Learn to write unit tests"],"time_estimation":"3h","key_points":["Read the Writing Tests for Galaxy documentation article","Check for existing examples of similar tests before implementing your own","Prefer Galaxy's abstractions to writing low level code whenever possible","Write tests that do not depend on each other or the state of the database","When testing the API, verify the return status code before checking the response data","Refactor the code under test if that's needed to make it testable","Move redundant setup code into fixtures","Use test doubles (mocks, stubs, etc.) sparingly"],"contributors":[{"name":"John Davis","email":"jdavcs@gmail.com","joined":"2019-06","orcid":"0000-0002-1363-1245","id":"jdavcs","url":"https://training.galaxyproject.org/training-material/api/contributors/jdavcs.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/"},{"name":"John Chilton","email":"jmchilton@gmail.com","joined":"2017-09","twitter":"jmchilton","matrix":"jmchilton:matrix.org","orcid":"0000-0002-6794-0756","id":"jmchilton","url":"https://training.galaxyproject.org/training-material/api/contributors/jmchilton.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/"}],"requirements":[{"type":"none","title":"Familiarity with basic Git commands"},{"type":"none","title":"Basic knowledge of Python and JavaScript"},{"type":"none","title":"Mac OS or Linux that can run Galaxy & your favorite IDE or editor"},{"type":"internal","topic_name":"dev","tutorials":["architecture"]}],"subtopic":"core","js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00123","url":"/topics/dev/tutorials/writing_tests/tutorial.html","topic_name":"dev","tutorial_name":"writing_tests","dir":"topics/dev/tutorials/writing_tests","symlink":null,"id":"dev/writing_tests","ref_tutorials":["<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#testing-in-galaxy\" id=\"markdown-toc-testing-in-galaxy\">Testing in Galaxy</a></li>\n  <li><a href=\"#local-development-environment-setup\" id=\"markdown-toc-local-development-environment-setup\">Local development environment setup</a></li>\n  <li><a href=\"#api-tests\" id=\"markdown-toc-api-tests\">API tests</a>    <ol>\n      <li><a href=\"#basic-api-test\" id=\"markdown-toc-basic-api-test\">Basic API test</a></li>\n      <li><a href=\"#test-creating-a-simple-object\" id=\"markdown-toc-test-creating-a-simple-object\">Test creating a simple object</a></li>\n      <li><a href=\"#a-better-test-for-creating-a-simple-object\" id=\"markdown-toc-a-better-test-for-creating-a-simple-object\">A better test for creating a simple object</a></li>\n      <li><a href=\"#use-galaxys-populators-for-setting-up-database-state\" id=\"markdown-toc-use-galaxys-populators-for-setting-up-database-state\">Use Galaxy’s populators for setting up database state</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#unit-tests\" id=\"markdown-toc-unit-tests\">Unit tests</a>    <ol>\n      <li><a href=\"#testing-simple-functions\" id=\"markdown-toc-testing-simple-functions\">Testing simple functions</a></li>\n      <li><a href=\"#verifying-that-an-error-is-raised\" id=\"markdown-toc-verifying-that-an-error-is-raised\">Verifying that an error is raised</a></li>\n      <li><a href=\"#using-fixtures-to-reduce-code-duplication\" id=\"markdown-toc-using-fixtures-to-reduce-code-duplication\">Using fixtures to reduce code duplication</a></li>\n      <li><a href=\"#parametrization-of-test-functions\" id=\"markdown-toc-parametrization-of-test-functions\">Parametrization of test functions</a></li>\n      <li><a href=\"#dealing-with-less-trivial-code\" id=\"markdown-toc-dealing-with-less-trivial-code\">Dealing with less trivial code</a></li>\n      <li><a href=\"#mocking-a-dependency\" id=\"markdown-toc-mocking-a-dependency\">Mocking a dependency</a></li>\n      <li><a href=\"#refactoring-for-testability\" id=\"markdown-toc-refactoring-for-testability\">Refactoring for testability</a></li>\n      <li><a href=\"#monkeypatching-the-module-under-test\" id=\"markdown-toc-monkeypatching-the-module-under-test\">“Monkeypatching” the module under test</a></li>\n      <li><a href=\"#more-refactoring\" id=\"markdown-toc-more-refactoring\">More refactoring</a></li>\n      <li><a href=\"#more-monkeypatching\" id=\"markdown-toc-more-monkeypatching\">More “monkeypatching”</a></li>\n      <li><a href=\"#utilizing-the-mocks-to-test-the-logic\" id=\"markdown-toc-utilizing-the-mocks-to-test-the-logic\">Utilizing the mocks to test the logic</a></li>\n      <li><a href=\"#reformatting-for-improved-readability\" id=\"markdown-toc-reformatting-for-improved-readability\">Reformatting for improved readability</a></li>\n      <li><a href=\"#adding-the-remaining-tests\" id=\"markdown-toc-adding-the-remaining-tests\">Adding the remaining tests</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"testing-in-galaxy\">Testing in Galaxy</h1>\n\n<p>The Galaxy code base contains thousands of tests that include tests of different types (unit vs. functional vs. end-to-end; client vs. backend, etc.) that are supported by a variety of testing frameworks and libraries. In this tutorial, we will offer a small, yet representative sample of the types of tests you might write, as well as the concepts and issues you may need to be familiar with when writing tests for Galaxy code, whether as part of a new feature you are implementing, or as a standalone contribution to Galaxy’s testing code.</p>\n\n<p>A good way to start learning about Galaxy’s testing infrastructure and how to use it is to read the documentation article on the different types of tests that are present in the code base as well as how to determine which type is most appropriate for a given scenario (see <a href=\"https://docs.galaxyproject.org/en/master/dev/writing_tests.html\">Writing Tests for Galaxy</a>).</p>\n\n<p>In addition to reading the documentation, it is essential to have a reasonable understanding of Galaxy’s code organization. The best documentation resource for that is the <a href=\"/training-material/topics/dev/tutorials/architecture/slides.html\">Galaxy Code Architecture slides</a>. In addition, we recommend the <a href=\"/training-material/topics/dev/tutorials/core-contributing/tutorial.html\">Contributing a New Feature to Galaxy Core</a> tutorial, which, among other things, combines some of the concepts from the architecture slides with the material covered in this tutorial.</p>\n\n<p>The most detailed and up-to-date documentation on running Galaxy tests is located at the top of the <code class=\"language-plaintext highlighter-rouge\">run_tests.sh</code> script in Galaxy’s root directory.</p>\n\n<p>To run Galaxy tests, you may also use the <code class=\"language-plaintext highlighter-rouge\">pytest</code> command directly (except for client tests, which provide their own infrastructure and scripts described in <code class=\"language-plaintext highlighter-rouge\">client/README.md</code>. Using pytest directly is most convenient for running individual tests (although you might have to manually set the required environment variables for all but unit tests, as per documentation in <code class=\"language-plaintext highlighter-rouge\">run_tests.sh</code>). However, keep in mind that the <code class=\"language-plaintext highlighter-rouge\">run_scripts.sh</code> script optimizes the tests by reusing the same Galaxy instance and database for API tests, so running API tests in batch with pytest would be very inefficient.</p>\n\n<p>Another useful resource is the <a href=\"/training-material/topics/dev/tutorials/debugging/tutorial.html\">Debugging Galaxy</a> tutorial which contains a lot of useful information on how to debug test failures that occur both locally and remotely.</p>\n\n<p>Finally, nothing can substitute studying Galaxy’s test code - we encourage you to always look for examples of similar tests and testing scenarios before you write your own.</p>\n\n<h1 id=\"local-development-environment-setup\">Local development environment setup</h1>\n\n<!--SNIPPET-->\n<blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-how-to-contribute-to-galaxy\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-how-to-contribute-to-galaxy\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: How to Contribute to Galaxy</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>To contribute to galaxy, a GitHub account is required. Changes are proposed via a <a href=\"https://docs.github.com/en/github/collaborating-with-pull-requests\">pull request</a>. This allows the project maintainers to review the changes and suggest improvements.</p>   <p>The general steps are as follows:</p>   <ol>   <li>Fork the Galaxy repository</li>   <li>Clone your fork</li>   <li>Make changes in a new branch</li>   <li>Commit your changes, push branch to your fork</li>   <li>Open a pull request for this branch in the upstream Galaxy repository</li> </ol>   <blockquote class=\"details\">   <details-title>Git, Github, and Galaxy Core</details-title>   <p>For a lot more information about Git branching and managing a repository on Github,  see the <a href=\"/training-material/topics/contributing/tutorials/github-command-line-contribution/tutorial.html\">Contributing with GitHub via command-line</a> tutorial.</p>   <p>The <a href=\"/training-material/topics/dev/tutorials/architecture/slides.html\">Galaxy Core Architecture slides</a> have a lot of important Galaxy core-related information related to branches,  project management, and contributing to Galaxy - under the Project Management section of the slides.</p> </blockquote> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Setup your local Galaxy instance</hands-on-title>\n\n  <ol>\n    <li>Use GitHub UI to fork Galaxy’s repository at <code class=\"language-plaintext highlighter-rouge\">galaxyproject/galaxy</code>.</li>\n    <li>\n      <p>Clone your forked repository to a local path, further referred to as <code class=\"language-plaintext highlighter-rouge\">GALAXY_ROOT</code> and <code class=\"language-plaintext highlighter-rouge\">cd</code> into <code class=\"language-plaintext highlighter-rouge\">GALAXY_ROOT</code>. Note that we specify the tutorial branch with the <code class=\"language-plaintext highlighter-rouge\">-b</code> option:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git clone https://github.com/&lt;your-username&gt;/galaxy GALAXY_ROOT\n<span class=\"nb\">cd </span>GALAXY_ROOT\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>\n      <p>Before we can use Galaxy, we need to create a virtual environment and install the required dependencies. This is generally done with the <code class=\"language-plaintext highlighter-rouge\">common_startup.sh</code> script:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>bash scripts/common_startup.sh <span class=\"nt\">--dev-wheels</span>\n</code></pre></div>        </div>\n      </blockquote>\n\n      <p>Make sure your Python version is at least 3.7 (you can check your Python version with <code class=\"language-plaintext highlighter-rouge\">python --version</code>). If your system uses an older version, you may specify an alternative Python interpreter using the <code class=\"language-plaintext highlighter-rouge\">GALAXY_PYTHON</code> environment variable (<code class=\"language-plaintext highlighter-rouge\">GALAXY_PYTHON=/path/to/alt/python bash scripts/common_startup.sh --dev-wheels</code>).</p>\n    </li>\n    <li>\n      <p>Activate your new virtual environment:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">.</span> .venv/bin/activate\n</code></pre></div>        </div>\n      </blockquote>\n\n      <p>Once activated, you’ll see the name of the virtual environment prepended to your shell prompt: <code class=\"language-plaintext highlighter-rouge\">(.venv)$</code>.</p>\n    </li>\n    <li>\n      <p>Finally, let’s create a new branch for your edits:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git checkout <span class=\"nt\">-b</span> my-training\n</code></pre></div>        </div>\n      </blockquote>\n\n      <p>Now when you run <code class=\"language-plaintext highlighter-rouge\">git branch</code> you’ll see that your new branch is activated:</p>\n\n      <blockquote class=\"code-2col\">\n        <blockquote class=\"code-in\">\n          <code-in-title>Bash</code-in-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git branch\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title></code-out-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  training\n<span class=\"k\">*</span> my-training\n</code></pre></div>          </div>\n        </blockquote>\n      </blockquote>\n\n      <p>Note: <code class=\"language-plaintext highlighter-rouge\">my-training</code> is just an example; you can call your new branch anything you like.</p>\n    </li>\n  </ol>\n</blockquote>\n\n<h1 id=\"api-tests\">API tests</h1>\n\n<p>We turn to API tests when we need to test some feature that requires a running Galaxy instance and, in many cases, the Galaxy database. These tests use the Galaxy API to drive the test.</p>\n\n<p>In a way, these tests may be the simplest to write. While the required setup of an API test is, certainly, more involved than that of a basic unit test, Galaxy’s testing infrastructure takes care of all the heavy lifting, such as creating a test database, configuring and starting up a Galaxy instance, and tearing down the setup upon test completion. The testing infrastructure also provides a wealth of convenient abstractions that simplify pre-populating the database with the necessary state for each test, interacting with the API, as well as expressing expectations about the outcomes of a test. Thus, writing an API test boils down to calling the appropriate API endpoint and verifying the result.</p>\n\n<p>We are not developing any new features in this tutorial (check out the <a href=\"/training-material/topics/dev/tutorials/core-contributing/tutorial.html\">Contributing a New Feature to Galaxy Core</a> tutorial). However, we need to exercise the API, so we will be using existing Galaxy functionality as our testing context. Much of that functionality is already covered by tests. Existing tests may include advanced concepts or details on Galaxy’s internals that are beyond the scope of a tutorial on testing, so they are not optimal as examples for training. Therefore, the approach we will use is as follows:</p>\n\n<ol>\n  <li>Pick a controller <code class=\"language-plaintext highlighter-rouge\">foo</code> in the <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/webapps/galaxy/api</code> directory.</li>\n  <li>Pick one of the existing endpoints from the selected controller. If the endpoint represents a <code class=\"language-plaintext highlighter-rouge\">GET</code> request (e.g. <code class=\"language-plaintext highlighter-rouge\">@router.get(\"/api/foos</code>), you may be able to view the results on a running instance at <code class=\"language-plaintext highlighter-rouge\">[host]/api/foos</code></li>\n  <li>Write a new test to verify the specified functionality.</li>\n</ol>\n\n<p>Ideally, we’d like to follow the process of test-driven development: write a test, run it and watch it fail, implement the functionality under test, rerun the test to verify it passes. Although we are not developing any new functionality here, we still would like to verify that the test we have written is a legitimate test of the correctness of the underlying code. In other words, we want it to be deterministic, and fail if the input is invalid. For this, you may want to intentionally break the test on its first run to verify it doesn’t pass under any condition. Then fix the test and rerun. Although this doesn’t guarantee correctness, it helps prevent obvious errors in the testing code (such as forgetting to edit the endpoint after cutting and pasting code from a similar test function.</p>\n\n<h2 id=\"basic-api-test\">Basic API test</h2>\n\n<p>Let’s start by writing a basic test for a very simple API endpoint: <code class=\"language-plaintext highlighter-rouge\">api/version</code>. The controller for this endpoint is located at <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/webapps/galaxy/api/configuration.py</code>. You can check the format of the data at <code class=\"language-plaintext highlighter-rouge\">https://usegalaxy.org/api/version</code>.</p>\n\n<p>First, you need to create a new file at <code class=\"language-plaintext highlighter-rouge\">lib/galaxy_test/api/test_mytutorial.py</code>. For simplicity, we’ll place all new tests in this module. Next, add a class definition for <code class=\"language-plaintext highlighter-rouge\">MyTutorialApiTestCase</code> that should be a subclass of <code class=\"language-plaintext highlighter-rouge\">ApiTestCase</code>. Then add a test method, <code class=\"language-plaintext highlighter-rouge\">test_version_is_current</code>, where you will (1) call the API via the <code class=\"language-plaintext highlighter-rouge\">_get</code> method that returns a response object; and (2) verify that the response contains the “22.09” version number (assuming you have cloned the “dev” branch; otherwise your version may be different).</p>\n\n<p>If your test fails, one way to debug it is to insert a <code class=\"language-plaintext highlighter-rouge\">breakpoint()</code> statement into the body of the test (right after the call to <code class=\"language-plaintext highlighter-rouge\">_get</code> would be a logical spot), and then use <a href=\"https://docs.python.org/3/library/pdb.html\">pdb</a>, Python’s interactive debugger, to explore the response at runtime with the test paused (see <a href=\"/training-material/topics/dev/tutorials/debugging/tutorial.html\">Debugging Galaxy</a> for more details on using pdb to debug Galaxy).</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of a basic API test.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">._framework</span> <span class=\"kn\">import</span> <span class=\"n\">ApiTestCase</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">MyTutorialApiTestCase</span><span class=\"p\">(</span><span class=\"n\">ApiTestCase</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_version_is_current</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">version</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">version_major</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"sh\">\"</span><span class=\"s\">22.09</span><span class=\"sh\">\"</span>  <span class=\"c1\"># Assuming you are on the \"dev\" branch\n</span></code></pre></div>  </div>\n</blockquote>\n\n<p>You may notice that in the provided solution we also call <code class=\"language-plaintext highlighter-rouge\">response.raise_for_status()</code>: this is a requests library function that verifies that the request was successful (of course, we can also explicitly check the status code). It is helpful to include this check, because otherwise, if an error is raised, the error message in the error log will be not as helpful. Try using a nonextistant endpoint and running the test with and without the <code class=\"language-plaintext highlighter-rouge\">raise_for_status</code> call. Compare these error messages:</p>\n\n<p>With the status check:</p>\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">requests.exceptions.HTTPError: 404 Client Error: Not Found for url: http://127.0.0.1:9584/api/versionx</code></li>\n</ul>\n\n<p>Without the status check:</p>\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">requests.exceptions.JSONDecodeError: Expecting value: line 1 column 1 (char 0)</code></li>\n</ul>\n\n<h2 id=\"test-creating-a-simple-object\">Test creating a simple object</h2>\n\n<p>Now let’s write an API test for adding a simple object. By “simple”, we mean that this object does not depend on any other objects, so, for example, we don’t need to provide a reference to a History or User object to create it. We will be creating a role, using the <code class=\"language-plaintext highlighter-rouge\">api/roles</code> <code class=\"language-plaintext highlighter-rouge\">POST</code> endpoint located at <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/webapps/galaxy/api/roles.py</code>.</p>\n\n<p>To create a role, we need to call the <code class=\"language-plaintext highlighter-rouge\">_post</code> method, passing it 4 arguments:</p>\n<ul>\n  <li>the string value of the endpoint</li>\n  <li>the payload containing the data for the new Role object</li>\n  <li>a boolean argument setting the format of the payload data: <code class=\"language-plaintext highlighter-rouge\">json=True</code></li>\n  <li>a boolean argument setting the test user’s admin status: <code class=\"language-plaintext highlighter-rouge\">admin=True</code></li>\n</ul>\n\n<p>How do we know what data to include in the payload? Look at the method signature in the API:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>self, trans: ProvidesUserContext = DependsOnTrans, role_definition_model: RoleDefinitionModel = Body(...)\n</code></pre></div></div>\n<p><code class=\"language-plaintext highlighter-rouge\">RoleDefinitionModel</code> is the Pydantic model that describes the structure of the data passed with this argument. Looking at its definition (check the import statement at the top of the file to find its location), we see the following:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">RoleDefinitionModel</span><span class=\"p\">(</span><span class=\"n\">BaseModel</span><span class=\"p\">):</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"n\">RoleNameField</span>\n    <span class=\"n\">description</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"n\">RoleDescriptionField</span>\n    <span class=\"n\">user_ids</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">EncodedDatabaseIdField</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"nc\">Field</span><span class=\"p\">(</span><span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sh\">\"</span><span class=\"s\">User IDs</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"p\">[])</span>\n    <span class=\"n\">group_ids</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">EncodedDatabaseIdField</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"nc\">Field</span><span class=\"p\">(</span><span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sh\">\"</span><span class=\"s\">Group IDs</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"p\">[])</span>\n</code></pre></div></div>\n\n<p>Thus, we need to provide a name and a description, both of which are string values (the other members are optional), formatted as JSON. (For more details on how the API works, see <a href=\"https://fastapi.tiangolo.com/tutorial/\">FastAPI’s excellent documentation</a>.)</p>\n\n<p>The response will return the Role object, so testing it is straightforward.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>API test for creating an object.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">MyTutorialApiTestCase</span><span class=\"p\">(</span><span class=\"n\">ApiTestCase</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_create_role</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># prepare new role\n</span>        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">cool role</span><span class=\"sh\">\"</span>\n        <span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">description of this cool role</span><span class=\"sh\">\"</span>\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">description</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n        <span class=\"c1\"># add new role and verify\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_post</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">,</span> <span class=\"n\">admin</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">role</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">description</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"a-better-test-for-creating-a-simple-object\">A better test for creating a simple object</h2>\n\n<p>Can we do better? We can verify that the new object has been added by using another endpoint to retrieve that object from the database. Here’s a first take:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_create_role_WRONG</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n    <span class=\"n\">ROLE_COUNT</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n    <span class=\"c1\"># verify no roles except one built-in role for test user\n</span>    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">ROLE_COUNT</span>\n\n    <span class=\"c1\"># create role\n</span>    <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"sh\">'</span><span class=\"s\">my cool name</span><span class=\"sh\">'</span>\n    <span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"sh\">'</span><span class=\"s\">description of this cool role</span><span class=\"sh\">'</span>\n    <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">description</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_post</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">,</span> <span class=\"n\">admin</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n    <span class=\"n\">role</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n    <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span>\n    <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">description</span>\n\n    <span class=\"c1\"># verify role has been added\n</span>    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">ROLE_COUNT</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n</code></pre></div></div>\n\n<p>Everything is straightforward: we verify that there is only n=1 role currently present (a built-in for the test user), we add the role, then retrieve all roles and verify that the new total is n + 1. Unfortunately, <strong><em>this is the wrong approach</em></strong>. Try running this together with the previous version of the test - you’ll get an assertion error: there’s an extra role in the database!</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>FAILED lib/galaxy_test/api/test_mytutorial.py::MyTutorialApiTestCase::test_create_role_WRONG - AssertionError: assert 2 == 1\n</code></pre></div></div>\n\n<p>The reason for that is that we are using the same database for both tests, so whatever artifacts are created in one test will affect the following test if we make any kind of assumptions about the state of the database.</p>\n\n<p>How do we rewrite this test without making assumptions about database state? We can’t retrieve the roles and use their initial quantity as our baseline: that’s a perfect recipe for a race condition (if some other test creates a role after we have counted the existing roles but before we have created our new role, our test will fail). Instead, we can use the role’s name (which is unique across all roles) to verify that our object has been added.</p>\n\n<p>We could generate our own unique name, but we can also simply use an existing method used across Galaxy’s tests: <code class=\"language-plaintext highlighter-rouge\">get_random_name()</code> (we need to add an import and override the <code class=\"language-plaintext highlighter-rouge\">setUp</code> method for that: see the solution code). Now we have a test we can safely run together with our old test (or with any number of other tests that create role objects).</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Alternative test for creating an object. Note the <code class=\"language-plaintext highlighter-rouge\">setUp</code> method and the new import.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">galaxy_test.base.populators</span> <span class=\"kn\">import</span> <span class=\"n\">DatasetPopulator</span>\n<span class=\"kn\">from</span> <span class=\"n\">._framework</span> <span class=\"kn\">import</span> <span class=\"n\">ApiTestCase</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">MyTutorialApiTestCase</span><span class=\"p\">(</span><span class=\"n\">ApiTestCase</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">setUp</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"nf\">super</span><span class=\"p\">().</span><span class=\"nf\">setUp</span><span class=\"p\">()</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span> <span class=\"o\">=</span> <span class=\"nc\">DatasetPopulator</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">galaxy_interactor</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># [code omitted]\n</span>\n    <span class=\"k\">def</span> <span class=\"nf\">test_create_role2</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># prepare new role\n</span>        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">get_random_name</span><span class=\"p\">()</span>\n        <span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"sh\">'</span><span class=\"s\">description of this cool role</span><span class=\"sh\">'</span>\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">description</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"c1\"># verify new role does not exist\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"ow\">not</span> <span class=\"nf\">any</span><span class=\"p\">(</span><span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">role</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># add new role\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_post</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">,</span> <span class=\"n\">admin</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">role</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">description</span>\n\n        <span class=\"c1\"># verify role has been added\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">any</span><span class=\"p\">(</span><span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">role</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Can’t we destroy and create or re-populate the database for each test? We can, and if you absolutely need to do that, there is infrastructure for that in <code class=\"language-plaintext highlighter-rouge\">test/unit/data/model/testing_utils</code> - you can see examples of its usage in the mapping and migrations unit tests (check these subdirectories). However, setting up and initializing the database is an expensive operation, which will be noticeable for a single test; Galaxy has hundreds of tests that rely on the database, so providing a fresh copy of the database for each test function is infeasible.</p>\n\n<h2 id=\"use-galaxys-populators-for-setting-up-database-state\">Use Galaxy’s populators for setting up database state</h2>\n\n<p>As our last example, we’ll look at how to take advantage of some of the many abstractions provided by Galaxy’s testing infrastructure. Supposing you’d like to test the “datasets-filter-by-history” functionality exposed via the <code class=\"language-plaintext highlighter-rouge\">api/datasets</code> endpoint (see <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/webapps/galaxy/api/datasets.py</code>). The test design is straightforward:</p>\n<ul>\n  <li>Create 2 history objects h1 and h2.</li>\n  <li>Create n and m datasets associated with h1 and h2 respectively.</li>\n  <li>Retrieve datasets filtering by h1. Verify there are n results.</li>\n  <li>Retrieve datasets filtering by h2. Verify there are m results.</li>\n</ul>\n\n<p>The question is, how do we create the datasets and the histories (and all their respective dependencies?). One way would be to use the API for each such object. However, that would result in a barely readable test function which would mostly consist of setup code. Instead, we want our tests to be simple and understandable at a glance, and contain as little infrastructure code as possible. Enter dataset populators! This is one of many abstractions available to you that make it much easier to write tests that otherwise would have required nontrivial setup.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Using populators.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    <span class=\"k\">def</span> <span class=\"nf\">test_search_dataset_by_history</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_history</span><span class=\"p\">()</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_history</span><span class=\"p\">()</span>\n\n        <span class=\"n\">history1_datasets</span><span class=\"p\">,</span> <span class=\"n\">history2_datasets</span> <span class=\"o\">=</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"nf\">range</span><span class=\"p\">(</span><span class=\"n\">history1_datasets</span><span class=\"p\">):</span>\n            <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_dataset</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"nf\">range</span><span class=\"p\">(</span><span class=\"n\">history2_datasets</span><span class=\"p\">):</span>\n            <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_dataset</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span><span class=\"p\">)</span>\n\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"sh\">\"</span><span class=\"s\">history_id</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span><span class=\"p\">,</span> <span class=\"p\">}</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">datasets</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">).</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">history1_datasets</span>\n\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"sh\">\"</span><span class=\"s\">history_id</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span><span class=\"p\">,</span> <span class=\"p\">}</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">datasets</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">).</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">history2_datasets</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Populators are used extensively throughout API tests as well as integration and Selenium tests to both setup database state, as well as access information from the Galaxy server. For more details, see the populators module at <code class=\"language-plaintext highlighter-rouge\">lib/galaxy_test/base/populators.py</code>.</p>\n\n<p>And we are done! Here’s the final version of the code we added to this testing module.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Final code.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">galaxy_test.base.populators</span> <span class=\"kn\">import</span> <span class=\"n\">DatasetPopulator</span>\n<span class=\"kn\">from</span> <span class=\"n\">._framework</span> <span class=\"kn\">import</span> <span class=\"n\">ApiTestCase</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">MyTutorialApiTestCase</span><span class=\"p\">(</span><span class=\"n\">ApiTestCase</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">setUp</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"nf\">super</span><span class=\"p\">().</span><span class=\"nf\">setUp</span><span class=\"p\">()</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span> <span class=\"o\">=</span> <span class=\"nc\">DatasetPopulator</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">galaxy_interactor</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_version_is_current</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">version</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">version_major</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"sh\">\"</span><span class=\"s\">22.09</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_create_role</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># prepare new role\n</span>        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">get_random_name</span><span class=\"p\">()</span>\n        <span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"sh\">'</span><span class=\"s\">description of this cool role</span><span class=\"sh\">'</span>\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">description</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n        <span class=\"c1\"># add new role and verify\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_post</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">,</span> <span class=\"n\">admin</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">role</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">description</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_create_role2</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># prepare new role\n</span>        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">get_random_name</span><span class=\"p\">()</span>\n        <span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"sh\">'</span><span class=\"s\">description of this cool role</span><span class=\"sh\">'</span>\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">description</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"c1\"># verify new role does not exist\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"ow\">not</span> <span class=\"nf\">any</span><span class=\"p\">(</span><span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">role</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># add new role\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_post</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">,</span> <span class=\"n\">admin</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">json</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">role</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span>\n        <span class=\"k\">assert</span> <span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">description</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">description</span>\n\n        <span class=\"c1\"># verify role has been added\n</span>        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">roles</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">raise_for_status</span><span class=\"p\">()</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"p\">.</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">any</span><span class=\"p\">(</span><span class=\"n\">role</span><span class=\"p\">[</span><span class=\"sh\">\"</span><span class=\"s\">name</span><span class=\"sh\">\"</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">role</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_search_dataset_by_history</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_history</span><span class=\"p\">()</span>\n        <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_history</span><span class=\"p\">()</span>\n\n        <span class=\"n\">history1_datasets</span><span class=\"p\">,</span> <span class=\"n\">history2_datasets</span> <span class=\"o\">=</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">3</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"nf\">range</span><span class=\"p\">(</span><span class=\"n\">history1_datasets</span><span class=\"p\">):</span>\n            <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_dataset</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"nf\">range</span><span class=\"p\">(</span><span class=\"n\">history2_datasets</span><span class=\"p\">):</span>\n            <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">dataset_populator</span><span class=\"p\">.</span><span class=\"nf\">new_dataset</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span><span class=\"p\">)</span>\n\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"sh\">\"</span><span class=\"s\">history_id</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history1_id</span><span class=\"p\">,</span> <span class=\"p\">}</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">datasets</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">).</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">history1_datasets</span>\n\n        <span class=\"n\">payload</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"sh\">\"</span><span class=\"s\">history_id</span><span class=\"sh\">\"</span><span class=\"p\">:</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"n\">history2_id</span><span class=\"p\">,</span> <span class=\"p\">}</span>\n        <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nf\">_get</span><span class=\"p\">(</span><span class=\"sh\">\"</span><span class=\"s\">datasets</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"n\">payload</span><span class=\"p\">).</span><span class=\"nf\">json</span><span class=\"p\">()</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">len</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">history2_datasets</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<h1 id=\"unit-tests\">Unit tests</h1>\n\n<p>Unit tests are best suited for testing well-defined, isolated functionality and, with rare exceptions, should not require a running Galaxy instance, a database, or any other external infrastructure. Unit tests are located in the <code class=\"language-plaintext highlighter-rouge\">test/unit</code> directory.</p>\n\n<p>There are numerous unit tests in the Galaxy code base. However, existing unit tests do not cover the entire code base and do not verify all the relevant logic (so there is plenty of space for improvement, and new contributions are always welcome!) In this tutorial, we will be writing unit tests for such code.</p>\n\n<h2 id=\"testing-simple-functions\">Testing simple functions</h2>\n\n<p>We’ll start by looking at the module <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/util/bytesize.py</code>. This module is not covered by unit tests. There are 2 obvious targets for unit tests: the <code class=\"language-plaintext highlighter-rouge\">parse bytesize</code> function and the <code class=\"language-plaintext highlighter-rouge\">to_unit</code> method of the <code class=\"language-plaintext highlighter-rouge\">ByteSize</code> class. Our goal is to come up with a reasonable selection of unit tests that verify essential aspects of this functionality.</p>\n\n<p>We’ll start with the <code class=\"language-plaintext highlighter-rouge\">parse_bytesize</code> function. Look at the code of the function and identify the logic that, you think, needs testing. Essentially, you want to ensure that any combination of valid input produces the expected output. Next, add a few tests. (see <a href=\"https://docs.pytest.org/en/7.1.x/how-to/assert.html\">https://docs.pytest.org/en/7.1.x/how-to/assert.html</a> for examples)</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of tests for the <code class=\"language-plaintext highlighter-rouge\">parse_bytesize</code> function:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">galaxy.util.bytesize</span> <span class=\"kn\">import</span> <span class=\"n\">ByteSize</span><span class=\"p\">,</span> <span class=\"n\">parse_bytesize</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_parse_bytesize_int_or_float</span><span class=\"p\">():</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">42</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"mf\">42.5</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mf\">42.5</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_parse_bytesize_str_no_suffix</span><span class=\"p\">():</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">42</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">42</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">42.5</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mf\">42.5</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_parse_bytesize_str_suffix</span><span class=\"p\">():</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">10K</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">10000</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">10 KI</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">10240</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify they pass. You can use the <code class=\"language-plaintext highlighter-rouge\">pytest</code> command:</p>\n\n<blockquote class=\"code-in\">\n  <code-in-title>Bash</code-in-title>\n  <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pytest <span class=\"nb\">test</span>/unit/util/test_bytesize.py\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"verifying-that-an-error-is-raised\">Verifying that an error is raised</h2>\n\n<p>Now let’s add a test that verifies that invalid input raises an error, as expected.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of a test verifying a raised exception. Make sure you add the <code class=\"language-plaintext highlighter-rouge\">pytest</code> import.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">pytest</span>\n\n<span class=\"c1\"># [code omitted]\n</span>\n<span class=\"k\">def</span> <span class=\"nf\">test_parse_bytesize_str_invalid</span><span class=\"p\">():</span>\n    <span class=\"k\">with</span> <span class=\"n\">pytest</span><span class=\"p\">.</span><span class=\"nf\">raises</span><span class=\"p\">(</span><span class=\"nb\">ValueError</span><span class=\"p\">):</span>\n        <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">10 invalid-suffix</span><span class=\"sh\">'</span><span class=\"p\">)</span>\n    <span class=\"k\">with</span> <span class=\"n\">pytest</span><span class=\"p\">.</span><span class=\"nf\">raises</span><span class=\"p\">(</span><span class=\"nb\">ValueError</span><span class=\"p\">):</span>\n        <span class=\"nf\">parse_bytesize</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">invalid-value</span><span class=\"sh\">'</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify they pass.</p>\n\n<h2 id=\"using-fixtures-to-reduce-code-duplication\">Using fixtures to reduce code duplication</h2>\n\n<p>Let’s move on to the <code class=\"language-plaintext highlighter-rouge\">to_unit</code> method of the <code class=\"language-plaintext highlighter-rouge\">ByteSize</code>class. Just like you did for the previous function, add a few tests that verify that valid input produces expected output, and invalid input raises an error.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of tests for the <code class=\"language-plaintext highlighter-rouge\">ByteSize.to_unit</code> method:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit</span><span class=\"p\">():</span>\n    <span class=\"n\">bytesize</span> <span class=\"o\">=</span> <span class=\"nc\">ByteSize</span><span class=\"p\">(</span><span class=\"mi\">1_000_000_000_000_000</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">k</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">m</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000M</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">g</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000G</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">t</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000T</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">p</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1P</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">e</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0E</span><span class=\"sh\">'</span>\n\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ki</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">976562500000KI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">mi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">953674316MI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">gi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">931322GI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ti</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">909TI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">pi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0PI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ei</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0EI</span><span class=\"sh\">'</span>\n\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000000</span><span class=\"sh\">'</span>  <span class=\"c1\"># no unit\n</span>    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">K</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span>  <span class=\"c1\"># uppercase unit\n</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit_as_str</span><span class=\"p\">():</span>\n    <span class=\"n\">bytesize</span> <span class=\"o\">=</span> <span class=\"nc\">ByteSize</span><span class=\"p\">(</span><span class=\"mi\">1_000_000_000_000_000</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">k</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"n\">as_string</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1000000000000</span>  <span class=\"c1\"># not to_string\n</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit_invalid</span><span class=\"p\">():</span>\n    <span class=\"n\">bytesize</span> <span class=\"o\">=</span> <span class=\"nc\">ByteSize</span><span class=\"p\">(</span><span class=\"mi\">1_000_000_000_000_000</span><span class=\"p\">)</span>\n    <span class=\"k\">with</span> <span class=\"n\">pytest</span><span class=\"p\">.</span><span class=\"nf\">raises</span><span class=\"p\">(</span><span class=\"nb\">KeyError</span><span class=\"p\">):</span>\n        <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">invalid</span><span class=\"sh\">'</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify they pass.</p>\n\n<p>Our tests are looking good for the most part, although code duplication is starting to creep in. It’s time to refactor!</p>\n\n<p>Let’s start by factoring out the ByteSize object creation into a fixture (see <a href=\"https://docs.pytest.org/en/7.1.x/how-to/fixtures.html\">https://docs.pytest.org/en/7.1.x/how-to/fixtures.html</a>). In this particular case moving this code into a fixture might be unnecessary, however, it provides an example of an approach that is very useful in more complex scenarios and is heavily used in Galaxy’s testing code.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Factoring out code into a fixture: we declare a fixture using pytest’s built-in <code class=\"language-plaintext highlighter-rouge\">fixture</code> decorator,\nand then simply pass it as an argument to our tests.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">bytesize</span><span class=\"p\">():</span>\n    <span class=\"k\">return</span> <span class=\"nc\">ByteSize</span><span class=\"p\">(</span><span class=\"mi\">1_000_000_000_000_000</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit</span><span class=\"p\">(</span><span class=\"n\">bytesize</span><span class=\"p\">):</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">k</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">m</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000M</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">g</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000G</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">t</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000T</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">p</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1P</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">e</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0E</span><span class=\"sh\">'</span>\n\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ki</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">976562500000KI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">mi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">953674316MI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">gi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">931322GI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ti</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">909TI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">pi</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0PI</span><span class=\"sh\">'</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ei</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">0EI</span><span class=\"sh\">'</span>\n\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000000</span><span class=\"sh\">'</span>  <span class=\"c1\"># no unit\n</span>    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">K</span><span class=\"sh\">'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span>  <span class=\"c1\"># uppercase unit\n</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit_as_str</span><span class=\"p\">(</span><span class=\"n\">bytesize</span><span class=\"p\">):</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">k</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"n\">as_string</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1000000000000</span>  <span class=\"c1\"># not to_string\n</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit_invalid</span><span class=\"p\">(</span><span class=\"n\">bytesize</span><span class=\"p\">):</span>\n    <span class=\"k\">with</span> <span class=\"n\">pytest</span><span class=\"p\">.</span><span class=\"nf\">raises</span><span class=\"p\">(</span><span class=\"nb\">KeyError</span><span class=\"p\">):</span>\n        <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">invalid</span><span class=\"sh\">'</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify they pass.</p>\n\n<h2 id=\"parametrization-of-test-functions\">Parametrization of test functions</h2>\n\n<p>Finally, our <code class=\"language-plaintext highlighter-rouge\">test_bytesize_to_unit</code> test has a lot of assert statements of the same form. We can do better! Let’s use pytest’s test parametrization feature (see <a href=\"https://docs.pytest.org/en/7.1.x/how-to/parametrize.html\">https://docs.pytest.org/en/7.1.x/how-to/parametrize.html</a>) to eliminate this redundancy. Again, as with the fixture example, this particular case would be fine without this feature. However, sometime you want to run the same test function on hundreds of different input combinations, in which case this feature is invaluable (e.g. Galaxy’s tool tests, or integration tests for configuration settings).</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of parametrizing a test. Replace the previous version of <code class=\"language-plaintext highlighter-rouge\">test_bytesize_to_unit</code> with the\nfollowing. Note that the test function takes 2 additional arguments.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nd\">@pytest.mark.parametrize</span><span class=\"p\">(</span>\n    <span class=\"sh\">\"</span><span class=\"s\">unit, expected_value</span><span class=\"sh\">\"</span><span class=\"p\">,</span>\n    <span class=\"p\">[</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">k</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">m</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000000000M</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">g</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000000G</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">t</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000T</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">p</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1P</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">e</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">0E</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ki</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">976562500000KI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">mi</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">953674316MI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">gi</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">931322GI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ti</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">909TI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">pi</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">0PI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">ei</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">0EI</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000000</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"sh\">'</span><span class=\"s\">K</span><span class=\"sh\">'</span><span class=\"p\">,</span> <span class=\"sh\">'</span><span class=\"s\">1000000000000K</span><span class=\"sh\">'</span><span class=\"p\">),</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">test_bytesize_to_unit</span><span class=\"p\">(</span><span class=\"n\">unit</span><span class=\"p\">,</span> <span class=\"n\">expected_value</span><span class=\"p\">,</span> <span class=\"n\">bytesize</span><span class=\"p\">):</span>\n    <span class=\"k\">assert</span> <span class=\"n\">bytesize</span><span class=\"p\">.</span><span class=\"nf\">to_unit</span><span class=\"p\">(</span><span class=\"n\">unit</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">expected_value</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify they pass.</p>\n\n<h2 id=\"dealing-with-less-trivial-code\">Dealing with less trivial code</h2>\n\n<p>So far we’ve been dealing with simple clean functions that had no external dependencies. However, quite often you will encounter lengthy blocks of code implementing nontrivial logic, that depend on objects that would be hard to instantiate in the context of a test. There are many excellent resources on this topic (the book <a href=\"https://www.oreilly.com/library/view/working-effectively-with/0131177052/\">Working Effectively with Legacy Code</a> by Michael Feathers is but one example). In this tutorial, we’ll demonstrate a few basic approaches to handling such cases.</p>\n\n<p>Your target module for the following exercises is <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/security/validate_user_input.py</code>. The unit tests for this module are located at <code class=\"language-plaintext highlighter-rouge\">test/unit/data/security/test_validate_user_input.py</code>. You will be adding your code to this testing module.</p>\n\n<p>If you look at the tests for this module, you’ll note that most of its functionality is directly or indirectly covered by tests. However, the <code class=\"language-plaintext highlighter-rouge\">validate_email</code> function does not have tests - and that’s a shame for, despite being relatively small, it contains logic that is not immediately obvious (consider how the function behaves under different combinations of the allowlist and blocklist). That’s the function we’ll be testing.</p>\n\n<p>The <code class=\"language-plaintext highlighter-rouge\">validate_email</code> function is not fun to test. It depends on a Transaction and User objects - one does not simply <del>walk into Mordor</del> instantiate those in the context of a unit test. It has multiple paths of execution, to determine which it accesses the GalaxyApplication object (which is a reference to a running instance of Galaxy) to access configuration values, the User object to check the value of its email attribute, and in addition to all that, of course, it calls the database. None of these dependencies require testing, at least not in the context of a unit test. However, we do want to verify the function’s core logic: the cases when no validation is required, when the provided email already exists, and the different combinations of the allowlist and blocklist.</p>\n\n<h2 id=\"mocking-a-dependency\">Mocking a dependency</h2>\n\n<p>First, let’s test the case when the function returns early - when the email argument is the empty string or when its value is the same as the value of the <code class=\"language-plaintext highlighter-rouge\">email</code> attribute of the provided User object. The first case is trivial, but the next one requires a User object. However, if we think about it, we only care about that user having a given string as its <code class=\"language-plaintext highlighter-rouge\">email</code> attribute. So let’s use a “test double” - a stand-in empty object, and give it an <code class=\"language-plaintext highlighter-rouge\">email</code> attribute. We’ll call it <code class=\"language-plaintext highlighter-rouge\">MockUser</code> (strictly speaking, it’s a stub, and <a href=\"https://martinfowler.com/articles/mocksArentStubs.html\">“mocks aren’t stubs”</a>, but we’ll follow the naming convention often used in Galaxy). We can pass <code class=\"language-plaintext highlighter-rouge\">None</code> as the transaction object in both cases.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Example of replacing an object with a test double:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">galaxy.security.validate_user_input</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">extract_domain</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_domain_resolves</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_email</span><span class=\"p\">,</span>  <span class=\"c1\"># we've added this import\n</span>    <span class=\"n\">validate_email_str</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_publicname_str</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">MockUser</span><span class=\"p\">:</span>\n    <span class=\"k\">pass</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_email_is_empty</span><span class=\"p\">():</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"\"</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">test_email_is_user_email</span><span class=\"p\">():</span>\n    <span class=\"n\">my_email</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">foo</span><span class=\"sh\">\"</span>\n    <span class=\"n\">my_user</span> <span class=\"o\">=</span> <span class=\"nc\">MockUser</span><span class=\"p\">()</span>\n    <span class=\"n\">my_user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">=</span> <span class=\"n\">my_email</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">my_email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">my_user</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Now run the tests for this module:</p>\n\n<blockquote class=\"code-in\">\n  <code-in-title>Bash</code-in-title>\n  <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>pytest <span class=\"nb\">test</span>/unit/data/security/test_validate_user_input.py\n</code></pre></div>  </div>\n</blockquote>\n\n<blockquote class=\"warning\">\n  <warning-title></warning-title>\n  <p>As a word of caution, mocking (or any kind of patching to accommodate testing) may lead to brittle tests: by relying too much on <em>how</em> the logic is implemented, we’ll be forced to adjust the test each time that implementation changes. It’s a tradeoff between having narrowly-scoped tests that will point to the exact location of the problem but may lock the code under test into a given state, and higher-level integration-type tests that test the end result without “looking under the hood”, but may be less helpful when pinpointing the exact cause of a failed test. So, use sparingly and keep it simple.</p>\n</blockquote>\n\n<h2 id=\"refactoring-for-testability\">Refactoring for testability</h2>\n\n<p>Next, we’d like to test the case when the provided email already exists, or doesn’t exist. To determine the existence of an email the function calls the database - we don’t want to do that. Instead, we can simulate both conditions, like we simulated the user email in the previous exercise.</p>\n\n<p>For this, we need to factor out the code that calls the database into its own function - then we can override that function for our test. So let’s modify <code class=\"language-plaintext highlighter-rouge\">lib/galaxy/security/validate_user_input.py</code>.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Factoring out the database call.</p>\n\n  <p>Old version:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">check_dup</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">,</span> <span class=\"n\">validate_domain</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">):</span>\n    <span class=\"sh\">\"\"\"</span><span class=\"s\">\n    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.\n    </span><span class=\"sh\">\"\"\"</span>\n    <span class=\"nf\">if </span><span class=\"p\">(</span><span class=\"n\">user</span> <span class=\"ow\">and</span> <span class=\"n\">user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"n\">email</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span> <span class=\"ow\">and</span> <span class=\"n\">allow_empty</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"sh\">\"\"</span>\n    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email_str</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span> <span class=\"ow\">and</span> <span class=\"n\">validate_domain</span><span class=\"p\">:</span>\n        <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_domain_resolves</span><span class=\"p\">(</span><span class=\"n\">domain</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Code to be refactored\n</span>    <span class=\"nf\">if </span><span class=\"p\">(</span>\n        <span class=\"ow\">not</span> <span class=\"n\">message</span>\n        <span class=\"ow\">and</span> <span class=\"n\">check_dup</span>\n        <span class=\"ow\">and</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">sa_session</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">User</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">.</span><span class=\"nf\">lower</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">User</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">.</span><span class=\"n\">email</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">email</span><span class=\"p\">.</span><span class=\"nf\">lower</span><span class=\"p\">())</span>\n        <span class=\"p\">.</span><span class=\"nf\">first</span><span class=\"p\">()</span>\n    <span class=\"p\">):</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"sh\">\"</span><span class=\"s\">User with email </span><span class=\"sh\">'</span><span class=\"si\">{</span><span class=\"n\">email</span><span class=\"si\">}</span><span class=\"sh\">'</span><span class=\"s\"> already exists.</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span><span class=\"p\">:</span>\n        <span class=\"c1\"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.\n</span>        <span class=\"k\">if</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_allowlist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_allowlist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter an allowed domain email address for this server.</span><span class=\"sh\">\"</span>\n        <span class=\"c1\"># If the blocklist is not empty filter out the disposable domains.\n</span>        <span class=\"k\">elif</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_blocklist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">base_only</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">in</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_blocklist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter your permanent email address.</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">message</span>\n</code></pre></div>  </div>\n\n  <p>Refactored version:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">):</span>\n    <span class=\"n\">user_record</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">sa_session</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">User</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">.</span><span class=\"nf\">lower</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">User</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">.</span><span class=\"n\">email</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">email</span><span class=\"p\">.</span><span class=\"nf\">lower</span><span class=\"p\">())</span>\n        <span class=\"p\">.</span><span class=\"nf\">first</span><span class=\"p\">()</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"nf\">bool</span><span class=\"p\">(</span><span class=\"n\">user_record</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">check_dup</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">,</span> <span class=\"n\">validate_domain</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">):</span>\n    <span class=\"sh\">\"\"\"</span><span class=\"s\">\n    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.\n    </span><span class=\"sh\">\"\"\"</span>\n    <span class=\"nf\">if </span><span class=\"p\">(</span><span class=\"n\">user</span> <span class=\"ow\">and</span> <span class=\"n\">user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"n\">email</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span> <span class=\"ow\">and</span> <span class=\"n\">allow_empty</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"sh\">\"\"</span>\n    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email_str</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span> <span class=\"ow\">and</span> <span class=\"n\">validate_domain</span><span class=\"p\">:</span>\n        <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_domain_resolves</span><span class=\"p\">(</span><span class=\"n\">domain</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Refactored code\n</span>    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span> <span class=\"ow\">and</span> <span class=\"n\">check_dup</span> <span class=\"ow\">and</span> <span class=\"nf\">check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">):</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"sh\">\"</span><span class=\"s\">User with email </span><span class=\"sh\">'</span><span class=\"si\">{</span><span class=\"n\">email</span><span class=\"si\">}</span><span class=\"sh\">'</span><span class=\"s\"> already exists.</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span><span class=\"p\">:</span>\n        <span class=\"c1\"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.\n</span>        <span class=\"k\">if</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_allowlist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_allowlist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter an allowed domain email address for this server.</span><span class=\"sh\">\"</span>\n        <span class=\"c1\"># If the blocklist is not empty filter out the disposable domains.\n</span>        <span class=\"k\">elif</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_blocklist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">base_only</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">in</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_blocklist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter your permanent email address.</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">message</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"monkeypatching-the-module-under-test\">“Monkeypatching” the module under test</h2>\n\n<p>Now we can use pytest’s “monkeypatch” built-in fixture to replace that function with a stub method and then use it to return <code class=\"language-plaintext highlighter-rouge\">True</code> or <code class=\"language-plaintext highlighter-rouge\">False</code> to test both cases. (see <a href=\"https://docs.pytest.org/en/7.1.x/how-to/monkeypatch.html?highlight=monkeypatch\">https://docs.pytest.org/en/7.1.x/how-to/monkeypatch.html?highlight=monkeypatch</a> for more details).</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Monkeypatching the factored out function. Note the added import.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">from</span> <span class=\"n\">galaxy.security</span> <span class=\"kn\">import</span> <span class=\"n\">validate_user_input</span>\n\n<span class=\"c1\"># [code omitted]\n</span>\n<span class=\"k\">def</span> <span class=\"nf\">test_check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">duplicate_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">exists</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"n\">result</span>\n\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">unique_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"n\">result</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"more-refactoring\">More refactoring</h2>\n\n<p>Run the tests to verify they pass after our latest modifications. But one test fails! The problem is that our validation function is not yet ready for testing: it still relies on the transaction object to access the running instance of Galaxy to retrieve 2 configuration settings: <code class=\"language-plaintext highlighter-rouge\">email_domain_allowlist_content</code> and <code class=\"language-plaintext highlighter-rouge\">email_domain_blocklist_content</code>.</p>\n\n<p>How would you fix this problem?</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Factor out the logic for obtaining both lists:</p>\n  <ol>\n    <li>Create 2 functions that take a transaction object as an argument and return the lists.</li>\n    <li>Call the functions from the <code class=\"language-plaintext highlighter-rouge\">validate_email</code> function’s body, assigning the results to\nlocal variables.</li>\n    <li>Replace all calls to <code class=\"language-plaintext highlighter-rouge\">trans.app.config.[the list]</code> with the variables you’ve just assigned.</li>\n  </ol>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">get_email_domain_allowlist_content</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_allowlist_content</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_email_domain_blocklist_content</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">trans</span><span class=\"p\">.</span><span class=\"n\">app</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">email_domain_blocklist_content</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">check_dup</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">,</span> <span class=\"n\">validate_domain</span><span class=\"o\">=</span><span class=\"bp\">False</span><span class=\"p\">):</span>\n    <span class=\"sh\">\"\"\"</span><span class=\"s\">\n    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.\n    </span><span class=\"sh\">\"\"\"</span>\n    <span class=\"nf\">if </span><span class=\"p\">(</span><span class=\"n\">user</span> <span class=\"ow\">and</span> <span class=\"n\">user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"n\">email</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">email</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span> <span class=\"ow\">and</span> <span class=\"n\">allow_empty</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"sh\">\"\"</span>\n    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email_str</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span> <span class=\"ow\">and</span> <span class=\"n\">validate_domain</span><span class=\"p\">:</span>\n        <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"nf\">validate_domain_resolves</span><span class=\"p\">(</span><span class=\"n\">domain</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span> <span class=\"ow\">and</span> <span class=\"n\">check_dup</span> <span class=\"ow\">and</span> <span class=\"nf\">check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">,</span> <span class=\"n\">email</span><span class=\"p\">):</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"sh\">\"</span><span class=\"s\">User with email </span><span class=\"sh\">'</span><span class=\"si\">{</span><span class=\"n\">email</span><span class=\"si\">}</span><span class=\"sh\">'</span><span class=\"s\"> already exists.</span><span class=\"sh\">\"</span>\n\n    <span class=\"n\">email_domain_allowlist_content</span> <span class=\"o\">=</span> <span class=\"nf\">get_email_domain_allowlist_content</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">)</span>\n    <span class=\"n\">email_domain_blocklist_content</span> <span class=\"o\">=</span> <span class=\"nf\">get_email_domain_blocklist_content</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">message</span><span class=\"p\">:</span>\n        <span class=\"c1\"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.\n</span>        <span class=\"k\">if</span> <span class=\"n\">email_domain_allowlist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">email_domain_allowlist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter an allowed domain email address for this server.</span><span class=\"sh\">\"</span>\n        <span class=\"c1\"># If the blocklist is not empty filter out the disposable domains.\n</span>        <span class=\"k\">elif</span> <span class=\"n\">email_domain_blocklist_content</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">domain</span> <span class=\"o\">=</span> <span class=\"nf\">extract_domain</span><span class=\"p\">(</span><span class=\"n\">email</span><span class=\"p\">,</span> <span class=\"n\">base_only</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">in</span> <span class=\"n\">email_domain_blocklist_content</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">Please enter your permanent email address.</span><span class=\"sh\">\"</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">message</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"more-monkeypatching\">More “monkeypatching”</h2>\n\n<p>Run the tests. They still fail. That’s because we haven’t replaced the new functions with a mock for our test. Try to do that - it’s the same approach as we used for monkeypatching the <code class=\"language-plaintext highlighter-rouge\">check_for_existing_email</code> function. Note that both lists should be <code class=\"language-plaintext highlighter-rouge\">None</code> to be ignored.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Monkeypatch the email lists: return <code class=\"language-plaintext highlighter-rouge\">None</code> for both, then override as needed:</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">duplicate_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">exists</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"n\">result</span>\n\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">unique_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"n\">result</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests - they should pass now.</p>\n\n<h2 id=\"utilizing-the-mocks-to-test-the-logic\">Utilizing the mocks to test the logic</h2>\n\n<p>Now that our tests pass, it’s time to test the last bit of logic: the allowlist and the blocklist. Our first step is to add a simple test to verify that if the allow-list is not empty, only emails with allowed domain names will be validated.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>First take on testing the allowlist.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_validate_email_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">good_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@good_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter an allowed domain</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests to verify we haven’t broken anything.</p>\n\n<p>However, again, we are getting a lot of duplication from our monkeypatching code, and there are more tests to come. Time to move some of it into fixtures; <strong>leave only the code that is specific to the test</strong>.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Factor out all common monkeypatching into fixtures. Note the <code class=\"language-plaintext highlighter-rouge\">pytest</code> import.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"n\">pytest</span>\n\n<span class=\"c1\"># [code omitted]\n</span>\n<span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_allowlist</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_blocklist</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_check_existing</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_email_is_empty</span><span class=\"p\">():</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"\"</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_email_is_user_email</span><span class=\"p\">():</span>\n    <span class=\"n\">my_email</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">foo</span><span class=\"sh\">\"</span>\n    <span class=\"n\">my_user</span> <span class=\"o\">=</span> <span class=\"nc\">MockUser</span><span class=\"p\">()</span>\n    <span class=\"n\">my_user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">=</span> <span class=\"n\">my_email</span>\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">my_email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">my_user</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">patch_allowlist</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">True</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">duplicate_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">exists</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"n\">result</span>\n\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">unique_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"n\">result</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">test_validate_email_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">):</span>\n    <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">good_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@good_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter an allowed domain</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Again, run the tests to verify we haven’t broken anything.</p>\n\n<h2 id=\"reformatting-for-improved-readability\">Reformatting for improved readability</h2>\n\n<p>Before we add more tests, let’s reformat our code to group all the tests that target the <code class=\"language-plaintext highlighter-rouge\">validate_email</code> function in one class. Keep in mind that each test gets its own instance of the class - so you cannot share instance state across tests. However, grouping related tests makes the testing module easier to navigate (there are more benefits; see <a href=\"https://docs.pytest.org/en/7.1.x/getting-started.html#group-multiple-tests-in-a-class\">https://docs.pytest.org/en/7.1.x/getting-started.html#group-multiple-tests-in-a-class</a>).</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Group related tests in one class. Note that you need to add <code class=\"language-plaintext highlighter-rouge\">self</code> as the first\nargument to each test function. You also need to add <code class=\"language-plaintext highlighter-rouge\">self</code> to the call to <code class=\"language-plaintext highlighter-rouge\">MockUser()</code>. Leave\nthe fixtures outside the class body, so that they can be reused by other test code.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">class</span> <span class=\"nc\">TestValidateEmail</span><span class=\"p\">:</span>\n\n    <span class=\"k\">class</span> <span class=\"nc\">MockUser</span><span class=\"p\">:</span>\n        <span class=\"k\">pass</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_email_is_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"\"</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_email_is_user_email</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">my_email</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">foo</span><span class=\"sh\">\"</span>\n        <span class=\"n\">my_user</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nc\">MockUser</span><span class=\"p\">()</span>\n        <span class=\"n\">my_user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">=</span> <span class=\"n\">my_email</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">my_email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">my_user</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">patch_allowlist</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">duplicate_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">exists</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"n\">result</span>\n    \n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">unique_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"k\">assert</span> <span class=\"n\">result</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_validate_email_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">):</span>\n        <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">good_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n    \n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@good_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n        <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter an allowed domain</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Again, run the tests to verify we haven’t broken anything.</p>\n\n<h2 id=\"adding-the-remaining-tests\">Adding the remaining tests</h2>\n\n<p>Now we have all the infrastructure in place. We need to add 2 more tests. First, you may notice that if the allowlist is not empty, the blocklist is ignored. Let’s write a test to verify this.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Testing ignoring the blocklist.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_ignore_blocklist_if_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">):</span>\n    <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">my_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># but add that domain to blocklist too!\n</span>    <span class=\"n\">blocklist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">my_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">blocklist</span><span class=\"p\">)</span>\n\n    <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@my_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>  <span class=\"c1\"># we expect blocklist to be ignored\n</span></code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests - they should pass.</p>\n\n<p>Finally, let’s test the blocklist.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Testing the blocklist.</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_blocklist_when_allowlist_is_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_allowlist</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">):</span>\n    <span class=\"n\">blocklist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">bad_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validation_module</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">blocklist</span><span class=\"p\">)</span>\n    <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter your permanent email</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n<p>Run the tests one last time - they should pass.</p>\n\n<p>And we are done! Here’s the final version of the code we’ve added to this testing module.</p>\n\n<blockquote class=\"solution\">\n  <solution-title></solution-title>\n\n  <p>Final code listing (excluding the 2 added imports).</p>\n\n  <div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_allowlist</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n\n<span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_blocklist</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n\n<span class=\"nd\">@pytest.fixture</span>\n<span class=\"k\">def</span> <span class=\"nf\">patch_check_existing</span><span class=\"p\">(</span><span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n    <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">TestValidateEmail</span><span class=\"p\">:</span>\n\n    <span class=\"k\">class</span> <span class=\"nc\">MockUser</span><span class=\"p\">:</span>\n        <span class=\"k\">pass</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_email_is_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"\"</span><span class=\"p\">,</span> <span class=\"n\">allow_empty</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_email_is_user_email</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">my_email</span> <span class=\"o\">=</span> <span class=\"sh\">\"</span><span class=\"s\">foo</span><span class=\"sh\">\"</span>\n        <span class=\"n\">my_user</span> <span class=\"o\">=</span> <span class=\"n\">self</span><span class=\"p\">.</span><span class=\"nc\">MockUser</span><span class=\"p\">()</span>\n        <span class=\"n\">my_user</span><span class=\"p\">.</span><span class=\"n\">email</span> <span class=\"o\">=</span> <span class=\"n\">my_email</span>\n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">my_email</span><span class=\"p\">,</span> <span class=\"n\">user</span><span class=\"o\">=</span><span class=\"n\">my_user</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_check_for_existing_email</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">patch_allowlist</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">):</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">duplicate_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">exists</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"n\">result</span>\n    \n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">check_for_existing_email</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">:</span> <span class=\"bp\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">unique_email@example.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n        <span class=\"k\">assert</span> <span class=\"n\">result</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n    \n    <span class=\"k\">def</span> <span class=\"nf\">test_validate_email_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">,</span> <span class=\"n\">patch_blocklist</span><span class=\"p\">):</span>\n        <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">good_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n    \n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@good_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>\n        <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter an allowed domain</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test_ignore_blocklist_if_allowlist_not_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">):</span>\n        <span class=\"n\">allowlist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">my_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_allowlist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">allowlist</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># but add that domain to blocklist too!\n</span>        <span class=\"n\">blocklist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">my_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validate_user_input</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">blocklist</span><span class=\"p\">)</span>\n\n        <span class=\"k\">assert</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@my_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"sh\">\"\"</span>  <span class=\"c1\"># we expect blocklist to be ignored\n</span>\n    <span class=\"k\">def</span> <span class=\"nf\">test_blocklist_when_allowlist_is_empty</span><span class=\"p\">(</span><span class=\"n\">self</span><span class=\"p\">,</span> <span class=\"n\">monkeypatch</span><span class=\"p\">,</span> <span class=\"n\">patch_allowlist</span><span class=\"p\">,</span> <span class=\"n\">patch_check_existing</span><span class=\"p\">):</span>\n        <span class=\"n\">blocklist</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"sh\">'</span><span class=\"s\">bad_domain.com</span><span class=\"sh\">'</span><span class=\"p\">]</span>\n        <span class=\"n\">monkeypatch</span><span class=\"p\">.</span><span class=\"nf\">setattr</span><span class=\"p\">(</span><span class=\"n\">validation_module</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">get_email_domain_blocklist_content</span><span class=\"sh\">\"</span><span class=\"p\">,</span> <span class=\"k\">lambda</span> <span class=\"n\">a</span><span class=\"p\">:</span> <span class=\"n\">blocklist</span><span class=\"p\">)</span>\n        <span class=\"k\">assert</span> <span class=\"sh\">\"</span><span class=\"s\">enter your permanent email</span><span class=\"sh\">\"</span> <span class=\"ow\">in</span> <span class=\"nf\">validate_email</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"sh\">\"</span><span class=\"s\">email@bad_domain.com</span><span class=\"sh\">\"</span><span class=\"p\">)</span>\n</code></pre></div>  </div>\n</blockquote>\n\n"],"ref_slides":[],"video_library":{"tutorial":null,"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":false,"mod_date":"2023-01-23 14:30:52 +0000","pub_date":"2022-07-15 10:22:17 +0000","version":4,"api":"https://training.galaxyproject.org/training-material/api/topics/dev/tutorials/writing_tests/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Development in Galaxy","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}