{"layout":"tutorial_hands_on","title":"Pox virus genome analysis from tiled-amplicon sequencing data","subtopic":"one-health","level":"Advanced","questions":["Which special challenges does one encounter during sequence data analysis of pox viruses?","How can standard workflows for viral mutation calling and consensus generation be adapted to the particularities of pox viruses?","How can viral consensus sequences, multiple-sequence alignments and mutation calls be generated from each other and used to answer questions about the data?"],"objectives":["Learn how to deal with pox virus genomes inverted terminal repeats through a combination of wet lab protocol and tailored bioinformatics","Construct a sample consensus genome from mapped reads","Explore a recombinant pox virus genome via a multiple-sequence alignment of consensus genome and references and through lists of mutations derived from it"],"time_estimation":"4H","key_points":["Compared to other viruses, analysis of sequencing data from pox viruses is complicated by the rather large genome size and by the presence of inverted terminal repeats, but well-designed wet lab and bioinformatic workflows can handle these particularities.","Galaxy and its huge set of tools are flexible enough to handle half-genome sequencing data efficiently.","A mapping-based approach can result in high-quality consensus genome reconstructions from pox virus sequencing data and appears promising even when dealing with recombinant samples."],"requirements":[{"type":"internal","topic_name":"galaxy-interface","tutorials":["collections","upload-rules"]}],"contributions":{"authorship":["wm75","TKlingstrom"],"funding":["by-covid","elixir-converge","h2020-defend"]},"tags":["virology","one-health"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00347","url":"/topics/variant-analysis/tutorials/pox-tiled-amplicon/tutorial.html","topic_name":"variant-analysis","tutorial_name":"pox-tiled-amplicon","dir":"topics/variant-analysis/tutorials/pox-tiled-amplicon","symlink":null,"id":"variant-analysis/pox-tiled-amplicon","ref_tutorials":["<p>Pox viruses (<em>Poxviridae</em>) are a large family of viruses, and members of it have various vertebrate and arthropod species as their natural hosts. The most widely known species in the family are the now extinct variola virus from the genus <em>orthopoxvirus</em> as the cause of smallpox, and vaccinia virus, a related, likely horsepox virus, which served as the source for the smallpox vaccine that allowed eradication of that disease.</p>\n\n<p>However, various other pox viruses infect mammalian hosts and cause often severe diseases, and some of them have the ability to jump to humans. Mpox, caused by monkeypox virus, is the most recent and prominent example demonstrating the zoonotic potential of <em>orthopoxviruses</em>. The sister genus <em>capripoxvirus</em> is a major concern in livestock farming with all its three species - sheeppox virus (SPPV), goatpox virus (GTPV), and lumpy skin disease virus (LSDV) causing severe disease <a href=\"https://www.woah.org/en/disease/sheep-pox-and-goat-pox/\">in sheep and goats</a> (SPPV, GTPV) and <a href=\"https://www.woah.org/en/disease/lumpy-skin-disease/\">in cattle</a> (LSDV).</p>\n\n<p>All pox viruses are characterized by a large double-stranded DNA genome (genome sizes of currently sequenced species range from 135 to 360kb) that gets replicated exclusively in the cytoplasm of host cells.</p>\n\n<p>The ends of pox virus genomes consist of inverted terminal repeats (ITRs), i.e. regions of exact reverse-complementarity at the 5’- and 3’-end of the genome. At the very tips of the genome, these regions contain tandem repeats and terminal bases that are cross-linked to the opposite genome strand as first described for vaccinia virus and reviewed in <span class=\"citation\"><a href=\"#Wittek1982\">Wittek 1982</a></span>.</p>\n\n<p>There is considerable length variation in the ITR regions of different species. For example, Capripox virus genomes have ITR lengths of 2.2 - 2.4 kb, monkeypox virus has 6.4 kb long ITRs, and variola virus had the shortest known\nITRs with a length of just 700 bases (reviewed in <span class=\"citation\"><a href=\"#Haller2014\">Haller <i>et al.</i> 2014</a></span>).</p>\n\n<p>Independent of their size, ITRs pose a problem for the analysis of high-throughput sequencing data of pox viruses. Their repetitive nature can confuse de-novo assembly algorithms, but is, to some extent, also a challenge during reference-based mapping, particularly at the boundary between ITRs and the central region of the genome and with samples less related to the reference.</p>\n\n<p>Recently, a tiled-amplicon approach with separate sequencing of half-genomes has been developed for <em>capripoxviruses</em> (<span class=\"citation\"><a href=\"#Mathijs2022\">Mathijs <i>et al.</i> 2022</a></span>) that makes it possible to assign ITR-derived reads unambiguously to the 5’- or 3’-end of a pox virus genome when combined with a suitable bioinformatics pipeline.</p>\n\n<p>This tutorial demonstrates how such data can be analyzed correctly with Galaxy.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>Advanced tutorial</comment-title>\n  <p>This tutorial demonstrates a very close to real-world analysis of viral sequencing data with Galaxy<sup id=\"fnref:prior_work\" role=\"doc-noteref\"><a href=\"#fn:prior_work\" class=\"footnote\" rel=\"footnote\">1</a></sup>.\nAs such, it avoids many simplifications that are often made in training material to ease understanding.\nOn the technical side, in particular, it makes use of many different Galaxy features and often assumes more than just basic familiarity with them.\nLike in other tutorials, you will find precise instructions for running every step in the analysis, but explanations focus very much on the biology of pox viruses and will often not offer much details on <em>why</em> a certain component of Galaxy is used the way it is described.</p>\n\n  <p>To get the most out of this tutorial, you should have worked through several other parts of the training material, which are listed under <strong>Requirements</strong> above, in particular:</p>\n  <ul>\n    <li>If you are not yet familiar with\n      <ul>\n        <li>some typical ways of getting data into Galaxy,</li>\n        <li>dataset collections and ways to manipulate them</li>\n        <li>importing and running workflows,</li>\n      </ul>\n\n      <p>you may benefit more from this tutorial if you first follow some of the introductory tutorials on these topics.</p>\n\n      <p>The tutorial also uses the rule-based uploader, which is an advanced feature, and treats it very much like a black box, which somehow lets you structure data exactly the way it is needed for the analysis. If you want to learn how to use this powerful feature for your own purposes, please follow the dedicated tutorials <a href=\"/training-material/topics/galaxy-interface/tutorials/upload-rules/tutorial.html\">Rule Based Uploader</a> and <a href=\"/training-material/topics/galaxy-interface/tutorials/upload-rules-advanced/tutorial.html\">Rule Based Uploader Advanced</a>.</p>\n    </li>\n    <li>If this is your first exposure to sequencing data analysis, our more basic tutorials on quality control and mapping of such data are highly recommended to get you familiar with general concepts, data types, etc.</li>\n  </ul>\n\n</blockquote>\n\n<p>The following figure provides an overview of the wet lab data generation process described in <span class=\"citation\"><a href=\"#Mathijs2022\">Mathijs <i>et al.</i> 2022</a></span> and of the flow of the analysis that we will perform in this tutorial.</p>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"../../images/pox-virus-tiled-amplicon/pox-tiled-amplicon-wf.png\" alt=\"A schematic drawing of a pox virus genome with a central coding region flanked by inverted terminal repeat regions. Below the genome 23 tiled amplicons are drawn as numbered lines to show their approximate distribution across the genome. Below the amplicons, the main steps in their wet lab processing and of the bioinformatics analysis of their sequences is shown as a flowchart. \" width=\"3750\" height=\"2454\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/pox-virus-tiled-amplicon/pox-tiled-amplicon-wf.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> Tiled-amplicon approach with mapping to half-genomes</figcaption></figure>\n\n<p>On the wet lab side, the genome of a viral sample gets amplified in the form of 23 overlapping amplicons using a set of pan-genus primers suitable for all species of <em>capripoxvirus</em>.</p>\n\n<p>Amplification happens in four separate multiplex PCR reactions: the primers for the odd-numbered amplicons (1-11) from the 5’ amplicon pool are used in reaction 1a, the primers for the even-numbered amplicons (2-12) in reaction 1b, the odd-numbered amplicons (13-23) from the 3’ amplicon pool in reaction 2a and the even numbered amplicons (12-22) from that pool in reaction 2b.</p>\n\n<p>Note that the 5’-ITR gets amplified as part of amplicon 1, while the 3’-ITR is part of amplicon 23. Amplification of the two regions is specific because the right primer of amplicon 1 and the left primer of amplicon 23 both bind in the “central coding region”, i.e. outside the reverse-complementary ITRs.</p>\n\n<p>After amplification, reactions 1a and 1b, and reactions 2a and 2b are combined to form the two sequencing pools, “pool 1” and “pool 2”. Note that amplicon 12 becomes part of both tools in the published protocol because overlap between the two sequencing pools is required for assembly-based analysis. For the mapping-based approach shown in this tutorial the overlap is not essential.</p>\n\n<p>The DNA from the two pools is subjected separately to Illumina sequencing. This way, reads obtained from sequencing of “pool 1” are known to be derived from the 5’-half of the genome, while reads obtained from sequencing of “pool 2” are known to originate from the 3’-half.</p>\n\n<p>In the tutorial analysis, we will exploit this information and map the “pool 1” data to a modified reference genome, in which the 3’-half of the sequence has been replaced with Ns. This masking prevents the read mapper from placing ambiguous reads (in particular reads derived from the 5’-ITR region) onto the 3’-half of the genome.\nLikewise, we will use a 5’-masked genome for the mapping of the “pool 2” reads, again preventing erroneous mapping of reads that we know must be derived from the 3’-half of the genome.</p>\n\n<p>Once the correct alignments of the reads from the two pools have been recorded, we can safely merge the two results, and use that merged data to construct a consensus sequence for the sample.</p>\n\n<p>Compared to a standard tiled-amplicon approach involving just one sequencing pool, the half-genome sequencing approach is more accurate, especially at the boundaries between the “central coding region” and the ITRs, but the analysis is complicated by the doubled number of inputs, by the need to generate masked reference sequences and by the extra step of merging two read mapping results.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#prepare-analysis-history-and-data\" id=\"markdown-toc-prepare-analysis-history-and-data\">Prepare analysis history and data</a>    <ol>\n      <li><a href=\"#get-reference-and-sequenced-samples-data\" id=\"markdown-toc-get-reference-and-sequenced-samples-data\">Get reference and sequenced samples data</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#generating-masked-reference-genome-versions-for-mapping\" id=\"markdown-toc-generating-masked-reference-genome-versions-for-mapping\">Generating masked reference genome versions for mapping</a></li>\n  <li><a href=\"#quality-control-of-the-sequencing-data-of-all-samples\" id=\"markdown-toc-quality-control-of-the-sequencing-data-of-all-samples\">Quality control of the sequencing data of all samples</a></li>\n  <li><a href=\"#mapping-to-the-masked-reference-genomes\" id=\"markdown-toc-mapping-to-the-masked-reference-genomes\">Mapping to the masked reference genomes</a></li>\n  <li><a href=\"#merging-the-mapped-reads-of-both-pools\" id=\"markdown-toc-merging-the-mapped-reads-of-both-pools\">Merging the mapped reads of both pools</a></li>\n  <li><a href=\"#mapped-reads-filtering-trimming-and-qc\" id=\"markdown-toc-mapped-reads-filtering-trimming-and-qc\">Mapped reads filtering, trimming, and QC</a></li>\n  <li><a href=\"#consensus-sequence-construction\" id=\"markdown-toc-consensus-sequence-construction\">Consensus sequence construction</a></li>\n  <li><a href=\"#quality-check-on-results-and-interpretation\" id=\"markdown-toc-quality-check-on-results-and-interpretation\">Quality check on results and interpretation</a>    <ol>\n      <li><a href=\"#composition-of-the-consensus-sequences\" id=\"markdown-toc-composition-of-the-consensus-sequences\">Composition of the consensus sequences</a></li>\n      <li><a href=\"#confirmation-of-published-findings\" id=\"markdown-toc-confirmation-of-published-findings\">Confirmation of published findings</a></li>\n      <li><a href=\"#comparison-of-consensus-sequences-to-published-sequences\" id=\"markdown-toc-comparison-of-consensus-sequences-to-published-sequences\">Comparison of consensus sequences to published sequences</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n  <li><a href=\"#footnotes\" id=\"markdown-toc-footnotes\">Footnotes</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"prepare-analysis-history-and-data\">Prepare analysis history and data</h1>\n\n<p>Any analysis should get its own Galaxy history. So let’s start by creating a new one:</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Prepare the Galaxy history</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a new history for this analysis</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Rename the history</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Click on <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name (which by default is “Unnamed history”)</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">pox-tiled-amplicon tutorial</code></li>   <li>Click on <strong>Save</strong></li> </ol>   <p>If you do not have the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name:</p>   <ol>   <li>Click on <strong>Unnamed history</strong> (or the current name of the history) (<strong>Click to rename history</strong>) at the top of your history panel</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">pox-tiled-amplicon tutorial</code></li>   <li>Press <kbd>Enter</kbd></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"get-reference-and-sequenced-samples-data\">Get reference and sequenced samples data</h2>\n\n<p>In this tutorial you are going to work on the sequencing data from two samples of lumpy skin disease virus that have been sequenced as amplified half-genomes in Illumina paired-end mode. This means that we will be dealing with a forward and a reverse read dataset per sample and amplified half-genome, and so will have to download a total of eight sequenced reads datasets for our analysis.</p>\n\n<p>The samples are the first two (<code class=\"language-plaintext highlighter-rouge\">SAMN20238786</code> and <code class=\"language-plaintext highlighter-rouge\">SAMN20238785</code>) from BioProject <code class=\"language-plaintext highlighter-rouge\">PRJNA746718</code> as found through the <a href=\"https://www.ebi.ac.uk/ena/browser/view/PRJNA746718\">European Nucleotide Archive browser</a>.</p>\n\n<p>If you follow the link, you should see that</p>\n<ul>\n  <li>\n    <p>for each of the two samples there is data from two sequencing runs (representing the two sequenced half-genome pools of amplicons).</p>\n\n    <p>If it isn’t shown by default, enable display of the <em>Library Name</em> column by clicking on <em>Show Column Selection</em> and selecting the checkbox for <em>library_name</em>. The pool identity (<code class=\"language-plaintext highlighter-rouge\">1</code> or <code class=\"language-plaintext highlighter-rouge\">2</code>) is provided as the last part of each sequencing run’s library name.</p>\n  </li>\n  <li>\n    <p>for each pool the data consists of two downloadable <code class=\"language-plaintext highlighter-rouge\">fastq.gz</code> results files, which represent the forward and reverse reads for that sequencing run.</p>\n  </li>\n</ul>\n\n<blockquote class=\"comment\">\n  <comment-title>Choice of samples</comment-title>\n  <p>An in-depth analysis (<span class=\"citation\"><a href=\"#Vandenbussche2022\">Vandenbussche <i>et al.</i> 2022</a></span>) of the samples from BioProject PRJNA746718 has revealed that their genomes are the result of recombination between at least two different parent strains.\nSo not only are these samples sequenced following our wet lab protocol of choice, but there is also some prior knowledge about their (rather interesting) biology.\nThis gives us the opportunity to evaluate the correctness of our analysis by comparing the results we will generate in this tutorial to the published findings.</p>\n\n</blockquote>\n\n<p>In addition, we will require:</p>\n<ul>\n  <li>\n    <p>a <strong>reference genome</strong> to map the sequenced reads to</p>\n\n    <p>We will be using the public lumpy skin disease virus reference sequence <a href=\"https://www.ncbi.nlm.nih.gov/nuccore/NC_003027.1/\">NC_003027.1</a> from the <a href=\"https://www.ncbi.nlm.nih.gov/refseq/\">NCBI RefSeq</a> database here.</p>\n  </li>\n  <li>\n    <p>a <strong>primer scheme file</strong> with information about</p>\n    <ul>\n      <li>which amplicons were present in which half-genome sequencing pool</li>\n      <li>where each primer binds with respect to the reference genome</li>\n    </ul>\n\n    <p>This is a custom file, which you may have to modify, when analysing your own data, depending on the actual primer scheme used during sample preparation, and which we will just copy/paste into Galaxy. The version we are using describes the binding sites of the 46 primers published by (<span class=\"citation\"><a href=\"#Mathijs2022\">Mathijs <i>et al.</i> 2022</a></span>) with respect to the NC_003027.1 reference sequence.</p>\n  </li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Get the data</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Import all <strong>pool 1</strong> sequenced reads files of the two samples to analyze into your history.</p>\n\n      <p>You could collect the download links and additional metadata from the ENA page for <code class=\"language-plaintext highlighter-rouge\">PRJNA746718</code>, but for simplicity lets just use this precompiled combined information:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>20L81    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/074/SRR15145274/SRR15145274_1.fastq.gz\n20L81    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/074/SRR15145274/SRR15145274_2.fastq.gz\n20L70    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/076/SRR15145276/SRR15145276_1.fastq.gz\n20L70    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/076/SRR15145276/SRR15145276_2.fastq.gz\n</code></pre></div>      </div>\n\n      <p>and upload them as a <em>List of Pairs</em> collection.</p>\n\n      <ol>\n        <li>Copy the links above</li>\n        <li>Open the <span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> Manager</li>\n        <li>In the top row of tabs select <strong>Rule-based</strong></li>\n        <li>Set <strong>Upload data as</strong> to <code class=\"language-plaintext highlighter-rouge\">Collection(s)</code></li>\n        <li>Paste the copied links into the text field on the right</li>\n        <li>Click <strong>Build</strong> to bring up the <em>Rule Builder</em> dialog</li>\n        <li>Click on the wrench icon <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> next to <strong>Rules</strong> in the left panel of the window</li>\n        <li>\n          <p>In the text field, erase the prefilled content and copy/paste the following rule definition into it instead:</p>\n\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"rules\": [\n    {\n      \"type\": \"add_column_regex\",\n      \"target_column\": 1,\n      \"expression\": \".+_(\\\\d)\\\\.fastq\\\\.gz\",\n      \"group_count\": 1,\n      \"replacement\": null\n    }\n  ],\n  \"mapping\": [\n    {\n      \"type\": \"url\",\n      \"columns\": [1]\n    },\n    {\n      \"type\": \"list_identifiers\",\n      \"columns\": [0],\n      \"editing\": false\n    },\n    {\n      \"type\": \"paired_identifier\",\n      \"columns\": [2]\n    }\n  ]\n}\n</code></pre></div>          </div>\n        </li>\n        <li>Click on <strong>Apply</strong></li>\n        <li>In the bottom row of options, change <strong>Type</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">fastqsanger.gz</code></li>\n        <li>Set the name of the new collection to <code class=\"language-plaintext highlighter-rouge\">pool1 reads</code></li>\n        <li>Click on <strong>Upload</strong></li>\n      </ol>\n\n      <p>It is ok to continue with the next step even while the upload of the pool 1 reads is still ongoing.\nJust click on the <strong>Close</strong> button of the information pop-up window if it is still open when you are ready to proceed.</p>\n    </li>\n    <li>\n      <p><span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> the <strong>pool2</strong> sequenced reads files of the same samples using the corresponding metadata:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>20L81    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/073/SRR15145273/SRR15145273_1.fastq.gz\n20L81    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/073/SRR15145273/SRR15145273_2.fastq.gz\n20L70    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/075/SRR15145275/SRR15145275_1.fastq.gz\n20L70    ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR151/075/SRR15145275/SRR15145275_2.fastq.gz\n</code></pre></div>      </div>\n\n      <ul>\n        <li>Follow the same steps as for the pool 1 reads to get the data into your history.</li>\n        <li>The rule definition used for the first pool will work unchanged for the second.</li>\n        <li>Just make sure to choose <code class=\"language-plaintext highlighter-rouge\">pool2 reads</code> as the name of the new collection.</li>\n      </ul>\n\n      <p>As before, it is ok to proceed to the next step while the data upload is still ongoing.</p>\n    </li>\n    <li>\n      <p>Tag the uploaded collections of <strong>pool1</strong> and <strong>pool2</strong> reads</p>\n\n      <p>For each of the two collections</p>\n\n      <ol>\n        <li>Click on the collection in the history panel to step into it</li>\n        <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> icon next to the collection name</li>\n        <li>Click on <em>“Add Tags”</em></li>\n        <li>Use <code class=\"language-plaintext highlighter-rouge\">#pool1</code> and <code class=\"language-plaintext highlighter-rouge\">#pool2</code> as the tag for the pool1 and the pool2 collection of reads, respectively</li>\n        <li>Click on <i class=\"far fa-save\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-save</span> <strong>Save</strong></li>\n        <li>Check that the tag appears below the collection name</li>\n      </ol>\n\n      <p>Parts of the analysis in this tutorial will consist of identical steps performed on the data of each pool.\nTo make it easier to distinguish which analysis step has been conducted with which pool, we will be using name tags.\nThese are tags starting with <code class=\"language-plaintext highlighter-rouge\">#</code>, and they will automatically propagate to new datasets and collections derived from the tagged collections.</p>\n    </li>\n    <li>\n      <p>Get the <code class=\"language-plaintext highlighter-rouge\">NC_003027.1</code> LSDV reference.</p>\n\n      <p>A convenient public download link for this sequence is best obtained from the ENA again, where the sequence is known under its <a href=\"https://www.insdc.org/\">INSDC</a> alias <a href=\"https://www.ebi.ac.uk/ena/browser/view/AF325528.1\">AF325528.1</a>:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://www.ebi.ac.uk/ena/browser/api/fasta/AF325528.1?download=true\n</code></pre></div>      </div>\n\n      <ol>\n        <li>\n          <p><span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> the reference to your history via the link above and make sure the dataset format is set to <code class=\"language-plaintext highlighter-rouge\">fasta</code>.</p>\n\n          <!--SNIPPET-->\n          <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Change <strong>Type (set all):</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">fasta</code></p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n          <p><!--END_SNIPPET--></p>\n        </li>\n        <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_replace_in_line/1.1.2\" title=\"Replace Text in entire line tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace Text in entire line</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.2)</span> to simplify the reference sequence name\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: the uploaded reference sequence from the ENA</li>\n            <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Replacement”</em>:\n              <ul>\n                <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;.+</code></li>\n                <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">&gt;AF325528.1</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li>\n          <p>When the Replace Text tool run is finished, <strong>rename</strong> the output dataset</p>\n\n          <!--SNIPPET-->\n          <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-dataset\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-dataset\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a dataset</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field  to <code class=\"language-plaintext highlighter-rouge\">LSDV reference</code></li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n          <p><!--END_SNIPPET--></p>\n        </li>\n      </ol>\n    </li>\n    <li>\n      <p><span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> the primer scheme information in <a href=\"http://www.genome.ucsc.edu/FAQ/FAQformat.html#format1\">BED</a> format</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>NC_003027.1    235       264       CaPV-V1_1_LEFT      pool1a    +\nNC_003027.1    6789      6819      CaPV-V1_2_LEFT      pool1b    +\nNC_003027.1    7771      7801      CaPV-V1_1_RIGHT     pool1a    -\nNC_003027.1    13515     13543     CaPV-V1_3_LEFT      pool1a    +\nNC_003027.1    14451     14482     CaPV-V1_2_RIGHT     pool1b    -\nNC_003027.1    20192     20219     CaPV-V1_4_LEFT      pool1b    +\nNC_003027.1    21201     21229     CaPV-V1_3_RIGHT     pool1a    -\nNC_003027.1    26787     26814     CaPV-V1_5_LEFT      pool1a    +\nNC_003027.1    27786     27814     CaPV-V1_4_RIGHT     pool1b    -\nNC_003027.1    33277     33305     CaPV-V1_6_LEFT      pool1b    +\nNC_003027.1    34363     34395     CaPV-V1_5_RIGHT     pool1a    -\nNC_003027.1    39894     39921     CaPV-V1_7_LEFT      pool1a    +\nNC_003027.1    40867     40897     CaPV-V1_6_RIGHT     pool1b    -\nNC_003027.1    46393     46420     CaPV-V1_8_LEFT      pool1b    +\nNC_003027.1    47419     47453     CaPV-V1_7_RIGHT     pool1a    -\nNC_003027.1    52864     52890     CaPV-V1_9_LEFT      pool1a    +\nNC_003027.1    54039     54069     CaPV-V1_8_RIGHT     pool1b    -\nNC_003027.1    59439     59472     CaPV-V1_10_LEFT     pool1b    +\nNC_003027.1    60530     60559     CaPV-V1_9_RIGHT     pool1a    -\nNC_003027.1    66008     66041     CaPV-V1_11_LEFT     pool1a    +\nNC_003027.1    66960     66989     CaPV-V1_10_RIGHT    pool1b    -\nNC_003027.1    72534     72560     CaPV-V1_12_LEFT     pool1b    +\nNC_003027.1    72534     72560     CaPV-V1_12_LEFT     pool2b    +\nNC_003027.1    73568     73601     CaPV-V1_11_RIGHT    pool1a    -\nNC_003027.1    79081     79111     CaPV-V1_13_LEFT     pool2a    +\nNC_003027.1    80176     80202     CaPV-V1_12_RIGHT    pool1b    -\nNC_003027.1    80176     80202     CaPV-V1_12_RIGHT    pool2b    -\nNC_003027.1    85743     85777     CaPV-V1_14_LEFT     pool2b    +\nNC_003027.1    86753     86781     CaPV-V1_13_RIGHT    pool2a    -\nNC_003027.1    92208     92232     CaPV-V1_15_LEFT     pool2a    +\nNC_003027.1    93323     93351     CaPV-V1_14_RIGHT    pool2b    -\nNC_003027.1    98974     99002     CaPV-V1_16_LEFT     pool2b    +\nNC_003027.1    99970     100000    CaPV-V1_15_RIGHT    pool2a    -\nNC_003027.1    105634    105662    CaPV-V1_17_LEFT     pool2a    +\nNC_003027.1    106584    106612    CaPV-V1_16_RIGHT    pool2b    -\nNC_003027.1    112082    112108    CaPV-V1_18_LEFT     pool2b    +\nNC_003027.1    113111    113144    CaPV-V1_17_RIGHT    pool2a    -\nNC_003027.1    118617    118649    CaPV-V1a_19_LEFT    pool2a    +\nNC_003027.1    119649    119675    CaPV-V1_18_RIGHT    pool2b    -\nNC_003027.1    125361    125390    CaPV-V1_20_LEFT     pool2b    +\nNC_003027.1    126297    126328    CaPV-V1_19_RIGHT    pool2a    -\nNC_003027.1    131713    131742    CaPV-V1_21_LEFT     pool2a    +\nNC_003027.1    132961    132988    CaPV-V1_20_RIGHT    pool2b    -\nNC_003027.1    138437    138467    CaPV-V1_22_LEFT     pool2b    +\nNC_003027.1    139333    139365    CaPV-V1_21_RIGHT    pool2a    -\nNC_003027.1    143117    143145    CaPV-V1_23_LEFT     pool2a    +\nNC_003027.1    146188    146219    CaPV-V1_22_RIGHT    pool2b    -\nNC_003027.1    150505    150538    CaPV-V1_23_RIGHT    pool2a    -\n</code></pre></div>      </div>\n\n      <p>Since BED is a tabular format, but the above display uses spaces to separate columns, please make sure, you have <strong>Convert spaces to tabs</strong> checked when creating the dataset from the copied content!</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-file\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-file\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new file</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong> at the bottom</li>   <li>     <p>Paste the file contents into the text field</p>   </li>   <li>Change the dataset name from “New File” to <code class=\"language-plaintext highlighter-rouge\">LSDV primer scheme</code></li>   <li>Change <strong>Type</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">bed</code>* From the Settings menu (<i class=\"fas fa-cog\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-gear</span>) select <strong>Convert spaces to tabs</strong>* Press <strong>Start</strong> and <strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>At this point you should have these four items in your history:</p>\n\n<ol>\n  <li>The collection of pool 1 reads (representing the 5’-half of the genome)\n    <ul>\n      <li>This should be a list of two elements (representing the two samples we are going to analyze).</li>\n      <li>Each of these elements should itself be a paired collection of a <em>forward</em> and a <em>reverse</em> reads dataset in <code class=\"language-plaintext highlighter-rouge\">fastqsanger.gz</code> format.</li>\n      <li>A <code class=\"language-plaintext highlighter-rouge\">#pool1</code> name tag should be attached to the collection in the history.</li>\n    </ul>\n  </li>\n  <li>The collection of pool 2 reads (representing the 3’-half of the genome)\n    <ul>\n      <li>This should be structured exactly as the first collection.</li>\n      <li>Also the names of the elements in both collections should be identical.</li>\n      <li>A <code class=\"language-plaintext highlighter-rouge\">#pool2</code> name tag should be attached to the collection in the history.</li>\n    </ul>\n  </li>\n  <li>The LSDV reference as a single <em>fasta</em> dataset</li>\n  <li>The primer scheme as a single <em>bed</em> dataset</li>\n</ol>\n\n<p>If this is the case for you, you are ready to start the actual data analysis.</p>\n\n<h1 id=\"generating-masked-reference-genome-versions-for-mapping\">Generating masked reference genome versions for mapping</h1>\n\n<p>As illustrated in Figure 1, we would like to map the “pool 1” reads of each sample to a version of the LSDV reference, in which the 3’-half of the genome (starting after the right end of amplicon 12, the 3’-most amplicon still contained in pool 1) is masked (i.e., bases are replaced by Ns). This ensures that the read mapper will only consider the 5’-half of the genome when placing reads from pool 1.\nLikewise, for the “pool2” read mapping, we would like to use a reference version, in which the 5’-half that is not covered by the second amplicon pool is masked out.</p>\n\n<p>To build these two masked reference versions we need to extract the information about amplicon pool boundaries from the primer scheme BED dataset and use it twice on the LSDV reference to replace the appropriate ranges of its bases with Ns.</p>\n\n<p>As this is a complex task that would take a considerable amount of time to perform step-by-step via manual tool runs, we are providing a pre-built workflow for you that you only need to import and run on the input data in your history.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Import and run the reference masking workflow</hands-on-title>\n\n  <ol>\n    <li>Go to the training material <a href=\"workflows/\">page for this workflow</a> and use one of the options listed there to import the workflow into your account on your Galaxy server.</li>\n    <li>Back on the list of workflows page, click the <em>Run workflow</em> icon <i class=\"fas fa-play\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">workflow-run</span> to the right of the newly imported workflow.</li>\n    <li>On the next page, select\n      <ul>\n        <li><em>“Primer Scheme (BED file with Pool identifiers)”</em>: the uploaded <code class=\"language-plaintext highlighter-rouge\">LSDV primer scheme</code> BED dataset</li>\n        <li><em>“Reference FASTA”</em>: the <code class=\"language-plaintext highlighter-rouge\">LSDV reference</code> fasta dataset generated with <strong>Replace Text</strong></li>\n      </ul>\n\n      <p>Running the workflow will produce two key output datasets:</p>\n      <ul>\n        <li>a <em>Masked reference for mapping of pool1</em></li>\n        <li>a <em>Masked reference for mapping of pool2</em></li>\n      </ul>\n    </li>\n    <li>\n      <p>Check whether the workflow produced correctly masked half-genomes</p>\n\n      <p>You can <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> inspect the two masked reference datasets by eye, which quickly reveals that one sequence has its beginning N-masked, while for the other it is the end, but it is hard to find out whether the regions are exactly right this way. Luckily, we can use a tool to determine the exact extent of Ns for each dataset:</p>\n      <ol>\n        <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/mbernt/fasta_regex_finder/fasta_regex_finder/0.1.0\" title=\"Fasta regular expression finder tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Fasta regular expression finder</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.1.0)</span>\n          <ul>\n            <li><i class=\"far fa-copy\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-files</span> <em>“Input”</em>: select the two masked reference datasets; output of the masking workflow run</li>\n            <li>\n              <p><em>“Regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">N+</code></p>\n\n              <p>This looks for stretches of one or more Ns.</p>\n            </li>\n            <li>In <em>“Specify advanced parameters”</em>:\n              <ul>\n                <li>\n                  <p><em>“Do not search the reverse complement”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></p>\n\n                  <p>We are only interested in the forward strand (and an N is an N on both strands anyway) so we can save some compute by turning on this option.</p>\n                </li>\n                <li>\n                  <p><em>“Maximum length of the match to report”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></p>\n\n                  <p>It would be boring to have the matched stretches of Ns written out again.</p>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ol>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Inspect the two result datasets created by the tool and compare the regions of Ns reported in them to the primer scheme.\nDid the correct regions get masked?</p>\n\n        <p>Tip: Galaxy’s <i class=\"fas fa-th\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-scratchbook</span> Window Manager, which you can enable (and disable again) from the menu bar can be very helpful for comparing multiple datasets.</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answer</solution-title>\n\n          <p>The masked reference for mapping of pool1 has Ns from 80,202 - 150,773.\nThe 3’-most primer contained in pool1, CaPV-V1_12_RIGHT, has its binding site listed as 80,176 - 80,202.\nBed format specifies zero-based half-open intervals, i.e. the first base of a sequence has position 0, and the end position of any interval is the first base <em>not</em> included in it!\nSo the 3’-most base covered by the primer is base number 80,201 (when counting from 0) and the reference is masked correctly from 80,202 onwards.</p>\n\n          <p>The masked reference for mapping of pool2 has Ns from 0 - 72,534.\nThe 5’-most primer of pool2 is CaPV-V1_12_LEFT and the primer scheme lists the start of its binding site as 72,534.\nAgain, the way bed format is specified means that position 72,534 is the first base <em>not</em> masked in the reference for pool2 mapping, and that is correct.\nAlso note that amplicon 12 is contained in both pools and the masking takes this fact into account.</p>\n\n          <p>Feel free to open the workflow in the workflow editor and inspect the steps it took to work out the masking, but it’s also ok to treat this part as a black box and move on. There is still a lot of analysis that is waiting to be done.</p>\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"quality-control-of-the-sequencing-data-of-all-samples\">Quality control of the sequencing data of all samples</h1>\n\n<p>The next step is to check the quality of the sequencing data of both samples and to eliminate, if necessary, poor-quality reads or parts of them.</p>\n\n<p>The tool <strong>fastp</strong> lets us perform these tasks and obtain a nice quality report for our reads before and after processing in one go, but many other options exist to perform sequenced reads quality control and trimming/filtering in Galaxy, and the dedicated tutorial on <a href=\"/training-material/topics/sequence-analysis/tutorials/quality-control/tutorial.html\">quality control</a> introduces more of them.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>QC and read trimming/filtering with fastp</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/fastp/fastp/0.23.2+galaxy0\" title=\"fastp tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>fastp</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.23.2+galaxy0)</span> on the collection of <strong>pool1</strong> reads\n      <ul>\n        <li><em>“Single-end or paired reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select paired collection(s)”</em>: the uploaded collection of <strong>pool1</strong> reads</li>\n        <li>In <em>“Filter Options”</em>\n          <ul>\n            <li>In <em>“Length filtering options”</em>\n              <ul>\n                <li><em>“Length required”</em>: <code class=\"language-plaintext highlighter-rouge\">30</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"details\">\n        <details-title>fastp default settings</details-title>\n\n        <p>fastp comes with basic default settings for some of its many parameters.\nIn particular, with no explicit parameter specifications, the tool will still remove reads that</p>\n        <ul>\n          <li>have base qualities &lt; 15 for more than 40% of their bases</li>\n          <li>have more than 5 Ns in their sequence</li>\n          <li>\n            <p>have a length &lt; 15 bases (after removing poly-G tails from Illumina reads)</p>\n\n            <p>Because our input data has far longer MiSeq-generated reads, we can increase this length threshold to 30 bases as done above.</p>\n          </li>\n        </ul>\n\n        <p>These are very relaxed criteria that will only remove the least usable reads, but still assure minimal\nquality standards that are good enough for many (including training) purposes.</p>\n      </blockquote>\n\n      <p>Running the tool will result in two outputs. One is a new paired collection with the processed reads, the other one is a report of initial quality, the processing actions performed and their effect on key quality metrics.</p>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> <strong>Inspect</strong> the reports for both samples and try to answer the following questions:</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>After filtering, which of the two samples has more reads retained?</li>\n          <li>Which sample had more reads filtered out?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>Sample 20L81 has more reads retained (947,000) than 20L70 (856,000).</li>\n            <li>Sample 20L81 also had more reads filtered out.\n“Only” 93.2% of its original reads got retained compared to 99.1% for 20L70.</li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n    <li>\n      <p>Now repeat the steps above for the collection of pool 2 reads.</p>\n\n      <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/fastp/fastp/0.23.2+galaxy0\" title=\"fastp tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>fastp</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.23.2+galaxy0)</span> on the collection of <strong>pool2</strong> reads</p>\n      <ul>\n        <li><em>“Single-end or paired reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select paired collection(s)”</em>: the uploaded collection of <strong>pool2</strong> reads</li>\n        <li>In <em>“Filter Options”</em>\n          <ul>\n            <li>In <em>“Length filtering options”</em>\n              <ul>\n                <li><em>“Length required”</em>: <code class=\"language-plaintext highlighter-rouge\">30</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n        <ol>\n          <li>Are the results for the pool 2 sequences similar to those of pool 1?</li>\n          <li>What’s your overall conclusion regarding the quality of the sequences and the effect of filtering?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>Results are rather similar although for pool2 the metrics for the two samples are even more similar than for poo1, and it is now 20L70, which has a bit more reads retained after filtering.</li>\n            <li>The input sequences are of rather good quality and the relaxed filtering criteria we have configured had little impact. This is not a bad thing though and we can proceed with our analysis.</li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"mapping-to-the-masked-reference-genomes\">Mapping to the masked reference genomes</h1>\n\n<p>We are now ready to map each pool of each sample to the corresponding masked reference. We will use the tool BWA-MEM with essentially default settings for this purpose. As shown in figure 1, however, we want to merge the mapping results afterwards, but still be able to tell mapped reads from pool 1 and pool 2 apart. To this end, we need to tag reads with <code class=\"language-plaintext highlighter-rouge\">pool1</code> and <code class=\"language-plaintext highlighter-rouge\">pool2</code> read group identifiers, respectively, at the mapping step. Just because a sample has pool1 and pool2 reads it is still just one sample though, and we are going to express that fact through a common sample name (which we let BWA-MEM autodetect as the name of the collection elements).</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Read mapping and quality control</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2\" title=\"Map with BWA-MEM tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Map with BWA-MEM</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.17.2)</span> for <strong>pool1</strong> data\n      <ul>\n        <li><em>“Will you select a reference genome from your history or use a built-in index?”</em>: <code class=\"language-plaintext highlighter-rouge\">Use a genome from history and build index</code>\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Use the following dataset as the reference sequence”</em>: Masked reference for mapping of <strong>pool1</strong></li>\n          </ul>\n        </li>\n        <li><em>“Single or Paired-end reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select a paired collection”</em>: the <code class=\"language-plaintext highlighter-rouge\">#pool1</code> collection of trimmed and filtered reads; output of <strong>fastp</strong> run on the pool1 data</li>\n        <li>\n          <p><em>“Set read groups information?”</em>: <code class=\"language-plaintext highlighter-rouge\">Set read groups (SAM/BAM specification)</code></p>\n\n          <p>for <em>Read group identifier</em>:</p>\n          <ul>\n            <li><em>“Auto-assign”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n            <li><em>“Read group identifier”</em>: <code class=\"language-plaintext highlighter-rouge\">pool1</code></li>\n          </ul>\n\n          <p>for <em>Read group sample name</em>:</p>\n          <ul>\n            <li>\n              <p><em>“Auto-assign”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></p>\n\n              <p>This interprets names of collection elements as sample names.</p>\n            </li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2\" title=\"Map with BWA-MEM tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Map with BWA-MEM</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.17.2)</span> for <strong>pool2</strong> data\n      <ul>\n        <li><em>“Will you select a reference genome from your history or use a built-in index?”</em>: <code class=\"language-plaintext highlighter-rouge\">Use a genome from history and build index</code>\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Use the following dataset as the reference sequence”</em>: Masked reference for mapping of <strong>pool2</strong></li>\n          </ul>\n        </li>\n        <li><em>“Single or Paired-end reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select a paired collection”</em>: the <code class=\"language-plaintext highlighter-rouge\">#pool2</code> collection of trimmed and filtered reads; output of <strong>fastp</strong> run on the pool2 data</li>\n        <li>\n          <p><em>“Set read groups information?”</em>: <code class=\"language-plaintext highlighter-rouge\">Set read groups (SAM/BAM specification)</code></p>\n\n          <p>for <em>Read group identifier</em>:</p>\n          <ul>\n            <li><em>“Auto-assign”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n            <li><em>“Read group identifier”</em>: <code class=\"language-plaintext highlighter-rouge\">pool2</code></li>\n          </ul>\n\n          <p>for <em>Read group sample name</em>:</p>\n          <ul>\n            <li><em>“Auto-assign”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"merging-the-mapped-reads-of-both-pools\">Merging the mapped reads of both pools</h1>\n\n<p>We have mapped both pool 1 and pool 2 reads to masked versions of the same reference sequence. This means that any mapping in any of the separate BWA-MEM outputs also describes a valid mapping to the complete, unmasked reference so all we need to do is merge the pool 1 and pool 2 mapped reads datasets of each sample into one to obtain complete mapping results for the entire genome of the sample.</p>\n\n<p>A tool that can perform this task for us is <strong>samtools merge</strong>. However, if we gave this tool our collection of pool1 reads with one BAM dataset per sample and the collection of pool2 reads with again one BAM dataset per sample, you would be very disappointed to see that it would merge all datasets into one, i.e. it would not only combine pools, but also sample data, which is not what we want.</p>\n\n<p>Why does <strong>samtools merge</strong> in Galaxy behave like this? Well, the tool is written so that it knows how to merge multiple datasets <em>and</em> it knows how to merge the contents of simple collections - and it’s just too eager to apply that knowledge. What we can do, however, is try and pass it something it does <em>not</em> know how to handle in a single run, and that’s a nested collection. So instead of providing the input as two separate collections (one for pool1 and one for pool2 data) that each hold two elements (representing data from one sample), we want to provide a collection of two samples, each one consisting of a collection of pool 1 and pool 2 reads, in turn.\nWhen we do this, Galaxy will recognize that the tool cannot handle this, but that it would know how to handle each outer element (sample) separately (as a simple collection). In this situation, Galaxy will automatically schedule two parallel excutions of the tool for us, each one receiving one element of the outer collection as input.</p>\n\n<p>We can do the necessary restructuring in two steps, then pass the result to <strong>samtools merge</strong>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Reorganize the data and merge across pools within samples</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"__ZIP_COLLECTION__\" title=\"Zip collections tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Zip collections</strong></span> with the following parameters\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Input 1”</em>: mapped reads <code class=\"language-plaintext highlighter-rouge\">#pool1</code>; output of <strong>BWA-MEM</strong> run on the pool1 data</li>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Input 2”</em>: mapped reads <code class=\"language-plaintext highlighter-rouge\">#pool2</code>; output of <strong>BWA-MEM</strong> run on the pool2 data</li>\n      </ul>\n\n      <p>This combines the two separate collections into one nested structure, but, unfortunately, that structure is not organized the way we want it because <strong>Zip collections</strong> creates lists of pairs, i.e. list collections that hold paired collections inside. Now we still need to turn the list of pairs into a list of lists.</p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"__APPLY_RULES__\" title=\"Apply rules tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Apply rules</strong></span> with the following parameters\n      <ul>\n        <li><em>“Input Collection”</em>: zipped collection of mapped reads from both pools</li>\n        <li>Under <em>“Rules”</em>\n          <ul>\n            <li><i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Edit</strong></li>\n          </ul>\n        </li>\n        <li>In the <em>“Build Rules for Applying to Existing Collection”</em> window\n          <ol>\n            <li>Click <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> next to <strong>Rules</strong></li>\n            <li>Erase the prefilled rules description</li>\n            <li>\n              <p>Copy the rules below and paste them into the empty rules description area</p>\n\n              <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>{\n  \"rules\": [\n    {\n      \"type\": \"add_column_metadata\",\n      \"value\": \"identifier0\"\n    },\n    {\n      \"type\": \"add_column_metadata\",\n      \"value\": \"identifier1\"\n    }\n  ],\n  \"mapping\": [\n    {\n      \"type\": \"list_identifiers\",\n      \"columns\": [\n        0,\n        1\n      ],\n      \"editing\": false\n    }\n  ]\n}\n</code></pre></div>              </div>\n            </li>\n            <li>Click <strong>Apply</strong></li>\n            <li>Click <strong>Save</strong>, then run the tool</li>\n          </ol>\n        </li>\n      </ul>\n\n      <p>This will reorganize the data once more, this time into the desired structure, which will give us the correct merge result.</p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/samtools_merge/samtools_merge/1.15.1+galaxy0\" title=\"Samtools merge tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Samtools merge</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.15.1+galaxy0)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Alignments in BAM format”</em>: the reorganized collection; output of <strong>Apply rules</strong></li>\n        <li><em>“Make @RG headers unique”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        <li><em>“Make @PG headers unique”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Now lets confirm that things have worked as expected:</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>What are the datasets inside the <strong>Samtools merge</strong> collection?</li>\n          <li><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Display each of the datasets. What information about read groups and samples is stored in each dataset?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>The collection consists of two BAM datasets, one for sample 20L81 and one for 20L70.</li>\n            <li>\n              <p>The header of the 20L81 dataset lists</p>\n\n              <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@RG ID:pool1 SM:20L81 PL:ILLUMINA\n@RG ID:pool2 SM:20L81 PL:ILLUMINA\n</code></pre></div>              </div>\n\n              <p>, which declares that the mapped reads in this file come from two read groups with the IDs pool1 and pool2 that belong to the same sample (SM), 20L81, sequenced on the Illumina platform.</p>\n\n              <p>The 20L70 dataset contains analogous lines in its header declaring the two read groups of the other sample.</p>\n\n              <p>When scrolling to the very right in the body of the datasets, you can see that a RG tag of the form RG:ID (where ID is one of the alternatives declared in the header) is attached to each mapped read line (because the dataset is sorted by mapped coordinates and pool2 reads should have been mapped only to the 3’-half of the genome, you will have to scroll down rather far in the dataset to find a RG tag with a pool2 ID value).</p>\n\n              <p>All this read group information in the dataset headers and on the mapped reads has been put there by BWA-MEM and Samtools merge has, apparently, merged the reads and the read group information correctly!</p>\n            </li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"mapped-reads-filtering-trimming-and-qc\">Mapped reads filtering, trimming, and QC</h1>\n\n<p>So now that we have one dataset of mapped reads per sample, we will do some cleaning and quality control on the mapped data to be sure we pass only reliable mapping data into consensus calling.</p>\n\n<p>We will first use <strong>samtools view</strong> to discard any alignments that we are not fully confident in.</p>\n\n<p>Next, we will run <strong>ivar trim</strong> on the retained reads. This tool can detect primer sequences at the ends of the mapped reads that represent the tiled amplicon primers used during preparation of the samples for sequencing, and will mask them so that they will not be considered during generation of the consensus sequence.</p>\n\n<blockquote class=\"details\">\n  <details-title>Primer trimming</details-title>\n\n  <p>The primers used for the tiled-amplicon generation will get incorporated physically at the start and end of each amplicon. These ends, therefor, do <em>not</em> represent amplified sequence from the sample genome, but merely reflect the primer sequences. Consequently, the amplicon ends will never capture any mutations in the genome region they cover, and we cannot meaningfully use them for building a consensus sequence for the sample.</p>\n\n  <p>Luckily, since we are dealing with <em>tiled</em> (i.e., overlapping) amplicons, each amplicon end should be overlapped by the non-primer part of another amplicon, and we can use these sequences to obtain information about the sequenced sample at primer binding sites. By masking parts of reads that are derived from incorporated primers, we make sure these “pseudo”-sequences are not interfering with mutation detection based on truly informative reads, and that we can faithfully reconstruct the genome of the sample.</p>\n\n</blockquote>\n\n<p>Finally, we will use <strong>Qualimap BamQC</strong> to generate a quality report on the trimmed and filtered mapped reads, which we’ll inspect to judge whether read mapping worked well enough for consensus generation purposes.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Mapped reads filtering and trimming and quality control for mappings</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/samtools_view/samtools_view/1.15.1+galaxy0\" title=\"Samtools view tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Samtools view</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.15.1+galaxy0)</span> for filtering the mapped reads\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“SAM/BAM/CRAM data set”</em>: collection of merged mapped reads; output of <strong>Samtools merge</strong></li>\n        <li><em>“What would you like to look at?”</em>: <code class=\"language-plaintext highlighter-rouge\">A filtered/subsampled selection of reads</code></li>\n        <li>In <em>“Configure filters”</em>:\n          <ul>\n            <li><em>“Filter by quality”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Require that these flags are set”</em>: <code class=\"language-plaintext highlighter-rouge\">Read is paired</code></li>\n            <li><em>“Exclude reads with any of the following flags set”</em>: <code class=\"language-plaintext highlighter-rouge\">Read is unmapped</code> and <code class=\"language-plaintext highlighter-rouge\">Mate is unmapped</code> and <code class=\"language-plaintext highlighter-rouge\">Alignment of the read is not primary</code> and <code class=\"language-plaintext highlighter-rouge\">Alignment is supplementary</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/ivar_trim/ivar_trim/1.4.2+galaxy0\" title=\"ivar trim tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>ivar trim</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.4.2+galaxy0)</span> for trimming of amplicon primers from mapped reads\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“BAM file”</em>: collection of filtered mapped reads BAM dataset; output of <strong>Samtools view</strong></li>\n        <li><em>“Source of primer information”</em>: <code class=\"language-plaintext highlighter-rouge\">History</code>\n          <ul>\n            <li><em>“BED file with primer sequences and positions”</em>: the uploaded <code class=\"language-plaintext highlighter-rouge\">LSDV primer scheme</code> BED dataset</li>\n          </ul>\n        </li>\n        <li><em>“Filter reads based on amplicon info”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes, drop reads that extend beyond amplicon boundaries</code></li>\n        <li><em>“Include reads not ending in any primer binding sites?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Require a minimum length for reads to retain them after any trimming?”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes, and provide a custom threshold</code>\n          <ul>\n            <li><em>“Minimum trimmed length threshold”</em>: `30</li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/qualimap_bamqc/qualimap_bamqc/2.2.2d+galaxy3\" title=\"QualiMap BamQC tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>QualiMap BamQC</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.2.2d+galaxy3)</span> for mapped reads quality control\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Mapped reads input dataset”</em>: filtered and trimmed mapped reads BAM dataset; output of <strong>ivar trim</strong></li>\n        <li><em>“Skip duplicate reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Deselect all</code></li>\n        <li>In <em>“Settings affecting specific plots”</em>:\n          <ul>\n            <li><em>“Number of bins to use in across-reference plots”</em>: <code class=\"language-plaintext highlighter-rouge\">200</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Study the report generated with QualiMap</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>What is the mean coverage for each of the samples across the entire genome?</li>\n          <li>Which sample might be a bit more problematic coverage-wise?</li>\n          <li>What can you observe for the “Mapping Quality Across Reference” plots for both samples?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>Mean coverage for sample 20L81 is 2,073, for 20L70 it is 2,155.</li>\n            <li>\n              <p>Despite its slightly higher mean coverage, sample 20L70 has the slightly worse coverage <em>distribution</em>.</p>\n\n              <p>The “Coverage across reference” plot shows higher variability of coverage for this sample.\nWhile it peaks at higher values, it also drops below a coverage of 500 more clearly and in more regions across the genome than 20L81, and even drops to potentially problematically low values in a short stretch of sequence just after the middle of the genome.\nThe “Coverage Histogram” plot also reveals that the coverage distribution for 20L70 is a bit skewed towards lower values than that for 20L81.</p>\n\n              <p>All these effects are not very dramatic and should not prevent us from continuing with the analysis of both samples. We should watch out for a potentially incomplete consensus sequence in that low-coverage stretch of the 20L70 genome though.</p>\n            </li>\n            <li>Mapping quality is almost constant at or very near 60 (which happens to be the maximum mapping quality value emitted by BWA-MEM) across the entire genome for both samples. Interestingly, there is a tiny dip in mapping quality around ~ 117,000 - 118,000 on the genome, which seems reproducible across the two samples.</li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"consensus-sequence-construction\">Consensus sequence construction</h1>\n\n<p>And with that we are ready for consensus sequence generation!</p>\n\n<p>To accept any base suggested by the mapped sequenced reads as the consensus base for the corresponding genome position, we ask for the following requirements to be fulfilled:</p>\n\n<ul>\n  <li>at least 20 sequenced reads have to provide information about the base in question</li>\n  <li>at a minimum, 70% of these reads have to agree on the base at this position (80% for indels)</li>\n</ul>\n\n<p>To avoid getting misled too much by sequencing errors, we are also going to ignore bases with a base calling quality less than 20 in the above counts (i.e., we are going to base our decisions only on bases in sequenced reads that the basecaller of the sequencer was reasonably sure about.</p>\n\n<p>Now what if we cannot obtain a consensus base for a position with the above criteria? In such cases of uncertainty we want to insert an N (i.e. an unknown base) to express that we either did not have enough information about the position or that this information was ambiguous.</p>\n\n<p><i class=\"fas fa-info-circle\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-info</span> All of the above limits for consensus base calling are arbitrary to some degree, and depend somewhat on the quality of the sequencing data. With very high overall coverage, for example, it is possible to increase the coverage threshold, but if you increase that threshold too much, you may end up with a consensus sequence consisting mostly of Ns.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Consensus building</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/ivar_consensus/ivar_consensus/1.4.2+galaxy0\" title=\"ivar consensus tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>ivar consensus</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.4.2+galaxy0)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“BAM file”</em>: collection of trimmed mapped reads BAM dataset; output of <strong>ivar trim</strong></li>\n        <li><em>“Minimum frequency threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">0.7</code></li>\n        <li><em>“Minimum indel frequency threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">0.8</code></li>\n        <li><em>“Minimum depth to call consensus”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Inspect the consensus sequences generated for the two samples</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Does everything look ok? What about those leading and trailing Ns in the sequences?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answer</solution-title>\n\n          <p>Certainly both sequences start and end with stretches of Ns.</p>\n\n          <p>Since the sequencing data is ampliconic in nature, and the primer scheme lists the first and the last primer as binding close to but not exactly at the end of the genome, it is expected that we cannot resolve the first and last couple of hundreds bases.</p>\n\n          <p>However, to determine whether those terminal stretches of Ns are exactly as long as we expect them to be would be a tedious task to perform manually. Likewise, it is not trivial to assert that there are no additional Ns somewhere in these long sequences.</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"quality-check-on-results-and-interpretation\">Quality check on results and interpretation</h1>\n\n<h2 id=\"composition-of-the-consensus-sequences\">Composition of the consensus sequences</h2>\n\n<p>So we have consensus sequences for our samples. Are there better ways for checking their quality than just looking through them by eye?</p>\n\n<p>Luckily, there is a tool to help us, and we have even used it before to check the masking of the reference genome!</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Check consensus sequences for unresolved bases</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/mbernt/fasta_regex_finder/fasta_regex_finder/0.1.0\" title=\"Fasta regular expression finder tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Fasta regular expression finder</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.1.0)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“BAM file”</em>: collection of consensus sequences; output of <strong>ivar consensus</strong></li>\n        <li>\n          <p><em>“Regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">[^ATGC]+</code></p>\n\n          <p>This expression matches stretches of sequences that do <em>not</em> (<code class=\"language-plaintext highlighter-rouge\">^</code>) contain any of the standard bases (any of the characters in <code class=\"language-plaintext highlighter-rouge\">[]</code>). The expression is case-sensitive, but ivar consensus only uses uppercase in sequences.</p>\n        </li>\n        <li>In <em>“Specify advanced parameters”</em>:\n          <ul>\n            <li><em>“Do not search the reverse complement”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Maximum length of the match to report”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Inspect the output of the tool for both samples and compare it to the primer scheme</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Has consensus building worked well?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answer</solution-title>\n\n          <p>The tool reports only two stretches consisting of Ns at both ends of the genome, and their positions are exactly identical between the samples. There are no interior Ns, nor other ambiguity characters.</p>\n\n          <p>The 5’-end stretch of Ns extends up to position 264 (in bed format, so zero-based and the position itself not included). The binding site of the first primer in the primer scheme is from (bed format again) 235 up to 264.</p>\n\n          <p>Remember that we used ivar trim to mask primer sequences? This seems to have worked well, and we got a consensus sequence from the first position for which we could reasonably expect information!</p>\n\n          <p>The 3’-end stretch of Ns starts at position 150,453 and continues (as we have seen by eye before) until the end of the genome, which seems to be at 150,721.\nHmm, these values are surrounding the binding site of the last primer in the primer scheme, but do not match perfectly. But wait:</p>\n\n          <p>It is possible that the consensus sequences incorporate deletions, i.e. it could be that they are shorter than the reference we have used for mapping. So obviously the <strong>consensus sequences have a length of 150,721 bases</strong>, but what is the length of the reference?</p>\n\n          <p>There are Galaxy tools for determining the length of a FASTA sequence. For example, you could use <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/fasta_compute_length/fasta_compute_length/1.0.3\" title=\"Compute sequence length tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Compute sequence length</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.0.3)</span> on the <code class=\"language-plaintext highlighter-rouge\">LSDV reference</code> dataset, but we have obtained the value before when we used the <strong>Fasta regular expression finder</strong> on the reference masked for pool 1 mapping. So lets try to find that output in the history and see what it says:</p>\n\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Chrom         Start    End       Name                           Score    Strand    ThickStart\nAF325528.1    80201    150773    AF325528.1_80201_150773_for    70572    +         N[1,70572]\n</code></pre></div>          </div>\n\n          <p>is what the tool reported for the 3’-mask so <strong>the reference is 150,773 bases</strong> long.</p>\n\n          <p>Now, 150,773 - 150,721 = 52 is how many bases the consensus sequences are shorter than the reference,\nand on these shorter sequences the binding site of the 3’-most primer would be shifted from 150,505 - 150,538 on the reference to 150,453 - 150, 486.</p>\n\n          <p>Again primer masking by ivar trim will cause the primer sequence itself to be ignored during consensus sequence building so we can expect the sequence to be resolved up to position 150,453 and this is exactly where the trailing Ns start.</p>\n\n          <p>Consensus building seems to have worked perfectly, with no interior Ns and the maximal sequence resolved!</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"confirmation-of-published-findings\">Confirmation of published findings</h2>\n\n<p>Even a perfectly looking consensus sequence could, of course, have wrong bases incorporated. Also, a consensus sequence on its own does not convey too much information.</p>\n\n<p>So the next question is if the sequences we have generated make sense when compared to other sequences.</p>\n\n<p>Figure 2 in (<span class=\"citation\"><a href=\"#Vandenbussche2022\">Vandenbussche <i>et al.</i> 2022</a></span>) illustrates that our two samples (third-last and fourth-last alignment records in both panels A and B) have a mosaic genome composed of recombined sequences from at least two different parent strains, and as a plausibility check we can try to reproduce this finding.</p>\n\n<p>For this, we will need to create a multiple-sequence alignment (MSA) between our consensus sequences and the assumed parent strains used in the figure. The assumed parent P2 (with accesion number KX683219), however, is very closely related to the reference we have used for mapping here so we can simply use that already obtained sequence instead of parent P2.</p>\n\n<p>This leaves us with the tasks of obtaining the sequence for parent P1 (accession number: KX764644) and of combining this sequence, our reference and our two consensus sequences into an MSA.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Build multiple-sequence alignment between samples and two LSDV references</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Get the <code class=\"language-plaintext highlighter-rouge\">KX764644</code> LSDV “Herbivac” reference.</p>\n\n      <p>As with the LSDV reference sequence that we have used for mapping, we can use a convenient download link for the <a href=\"https://www.ebi.ac.uk/ena/browser/view/KX764644\">Herbivac strain sequence at the ENA</a>:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://www.ebi.ac.uk/ena/browser/api/fasta/KX764644.1?download=true\n</code></pre></div>      </div>\n\n      <ol>\n        <li>\n          <p><span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> the reference to your history via the link above and make sure the dataset format is set to <code class=\"language-plaintext highlighter-rouge\">fasta</code>.</p>\n\n          <!--SNIPPET-->\n          <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links-1\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links-1\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Change <strong>Type (set all):</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">fasta</code></p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n          <p><!--END_SNIPPET--></p>\n        </li>\n        <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_replace_in_line/1.1.2\" title=\"Replace Text in entire line tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace Text in entire line</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.2)</span> to simplify the reference sequence name\n          <ul>\n            <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: the uploaded reference sequence from the ENA</li>\n            <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Replacement”</em>:\n              <ul>\n                <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;.+</code></li>\n                <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">&gt;KX764644.1</code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li>\n          <p>When the Replace Text tool run is finished, <strong>rename</strong> the output dataset</p>\n\n          <!--SNIPPET-->\n          <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-dataset-1\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-dataset-1\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a dataset</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field  to <code class=\"language-plaintext highlighter-rouge\">Herbivac sequence</code></li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n          <p><!--END_SNIPPET--></p>\n        </li>\n      </ol>\n    </li>\n    <li>\n      <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/rnateam/mafft/rbc_mafft/7.520+galaxy0\" title=\"MAFFT tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>MAFFT</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 7.520+galaxy0)</span></p>\n      <ul>\n        <li><em>“For multiple inputs generate”</em>: <code class=\"language-plaintext highlighter-rouge\">a single MSA of all sequences from all inputs</code>\n          <ul>\n            <li>In <em>“Input batch”</em>:\n              <ul>\n                <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1: Input batch”</em>\n                  <ul>\n                    <li><i class=\"far fa-copy\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-files</span> <em>“Sequences to align”</em>: the <code class=\"language-plaintext highlighter-rouge\">Herbivac sequence</code>; renamed output of <strong>Replace</strong></li>\n                  </ul>\n                </li>\n                <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“2: Input batch”</em>\n                  <ul>\n                    <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Sequences to align”</em>: collection of consensus sequences; output of <strong>ivar consensus</strong></li>\n                  </ul>\n                </li>\n                <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“3: Input batch”</em>\n                  <ul>\n                    <li><i class=\"far fa-copy\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-files</span> <em>“Sequences to align”</em>: the <code class=\"language-plaintext highlighter-rouge\">LSDV reference</code></li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li><em>“Type of sequences”</em>: <code class=\"language-plaintext highlighter-rouge\">Nucleic acids</code></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>From here on, there exist different possibilities to compare the aligned sequences. Two of them that work right inside Galaxy and do not require additional tools or skills are:</p>\n\n<ul>\n  <li>using Galaxy’s built in MSA visualization</li>\n  <li>using the tool <strong>faToVcf</strong> to turn the MSA into a list of mutations with regard to one of the parents</li>\n</ul>\n\n<p>For a rather long MSA like this one, the second approach may be faster, but the visual one may still be easier to understand. So lets go through both of them.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Visualize the multiple-sequence alignment</hands-on-title>\n\n  <ol>\n    <li>Visualize the multiple-sequence alignment\n      <ol>\n        <li>Click on the MAFFT output to expand this dataset</li>\n        <li>Click on <i class=\"fas fa-chart-column\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-barchart</span> <strong>Visualize</strong></li>\n        <li>Maximize the browser window (the visualization we are about to launch will not rescale properly if you do this later!)</li>\n        <li>Select <strong>Multiple Sequence Alignment</strong> as the visualization</li>\n        <li>Wait for the alignment to finish loading</li>\n        <li>\n          <p>You can now scroll through the alignment by dragging the scroll-bar, or move through it in windows by clicking next to it on the same line. You can also go to a specific position in the alignment directly via <strong>Extras</strong> -&gt; <strong>Jump to a column</strong>.</p>\n\n          <p>You can manually check some regions of the alignment to see whether they fit the published figure.</p>\n        </li>\n      </ol>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Generate list of SNVs between aligned sequences</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/ucsc_fatovcf/fatovcf/426+galaxy0\" title=\"faToVcf tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>faToVcf</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 426+galaxy0)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“FASTA Alignment”</em>: multiple-sequence alignment; output of <strong>MAFFT</strong></li>\n        <li><em>“Include positions without defined ALT allele”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Inspect the output of the tool</p>\n\n      <p>With the settings above the tool has used the first sequence in the MSA, which should be KX764644.1 (parent P1), as the reference sequence.</p>\n\n      <p>For every position in this reference sequence, for which the MSA shows something else than the reference base for any other sample, the tool has then generated a line of output, which:</p>\n      <ul>\n        <li>lists the position on the reference sequence in the <em>POS</em> column</li>\n        <li>provides the reference base in the <em>REF</em> column</li>\n        <li>\n          <p>in the <em>ALT</em> column lists what has been observed instead of <em>REF</em> in at least one of the other samples</p>\n\n          <p>Because we had activated <em>“Include positions without defined ALT allele”</em> the tool has produced result lines also for cases, in which other sequences have a gap or an N at that position, and both situations are represented by a <strong>*</strong> in the <em>ALT</em> column</p>\n        </li>\n        <li>\n          <p>has sample-specifc columns at the end</p>\n\n          <p>These columns provide information about which allele is seen for a specific sample at the reference position.</p>\n\n          <p>If a sample shows, at a position in the MSA, the same base as the reference the value in that sample’s column will be a <strong>0</strong>. If it’s showing the base in the <em>ALT</em> column instead, the value will be a <strong>1</strong>. If the position in the sample is a gap or a N (in which case the <em>ALT</em> column will have a <strong>*</strong>), the value in the sample-specific column will be a <strong>.</strong>.</p>\n        </li>\n      </ul>\n\n      <p>With this information now scroll through the file and compare what’s listed to the published figure.</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Does the data fit the figure?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answer</solution-title>\n\n          <p>The output of faToVcf starts with lines that have dots in the columns for the two consensus sequences.\nThese correspond to the leading Ns in those sequences.</p>\n\n          <p>The rest of the output (up to the trailing Ns) appears mostly as blocks, in which the two consensus sequences either look like AF325528.1, or they don’t.\nIf you compare those blocks to the figure, you’ll see that they correspond very nicely to the blue and white regions in it. So, yes, our consensus sequences confirm the same mosaic pattern.</p>\n\n          <p>When looking for lines corresponding to the red and green features of the figure, i.e. for deletions and insertions, please note that the output of faToVcf is limited to deletions with respect to the reference.\nSince the tool only emits lines for positions in the reference, it will never include insertions relative to it.\nTo have those listed, you would have to run the tool again with AF325528.1 as the reference, then look for deletions (which would correspond to insertions with respect to KX764644.1).</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"comparison-of-consensus-sequences-to-published-sequences\">Comparison of consensus sequences to published sequences</h2>\n\n<p>If you paid close attention up to this point you may have spotted the MZ** prefixes on the aligned sequences of the published figure 2. These turn out to be NCBI Genbank identifiers. So all these sequences have already been submitted to a public database!</p>\n\n<p>This means that as the last and ultimate check of our consensus sequences we can directly compare them to the public sequences - something you would, of course, not be able to do for your own samples.</p>\n\n<p>Instead of downloading the Genbank sequences into Galaxy and running yet another alignment job, we will take a shortcut this time and just do a BLAST of our consensus sequences using the public NCBI BLAST service:</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>NCBI BLAST of consensus sequences</hands-on-title>\n\n  <ol>\n    <li>Click on the collection of generated consensus sequences in your history; output of <strong>ivar consensus</strong></li>\n    <li>Inside the collection, <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> display the consensus sequence of sample 20L81</li>\n    <li>In the middle panel, which should now display the sequence, use the mouse to select the whole sequence except for the leading and trailing Ns (those would not be helpful in any way in the BLAST search), then copy the selection to the clipboard with <kbd>Ctrl</kbd>+<kbd>C</kbd></li>\n    <li>Head over to the <a href=\"https://blast.ncbi.nlm.nih.gov/Blast.cgi?PAGE=MegaBlast&amp;PROGRAM=blastn\">NCBI BLAST</a> service, paste the copied content into the <code class=\"language-plaintext highlighter-rouge\">Enter Query Sequence</code> text box  and click <code class=\"language-plaintext highlighter-rouge\">BLAST</code> at the bottom of the form</li>\n    <li>Wait for the <em>BLAST</em> run to finish</li>\n    <li>\n      <p>Inspect the results</p>\n\n      <p>In the top section, take note of the <strong>Query Length</strong> reported by BLAST. This is the length of the sequence you copied over from Galaxy and should be 150,189.</p>\n\n      <p>Then proceed to the table of BLAST hists.\n<strong>Lumpy skin disease virus strain 20L81_Bang-Thanh/VNM/20</strong> should be very near the top of the list.\nBy clicking on the name of the sequence you can jump directly to the alignment between your consensus sequence (the BLAST <em>Query</em>) and that sequence (the BLAST <em>Subject</em>).</p>\n\n      <p>Just above that alignment its statistics are displayed and say that the 150,189 bases in our input have been aligned with 100% identity to the subject!\nThe MZ577076.1 Genbank sequence is reported to have a length of 150,664 bases so is almost 500 bases longer than our consensus, but we established already that our consensus sequence has the maximum length that is to be expected with the primer scheme used in the tiled-amplicon approach.</p>\n\n      <p>So looks like we have done a really good job!</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>What about the consensus sequence for 20L70? Well, as another shortcut if you head back to the table of BLAST hits (navigate to the very top of the current alignment view and click <strong>Descriptions</strong> at the top right to return to the table), you should find 20L70 as a hit really close to the one for 20L81. Turns out it is an equally perfect hit to our 20L81 sequence, which means that the public sequences for the two samples are identical at least in the part that we have determined the sequence for.</p>\n\n<p>So if our 20L70 consensus is identical to the published 20L70 sequence, it should also be identical to our 20L81 sequence. One way to confirm the identity of two sequences is to calculate checksums for both of them and see if they match. Obtaining a checksum of an entire dataset is possible in Galaxy with the tool <strong>Secure Hash / Message Digest</strong>, but makes limited sense when the goal is to compare FASTA sequences as these will typically differ in the sequence title line, can have different line breaks structure in the sequence part, or differ in case of any number of bases. That’s why a specialized tool is needed that only compares the sequences themselves.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Checking two sequences for identity</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/wolma/mimodd_main/mimodd_info/0.1.8_1\" title=\"MiModD File Information tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>MiModD File Information</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.1.8_1)</span>\n      <ul>\n        <li><em>“Input is a”</em>: <code class=\"language-plaintext highlighter-rouge\">Dataset in history</code></li>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Input dataset”</em>: collection of consensus sequences; output of <strong>ivar consensus</strong></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>The outputs of the tool should confirm that both sequences have a length of 150,721 bases (Ns included) and identical md5 checksums!</p>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>We have reached the end of this tutorial, in which we have introduced a lot of tools of general usefulness for viral sequence data analysis. We have also touched on several Galaxy features - collections, workflows, rule-based uploads, visualizations - that let you handle any number of samples and rather complex structured input data like half-genome sequenced samples, with two pairs of forward and reverse reads per sample, with relative ease.</p>\n\n<p>We were able to generate high-quality pox virus consensus genomes and explore them in different ways right in Galaxy. Many of the concepts and techniques you have seen in this tutorial are useful also in analysis of other data - certainly for data from other pox viruses like monkeypox, but much could be reapplied to other viruses.</p>\n\n<h1 id=\"footnotes\">Footnotes</h1>\n\n<div class=\"footnotes\" role=\"doc-endnotes\">\n  <ol>\n    <li id=\"fn:prior_work\" role=\"doc-endnote\">\n      <p>This tutorial is modeled after this <a href=\"https://workflowhub.eu/workflows/439\">fully production-ready workflow</a> for the analysis of pox virus genomes sequenced as half-genomes in a tiled-amplicon approach. The workflow and the tutorial are based on and enhance original protocols and a training developed in the DEFEND project (www.defend2020.eu) with funding from the European Union’s Horizon 2020 research and innovation programme under grant agreement No 773701. <a href=\"#fnref:prior_work\" class=\"reversefootnote\" role=\"doc-backlink\">&#8617;</a></p>\n    </li>\n  </ol>\n</div>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2024-03-20 15:09:06 +0000","pub_date":"2023-05-15 10:22:16 +0000","version":10,"workflows":[{"workflow":"pox-virus-tiled-amplicon-ref-masking.ga","tests":true,"url":"https://training.galaxyproject.org/training-material/topics/variant-analysis/tutorials/pox-tiled-amplicon/workflows/pox-virus-tiled-amplicon-ref-masking.ga","path":"topics/variant-analysis/tutorials/pox-tiled-amplicon/workflows/pox-virus-tiled-amplicon-ref-masking.ga","wfid":"variant-analysis-pox-tiled-amplicon","wfname":"pox-virus-tiled-amplicon-ref-masking","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/variant-analysis-pox-tiled-amplicon/versions/pox-virus-tiled-amplicon-ref-masking","license":"MIT","creators":[{"class":"Person","identifier":"https://orcid.org/0000-0001-6897-1215","name":"Viktoria Isabel Schwarz"},{"class":"Person","identifier":"https://orcid.org/0000-0002-9464-6640","name":"Wolfgang Maier"}],"name":"pox-virus-tiled-amplicon-ref-masking","title":"pox-virus-tiled-amplicon-ref-masking","test_results":null,"modified":"2024-06-23 00:06:11 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nPrimer Scheme\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"ℹ️ Input Dataset\\nReference FASTA\"];\n  style 1 stroke:#2c3143,stroke-width:4px;\n  2[\"Select pool1 primers\"];\n  0 -->|output| 2;\n  3[\"Select pool2 primers\"];\n  0 -->|output| 3;\n  4[\"Compute sequence length\"];\n  1 -->|output| 4;\n  5[\"Datamash\"];\n  2 -->|out_file1| 5;\n  6[\"Datamash\"];\n  3 -->|out_file1| 6;\n  7[\"Cut\"];\n  4 -->|output| 7;\n  8[\"Compute\"];\n  5 -->|out_file| 8;\n  9[\"Get start position of Pool2\"];\n  6 -->|out_file| 9;\n  10[\"Get end position of sequence\"];\n  7 -->|out_file1| 10;\n  11[\"Get end position of Pool1\"];\n  8 -->|out_file1| 11;\n  12[\"Compose text parameter value\"];\n  9 -->|text_param| 12;\n  13[\"Compose text parameter value\"];\n  11 -->|text_param| 13;\n  10 -->|text_param| 13;\n  14[\"Mask Reference for Pool2\"];\n  1 -->|output| 14;\n  12 -->|out1| 14;\n  af755a5e-2b20-49bc-9d52-34781f937f48[\"Output\\nmasked_ref_pool2\"];\n  14 --> af755a5e-2b20-49bc-9d52-34781f937f48;\n  style af755a5e-2b20-49bc-9d52-34781f937f48 stroke:#2c3143,stroke-width:4px;\n  15[\"Mask Reference for Pool1\"];\n  1 -->|output| 15;\n  13 -->|out1| 15;\n  0c3b5b20-c426-428c-a08b-c835a82477c1[\"Output\\nmasked_ref_pool1\"];\n  15 --> 0c3b5b20-c426-428c-a08b-c835a82477c1;\n  style 0c3b5b20-c426-428c-a08b-c835a82477c1 stroke:#2c3143,stroke-width:4px;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/variant-analysis/tutorials/pox-tiled-amplicon/tutorial.json","tools":["Cut1","Grep1","__APPLY_RULES__","__ZIP_COLLECTION__","param_value_from_file","toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2","toolshed.g2.bx.psu.edu/repos/devteam/column_maker/Add_a_column1/2.0","toolshed.g2.bx.psu.edu/repos/devteam/emboss_5/EMBOSS: maskseq51/5.0.0","toolshed.g2.bx.psu.edu/repos/devteam/fasta_compute_length/fasta_compute_length/1.0.3","toolshed.g2.bx.psu.edu/repos/iuc/compose_text_param/compose_text_param/0.1.1","toolshed.g2.bx.psu.edu/repos/iuc/datamash_ops/datamash_ops/1.1.0+galaxy2","toolshed.g2.bx.psu.edu/repos/iuc/fastp/fastp/0.23.2+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/ivar_consensus/ivar_consensus/1.4.2+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/ivar_trim/ivar_trim/1.4.2+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/qualimap_bamqc/qualimap_bamqc/2.2.2d+galaxy3","toolshed.g2.bx.psu.edu/repos/iuc/samtools_merge/samtools_merge/1.15.1+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/samtools_view/samtools_view/1.15.1+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/ucsc_fatovcf/fatovcf/426+galaxy0","toolshed.g2.bx.psu.edu/repos/mbernt/fasta_regex_finder/fasta_regex_finder/0.1.0","toolshed.g2.bx.psu.edu/repos/rnateam/mafft/rbc_mafft/7.520+galaxy0","toolshed.g2.bx.psu.edu/repos/wolma/mimodd_main/mimodd_info/0.1.8_1","upload1"],"supported_servers":{"exact":[{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true}]},"topic_name_human":"Variant Analysis","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"bwa","owner":"devteam","revisions":"e188dc7a68e6","tool_panel_section_label":"Mapping","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"column_maker","owner":"devteam","revisions":"6595517c2dd8","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"emboss_5","owner":"devteam","revisions":"63dd26468588","tool_panel_section_label":"EMBOSS","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"fasta_compute_length","owner":"devteam","revisions":"7d37cfda8e00","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"compose_text_param","owner":"iuc","revisions":"e188c9826e0f","tool_panel_section_label":"Expression Tools","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"datamash_ops","owner":"iuc","revisions":"746e8e4bf929","tool_panel_section_label":"Join, Subtract and Group","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"fastp","owner":"iuc","revisions":"65b93b623c77","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"ivar_consensus","owner":"iuc","revisions":"40737febe339","tool_panel_section_label":"Virology","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"ivar_trim","owner":"iuc","revisions":"86a20ae274fc","tool_panel_section_label":"Virology","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"qualimap_bamqc","owner":"iuc","revisions":"19ece8afbaab","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"samtools_merge","owner":"iuc","revisions":"36677f429310","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"samtools_view","owner":"iuc","revisions":"5826298f6a73","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"ucsc_fatovcf","owner":"iuc","revisions":"78df8fc2b3ab","tool_panel_section_label":"Variant Calling","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"fasta_regex_finder","owner":"mbernt","revisions":"9a811adb714f","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"mafft","owner":"rnateam","revisions":"bf28a8cff401","tool_panel_section_label":"Multiple Alignments","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"mimodd_main","owner":"wolma","revisions":"f0f2795de2c7","tool_panel_section_label":"MiModD","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: bwa\n  owner: devteam\n  revisions: e188dc7a68e6\n  tool_panel_section_label: Mapping\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: column_maker\n  owner: devteam\n  revisions: 6595517c2dd8\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: emboss_5\n  owner: devteam\n  revisions: 63dd26468588\n  tool_panel_section_label: EMBOSS\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: fasta_compute_length\n  owner: devteam\n  revisions: 7d37cfda8e00\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: compose_text_param\n  owner: iuc\n  revisions: e188c9826e0f\n  tool_panel_section_label: Expression Tools\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: datamash_ops\n  owner: iuc\n  revisions: 746e8e4bf929\n  tool_panel_section_label: Join, Subtract and Group\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: fastp\n  owner: iuc\n  revisions: 65b93b623c77\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: ivar_consensus\n  owner: iuc\n  revisions: 40737febe339\n  tool_panel_section_label: Virology\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: ivar_trim\n  owner: iuc\n  revisions: 86a20ae274fc\n  tool_panel_section_label: Virology\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: qualimap_bamqc\n  owner: iuc\n  revisions: 19ece8afbaab\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: samtools_merge\n  owner: iuc\n  revisions: 36677f429310\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: samtools_view\n  owner: iuc\n  revisions: 5826298f6a73\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: ucsc_fatovcf\n  owner: iuc\n  revisions: 78df8fc2b3ab\n  tool_panel_section_label: Variant Calling\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: fasta_regex_finder\n  owner: mbernt\n  revisions: 9a811adb714f\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: mafft\n  owner: rnateam\n  revisions: bf28a8cff401\n  tool_panel_section_label: Multiple Alignments\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: mimodd_main\n  owner: wolma\n  revisions: f0f2795de2c7\n  tool_panel_section_label: MiModD\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial","contributors":[{"name":"Wolfgang Maier","orcid":"0000-0002-9464-6640","matrix":"wm75:matrix.org","joined":"2017-09","elixir_node":"de","fediverse":"https://scholar.social/@zerodivision","fediverse_flavor":"mastodon","affiliations":["by-covid","uni-freiburg","elixir-europe"],"id":"wm75","url":"https://training.galaxyproject.org/training-material/api/contributors/wm75.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/wm75/"},{"name":"Tomas Klingström","email":"tomas.klingstrom@slu.se","twitter":"TKlingstrom","matrix":"TKlingstrom:matrix.org","orcid":"0000-0002-9504-1352","joined":"2018-11","elixir_node":"se","affiliations":["elixir-europe"],"id":"TKlingstrom","url":"https://training.galaxyproject.org/training-material/api/contributors/TKlingstrom.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/TKlingstrom/"},{"name":"BeYond-COVID","joined":"2023-04","funder":true,"funding_id":"101046203","funding_system":"cordis","funding_statement":"BY-COVID is an EC funded project that tackles the data challenges that can hinder effective pandemic response.\n\nThis project has received funding from the European Union’s Horizon Europe research and innovation programme under grant agreement № 101046203 (BY-COVID)","url":"https://training.galaxyproject.org/training-material/api/funders/by-covid.json","members":["bgruening","hexylena","ilveroluca","kikkomep","mbaardwijk","PapXis","pauldg","simleo","stain","wm75"],"id":"by-covid","page":"https://training.galaxyproject.org/training-material/hall-of-fame/by-covid/"},{"name":"ELIXIR-CONVERGE","github":false,"joined":"2023-01","avatar":"https://elixir-europe.org/sites/default/files/styles/right-medium/public/images/converge_logo.png","url":"https://training.galaxyproject.org/training-material/api/funders/elixir-converge.json","funder":true,"funding_id":"871075","funding_system":"cordis","funding_statement":"ELIXIR CONVERGE is connecting and align ELIXIR Nodes to deliver sustainable FAIR life-science data management services. This project has received funding from the European Union’s Horizon 2020 research and innovation programme under grant agreement № 871075","members":["bgruening","hexylena"],"id":"elixir-converge","page":"https://training.galaxyproject.org/training-material/hall-of-fame/elixir-converge/"},{"name":"Addressing the dual emerging threats of African Swine Fever and Lumpy Skin Disease in Europe","short_name":"DEFEND","github":false,"joined":"2023-05","funder":true,"funding_id":"773701","funding_system":"cordis","funding_statement":"DEFEND is Addressing the dual emerging threats of African Swine Fever and Lumpy Skin Disease in Europe.\n\nThis work has received funding from the DEFEND project (www.defend2020.eu) with funding from the European Union’s Horizon 2020 research and innovation programme under grant agreement No 773701.","url":"https://training.galaxyproject.org/training-material/api/funders/h2020-defend.json","id":"h2020-defend","page":"https://training.galaxyproject.org/training-material/hall-of-fame/h2020-defend/"}]}