{"layout":"tutorial_hands_on","title":"Server Maintenance: Cleanup, Backup, and Restoration","questions":["How can I back up my Galaxy?","What data should be included?","How can I ensure jobs get cleaned up appropriately?","How do I maintain a Galaxy server?","What happens if I lose everything?"],"objectives":["Learn about different maintenance steps","Setup postgres backups","Setup cleanups","Learn what to back up and how to recover"],"time_estimation":"30m","key_points":["Use configuration management (e.g. Ansible)","Store configuration management in git","Back up the parts of Galaxy that can't be recreated"],"contributions":{"authorship":["hexylena","lldelisle","natefoo"]},"tags":["ansible","deploying","git-gat"],"subtopic":"maintenance","requirements":[{"type":"internal","topic_name":"admin","tutorials":["ansible-galaxy"]},{"type":"none","title":"A VM with at least 2 vCPUs and 4 GB RAM, preferably running Ubuntu 18.04 - 20.04."}],"abbreviations":{"WORM":"Write Once Read Many"},"edam_ontology":["topic_3489","topic_0605","topic_3071"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00324","url":"/topics/admin/tutorials/backup-cleanup/tutorial.html","topic_name":"admin","tutorial_name":"backup-cleanup","dir":"topics/admin/tutorials/backup-cleanup","symlink":null,"id":"admin/backup-cleanup","ref_tutorials":["<p>Keeping your Galaxy cleaned up is an important way to retain space, especially since for many groups that is the\nlimiting factor in their deployment.</p>\n\n<p>Additionally, backups are necessary to ensure that if you ever experience system level failures, you can safely recover\nfrom these.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#cleanups\" id=\"markdown-toc-cleanups\">Cleanups</a>    <ol>\n      <li><a href=\"#user-created-files\" id=\"markdown-toc-user-created-files\">User Created Files</a></li>\n      <li><a href=\"#galaxy-created-files\" id=\"markdown-toc-galaxy-created-files\">Galaxy Created Files</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#backups\" id=\"markdown-toc-backups\">Backups</a>    <ol>\n      <li><a href=\"#galaxy\" id=\"markdown-toc-galaxy\">Galaxy</a></li>\n      <li><a href=\"#database-backups\" id=\"markdown-toc-database-backups\">Database Backups</a></li>\n      <li><a href=\"#data-backup\" id=\"markdown-toc-data-backup\">Data Backup</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#restoration\" id=\"markdown-toc-restoration\">Restoration</a>    <ol>\n      <li><a href=\"#restoring-the-database\" id=\"markdown-toc-restoring-the-database\">Restoring the Database</a></li>\n      <li><a href=\"#restoring-galaxy\" id=\"markdown-toc-restoring-galaxy\">Restoring Galaxy</a></li>\n      <li><a href=\"#restoring-user-data\" id=\"markdown-toc-restoring-user-data\">Restoring User Data</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"cleanups\">Cleanups</h1>\n\n<p>There are two kinds of data that are produced when running a Galaxy: files users create and then delete or purge, and\nthen files Galaxy creates itself. Both of these can be cleaned to save space.</p>\n\n<h2 id=\"user-created-files\">User Created Files</h2>\n\n<p>You can use <code class=\"language-plaintext highlighter-rouge\">gxadmin</code> to cleanup user created files. <code class=\"language-plaintext highlighter-rouge\">gxadmin</code> is covered in more detail in <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">its own dedicated\ntutorial</a>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Installing gxadmin with Ansible</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Edit your <code class=\"language-plaintext highlighter-rouge\">requirements.yml</code> and add the following:</p>\n\n      <div data-commit=\"Add requirement\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/requirements.yml\n</span><span class=\"gi\">+++ b/requirements.yml\n</span><span class=\"p\">@@ -11,3 +11,6 @@</span>\n   version: 0.3.1\n - src: usegalaxy_eu.certbot\n   version: 0.1.11\n<span class=\"gi\">+# gxadmin (used in cleanup, and later monitoring.)\n+- src: galaxyproject.gxadmin\n+  version: 0.0.12\n</span>   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Install the role with:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-galaxy <span class=\"nb\">install</span> <span class=\"nt\">-p</span> roles <span class=\"nt\">-r</span> requirements.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>\n      <p>Add the role to your playbook:</p>\n\n      <div data-commit=\"Add the gxadmin role\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/galaxy.yml\n</span><span class=\"gi\">+++ b/galaxy.yml\n</span><span class=\"p\">@@ -27,3 +27,4 @@</span>\n       become: true\n       become_user: \"{{ galaxy_user_name }}\"\n     - galaxyproject.nginx\n<span class=\"gi\">+    - galaxyproject.gxadmin\n</span>   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Setup a cleanup task to run regularly:</p>\n\n      <div data-commit=\"Configure gxadmin to cleanup data\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/galaxy.yml\n</span><span class=\"gi\">+++ b/galaxy.yml\n</span><span class=\"p\">@@ -28,3 +28,11 @@</span>\n       become_user: \"{{ galaxy_user_name }}\"\n     - galaxyproject.nginx\n     - galaxyproject.gxadmin\n<span class=\"gi\">+  post_tasks:\n+    - name: Setup gxadmin cleanup task\n+      ansible.builtin.cron:\n+        name: \"Cleanup Old User Data\"\n+        user: galaxy # Run as the Galaxy user\n+        minute: \"0\"\n+        hour: \"0\"\n+        job: \"SHELL=/bin/bash source {{ galaxy_venv_dir }}/bin/activate &amp;&amp;  GALAXY_LOG_DIR=/tmp/gxadmin/ GALAXY_ROOT={{ galaxy_root }}/server GALAXY_CONFIG_FILE={{ galaxy_config_file }} /usr/local/bin/gxadmin galaxy cleanup 60\"\n</span>   \n</code></pre></div>      </div>\n\n      <p>This will cause datasets deleted for more than 60 days to be purged.</p>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>Whenever <code class=\"language-plaintext highlighter-rouge\">gxadmin</code> runs, it will create logs you can read in <code class=\"language-plaintext highlighter-rouge\">/tmp/gxadmin</code> which you can check later.</p>\n\n<h2 id=\"galaxy-created-files\">Galaxy Created Files</h2>\n\n<p>Before we begin backing up our Galaxy data, let’s set up automated cleanups to ensure we backup the minimal required set of data.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Configuring PostgreSQL Backups</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Edit <code class=\"language-plaintext highlighter-rouge\">galaxy.yml</code> to install <code class=\"language-plaintext highlighter-rouge\">tmpwatch</code> (if using RHEL/CentOS/Rocky) and <code class=\"language-plaintext highlighter-rouge\">tmpreaper</code> if using Debian/Ubuntu</p>\n\n      <div data-commit=\"Install tmpwatch/tmpreaper\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/galaxy.yml\n</span><span class=\"gi\">+++ b/galaxy.yml\n</span><span class=\"p\">@@ -21,6 +21,14 @@</span>\n     - name: Install Dependencies\n       package:\n         name: ['acl', 'bzip2', 'git', 'make', 'tar', 'python3-venv', 'python3-setuptools']\n<span class=\"gi\">+    - name: Install RHEL/CentOS/Rocky specific dependencies\n+      package:\n+        name: ['tmpwatch']\n+      when: ansible_os_family == 'RedHat'\n+    - name: Install Debian/Ubuntu specific dependencies\n+      package:\n+        name: ['tmpreaper']\n+      when: ansible_os_family == 'Debian'\n</span>   roles:\n     - galaxyproject.galaxy\n     - role: galaxyproject.miniconda\n   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Edit <code class=\"language-plaintext highlighter-rouge\">group_vars/galaxyservers.yml</code> and add some variables to configure PostgreSQL:</p>\n\n      <div data-commit=\"Configure automated cleanup\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/galaxyservers.yml\n</span><span class=\"gi\">+++ b/group_vars/galaxyservers.yml\n</span><span class=\"p\">@@ -2,6 +2,7 @@</span>\n galaxy_create_user: true # False by default, as e.g. you might have a 'galaxy' user provided by LDAP or AD.\n galaxy_separate_privileges: true # Best practices for security, configuration is owned by 'root' (or a different user) than the processes\n galaxy_manage_paths: true # False by default as your administrator might e.g. have root_squash enabled on NFS. Here we can create the directories so it's fine.\n<span class=\"gi\">+galaxy_manage_cleanup: true\n</span> galaxy_layout: root-dir\n galaxy_root: /srv/galaxy\n galaxy_user: {name: \"{{ galaxy_user_name }}\", shell: /bin/bash}\n   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>Check out the cleanup task which has been generated in: <code class=\"language-plaintext highlighter-rouge\">/etc/cron.d/ansible_galaxy_tmpclean</code></li>\n  </ol>\n\n</blockquote>\n\n<p>This will setup <code class=\"language-plaintext highlighter-rouge\">tmpwatch</code> to cleanup a few folders:</p>\n\n<ul>\n  <li>the job working directory, important if you set <code class=\"language-plaintext highlighter-rouge\">cleanup: onsuccess</code>, to cleanup old failed jobs once you’re done debugging their failures.</li>\n  <li>the new file upload path, to catch uploaded temporary files that are no longer necessary.</li>\n</ul>\n\n<h1 id=\"backups\">Backups</h1>\n\n<p>There are a few important things to back up with your Ansible Galaxy:</p>\n\n<ul>\n  <li>Galaxy\n    <ul>\n      <li>The Galaxy-managed config files</li>\n      <li>The playbooks</li>\n    </ul>\n  </li>\n  <li>The Database</li>\n  <li>The Data</li>\n</ul>\n\n<h2 id=\"galaxy\">Galaxy</h2>\n\n<p>By using Ansible, as long as you are storing your playbooks on another system, you are generally safe from failues of\nthe Galaxy node, and you’ll be able to re-run your playbook at a later date.</p>\n\n<p>However, playbooks often do not include:</p>\n\n<ul>\n  <li>Which tools you’ve installed (have you ever installed a tool outside of ephemeris? This might be lost!)</li>\n  <li>Conda environments, which will not always resolve identically over time. If strong guarantees of reproducibility are\nimportant, then consider backing these up as well.</li>\n</ul>\n\n<h2 id=\"database-backups\">Database Backups</h2>\n\n<p>We’re setting a couple of variables to control the automatic backups, they’ll be placed in the <code class=\"language-plaintext highlighter-rouge\">/data/backups</code> folder next to our user uploaded Galaxy data.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Configuring PostgreSQL Backups</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Edit <code class=\"language-plaintext highlighter-rouge\">group_vars/galaxyservers.yml</code> and add some variables to configure PostgreSQL:</p>\n\n      <div data-commit=\"Add backups\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/dbservers.yml\n</span><span class=\"gi\">+++ b/group_vars/dbservers.yml\n</span><span class=\"p\">@@ -5,3 +5,7 @@</span> postgresql_objects_users:\n postgresql_objects_databases:\n   - name: \"{{ galaxy_db_name }}\"\n     owner: \"{{ galaxy_user_name }}\"\n<span class=\"gi\">+\n+# PostgreSQL Backups\n+postgresql_backup_dir: /data/backups\n+postgresql_backup_local_dir: \"{{ '~postgres' | expanduser }}/backups\"\n</span>   \n</code></pre></div>      </div>\n\n      <!-- TODO: expanduser tip here -->\n    </li>\n  </ol>\n</blockquote>\n\n<p>This will setup our backups to run as a cron job.</p>\n\n<!-- TODO: explore cron jobs -->\n\n<h2 id=\"data-backup\">Data Backup</h2>\n\n<p>With Galaxy it is <em>technically</em> only necessary to backup your inputs, as the downstream files <em>should</em>, <em>in theory</em> be re-createable due to the reproducibility of Galaxy.</p>\n\n<p>In practice, some groups either choose to not backup, or to backup everything, often to extremely cheap and slow storage like Glacier or a tape library.</p>\n\n<p>Most groups choose to implement this as a custom cron job, e.g.</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">post_tasks</span><span class=\"pi\">:</span>\n  <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Setup backup cron job</span>\n    <span class=\"na\">ansible.builtin.cron</span><span class=\"pi\">:</span>\n      <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">Backup</span><span class=\"nv\"> </span><span class=\"s\">User</span><span class=\"nv\"> </span><span class=\"s\">Data\"</span>\n      <span class=\"na\">minute</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">0\"</span>\n      <span class=\"na\">hour</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">5,2\"</span>\n      <span class=\"na\">job</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">rsync</span><span class=\"nv\"> </span><span class=\"s\">-avr</span><span class=\"nv\"> </span><span class=\"s\">/data/galaxy/</span><span class=\"nv\"> </span><span class=\"s\">backup@backup.example.org:/backups/$(date</span><span class=\"nv\"> </span><span class=\"s\">-I)/\"</span>\n</code></pre></div></div>\n\n<blockquote class=\"tip\">\n  <tip-title>This isn't a backup strategy!</tip-title>\n  <p>People who, let’s say, care strongly about backups will often insist that you need to version files. This is of course unnecessary in the Galaxy case as files are essentially Write Once Read Many (WORM)s, which is a really good file storage practice. Files can get removed so it isn’t a true <abbr title=\"Write Once Read Many\">WORM</abbr> strategy that you’d use for e.g. audit logs, but it is close.\nThat said, since files never get changed, keeping multiple versions is unnecesary.</p>\n\n  <p>Please consider communicating <strong>very well</strong> with your users what the data backup policy is.</p>\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-got-lost-along-the-way\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Got lost along the way?</div>   <p>If you missed any steps, you can compare against the <a href=\"https://github.com/hexylena/git-gat/tree/step-2\">reference files</a>, or see what changed since <a href=\"https://github.com/hexylena/git-gat/compare/step-1...step-2#files_bucket\">the previous tutorial</a>.</p>   <p>If you’re using <code class=\"language-plaintext highlighter-rouge\">git</code> to track your progress, remember to add your changes and commit with a good commit message!</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"restoration\">Restoration</h1>\n\n<p>Sometimes failures happen! We’re sorry you have to read this section.</p>\n\n<h2 id=\"restoring-the-database\">Restoring the Database</h2>\n\n<p>This procedure is more complicated, you can <a href=\"https://github.com/galaxyproject/ansible-postgresql/pull/30#issuecomment-963600656\">read about the restoration procedure</a> in the associated PR.</p>\n\n<p>This step assumes you have pre-existing backups in place, you must check this first:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">ls /data/backups/\n</span></code></pre></div></div>\n\n<p>If you have backups, you’re ready to restore:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">#</span><span class=\"w\"> </span>Stop Galaxy, you <span class=\"k\">do </span>NOT want galaxy to connect mid-restoration <span class=\"k\">in case</span> it\n<span class=\"gp\">#</span><span class=\"w\"> </span>tries to modify the database.\n<span class=\"go\">sudo systemctl stop galaxy\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Stop the database\n<span class=\"go\">sudo systemctl stop postgresql\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Ensure that it is stopped\n<span class=\"go\">sudo systemctl status postgresql\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Begin the backup procedure by becoming postgres:\n<span class=\"go\">sudo su - postgres\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Move the current, live database to a backup location just <span class=\"k\">in case</span>:\n<span class=\"go\">mkdir /tmp/test/\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span><span class=\"o\">====</span>\n<span class=\"gp\">#</span><span class=\"w\"> </span>NOTE THAT THIS NUMBER MAY BE DIFFERENT FOR YOU!\n<span class=\"gp\">#</span><span class=\"w\"> </span>You will need to change 12 to whatever version of postgres you<span class=\"s1\">'re running\n</span><span class=\"gp\">#</span><span class=\"w\"> </span><span class=\"s1\">in every subsequent command\n</span><span class=\"gp\">#</span><span class=\"w\"> </span><span class=\"s1\">====\n</span><span class=\"go\">mv /var/lib/postgresql/12/main/* /tmp/test/\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Add backup\n<span class=\"go\">rsync -av /data/backups/YOUR_LATEST_BACKUP/ /var/lib/postgresql/12/main\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Add the restore_command, to your backup file:\n<span class=\"gp\">#</span><span class=\"w\"> </span>restore_command <span class=\"o\">=</span> <span class=\"s1\">'cp \"/tmp/backup/current/wal/%f\" \"%p\"'</span>\n<span class=\"gp\">$</span>EDITOR ./12/main/postgresql.auto.conf\n<span class=\"go\">\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Touch a recovery file\n<span class=\"go\">touch /var/lib/postgresql/12/main/recovery.signal\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>As <span class=\"nv\">$username</span> <span class=\"o\">(</span>with <span class=\"nb\">sudo </span>right<span class=\"o\">)</span>\n<span class=\"go\">sudo systemctl restart postgresql\nsudo systemctl status postgresql\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Restart Galaxy\n<span class=\"go\">sudo systemctl start galaxy\n</span></code></pre></div></div>\n\n<p>If you encounter issues, we suggest reading <a href=\"https://github.com/lldelisle/galaxyduboule-infrastructure/blob/778e5b056f03970a1af5fc2f9dd133b4e4791cac/testUpgradeOnVM.sh#L53-L130\">Lucille’s log of her experiences restoring</a> as you might encounter similar issues.</p>\n\n<h2 id=\"restoring-galaxy\">Restoring Galaxy</h2>\n\n<p>Restoring Galaxy is easy via Ansible (maybe ensuring users cannot login by disabling the routes in nginx)</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">ansible-playbook galaxy.yml\n</span></code></pre></div></div>\n\n<p>And if you are following best practices, you probably have your tools stored in a YAML file to use with <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">Ephemeris</a>:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">shed-tools install -g https://galaxy.example.org -a &lt;api-key&gt;</span><span class=\"w\"> </span><span class=\"nt\">-t</span> our_tools.yml\n</code></pre></div></div>\n\n<h2 id=\"restoring-user-data\">Restoring User Data</h2>\n\n<p>This should simply be <code class=\"language-plaintext highlighter-rouge\">rsync</code>ing your data from the backup location back into <code class=\"language-plaintext highlighter-rouge\">/data/galaxy</code>.</p>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path-1\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n"],"ref_slides":["# Server Maintenance\n\n???\n\n- Server Maintenance\n\n---\n\n## Dataset Cleanup\n\nCan only delete (or purge) dataset when all 'associations' pointing at it have been marked `deleted`.\n\n| method | description |\n| ---- | ---- |\n| `scripts/cleanup_datasets/pgcleanup.py` | PostgreSQL-optimized fast cleanup script |\n| `scripts/cleanup_datasets/cleanup_datasets.py` | General cleanup script |\n| `gxadmin cleanup <days>` | calls pgcleanup |\n\n???\n\n- One of the important admimn tasks is to keep an eye on the storage consumption.\n- Every instance should have a data rention policy defined and shared with users.\n- Codebase contains scripts that can assist with cleaning up and reclaiming space.\n- The gxadmin tool can assist with invoking these scripts.\n\n---\nclass: reduce70\n\n## pgcleanup invocation\n\n```console\n$ ./scripts/cleanup_datasets/pgcleanup.py --help\nusage: pgcleanup.py [-h] [-c CONFIG_FILE] [-d] [--dry-run] [--force-retry]\n                    [-o DAYS] [-U] [-s SEQUENCE] [-w WORK_MEM] [-l LOG_DIR]\n                    [ACTION [ACTION ...]]\n\npositional arguments:\n  ACTION                Action(s) to perform, chosen from: delete_datasets,\n                        delete_exported_histories, delete_inactive_users,\n                        delete_userless_histories, purge_datasets,\n                        purge_deleted_hdas, purge_deleted_histories,\n                        purge_deleted_users, purge_error_hdas,\n                        purge_hdas_of_purged_histories,\n                        purge_historyless_hdas, update_hda_purged_flag\n\noptional arguments:\n  -h, --help            show this help message and exit\n  -c CONFIG_FILE, --config-file CONFIG_FILE, --config CONFIG_FILE\n                        Galaxy config file (defaults to\n                        $GALAXY_ROOT/config/galaxy.yml if that file exists or\n                        else to ./config/galaxy.ini if that exists). If this\n                        isn't set on the command line it can be set with the\n                        environment variable GALAXY_CONFIG_FILE.\n  -d, --debug           Enable debug logging (SQL queries)\n  --dry-run             Dry run (rollback all transactions)\n  --force-retry         Retry file removals (on applicable actions)\n  -o DAYS, --older-than DAYS\n                        Only perform action(s) on objects that have not been\n                        updated since the specified number of days\n  -U, --no-update-time  Don't set update_time on updated objects\n  -s SEQUENCE, --sequence SEQUENCE\n                        DEPRECATED: Comma-separated sequence of actions\n  -w WORK_MEM, --work-mem WORK_MEM\n                        Set PostgreSQL work_mem for this connection\n  -l LOG_DIR, --log-dir LOG_DIR\n                        Log file directory\n```\n\n???\n\n- Cleanup scripts provide various options for filtering on which datasets to take action.\n- Use the dry run option to verify what datasets you are about to affect.\n\n---\nclass: reduce70\n\n## pgcleanup actions\n\n| action | description |\n| ---- | ---- |\n| `delete_userless_histories` | <ul><li>Mark deleted all \"anonymous\" Histories (not owned by a registered user) that are older than the specified number of days.</li></ul> |\n| `delete_exported_histories` | <ul><li>Mark deleted all Datasets that are derivative of JobExportHistoryArchives that are older than the specified number of days.</li></ul> |\n| `purge_deleted_users` | <ul><li>Mark purged all users that are older than the specified number of days.</li><li>Mark purged all Histories whose user_ids are purged in this step.</li><li>Mark purged all HistoryDatasetAssociations whose history_ids are purged in this step.</li><li>Delete all UserGroupAssociations whose user_ids are purged in this step.</li><li>Delete all UserRoleAssociations whose user_ids are purged in this step EXCEPT FOR THE PRIVATE ROLE.</li><li>Delete all UserAddresses whose user_ids are purged in this step.</li></ul> |\n| `purge_deleted_histories` | <ul><li>Mark purged all Histories marked deleted that are older than the specified number of days.</li><li>Mark purged all HistoryDatasetAssociations in Histories marked purged in this step (if not already purged).</li></ul> |\n| `purge_deleted_hdas` | <ul><li>Mark purged all HistoryDatasetAssociations currently marked deleted that are older than the specified number of days.</li><li>Mark deleted all MetadataFiles whose hda_id is purged in this step.</li><li>Mark deleted all ImplicitlyConvertedDatasetAssociations whose hda_parent_id is purged in this step.</li><li>Mark purged all HistoryDatasetAssociations for which an ImplicitlyConvertedDatasetAssociation with matching hda_id is deleted in this step.</li></ul> |\n\n???\n\n- Some available actions are safer than others, for example \"delete userless histories\".\n- In Galaxy, when something is marked deleted, it still exists with a deleted flag.\n- Once purged the file is gone.\n\n---\nclass: reduce70\n\n## More pgcleanup actions\n\n| action | description |\n| ---- | ---- |\n| `purge_historyless_hdas` | <ul><li>Mark purged all HistoryDatasetAssociations whose history_id is null.</li></ul> |\n| `purge_error_hdas` | <ul><li>Mark purged all HistoryDatasetAssociations whose dataset_id is state = 'error' that are older than the specified number of days.</li></ul> |\n| `purge_hdas_of_purged_histories` | <ul><li>Mark purged all HistoryDatasetAssociations in histories that are purged and older than the specified number of days.</li></ul> |\n| `delete_datasets` | <ul><li>Mark deleted all Datasets whose associations are all marked as deleted (LDDA) or purged (HDA) that are older than the specified number of days.</li><li>JobExportHistoryArchives have no deleted column, so the datasets for these will simply be deleted after the specified number of days.</li></ul> |\n| `purge_datasets` | <ul><li>Mark purged all Datasets marked deleted that are older than the specified number of days.</li></ul> |\n\n???\n\n- Be wary about aggressive storage reclamation. It can aggravate users.\n- Well-defined and updated data retention policy brings benefits.\n\n---\n# Additional cleaning scripts\n\n* `admin_cleanup_datasets.py`\n  * Mark datasets as deleted that are older than specified cutoff.\n  * Has email templated notification (can also be used to just send info without deleting).\n  * Can be restricted to a tool.\n\n???\n\n- One of the included scripts can send templated email to the affected users.\n- Take advantage of this to give your users some time to backup their data before you reclaim the space.\n\n---\n\n## Other disk space cleanups\n\n- `tmpwatch` (`tmpreaper` on Debian-based distros) your job working directory\n  - `cleanup_job` in `galaxy.yml` (defaults to `always` though)\n- `tmpwatch` your `new_file_path`\n  - `/usr/bin/tmpwatch -v --mtime --dirmtime 7d /srv/galaxy/var/tmp`\n\n???\n\n- Galaxy generates intermediate data as part of the job execution.\n- These should be automatically cleaned up unless you change the cleanup_job flag in galaxy's configuration.\n\n---\n\n# Backups\n\n???\n\n- Backups\n\n---\nclass: left\n\n## What to backup\n\n**Must** be backed up:\n\n| item | path (from tutorials) |\n| ---- | ---- |\n| Database ([PITR][postgresql-pitr], enable in [galaxyproject.postgresql][ansible-postgresql]) | system dependent |\n| Installed shed tools | `/srv/galaxy/var/shed_tools` |\n| *Managed* (aka *mutable*) configs | `/srv/galaxy/var/config` |\n| Logs (if you like...) | `systemd-journald` |\n| Datasets (if you can...) | `/data` |\n\nIf absolute reproducibility matters:\n\n| item | path (from tutorials) |\n| ---- | ---- |\n| Tool dependencies | `/srv/galaxy/var/dependencies` |\n| Data manager-installed reference data | `/srv/galaxy/var/tool-data` |\n\n???\n\n- Many parts of Galaxy are convenient to back up since they are straight folder hierarchies.\n- Use your system's recommended way to back up galaxy's database.\n- If you have local modifications to galaxy's code back up those as well.\n\n---\nclass: left\n\n## What not to back up\n\nRestorable from Ansible Playbook:\n\n| item | path (from tutorials) |\n| ---- | ---- |\n| Galaxy | `/srv/galaxy/server` |\n| Virtualenv | `/srv/galaxy/venv` |\n| *Static* configs | `/srv/galaxy/config` |\n\nRecreatable at runtime:\n\n| item | path (from tutorials) |\n| ---- | ---- |\n| Anything in *managed/mutable data dir* not previously mentioned | `/srv/galaxy/var` |\n| Job working directories | `/srv/galaxy/jobs` |\n\n[postgresql-pitr]: https://www.postgresql.org/docs/current/continuous-archiving.html\n[ansible-postgresql]: https://github.com/galaxyproject/ansible-postgresql\n\n---\n\n## Restoring from backups\n\nIf lost *database* or *managed/mutable configs*, then **restore these first**\n\nThen run playbook\n\n???\n\n- In case of an incident do not rush even when pressure is piling.\n- Careful planning of the restoration procedure will save you from hasty recovery attempts with errors.\n- Consider running a recovery drill pretending that e.g. your galaxy machine was wiped.\n"],"video_library":{"tutorial":null,"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":true,"mod_date":"2023-07-13 08:50:17 +0000","pub_date":"2019-01-31 15:17:51 +0000","version":22,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/backup-cleanup/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":true,"translations":{"tutorial":[],"slides":[],"video":true},"license":"CC-BY-4.0","type":"tutorial","contributors":[{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"},{"name":"Lucille Delisle","email":"lucille.delisle@epfl.ch","orcid":"0000-0002-1964-4960","joined":"2019-08","elixir_node":"ch","contact_for_training":true,"location":{"country":"CH","lat":46.52,"lon":6.56},"affiliations":["elixir-europe"],"id":"lldelisle","url":"https://training.galaxyproject.org/training-material/api/contributors/lldelisle.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/lldelisle/"},{"name":"Nate Coraor","matrix":"natefoo:matrix.org","twitter":"natefoo","email":"nate@bx.psu.edu","joined":"2017-12","orcid":"0000-0001-8083-2963","id":"natefoo","url":"https://training.galaxyproject.org/training-material/api/contributors/natefoo.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/natefoo/"}]}