{"layout":"tutorial_hands_on","title":"How I learned to stop worrying and love the systemd","questions":["Unix is supposed to be about FILES™","What is this systemd stuff?","Why should I love it?","I have so many worries!"],"objectives":["Have an objective understanding of systemd allowing the user to obtain the benefits of this new system","Realise the joys of journald, and how it makes logging easier and simpler"],"time_estimation":"30m","key_points":["systemd units are actually kinda nice","In most versions you even can limit memory, cpu usage of process groups. In recent versions, disk usage!","No more PID files! Cgroups mean the processes are actually cleaned up!","journalctl makes accessing logs incredibly easy; view multiple logs simultaneously, properly interlaced.","journalctl-vacuum replaces onerous cleaning processes and even can clean by relative timestamps"],"contributions":{"authorship":["hexylena"],"editing":["natefoo"],"testing":["natefoo"]},"tags":["ansible","systemd"],"subtopic":"features","requirements":[{"type":"internal","topic_name":"admin","tutorials":["ansible-galaxy"]}],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00020","url":"/topics/admin/tutorials/stop-worrying-love-systemd/tutorial.html","topic_name":"admin","tutorial_name":"stop-worrying-love-systemd","dir":"topics/admin/tutorials/stop-worrying-love-systemd","symlink":null,"id":"admin/stop-worrying-love-systemd","ref_tutorials":["<p>Many linux sysadmins with years and years of experience bemoan systemd (“it’s infecting everything! Now it wants to mess with time? And DNS???”) and journalctl (“unix was supposed to be about files!”) and while those are fair complaints and make systemd and friends wildly more opaque than traditional SysV and logging to files, there are some benefits that can be obtained, and may be interesting even to the wise old admins. There is a lot of convenience in systemd that can make the tradeoffs worth it.</p>\n\n<p>This tutorial assumes a working knowledge of unix systems (files, directories, services, logging, <code class=\"language-plaintext highlighter-rouge\">/var/log</code>, etc.).</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#systemd\" id=\"markdown-toc-systemd\">systemd</a>    <ol>\n      <li><a href=\"#why-systemd-units-and-not-service-shell-scripts\" id=\"markdown-toc-why-systemd-units-and-not-service-shell-scripts\">Why systemd units, and not service shell scripts?</a></li>\n      <li><a href=\"#unit-files\" id=\"markdown-toc-unit-files\">Unit Files</a></li>\n      <li><a href=\"#status\" id=\"markdown-toc-status\">Status</a></li>\n      <li><a href=\"#restarting\" id=\"markdown-toc-restarting\">Restarting</a></li>\n      <li><a href=\"#failed-units\" id=\"markdown-toc-failed-units\">Failed Units</a></li>\n      <li><a href=\"#enabling-units\" id=\"markdown-toc-enabling-units\">Enabling Units</a></li>\n      <li><a href=\"#editing-units-or-overriding\" id=\"markdown-toc-editing-units-or-overriding\">Editing Units or Overriding</a></li>\n      <li><a href=\"#masking-units\" id=\"markdown-toc-masking-units\">Masking Units</a></li>\n      <li><a href=\"#unit-security-optimisation\" id=\"markdown-toc-unit-security-optimisation\">Unit Security Optimisation</a></li>\n      <li><a href=\"#testing-with-systemd-run\" id=\"markdown-toc-testing-with-systemd-run\">Testing with systemd-run</a></li>\n      <li><a href=\"#optimising-slow-boots\" id=\"markdown-toc-optimising-slow-boots\">Optimising Slow Boots</a></li>\n      <li><a href=\"#procons-of-systemd\" id=\"markdown-toc-procons-of-systemd\">Pro/Cons of systemd</a></li>\n      <li><a href=\"#further-reading\" id=\"markdown-toc-further-reading\">Further Reading</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#timers\" id=\"markdown-toc-timers\">timers</a>    <ol>\n      <li><a href=\"#listing-timers\" id=\"markdown-toc-listing-timers\">Listing Timers</a></li>\n      <li><a href=\"#fixing-those-cron-issues\" id=\"markdown-toc-fixing-those-cron-issues\">Fixing those Cron Issues</a></li>\n      <li><a href=\"#notifying-you\" id=\"markdown-toc-notifying-you\">Notifying you</a></li>\n      <li><a href=\"#further-reading-1\" id=\"markdown-toc-further-reading-1\">Further Reading</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#journald\" id=\"markdown-toc-journald\">journald</a>    <ol>\n      <li><a href=\"#per-unit-logs\" id=\"markdown-toc-per-unit-logs\">Per Unit Logs</a></li>\n      <li><a href=\"#logs-for-a-group-of-units\" id=\"markdown-toc-logs-for-a-group-of-units\">Logs for a Group of Units</a></li>\n      <li><a href=\"#dropping-logs\" id=\"markdown-toc-dropping-logs\">Dropping Logs</a></li>\n      <li><a href=\"#logs-during-a-specific-time-period\" id=\"markdown-toc-logs-during-a-specific-time-period\">Logs during a specific time period</a></li>\n      <li><a href=\"#logs-during-a-specific-time-period-relatively\" id=\"markdown-toc-logs-during-a-specific-time-period-relatively\">Logs during a specific time period, relatively</a></li>\n      <li><a href=\"#previous-boot-logs\" id=\"markdown-toc-previous-boot-logs\">Previous Boot Logs</a></li>\n      <li><a href=\"#advanced-log-filtering\" id=\"markdown-toc-advanced-log-filtering\">Advanced Log Filtering</a></li>\n      <li><a href=\"#cleaning-logs\" id=\"markdown-toc-cleaning-logs\">Cleaning Logs</a></li>\n      <li><a href=\"#log-verification\" id=\"markdown-toc-log-verification\">Log Verification</a></li>\n      <li><a href=\"#further-reading-2\" id=\"markdown-toc-further-reading-2\">Further Reading</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"systemd\">systemd</h1>\n\n<h2 id=\"why-systemd-units-and-not-service-shell-scripts\">Why systemd units, and not service shell scripts?</h2>\n\n<ul>\n  <li>CGroups</li>\n  <li>Hard Memory Limits that include all children (also CPU, disk.)</li>\n  <li>Dependencies (is your database up, before your service that needs it?)</li>\n  <li>Fancy restarting (always/n times, delays, timeouts.)</li>\n  <li><a href=\"https://github.com/influxdata/telegraf/tree/master/plugins/inputs/systemd_units\">Monitor it with Telegraf</a></li>\n</ul>\n\n<h2 id=\"unit-files\">Unit Files</h2>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[Unit]\nDescription=Galaxy\nAfter=network.target\nAfter=time-sync.target\n\n[Service]\nUMask=022\nType=simple\nUser=galaxy\nGroup=galaxy\nWorkingDirectory=/srv/galaxy/server\nTimeoutStartSec=60\nExecStart=/srv/galaxy/venv/bin/galaxyctl start --foreground --quiet\n\nEnvironment=HOME=/srv/galaxy\nEnvironment=VIRTUAL_ENV=/srv/galaxy/venv\n\nMemoryAccounting=yes\nMemoryLimit=16G\nCPUAccounting=yes\nIOAccounting=yes\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></div></div>\n\n<p>Here’s a simple unit file. It has a name, and some targets that must be up before it should be started, then the service definition featuring all of the common fields like:</p>\n\n<ul>\n  <li>User/group and umask restriction</li>\n  <li>Working directory</li>\n  <li>Process to start (and optionally reload/stop commands.)</li>\n  <li>Some environment variables</li>\n  <li>Enabling of CPU and Mmeory accounting</li>\n  <li>As well as limiting the memory to 16GB, at which time the child will be killed and restarted.</li>\n</ul>\n\n<p>Unit files are very easy to create, be sure to see the <a href=\"https://man.archlinux.org/man/systemd.service.5#EXAMPLES\">examples section</a> of the documentation, and stick with <code class=\"language-plaintext highlighter-rouge\">Type=simple</code> services which stay in the foreground for maximum convenience.</p>\n\n<h2 id=\"status\">Status</h2>\n\n<p>Status is generally your first step looking at any unit file.</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>systemctl galaxy\n● galaxy.service - Galaxy\n     Loaded: loaded <span class=\"o\">(</span>/etc/systemd/system/galaxy.service<span class=\"p\">;</span> enabled<span class=\"p\">;</span> vendor preset: enabled<span class=\"o\">)</span>\n     Active: active <span class=\"o\">(</span>running<span class=\"o\">)</span> since Tue 2022-06-28 15:17:04 CEST<span class=\"p\">;</span> 5 days ago\n   Main PID: 217446\n      Tasks: 73 <span class=\"o\">(</span>limit: 9521<span class=\"o\">)</span>\n     Memory: 1.7G <span class=\"o\">(</span>limit: 16.0G<span class=\"o\">)</span>\n        CPU: 18h 16min 20.685s\n     CGroup: /system.slice/galaxy.service\n             ├─217446 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/galaxyctl start <span class=\"nt\">--foreground</span> <span class=\"nt\">--quiet</span>\n             ├─217467 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/supervisord <span class=\"nt\">-c</span> /srv/galaxy/var/gravity/supervisor/supervisord.conf <span class=\"nt\">--nodaemon</span>\n             ├─217484 /bin/tail <span class=\"nt\">-f</span> /srv/galaxy/var/gravity/supervisor/supervisord.log\n             ├─217487 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/gunicorn galaxy.webapps.galaxy.fast_factory:factory<span class=\"o\">()</span> <span class=\"nt\">--timeout</span> 300 <span class=\"nt\">--pythonpath</span> lib <span class=\"nt\">-k</span> galaxy.webapps.galaxy.workers.Worker <span class=\"nt\">-b</span> unix:/srv/galaxy/var/config/gunicorn.sock <span class=\"nt\">--workers</span><span class=\"o\">=</span>2 <span class=\"nt\">--config</span> python:galaxy.web_stack.gunicorn_config <span class=\"nt\">--preload</span> <span class=\"nt\">--forwarded-allow-ips</span><span class=\"o\">=</span><span class=\"k\">*</span>\n             ├─245320 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/gunicorn galaxy.webapps.galaxy.fast_factory:factory<span class=\"o\">()</span> <span class=\"nt\">--timeout</span> 300 <span class=\"nt\">--pythonpath</span> lib <span class=\"nt\">-k</span> galaxy.webapps.galaxy.workers.Worker <span class=\"nt\">-b</span> unix:/srv/galaxy/var/config/gunicorn.sock <span class=\"nt\">--workers</span><span class=\"o\">=</span>2 <span class=\"nt\">--config</span> python:galaxy.web_stack.gunicorn_config <span class=\"nt\">--preload</span> <span class=\"nt\">--forwarded-allow-ips</span><span class=\"o\">=</span><span class=\"k\">*</span>\n             ├─245322 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/gunicorn galaxy.webapps.galaxy.fast_factory:factory<span class=\"o\">()</span> <span class=\"nt\">--timeout</span> 300 <span class=\"nt\">--pythonpath</span> lib <span class=\"nt\">-k</span> galaxy.webapps.galaxy.workers.Worker <span class=\"nt\">-b</span> unix:/srv/galaxy/var/config/gunicorn.sock <span class=\"nt\">--workers</span><span class=\"o\">=</span>2 <span class=\"nt\">--config</span> python:galaxy.web_stack.gunicorn_config <span class=\"nt\">--preload</span> <span class=\"nt\">--forwarded-allow-ips</span><span class=\"o\">=</span><span class=\"k\">*</span>\n             ├─245334 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/celery <span class=\"nt\">--app</span> galaxy.celery worker <span class=\"nt\">--concurrency</span> 2 <span class=\"nt\">--loglevel</span> DEBUG <span class=\"nt\">--pool</span> threads <span class=\"nt\">--queues</span> celery,galaxy.internal,galaxy.external\n             ├─245401 /srv/galaxy/venv/bin/python <span class=\"nt\">-c</span> from multiprocessing.resource_tracker import main<span class=\"p\">;</span>main<span class=\"o\">(</span>7<span class=\"o\">)</span>\n             ├─245582 /srv/galaxy/venv/bin/python /srv/galaxy/venv/bin/celery <span class=\"nt\">--app</span> galaxy.celery beat <span class=\"nt\">--loglevel</span> DEBUG <span class=\"nt\">--schedule</span> /srv/galaxy/var/gravity/celery-beat-schedule\n             ├─245806 python ./lib/galaxy/main.py <span class=\"nt\">-c</span> /srv/galaxy/config/galaxy.yml <span class=\"nt\">--server-name</span><span class=\"o\">=</span>handler_0 <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>job-handler <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>workflow-scheduler <span class=\"nt\">--pid-file</span><span class=\"o\">=</span>/srv/galaxy/var/gravity/supervisor/handler_0.pid\n             ├─246274 python ./lib/galaxy/main.py <span class=\"nt\">-c</span> /srv/galaxy/config/galaxy.yml <span class=\"nt\">--server-name</span><span class=\"o\">=</span>handler_1 <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>job-handler <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>workflow-scheduler <span class=\"nt\">--pid-file</span><span class=\"o\">=</span>/srv/galaxy/var/gravity/supervisor/handler_1.pid\n             └─246737 python ./lib/galaxy/main.py <span class=\"nt\">-c</span> /srv/galaxy/config/galaxy.yml <span class=\"nt\">--server-name</span><span class=\"o\">=</span>handler_2 <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>job-handler <span class=\"nt\">--attach-to-pool</span><span class=\"o\">=</span>workflow-scheduler <span class=\"nt\">--pid-file</span><span class=\"o\">=</span>/srv/galaxy/var/gravity/supervisor/handler_2.pid\n</code></pre></div></div>\n\n<p>Helpful things to note:</p>\n\n<ul>\n  <li>the file defining the service is listed after <code class=\"language-plaintext highlighter-rouge\">Loaded</code>, if you want to see what it does or how it’s configured, or to edit that configuration</li>\n  <li>You can see how long it’s been running</li>\n  <li>How many tasks (children) there are</li>\n  <li>Memory and the limit, if memory limiting is configured.</li>\n  <li>CPU time used</li>\n  <li>And then many of the children.</li>\n</ul>\n\n<h2 id=\"restarting\">Restarting</h2>\n\n<p>Here’s one of the nice new things you can do, once you’ve moved away from SysV, and to the joyous world of systemd, restart multiple processes at once! If you have multiple Galaxy processes, use a wildcard to restart them all.</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemctl restart nginx galaxy-<span class=\"k\">*</span>\n</code></pre></div></div>\n\n<h2 id=\"failed-units\">Failed Units</h2>\n\n<p>Easily check if any service has failed with:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemctl <span class=\"nt\">--failed</span>\n</code></pre></div></div>\n\n<h2 id=\"enabling-units\">Enabling Units</h2>\n\n<p>In order to start at boot time, it must be “enabled”, so you can run a service once knowing it won’t come back when the machine reboots (or vice versa). But you should be sure that a unit is enabled if you want it available on restart. You can do this in separate commands</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemctl <span class=\"nb\">enable </span>my.service\nsystemctl start my.service\n</code></pre></div></div>\n\n<p>Or simultaneously, <a href=\"https://unix.stackexchange.com/questions/374280/the-now-switch-of-systemctl\">if you’re on a systemd v220 or newer</a>:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemctl <span class=\"nb\">enable</span> <span class=\"nt\">--now</span> my.service\n</code></pre></div></div>\n\n<h2 id=\"editing-units-or-overriding\">Editing Units or Overriding</h2>\n\n<p>Sometimes one of the system units provided will have some weird behaviour that you need to override (or your ansible role doesn’t expose it), then you can use <code class=\"language-plaintext highlighter-rouge\">systemctl edit unit</code> to override some settings.</p>\n\n<p>Additional directives can be supplied, e.g. making your service start after another service is started, if you need to sequence their starts.</p>\n\n<p>Note that if it was defined in the base unit file, then you need to set it to an empty value first, before overriding. E.g. <code class=\"language-plaintext highlighter-rouge\">ExecStart=\\nExecStart=command...</code></p>\n\n<h2 id=\"masking-units\">Masking Units</h2>\n\n<p>I never needed this until one day I did. Masking a unit makes it impossible to start, but if someone’s gone and installed a GUI on your server, inclusive of power management systems that trigger hibernation when not in use, then this might be a useful trick. You can mask anything, service, or even targets like I had to in that case.</p>\n\n<p>This command will prevent the device from reaching or activating any of those targets. Useful for servers when you’re in a bind and don’t know how to remove power management:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target\n</span></code></pre></div></div>\n\n<h2 id=\"unit-security-optimisation\">Unit Security Optimisation</h2>\n\n<p>Because systemd uses cgroups, it can also give us a nice overview of any security issues that might be worth looking into. Here we see the Galaxy unit has a lot of</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">ubuntu@gat-1:~$</span><span class=\"w\"> </span>systemd-analyze security galaxy\n<span class=\"go\">  NAME                                       DESCRIPTION                                         EXPOSURE\n✗ PrivateNetwork=                            Service has access to the host's network            0.5\n✓ User=/DynamicUser=                         Service runs under a static non-root user identity\n</span><span class=\"c\">....\n</span><span class=\"go\">✗ CapabilityBoundingSet=~CAP_SYS_CHROOT      Service may issue chroot()                          0.1\n✗ ProtectHostname=                           Service may change system host/domainname           0.1\n✗ CapabilityBoundingSet=~CAP_BLOCK_SUSPEND   Service may establish wake locks                    0.1\n✗ CapabilityBoundingSet=~CAP_LEASE           Service may create file leases                      0.1\n✗ CapabilityBoundingSet=~CAP_SYS_PACCT       Service may use acct()                              0.1\n✗ CapabilityBoundingSet=~CAP_SYS_TTY_CONFIG  Service may issue vhangup()                         0.1\n✗ CapabilityBoundingSet=~CAP_WAKE_ALARM      Service may program timers that wake up the system  0.1\n✗ RestrictAddressFamilies=~AF_UNIX           Service may allocate local sockets                  0.1\n\n→ Overall exposure level for galaxy.service: 9.2 UNSAFE 😨\n</span></code></pre></div></div>\n\n<p>Here we see a lot of low hanging fruit for restricting the abilities of Galaxy’s processes. This can also be applied to e.g. the job runner, or your webserver for additional security.</p>\n\n<h2 id=\"testing-with-systemd-run\">Testing with systemd-run</h2>\n\n<p>Would you like to test some of these limits manually? Or just to run a one-off process in a very sandboxed environment? Enter <code class=\"language-plaintext highlighter-rouge\">systemd-run</code>, which allows just that. Here you can set a lot of the capabilities or restrictions:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemd-run <span class=\"nt\">-p</span> <span class=\"nv\">IOAccounting</span><span class=\"o\">=</span><span class=\"nb\">yes</span> <span class=\"nt\">-p</span> <span class=\"nv\">CPUAccounting</span><span class=\"o\">=</span><span class=\"nb\">true</span> <span class=\"nt\">-p</span> <span class=\"nv\">MemoryAccounting</span><span class=\"o\">=</span><span class=\"nb\">true</span> <span class=\"nt\">-p</span> <span class=\"nv\">TasksAccounting</span><span class=\"o\">=</span><span class=\"nb\">true</span> <span class=\"nt\">-p</span> <span class=\"nv\">ProtectSystem</span><span class=\"o\">=</span>strict <span class=\"nt\">-p</span> <span class=\"nv\">PrivateDevices</span><span class=\"o\">=</span><span class=\"nb\">yes</span> <span class=\"nt\">-t</span> <span class=\"nt\">-S</span>\n</code></pre></div></div>\n\n<p>And <code class=\"language-plaintext highlighter-rouge\">-S</code> puts you in an interactive terminal, allowing you to play around with this environment. You get a cleaned out environment, working inside of a cgroup (visible in <code class=\"language-plaintext highlighter-rouge\">systemd-cgtop</code>, and <code class=\"language-plaintext highlighter-rouge\">systemctl status</code>) and when you exit it tells how you many resources you’ve used. This is both an easy way to test processes, and an option to sandbox rarely run processes, by setting an extremely restrictive environment.</p>\n\n<h2 id=\"optimising-slow-boots\">Optimising Slow Boots</h2>\n\n<p>systemd features an analyze command to check why your booting is slow</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">$</span><span class=\"w\"> </span>systemd-analyze\n<span class=\"go\">Startup finished in 3.841s (firmware) + 3.925s (loader) + 11.104s (kernel) + 1min 5.331s (userspace) = 1min 24.203s\ngraphical.target reached after 11.547s in userspace\n</span></code></pre></div></div>\n\n<p>You can even have it generate a fancy plot for you!</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>systemd-analyze plot <span class=\"o\">&gt;</span> plot.svg\n</code></pre></div></div>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><div style=\"overflow-x: auto\"><object data=\"images/plot.svg\" type=\"image/svg+xml\" alt=\"waterfall graphic of systemd boot time, cloud-init has the most, largest red bars. \">waterfall graphic of systemd boot time, cloud-init has the most, largest red bars.</object></div><a target=\"_blank\" href=\"images/plot.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> Notice how many units wait for network to finish being ready, and are stuck until that is ready. This image was generated from a training VM. Can you spot Galaxy? It doesn't show the red bars, because it does not currently notify systemd when it's done starting up.</figcaption></figure>\n\n<h2 id=\"procons-of-systemd\">Pro/Cons of systemd</h2>\n\n<blockquote class=\"code-2col\">\n  <blockquote class=\"code-out\">\n    <code-out-title>Pros</code-out-title>\n    <ul>\n      <li>CGroups, to reap children!</li>\n      <li>CGroups, for hard memory/cpu limits</li>\n      <li>CGroups, for security benefits, and dropping capabilities!</li>\n      <li>Service dependencies and simultaneously booting multiple units.</li>\n      <li>Easily override tasks</li>\n    </ul>\n  </blockquote>\n\n  <blockquote class=\"code-in\">\n    <code-in-title>Cons</code-in-title>\n    <ul>\n      <li>It’s new and requires time to learn\n        <ul>\n          <li>But all the distros have mostly switched so, might be time to learn.</li>\n        </ul>\n      </li>\n      <li>It is significantly more complicated</li>\n      <li>Even if that complexity does have a lot of benefits</li>\n    </ul>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"further-reading\">Further Reading</h2>\n\n<ul>\n  <li><a href=\"https://wiki.archlinux.org/title/Systemd\">Archi wiki page</a></li>\n  <li><a href=\"https://man.archlinux.org/man/systemctl.1\">man 1 systemctl</a></li>\n  <li><a href=\"https://man.archlinux.org/man/systemd.service.5\">man 5 systemd.service</a></li>\n</ul>\n\n<h1 id=\"timers\">timers</h1>\n\n<p>Do you use cron aggressively, like any other sysadmin? It’s an amazing part of the system, no? Doing things periodically, and repeatably. But you’ve probably had to learn a lot of hard lessons along the way, right?</p>\n\n<ul>\n  <li>Doing things idempotently</li>\n  <li>Checking that you don’t have a period cron job running, before starting this one, if it’s a long one.</li>\n  <li>What if there was a reboot?</li>\n</ul>\n\n<p>Would you like to worry less about those issues? Try systemd timers today!</p>\n\n<p><a href=\"https://wiki.archlinux.org/title/Systemd/Timers\">The arch page</a> is an excellent reference on why they’re interesting and useful. We’ll reproduce their pro/con list below:</p>\n\n<blockquote class=\"code-2col\">\n  <blockquote class=\"code-out\">\n    <code-out-title>Pros</code-out-title>\n    <ul>\n      <li>Easier testing, you can trigger units any time</li>\n      <li>Cgroups!</li>\n      <li>dependencies (e.g. network!)</li>\n      <li>automatic logging!!</li>\n      <li>two flavours of timers: clock time based, and monotonic (e.g. time since last execution)</li>\n    </ul>\n  </blockquote>\n\n  <blockquote class=\"code-in\">\n    <code-in-title>Cons</code-in-title>\n    <ul>\n      <li>Two files, instead of a single line. It <em>is</em> annoying, you’re not wrong. Maybe write an ansible role that translates it.</li>\n      <li>No <code class=\"language-plaintext highlighter-rouge\">MALITO</code> functionality built in.</li>\n    </ul>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"listing-timers\">Listing Timers</h2>\n\n<p>We have a lovely timer listing, which tells you when it’ll next run, how much time is left, when it last ran, how much time since that passed.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ systemctl list-timers\nNEXT                         LEFT          LAST                         PASSED       UNIT                         ACTIVATES\nMon 2022-07-04 12:32:45 CEST 6min left     Mon 2022-07-04 11:34:59 CEST 51min ago    anacron.timer                anacron.service\nMon 2022-07-04 14:07:08 CEST 1h 40min left Fri 2022-07-01 13:38:20 CEST 2 days ago   motd-news.timer              motd-news.service\nMon 2022-07-04 17:12:05 CEST 4h 45min left Mon 2022-07-04 10:20:49 CEST 2h 5min ago  ua-timer.timer               ua-timer.service\nMon 2022-07-04 17:14:33 CEST 4h 48min left Fri 2022-07-01 19:22:14 CEST 2 days ago   apt-daily.timer              apt-daily.service\nTue 2022-07-05 00:00:00 CEST 11h left      Mon 2022-07-04 09:32:16 CEST 2h 54min ago logrotate.timer              logrotate.service\nTue 2022-07-05 00:00:00 CEST 11h left      Mon 2022-07-04 09:32:16 CEST 2h 54min ago man-db.timer                 man-db.service\nTue 2022-07-05 01:44:11 CEST 13h left      Mon 2022-07-04 11:07:49 CEST 1h 18min ago fwupd-refresh.timer          fwupd-refresh.service\nTue 2022-07-05 06:28:44 CEST 18h left      Mon 2022-07-04 09:33:59 CEST 2h 52min ago apt-daily-upgrade.timer      apt-daily-upgrade.service\nTue 2022-07-05 10:12:36 CEST 21h left      Mon 2022-07-04 09:47:01 CEST 2h 39min ago systemd-tmpfiles-clean.timer systemd-tmpfiles-clean.service\nSun 2022-07-10 03:10:47 CEST 5 days left   Mon 2022-07-04 09:32:52 CEST 2h 53min ago e2scrub_all.timer            e2scrub_all.service\nMon 2022-07-11 00:00:00 CEST 6 days left   Mon 2022-07-04 09:32:16 CEST 2h 54min ago fstrim.timer                 fstrim.service\n</code></pre></div></div>\n\n<p>In the last column we can see the timer units, and the services which they activate. In systemd everything is a unit, and hopefully by this point in the tutorial you’ve seen some of the benefits of that.</p>\n\n<p>Let’s look at the <code class=\"language-plaintext highlighter-rouge\">motd-news</code> timer:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">$</span><span class=\"w\"> </span>systemctl <span class=\"nb\">cat </span>motd-news.timer\n<span class=\"go\">[Unit]\nDescription=Message of the Day\n\n[Timer]\nOnCalendar=00,12:00:00\nRandomizedDelaySec=12h\nPersistent=true\nOnStartupSec=1min\n\n[Install]\nWantedBy=timers.target\n</span></code></pre></div></div>\n\n<p>It has a description, an <code class=\"language-plaintext highlighter-rouge\">OnCalendar</code> time since it’s a clock based timer, potentially a random delay as well (despite being <code class=\"language-plaintext highlighter-rouge\">Sec</code>, can be expressed in any unit). The associated <code class=\"language-plaintext highlighter-rouge\">motd-news.service</code> does not need to be mentioned, it will be started by default based on the name of the timer.</p>\n\n<p>What about logs? They’re in journalctl now! Let’s take advantage of some of the things we learned earlier, like, wildcards!</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">journalctl -u motd-news.* --since '5 days ago'\n</span></code></pre></div></div>\n\n<p>You’ll see the timer unit start mostly around reboots, usually it doesn’t have much useful in it. The service unit has what we’re more interested in, any logged output.</p>\n\n<h2 id=\"fixing-those-cron-issues\">Fixing those Cron Issues</h2>\n\n<p>Before we mentioned a few issues that admins dealt with with cron</p>\n\n<ul>\n  <li>Doing things idempotently</li>\n  <li>Checking that you don’t have a period cron job running, before starting this one, if it’s a long one.</li>\n  <li>What if there was a reboot?</li>\n</ul>\n\n<p>While we can’t help with the first, the second is taken care of by having systemd services be state machines, if there’s an already running copy of the <code class=\"language-plaintext highlighter-rouge\">.service</code>, then the <code class=\"language-plaintext highlighter-rouge\">.timer</code> won’t do anything. No more <code class=\"language-plaintext highlighter-rouge\">pgrep</code> to check for specific processes. And as for reboots, <code class=\"language-plaintext highlighter-rouge\">Persistent=true</code> can cause a timer to trigger immediately, if it missed the last start time.</p>\n\n<h2 id=\"notifying-you\">Notifying you</h2>\n\n<p>As mentioned in the Arch wiki, you can setup a “notification” service. This is a service, typically a simple bash script, that, when run, sends a notification to a channel of your choice (Slack, XMPP, Email, etc.) This can be a really simple service:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>/etc/systemd/system/failure-notification@.service\n\n[Unit]\nDescription=Send a notification\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/path/to/failure-notification.sh %i\n</code></pre></div></div>\n\n<p>And then for any unit (timer’s associated service, normal units, etc) where you’d like to be informed of the failure, simply update or override that to do the notification:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[Unit]\nOnFailure=failure-notification@%n\n</code></pre></div></div>\n\n<p>Here it will be templated out with <code class=\"language-plaintext highlighter-rouge\">%n</code> meaning the unit name, which will replace the <code class=\"language-plaintext highlighter-rouge\">%i</code> in the notification unit, and be included in the notification to you.</p>\n\n<h2 id=\"further-reading-1\">Further Reading</h2>\n\n<ul>\n  <li><a href=\"https://wiki.archlinux.org/title/Systemd/Timers\">The arch page</a></li>\n  <li><a href=\"https://man.archlinux.org/man/systemd.timer.5\">man 5 systemd.timer</a></li>\n  <li><a href=\"https://man.archlinux.org/man/systemd.time.7\">man 7 systemd.time</a></li>\n</ul>\n\n<h1 id=\"journald\">journald</h1>\n\n<blockquote class=\"quote\">\n  <p>Where did my files go?</p>\n</blockquote>\n\n<p>In a number of systems they’re still there, to be honest, you’ve still got all of your old log files.</p>\n\n<p>But now instead of search N different log files, or memorising which files have what contents, there’s one firehose for you to watch instead: journalctl. So we need to make this manageable with filters!</p>\n\n<h2 id=\"per-unit-logs\">Per Unit Logs</h2>\n\n<blockquote class=\"code-out\">\n  <code-out-title>The journalctl Way</code-out-title>\n  <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">-u</span> galaxy\n</code></pre></div>  </div>\n</blockquote>\n\n<p>returns all of the logs for Galaxy.  The first line even tells us how far back our logs go:</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">$</span><span class=\"w\"> </span>journalctl <span class=\"nt\">-u</span> galaxy | <span class=\"nb\">head</span> <span class=\"nt\">-n1</span>\n<span class=\"go\">-- Logs begin at Tue 2022-06-28 08:31:06 UTC, end at Mon 2022-07-04 09:30:01 UTC. --\n</span></code></pre></div></div>\n\n<blockquote class=\"code-2col\">\n  <blockquote class=\"code-out\">\n    <code-out-title>Pros</code-out-title>\n    <p>You did not need to know or remember:</p>\n\n    <ul>\n      <li>Where the log files were (<code class=\"language-plaintext highlighter-rouge\">/var/log</code>? <code class=\"language-plaintext highlighter-rouge\">/srv/galaxy/log</code>? somewhere else?)</li>\n      <li>If any of the old logs were compressed (or use <code class=\"language-plaintext highlighter-rouge\">zless</code>/<code class=\"language-plaintext highlighter-rouge\">zcat</code>/<code class=\"language-plaintext highlighter-rouge\">zgrep</code>)</li>\n    </ul>\n  </blockquote>\n\n  <blockquote class=\"code-in\">\n    <code-in-title>Cons</code-in-title>\n    <ul>\n      <li>Can’t just <code class=\"language-plaintext highlighter-rouge\">cat</code> it.</li>\n    </ul>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"logs-for-a-group-of-units\">Logs for a Group of Units</h2>\n\n<p>Sometimes you want to tail the logs of multiple proceses as once. Have you ever been debugging an issue, and wanted to see the logs of <code class=\"language-plaintext highlighter-rouge\">nginx</code>, <strong>all</strong> <code class=\"language-plaintext highlighter-rouge\">galaxy</code> processes, and <code class=\"language-plaintext highlighter-rouge\">postgres</code>? Well you can’t because <code class=\"language-plaintext highlighter-rouge\">nginx</code> needs special configuration to write to journalctl (see, your files are still there, and it makes things extra confusing.)</p>\n\n<p>Adding these two lines to your <code class=\"language-plaintext highlighter-rouge\">nginx</code> configuration will place logs in journald</p>\n\n<div class=\"language-nginx highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">error_log</span> <span class=\"s\">syslog:server=unix:/dev/log</span><span class=\"p\">;</span>\n<span class=\"k\">access_log</span> <span class=\"s\">syslog:server=unix:/dev/log</span><span class=\"p\">;</span>\n</code></pre></div></div>\n\n<p>And then you can simply</p>\n\n<blockquote class=\"code-out\">\n  <code-out-title>The journalctl Way</code-out-title>\n  <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">-f</span> <span class=\"nt\">-u</span> galaxy<span class=\"k\">*</span> <span class=\"nt\">-u</span> nginx <span class=\"nt\">-u</span> postgresql\n</code></pre></div>  </div>\n</blockquote>\n\n<p>If you have multiple similarly named units, the wildcard feature is incredibly helpful. UseGalaxy.eu had multiple named processes for: web handlers, workflow schedulers, job handlers. We could see logs simultaneously across all of these units.</p>\n\n<blockquote class=\"code-2col\">\n  <blockquote class=\"code-out\">\n    <code-out-title>Pros</code-out-title>\n    <ul>\n      <li>Tail multiple units at once</li>\n      <li>Again don’t have to know where the files are</li>\n      <li>Or switch tools if you want to look at older logs</li>\n    </ul>\n  </blockquote>\n\n  <blockquote class=\"code-in\">\n    <code-in-title>Cons</code-in-title>\n    <p>?</p>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"dropping-logs\">Dropping Logs</h2>\n\n<p>journald has the habit of throwing away logs if it gets too many messages simultaneously, to prevent {DOS} and denial-of-storage attacks. To disable that behaviour, you can tune</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>RateLimitBurst=0\n</code></pre></div></div>\n\n<p>(see <code class=\"language-plaintext highlighter-rouge\">man 5 journald.conf</code>)</p>\n\n<h2 id=\"logs-during-a-specific-time-period\">Logs during a specific time period</h2>\n\n<p>This is my absolute favourite feature of journalctl, and I’ve regularly used it to narrow down logs from dozens of processes, especially when I don’t know the root cause of an issue and need to watch all of the logs.</p>\n\n<blockquote class=\"code-2col\">\n  <blockquote class=\"code-in\">\n    <code-in-title>The Old Way</code-in-title>\n    <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>zcat /var/log/<span class=\"k\">*</span> | egrep <span class=\"s2\">\"(Jul</span><span class=\"se\">\\s</span><span class=\"s2\">*1 11:4.:..|2022-07-01 11:4.:..)\"</span>\n</code></pre></div>    </div>\n    <p>Hope everything logs in the same timezone! And no one uses UTC when there’s a different system time configured.</p>\n  </blockquote>\n\n  <blockquote class=\"code-out\">\n    <code-out-title>The journalctl Way</code-out-title>\n    <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--since</span> <span class=\"s2\">\"2022-07-01 11:40 CEST\"</span> <span class=\"nt\">--until</span> <span class=\"s2\">\"2022-07-01 11:50 CEST\"</span>\n</code></pre></div>    </div>\n  </blockquote>\n</blockquote>\n\n<p>This is very useful if you know when an error is, easily pull out entire system logs from around a specific timepoint. Everything is forced through journald’s logging format, so you can be sure the timestamps are all correct, and <code class=\"language-plaintext highlighter-rouge\">--since</code> and <code class=\"language-plaintext highlighter-rouge\">--when</code> can be made timezone aware if you have reason to use that (e.g. a user reporting an issue in their current local time.) You can mix and match explicit time zone locales for even more fun:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--since</span> <span class=\"s2\">\"2022-06-21 14:24 Pacific/Auckland\"</span> <span class=\"nt\">--until</span> <span class=\"s2\">\"2022-06-21 14:30 Europe/Amsterdam\"</span>\n</code></pre></div></div>\n\n<p>The logs will be displayed in the last mentioned TZ.</p>\n\n<h2 id=\"logs-during-a-specific-time-period-relatively\">Logs during a specific time period, relatively</h2>\n\n<p>This is another flag that I use literally every day:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--since</span> <span class=\"s1\">'1 hour ago'</span>\n</code></pre></div></div>\n\n<p>If you know relatively when an issue started happening, it’s a great way to filter on the logs that are interesting, without having to do clock math.</p>\n\n<h2 id=\"previous-boot-logs\">Previous Boot Logs</h2>\n\n<p>Want to see what happened during a previous run of the system, during a previous boot? Use <code class=\"language-plaintext highlighter-rouge\">--list-boots</code> to list all of the previous system restarts</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">$</span><span class=\"w\"> </span>journalctl <span class=\"nt\">--list-boots</span>\n<span class=\"go\">-14 143fdb7ac7a54370b41196c02affc3e8 Wed 2022-04-06 20:03:38 CEST—Mon 2022-04-11 08:26:00 CEST\n-13 45801d31b0654fe3a4a7d5541e6ff71a Mon 2022-04-11 09:06:07 CEST—Wed 2022-04-20 13:37:31 CEST\n-12 661e959635954aa0bbd6b800433e5097 Wed 2022-04-20 13:37:53 CEST—Thu 2022-04-28 17:26:32 CEST\n-11 cedaef23e95849c39cfcdb1611b616a2 Thu 2022-04-28 17:40:33 CEST—Thu 2022-04-28 17:43:23 CEST\n-10 6ac084d5256d4134bd6e395b490e99f2 Thu 2022-04-28 18:44:57 CEST—Mon 2022-05-09 11:21:33 CEST\n -9 680c9440c75d4699b6de48a56891d835 Mon 2022-05-09 11:21:54 CEST—Tue 2022-05-17 15:21:36 CEST\n -8 b8581fd6394144a9abc59b2832056037 Wed 2022-05-18 09:08:54 CEST—Fri 2022-05-20 17:33:36 CEST\n -7 8bb5c9d7d4ef4117ad8181d0314de7e1 Sun 2022-05-22 17:45:23 CEST—Thu 2022-06-02 16:35:45 CEST\n -6 5325407857054a828dbba6bb104efc80 Fri 2022-06-03 12:04:28 CEST—Thu 2022-06-09 10:15:40 CEST\n -5 0428cc6d11bc4aa9bd8e3999f9bd2c7f Thu 2022-06-09 10:20:05 CEST—Fri 2022-06-17 12:26:06 CEST\n -4 990910c70e79458394f5d9a97ae724ab Sat 2022-06-18 11:21:16 CEST—Tue 2022-06-21 12:14:47 CEST\n -3 d9a9088afacd4c6c9f85db49e9b321ce Tue 2022-06-21 14:29:20 CEST—Tue 2022-06-21 15:07:26 CEST\n -2 c3f0ec4fbc93410280f1e086d6533286 Tue 2022-06-21 15:07:45 CEST—Thu 2022-06-23 12:58:11 CEST\n -1 5d4d9c039daf4e5795a13211de4d6fd4 Thu 2022-06-23 12:58:31 CEST—Fri 2022-07-01 20:10:15 CEST\n  0 490a1609fb5d422cad1e7135db88efe7 Mon 2022-07-04 09:32:12 CEST—Mon 2022-07-04 11:56:09 CEST\n</span></code></pre></div></div>\n\n<p>You can then see logs for those specific timeperiods with</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ journalctl -b -3 | head\n-- Logs begin at Wed 2022-04-06 20:03:38 CEST, end at Mon 2022-07-04 11:59:13 CEST. --\njun 21 14:29:20 cosima kernel: microcode: microcode updated early to revision 0x88, date = 2021-03-31\njun 21 14:29:20 cosima kernel: Linux version 5.13.0-44-generic (buildd@lcy02-amd64-107) (gcc (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0, GNU ld (GNU Binutils for Ubuntu) 2.34) #49~20.04.1-Ubuntu SMP Wed May 18 18:44:28 UTC 2022 (Ubuntu 5.13.0-44.49~20.04.1-generic 5.13.19)\n</code></pre></div></div>\n\n<p>All of the other filtering commands (<code class=\"language-plaintext highlighter-rouge\">--since</code>, <code class=\"language-plaintext highlighter-rouge\">--when</code>) natively search across boots so there’s generally no need to supply this flag unless you want to restrict to a specific time period based on restarting.</p>\n\n<h2 id=\"advanced-log-filtering\">Advanced Log Filtering</h2>\n\n<p>There’s a lot of additional information journald tracks with your logs, you can read them in the <code class=\"language-plaintext highlighter-rouge\">verbose</code> format to see</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">$</span><span class=\"w\"> </span>journalctl <span class=\"nt\">-o</span> verbose\n<span class=\"gp\">Wed 2022-04-06 20:03:38.281794 CEST [s=1b57c151fb2e49ad98a84ac45ed2e245;</span><span class=\"nv\">i</span><span class=\"o\">=</span>a310796<span class=\"p\">;</span><span class=\"nv\">b</span><span class=\"o\">=</span>143fdb7ac7a54370b41196c02affc3e8<span class=\"p\">;</span><span class=\"nv\">m</span><span class=\"o\">=</span>51917bf226<span class=\"p\">;</span><span class=\"nv\">t</span><span class=\"o\">=</span>5dc002e4a3f42<span class=\"p\">;</span><span class=\"nv\">x</span><span class=\"o\">=</span>4ae28fb4218f3691]\n<span class=\"go\">    _TRANSPORT=stdout\n    _STREAM_ID=45b0adde513f46348564e6f9ce85e4b2\n    PRIORITY=6\n    SYSLOG_FACILITY=3\n    SYSLOG_IDENTIFIER=influxd-systemd-start.sh\n</span><span class=\"gp\">    MESSAGE=[httpd] 127.0.0.1 - - [06/Apr/2022:20:03:38 +0200] \"POST /write?db=telegraf HTTP/1.1 \" 204 0 \"-\" \"Telegraf/1.21.4 Go/1.17.7\" e265a273-b5d3-11ec-88d5-80fa5b94d68a&gt;</span><span class=\"w\">\n</span><span class=\"go\">    _PID=2491\n    _UID=1001\n    _GID=1001\n    _COMM=influxd\n    _EXE=/usr/bin/influxd\n    _CMDLINE=/usr/bin/influxd -config /etc/influxdb/influxdb.conf\n    _CAP_EFFECTIVE=0\n    _SELINUX_CONTEXT=unconfined\n    _SYSTEMD_CGROUP=/system.slice/influxdb.service\n    _SYSTEMD_UNIT=influxdb.service\n    _SYSTEMD_SLICE=system.slice\n    _SYSTEMD_INVOCATION_ID=0ba7986947854acc938a93f020f96cee\n    _BOOT_ID=143fdb7ac7a54370b41196c02affc3e8\n    _MACHINE_ID=08854338f5f046d5a0d73f81ca5c2d79\n    _HOSTNAME=cosima\n</span></code></pre></div></div>\n\n<p>All of these attributes can be used to filter your logs, just add them to your <code class=\"language-plaintext highlighter-rouge\">journalctl</code> command like so:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nv\">_GID</span><span class=\"o\">=</span>1001\n</code></pre></div></div>\n\n<p>Or, for example, to get every log, by any process that logged, running under a specific user, like the Galaxy user:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nv\">_UID</span><span class=\"o\">=</span><span class=\"si\">$(</span>getent passwd | <span class=\"nb\">grep </span>galaxy | <span class=\"nb\">cut</span> <span class=\"nt\">-f</span> 3 <span class=\"nt\">-d</span> : <span class=\"si\">)</span>\n</code></pre></div></div>\n\n<p>Or to see every log from a python program?</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nv\">_COMM</span><span class=\"o\">=</span>python3\n</code></pre></div></div>\n\n<h2 id=\"cleaning-logs\">Cleaning Logs</h2>\n\n<p>Journald comes with a nice tool for cleaning up logs, <code class=\"language-plaintext highlighter-rouge\">journalctl --vacuum-...</code>. There are a couple different ways to invoke this. It’s very useful if you left Galaxy poorly configured, reading bad XML files and crashing every minute, logging endlessly until you checked it again. That sort of behaviour generates an incredible number of logs.</p>\n\n<p>First we can check how much disk space our logs are using:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ journalctl --disk-usage\nArchived and active journals take up 120.0M in the file system.\n</code></pre></div></div>\n\n<p>And then we can clean it!</p>\n\n<p>Based on <strong>size</strong>:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--vacuum-size</span><span class=\"o\">=</span>4GB\n</code></pre></div></div>\n\n<p>Based on <strong>age</strong></p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--vacuum-time</span><span class=\"o\">=</span><span class=\"s2\">\"2 days\"</span>\n</code></pre></div></div>\n\n<p>Or based on number of <strong>files</strong></p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>journalctl <span class=\"nt\">--vacuum-files</span><span class=\"o\">=</span>3 <span class=\"c\"># I've never used this one.</span>\n</code></pre></div></div>\n\n<p>Note that this only applies to “archived” logs, not “active” ones, but you can use <code class=\"language-plaintext highlighter-rouge\">journalctl --rotate</code> to force them to archived, before cleaning..</p>\n\n<h2 id=\"log-verification\">Log Verification</h2>\n\n<p>Want to check if they’ve been tampered with (and someone forgot to recalculate checksums?). The <code class=\"language-plaintext highlighter-rouge\">--verify</code> flag can be used to do that.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ journalctl --verify\nPASS: /var/log/journal/08854338f5f046d5a0d73f81ca5c2d79/user-1001@0005df9b9d17faa5-c4276c13359e16e1.journal~\nFile corruption detected at /var/log/journal/08854338f5f046d5a0d73f81ca5c2d79/system@0005df9b9c8ebfda-d41419e76ede7f2c.journal~:3f070f8 (of 67108864 bytes, 98%).\nFAIL: /var/log/journal/08854338f5f046d5a0d73f81ca5c2d79/system@0005df9b9c8ebfda-d41419e76ede7f2c.journal~ (Bad message)\nPASS: /var/log/journal/08854338f5f046d5a0d73f81ca5c2d79/system@ede9cabbb3874bd98bcb0b16ada49d8f-000000000a6ce684-0005de680b29a077.journal\n7e5abf8: Unused data (entry_offset==0)\n..  94%\n</code></pre></div></div>\n\n<h2 id=\"further-reading-2\">Further Reading</h2>\n\n<ul>\n  <li><a href=\"https://manpages.ubuntu.com/manpages/bionic/man5/journald.conf.5.html\">man 5 journald.conf</a></li>\n  <li><a href=\"https://manpages.ubuntu.com/manpages/bionic/man1/journalctl.1.html\">man 1 journalctl</a></li>\n  <li><a href=\"https://manpages.ubuntu.com/manpages/bionic/man7/systemd.journal-fields.7.html\">man 7 systemd.journal-fields</a></li>\n</ul>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-09-27 06:52:01 +0000","pub_date":"2022-07-06 17:13:50 +0000","version":4,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/stop-worrying-love-systemd/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial","contributors":[{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"},{"name":"Nate Coraor","matrix":"natefoo:matrix.org","twitter":"natefoo","email":"nate@bx.psu.edu","joined":"2017-12","orcid":"0000-0001-8083-2963","id":"natefoo","url":"https://training.galaxyproject.org/training-material/api/contributors/natefoo.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/natefoo/"},{"name":"Nate Coraor","matrix":"natefoo:matrix.org","twitter":"natefoo","email":"nate@bx.psu.edu","joined":"2017-12","orcid":"0000-0001-8083-2963","id":"natefoo","url":"https://training.galaxyproject.org/training-material/api/contributors/natefoo.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/natefoo/"}]}