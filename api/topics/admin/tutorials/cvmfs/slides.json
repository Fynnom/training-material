{"layout":"tutorial_slides","title":"Reference Data with CVMFS","zenodo_link":"","questions":null,"objectives":["Have an understanding of what CVMFS is and how it works","Install and configure the CVMFS client on a linux machine and mount the Galaxy reference data repository","Configure your Galaxy to use these reference genomes and indices","Use an ansible playbook for all of the above."],"time_estimation":"1h","key_points":null,"contributors":["blankenberg","slugger70","hexylena"],"requirements":[{"type":"internal","topic_name":"admin","tutorials":["ansible","ansible-galaxy"]}],"voice":{"id":"Olivia","lang":"en-AU","neural":true},"subtopic":"data","tags":["ansible","git-gat"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"S00006","url":"/topics/admin/tutorials/cvmfs/slides.html","topic_name":"admin","tutorial_name":"cvmfs","dir":"topics/admin/tutorials/cvmfs","symlink":null,"id":"admin/cvmfs","ref_tutorials":["<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#top-navbar\">\n  <p>These words come from a transcript of Simon Gladman teaching this course. He\nis a bioinformatician at the University of Melbourne in Australia and also\none of the administrators of Galaxy Australia.</p>\n\n  <p>Hello everybody and welcome back to the Galaxy\nadministrators course. in this session we’re going to be talking about\nreference data in Galaxy using CVMFS.</p>\n\n  <p>Hopefully by now you’ve all seen the video of\nthe slides - if not I suggest you go and do\nlook at those first as that explains how reference\ndata works in Galaxy and also what CVMFS does to\nhelp us with that reference data.</p>\n\n  <p>Some of the requirements from that we hope you’ve\nalready completed: Galaxy server installation\nwith Ansible and hopefully you\nunderstand what Ansible is and how\nit’s used.</p>\n</blockquote>\n\n<h1 id=\"overview\">Overview</h1>\n\n<p>The CernVM-FS <span class=\"citation\"><a href=\"#Blomer_2011\">Blomer <i>et al.</i> 2011</a></span> is a distributed filesystem perfectly designed for sharing readonly data across the globe. We use it in the <a href=\"https://galaxyproject.org\">Galaxy Project</a> for sharing things that a lot of Galaxy servers need. Namely:</p>\n<ul>\n  <li><strong>Reference Data</strong>\n    <ul>\n      <li>Genome sequences for hundreds of useful species.</li>\n      <li>Indices for the genome sequences</li>\n      <li>Various bioinformatic tool indices for the available genomes</li>\n    </ul>\n  </li>\n  <li><strong>Tool containers</strong>\n    <ul>\n      <li><a href=\"https://www.sylabs.io/\">Singularity</a> containers of everything stored in <a href=\"https://biocontainers.pro/\">Biocontainers</a> (A bioinformatic tool container repository.) You get these for free every time you build a <a href=\"https://bioconda.github.io/\">Bioconda</a> recipe/package for a tool.</li>\n    </ul>\n  </li>\n  <li>Others too..</li>\n</ul>\n\n<p>From the Cern website:</p>\n\n<blockquote class=\"quote\" id=\"cvmfs-quote\" cite=\"https://cernvm.cern.ch/portal/filesystem\">\n  <p>The CernVM File System provides a scalable, reliable and low-maintenance software distribution service. It was developed to assist High Energy Physics (HEP) collaborations to deploy software on the worldwide-distributed computing infrastructure used to run data processing applications. CernVM-FS is implemented as a POSIX read-only file system in user space (a FUSE module). Files and directories are hosted on standard web servers and mounted in the universal namespace /cvmfs.”</p>\n\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#cvmfs-quote\">\n  <p>All right, just a quick recap. CVMFS or\nCern-VMFS is a distributed file system perfectly\ndesigned for sharing read-only data across the\nglobe and we use it extensively in the Galaxy\nproject for sharing things that\na lot of Galaxy servers need.\nNamely all the reference data; so the genome\nsequences for all the different genomes that\nwe need to think about in in Galaxy and\nbioinformatics. Things like a human genome,\nmouse genome, etc., etc. And we need a lot of\nindices for the genome sequences and lots of\ntool indices for all those genomes. And we also\nhave a repository that contains tool containers.\nSo singularity containers for all of the\nbioinformatics tools that we might want to use.\nThere’s a tutorial idea already done this week\nor coming up soon this week that explains how to\nuse those singularity containers within Galaxy as\nwell. So we’re just going to get on with things.</p>\n</blockquote>\n\n<p><a href=\"/training-material/topics/admin/tutorials/cvmfs/slides.html\">A slideshow presentation on this subject</a> is available. More <a href=\"https://galaxyproject.org/admin/reference-data-repo/#usegalaxyorg-reference-data\">details are available on usegalaxy.org (Galaxy Main’s) reference data setup</a> and CVMFS system.</p>\n\n<p>This exercise uses Ansible to install and configure CVMFS and Galaxy’s access to CVMFS. For a tutorial that does not use Ansible and gives a closer look at how reference data is configured in Galaxy, see <a href=\"/training-material/topics/admin/tutorials/cvmfs-manual/tutorial.html\">the Reference Data with CVMFS without Ansible tutorial</a>.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#overview\" id=\"markdown-toc-overview\">Overview</a></li>\n  <li><a href=\"#ansible-cvmfs-and-galaxy\" id=\"markdown-toc-ansible-cvmfs-and-galaxy\">Ansible-CVMFS and Galaxy</a>    <ol>\n      <li><a href=\"#installing-and-configuring\" id=\"markdown-toc-installing-and-configuring\">Installing and Configuring</a></li>\n      <li><a href=\"#exploring-the-cvmfs-installation\" id=\"markdown-toc-exploring-the-cvmfs-installation\">Exploring the CVMFS Installation</a></li>\n      <li><a href=\"#configuring-galaxy-to-use-the-cvmfs-references\" id=\"markdown-toc-configuring-galaxy-to-use-the-cvmfs-references\">Configuring Galaxy to use the CVMFS references.</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#common-production-questions\" id=\"markdown-toc-common-production-questions\">Common Production Questions</a></li>\n  <li><a href=\"#other-aspects\" id=\"markdown-toc-other-aspects\">Other Aspects</a>    <ol>\n      <li><a href=\"#development\" id=\"markdown-toc-development\">Development</a></li>\n      <li><a href=\"#automation\" id=\"markdown-toc-automation\">Automation</a></li>\n      <li><a href=\"#access-control\" id=\"markdown-toc-access-control\">Access Control</a></li>\n      <li><a href=\"#proxying-recap\" id=\"markdown-toc-proxying-recap\">Proxying Recap</a></li>\n      <li><a href=\"#plant-data\" id=\"markdown-toc-plant-data\">Plant Data</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#agenda\">\n  <p>The agenda we’re going to follow today is: We’re going to install and\nconfigure Galaxy CVMFS reference data using ansible. We’re going to explore\nthe CVMFS installation and then we’re going to configure Galaxy to use it.</p>\n</blockquote>\n\n<h1 id=\"ansible-cvmfs-and-galaxy\">Ansible-CVMFS and Galaxy</h1>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#ansible-cvmfs-and-galaxy\">\n  <p>There are a few different repositories that um Galaxy project has created and\nshared with everybody. The first one is the reference data and indices and\nthis is in data.galaxyproject.org. And then we have another one called\nsingularity.galaxyproject.org.</p>\n\n  <p>If you want to have a look at what’s in there you can click on the “data\ncache”, and this link here will show you all the things that are inside this\ndata.galaxyproject.org</p>\n</blockquote>\n\n<p>The Galaxy project supports a few CVMFS repositories.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Repository</th>\n      <th>Repository Address</th>\n      <th>Contents</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Reference Data and Indices</td>\n      <td><code class=\"language-plaintext highlighter-rouge\">data.galaxyproject.org</code></td>\n      <td>Genome sequences and their tool indices, Galaxy <code class=\"language-plaintext highlighter-rouge\">.loc</code> files for them as well</td>\n    </tr>\n    <tr>\n      <td>Singularity Containers</td>\n      <td><code class=\"language-plaintext highlighter-rouge\">singularity.galaxyproject.org</code></td>\n      <td>Singularity containers for everything in Biocontainers for use in Galaxy systems</td>\n    </tr>\n    <tr>\n      <td>Galaxy Main Configuration</td>\n      <td><code class=\"language-plaintext highlighter-rouge\">main.galaxyproject.org</code></td>\n      <td>The configuration files etc for Galaxy Main (usegalaxy.org)</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>You can browse the contents of <code class=\"language-plaintext highlighter-rouge\">data.galaxyproject.org</code> at the <a href=\"http://datacache.galaxyproject.org/\">datacache</a>.</p>\n\n<h2 id=\"installing-and-configuring\">Installing and Configuring</h2>\n\n<p>Luckily for us, the Galaxy Project has a lot of experience with using and configuring CVMFS and we are going to leverage off that. To get CVMFS working on our Galaxy server, we will use the Ansible role for CVMFS written by the Galaxy Project. Firstly, we need to install the role and then write a playbook for using it.</p>\n\n<p>If the terms “Ansible”, “role” and “playbook” mean nothing to you, please checkout <a href=\"/training-material/topics/admin/tutorials/ansible/slides.html\">the Ansible introduction slides</a> and <a href=\"/training-material/topics/admin/tutorials/ansible/tutorial.html\">the Ansible introduction tutorial</a></p>\n\n<!--SNIPPET-->\n<blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-running-ansible-on-your-remote-machine\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-running-ansible-on-your-remote-machine\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Running Ansible on your remote machine</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>It is possible to have ansible installed on the remote machine and run it there, not just from your local machine connecting to the remote machine.</p>   <p>Your hosts file will need to use <code class=\"language-plaintext highlighter-rouge\">localhost</code>,  and whenever you run playbooks with <code class=\"language-plaintext highlighter-rouge\">ansible-playbook -i hosts playbook.yml</code>, you will need to add <code class=\"language-plaintext highlighter-rouge\">-c local</code> to your command.</p>   <p>Be <strong>certain</strong> that the playbook that you’re writing on the remote machine is stored somewhere safe, like your user home directory, or backed up on your local machine. The cloud can be unreliable and things can disappear at any time.</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#installing-and-configuring\">\n  <p>Okay, so now we’re going to move on to installing and configuring Galaxy’s\nCVMFS reference data with Ansible. We are going to do some Ansible here and\nwe’re going to install CVMFS onto our Galaxy server. Hopefully you all have\naccess to a Galaxy server.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\"/\" data-action=\"goto\">\n  <p>Here is mine. And on it I am an admin user and I have access to the admin\npage. This was done as part of the installation of Galaxy um and hopefully\nyou’ve installed a tool.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\".search-input input\" data-action=\"fill\" data-value=\"bwa-mem\">\n  <p>I have bwa and bwa-mem installed under Mapping.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\"/?tool_id=bwa_mem\" data-action=\"goto\">\n  <p>So if I click on that you can see\nhere that I have bwa-mem but there are no options available for reference\ngenomes, so we want to fix that. We want to connect to all of Galaxy’s\npre-built references and so we’re going to use Galaxy’s CVMFS system to let\nour own Galaxies connect and get access to all the pre-built caches and\neverything we already have.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#hands-on-installing-cvmfs-with-ansible\">\n  <p>Okay, so let’s get started. If we go back to our\ntutorial here, it says that we need to install a CVMFS role into our\nrequirements.yml and then add it to our Ansible.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Installing CVMFS with Ansible</hands-on-title>\n\n  <ol>\n    <li>\n      <p>In your working directory, add the CVMFS role to your <code class=\"language-plaintext highlighter-rouge\">requirements.yml</code></p>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"whoami; hostname -f\">\n        <p>Well the first thing I need to do is log into my Galaxy machine in the\nterminal.</p>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls -al\">\n        <p>Have a look at he contents of this directory and I’ll go into galaxy and here we have all of the Ansible scripts that hopefully everybody already has.</p>\n      </blockquote>\n\n      <div data-commit=\"Add requirement\" data-ref=\"add-req\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/requirements.yml\n</span><span class=\"gi\">+++ b/requirements.yml\n</span><span class=\"p\">@@ -17,3 +17,6 @@</span>\n # TUS (uploads)\n - name: galaxyproject.tusd\n   version: 0.0.1\n<span class=\"gi\">+# CVMFS Support\n+- src: galaxyproject.cvmfs\n+  version: 0.2.21\n</span>   \n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-how-to-read-a-diff\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-how-to-read-a-diff\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: How to read a Diff</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>If you haven’t worked with diffs before, this can be something quite new or different.</p>   <p>If we have two files, let’s say a grocery list, in two files. We’ll call them ‘a’ and ‘b’.</p>   <blockquote class=\"code-2col\">   <blockquote class=\"code-in\">     <code-in-title>Old</code-in-title>     <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ cat old<br />🍎<br />🍐<br />🍊<br />🍋<br />🍒<br />🥑<br /></code></pre></div>    </div>   </blockquote>   <blockquote class=\"code-out\">     <code-out-title>New</code-out-title>     <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ cat new<br />🍎<br />🍐<br />🍊<br />🍋<br />🍍<br />🥑<br /></code></pre></div>    </div>   </blockquote> </blockquote>   <p>We can see that they have some different entries. We’ve removed 🍒 because they’re awful, and replaced them with an 🍍</p>   <p>Diff lets us compare these files</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff old new<br />5c5<br />&lt; 🍒<br /><span class=\"nt\">---</span><br /><span class=\"o\">&gt;</span> 🍍<br /></code></pre></div></div>   <p>Here we see that 🍒 is only in a, and 🍍 is only in b. But otherwise the files are identical.</p>   <p>There are a couple different formats to diffs, one is the ‘unified diff’</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff <span class=\"nt\">-U2</span> old new<br /><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:06:36.340962616 +0100<br />@@ <span class=\"nt\">-3</span>,4 +3,4 @@<br /> 🍊<br /> 🍋<br />-🍒<br />+🍍<br /> 🥑<br /></code></pre></div></div>   <p>This is basically what you see in the training materials which gives you a lot of context about the changes:</p>   <ul>   <li><code class=\"language-plaintext highlighter-rouge\">--- old</code> is the ‘old’ file in our view</li>   <li><code class=\"language-plaintext highlighter-rouge\">+++ new</code> is the ‘new’ file</li>   <li>@@ these lines tell us where the change occurs and how many lines are added or removed.</li>   <li>Lines starting with a - are removed from our ‘new’ file</li>   <li>Lines with a + have been added.</li> </ul>   <p>So when you go to apply these diffs to your files in the training:</p>   <ol>   <li>Ignore the header</li>   <li>Remove lines starting with - from your file</li>   <li>Add lines starting with + to your file</li> </ol>   <p>The other lines (🍊/🍋 and 🥑) above just provide “context”, they help you know where a change belongs in a file, but <strong>should not be edited</strong> when you’re making the above change. Given the above diff, you would find a line with a 🍒, and replace it with a 🍍</p>   <h4 id=\"added--removed-lines\">Added &amp; Removed Lines</h4>   <p>Removals are very easy to spot, we just have removed lines</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:10:14.370722802 +0100<br />@@ <span class=\"nt\">-4</span>,3 +4,2 @@<br /> 🍋<br /> 🍒<br />-🥑<br /></code></pre></div></div>   <p>And additions likewise are very easy, just add a new line, between the other lines in your file.</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:11:11.422135393 +0100<br />@@ <span class=\"nt\">-1</span>,3 +1,4 @@<br /> 🍎<br />+🍍<br /> 🍐<br /> 🍊<br /></code></pre></div></div>   <h4 id=\"completely-new-files\">Completely new files</h4>   <p>Completely new files look a bit different, there the “old” file is <code class=\"language-plaintext highlighter-rouge\">/dev/null</code>, the empty file in a Linux machine.</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff <span class=\"nt\">-U2</span> /dev/null old<br /><span class=\"nt\">---</span> /dev/null\t2022-02-15 11:47:16.100000270 +0100<br />+++ old\t2022-02-16 14:06:19.697132568 +0100<br />@@ <span class=\"nt\">-0</span>,0 +1,6 @@<br />+🍎<br />+🍐<br />+🍊<br />+🍋<br />+🍒<br />+🥑<br /></code></pre></div></div>   <p>And removed files are similar, except with the new file being /dev/null</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ /dev/null\t2022-02-15 11:47:16.100000270 +0100<br />@@ <span class=\"nt\">-1</span>,6 +0,0 @@<br />-🍎<br />-🍐<br />-🍊<br />-🍋<br />-🍒<br />-🥑<br /></code></pre></div></div> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"add-req\">\n        <p>Okay, so the first thing I’m going to do is I’m going to add the CVMFS\nrole to the requirements.yml.\nEdit requirements.yml and we need to add this to the bottom of that file. Copy. Paste. And save it.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Install the role with:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" data-ref=\"req-install\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-galaxy <span class=\"nb\">install</span> <span class=\"nt\">-p</span> roles <span class=\"nt\">-r</span> requirements.yml\n</code></pre></div>        </div>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"req-install\">\n        <p>And now install the role into our local Ansible scripts using the\nansible-galaxy command. And as you can see, it’s downloading the CVMFS\nrole.</p>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls roles/\">\n        <p>And if we look into roles now you can see that we have galaxyproject.cmfs</p>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"clear\">\n        <p>Right, clear the screen.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>The variables available in this role are:</p>\n\n      <blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#variables-table\">\n        <p>Okay, now what we need to do is we need to run this role and that will\ninstall the CVMFS client onto our Galaxy server. So the first thing we\nneed to do is edit our group files galaxyservers file. There are a bunch\nof different variables that we can set. We can set the cvmfs role to be\na client or stratum zero, stratum one server. URLs - so where we’re\ngetting all this data from, and if you remember in the slideshow, the\ndata can come from Europe or America or Australia. Which repositories\nwe want to have installed. And this is an important one - the quota\nlimit. This is basically saying that CVMFS will cache some data on your\nlocal machine and the quota limit is the maximum size of that cache.</p>\n      </blockquote>\n\n      <table id=\"variables-table\">\n        <thead>\n          <tr>\n            <th>Variable</th>\n            <th>Type</th>\n            <th>Description</th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr>\n            <td><code class=\"language-plaintext highlighter-rouge\">cvmfs_role</code></td>\n            <td>string</td>\n            <td>Type of CVMFS host: <code class=\"language-plaintext highlighter-rouge\">client</code>, <code class=\"language-plaintext highlighter-rouge\">stratum0</code>, <code class=\"language-plaintext highlighter-rouge\">stratum1</code>, or <code class=\"language-plaintext highlighter-rouge\">localproxy</code>. Controls what packages are installed and what configuration is performed.</td>\n          </tr>\n          <tr>\n            <td><code class=\"language-plaintext highlighter-rouge\">cvmfs_keys</code></td>\n            <td>list of dicts</td>\n            <td>Keys to install on hosts of all types.</td>\n          </tr>\n          <tr>\n            <td><code class=\"language-plaintext highlighter-rouge\">cvmfs_server_urls</code></td>\n            <td>list of dicts</td>\n            <td>CVMFS server URLs, the value of <code class=\"language-plaintext highlighter-rouge\">CVMFS_SERVER_URL</code> in <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/domain.d/&lt;domain&gt;.conf</code>.</td>\n          </tr>\n          <tr>\n            <td><code class=\"language-plaintext highlighter-rouge\">cvmfs_repositories</code></td>\n            <td>list of dicts</td>\n            <td>CVMFS repository configurations, <code class=\"language-plaintext highlighter-rouge\">CVMFS_REPOSITORIES</code> in <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/default.local</code> plus additional settings in <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/repositories.d/&lt;repository&gt;/{client,server}.conf</code>.</td>\n          </tr>\n          <tr>\n            <td><code class=\"language-plaintext highlighter-rouge\">cvmfs_quota_limit</code></td>\n            <td>integer in MB</td>\n            <td>Size of CVMFS client cache. Default is <code class=\"language-plaintext highlighter-rouge\">4000</code>.</td>\n          </tr>\n        </tbody>\n      </table>\n\n      <p>But, luckily for us, the Galaxy Project CVMFS role has a lot of defaults for these variables which we can use by just setting <code class=\"language-plaintext highlighter-rouge\">galaxy_cvmfs_repos_enabled</code> to <code class=\"language-plaintext highlighter-rouge\">config-repo</code>. We will also set the <code class=\"language-plaintext highlighter-rouge\">cvmfs_quota_limit</code> to something sensible (500MB) as we have relatively small disks on our instances. In a production setup, you should size this appropriately for the client.</p>\n\n      <blockquote class=\"tip\">\n        <tip-title>What is a good size for this?</tip-title>\n        <p>In production UseGalaxy.org.au uses 100GB, different sites have different needs and you can make your cache smaller depending on your usage. E.g. if your users only use one dataset from the reference data (e.g. just hg38) then perhaps you don’t need such a large cache.</p>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls group_vars/\">\n        <p>Okay but instead of just modifying galaxyservers.yml and adding in some\nof these variables - instead what we’re going to do here is - we’re\ngoing to create a new group file called all.yml.</p>\n\n        <p>Because one of the things that we may want to do in the future - is we\nmay want to create other machines. We might want to have worker nodes\nfor our Galaxy cluster; or we may want to have other machines that we\nwant to be able to create using these Ansible scripts that also have the\nCVMFS role installed. And instead of reproducing these variables in each\nof the group var files for those particular machines, we can create a\nspecial group vars file called all.yml. And whatever we put in there\nwill be automatically available to all machines that we create with\nAnsible from this directory. Hopefully that makes a bit of sense and\nwe’re going to use that a bit later on if you come along to the pulsar\ntutorial where we will also be installing CVMFS on another machine - on\na remote machine to run Pulsar.</p>\n      </blockquote>\n\n      <p>Add the following lines to your <code class=\"language-plaintext highlighter-rouge\">group_vars/all.yml</code> file, creating it if it doesn’t exist:</p>\n\n      <div data-commit=\"Configure CVMFS variables\" data-ref=\"vars-all\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/all.yml\n</span><span class=\"gi\">+++ b/group_vars/all.yml\n</span><span class=\"p\">@@ -5,3 +5,8 @@</span> pip_virtualenv_command: /usr/bin/python3 -m venv  # usegalaxy_eu.certbot, usegal\n # Common variables needed by all hosts\n galaxy_user_name: galaxy\n galaxy_db_name: galaxy\n<span class=\"gi\">+\n+# CVMFS vars\n+cvmfs_role: client\n+galaxy_cvmfs_repos_enabled: config-repo\n+cvmfs_quota_limit: 500\n</span>   \n</code></pre></div>      </div>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"vars-all\">\n        <p>So what we’re going to do, is we’re going to create a new file called\ngroupvars/all.yml and we’re going to put some of these CVMFS variables\ninside it. So i’ll just copy that. Okay, groupvars all dot yaml. And\nI’ll paste this in. So basically the CVMFS role we want this machine to\nhave is client. Which means that we just want it to be able to access\nall of our CVMFS reference data. And then we want we’re going to set\nthis one here to say that, “yes we want to set this up for Galaxy.” And\nthe config repo is the one that tells CVMFS how to set everything else\nup. And then this is the other important one - the CVMFS quota limit.\nWe’re setting to 500 megabytes and that’s just so we don’t fill the root\ndisk of these machines. So I’ll save that.</p>\n      </blockquote>\n\n      <blockquote class=\"tip\">\n        <tip-title>Why all.yml?</tip-title>\n        <p>We’ve integrated the cvmfs and pulsar tutorials better, such that CVMFS will be used for Pulsar as well, this configuration will be needed on all of our machines. This mirrors real life where you want CVMFS on every node that does computation.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Add the new role to the list of roles under the <code class=\"language-plaintext highlighter-rouge\">roles</code> key in your playbook, <code class=\"language-plaintext highlighter-rouge\">galaxy.yml</code>:</p>\n\n      <div data-commit=\"Add role to playbook\" data-ref=\"pb\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/galaxy.yml\n</span><span class=\"gi\">+++ b/galaxy.yml\n</span><span class=\"p\">@@ -37,6 +37,7 @@</span>\n       become_user: \"{{ galaxy_user_name }}\"\n     - galaxyproject.nginx\n     - galaxyproject.gxadmin\n<span class=\"gi\">+    - galaxyproject.cvmfs\n</span>   post_tasks:\n     - name: Setup gxadmin cleanup task\n       ansible.builtin.cron:\n   \n</code></pre></div>      </div>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"pb\">\n        <p>And now we need to add the role - we need to add the role to our Galaxy\nplaybook. So we edit galaxy.yml which is our playbook and we just need to\nadd the galaxyproject.cvmfs to the bottom of this. galaxyproject.cvmfs.\nAnd that’s pretty much it.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" data-ref=\"run-pb1\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"run-pb1\">\n  <p>Okay now we just run the playbook. ansible-playbook. We want to run the\nGalaxy one. So. All right, we’re about to get to the CVMFS repo here. We are\nnow it’s installing the um the apt package of CVMFS. It’s going to get\nthat out of this special um Cern apt repository. Okay, it’s installing\nit. Hopefully it won’t take too long. Okay, now setting up the\nrepositories. And it’s done.</p>\n</blockquote>\n\n<p>Congratulations, you’ve set up CVMFS.</p>\n\n<h2 id=\"exploring-the-cvmfs-installation\">Exploring the CVMFS Installation</h2>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd /\">\n  <p>Okay, that was completed. We’ve now installed CVMFS client onto our machine\nand we’ve told it to go looking for certain repositories. Now to get access\nto them. We’ll see what’s in them. uh They’ll be located at slash cvmfs. So\nunder the cvmfs directory in your root directory. So, we can go to that. cd\n/</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls -al\">\n  <p>Do an ll. You can see here there’s a directory here called cvmfs.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd /cvmfs\">\n  <p>So we’ll go in there and have a look and see what’s in there.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls -al\">\n  <p>So let’s have a look. Oh there’s nothing in there!\nWell actually, what what’s going to happen is; as soon as we go looking for\nsomething in this directory, so autofs will automatically mount the\nparticular thing we’re looking for. And so what we’re going to do here is I’m\ngoing to go: cd data.galaxyproject.org, because I know that’s one of the one\nof the repositories that should have been installed.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd data.galaxyproject.org\">\n  <p>And when I do that, autofs is automatically going to mount it for me on the\nfly. Like that.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls -al\">\n  <p>And now I’ve cd’d into it and if I do an ll, you can see here I’ve got some\nthings in here now. I’ve got byhand and managed.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd byhand; ls\">\n  <p>If I go into byhand you can see here that I have quite a lot of different\n genomes and their tool indices.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"ls -al sacCer2/\">\n  <p>So if I’m going to, say, sacCer2, I can see in here there are bowtie index,\nthe bwa index, the uh the picard index, the sam index; a whole bunch of\nother different things - including the original sequences etc. So yeah,\nquite a lot of data and we just have access to that on the fly. And then as\nsoon as we try and look at any of these files, what will happen is CVMFS\nwill automatically cache it to the local disk within within that 500\nmegabyte cache that we uh we set up earlier. This is really cool. And we can\ntell Galaxy to look at all of this data and use it as its reference data.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Exploring CVMFS</hands-on-title>\n\n  <ol>\n    <li>\n      <p>SSH into your machine</p>\n    </li>\n    <li>\n      <p>Change directory into <code class=\"language-plaintext highlighter-rouge\">/cvmfs/</code> and list the files in that folder</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What do you see?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>You should see nothing, as CVMFS uses <code class=\"language-plaintext highlighter-rouge\">autofs</code> in order to mount paths only upon request.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li>\n      <p>Change directory into <code class=\"language-plaintext highlighter-rouge\">/cvmfs/data.galaxyproject.org/</code>.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd /cvmfs/data.galaxyproject.org/\nls\nls byhand\nls managed\n</code></pre></div>        </div>\n      </blockquote>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What do you see now?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>You’ll see <code class=\"language-plaintext highlighter-rouge\">.loc</code> files, genomes and indices.\nAutoFS only mounts the files when they’re accessed, so it appears like there is no folder there.</p>\n        </blockquote>\n\n      </blockquote>\n\n      <p>And just like that we all have access to all the reference genomes and associated tool indices thanks to the Galaxy Project, IDC, and Nate’s hard work!</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"configuring-galaxy-to-use-the-cvmfs-references\">Configuring Galaxy to use the CVMFS references.</h2>\n\n<p>Now that we have mounted the CVMFS repository we need to tell Galaxy how to find it and use it.</p>\n\n<p>There are two primary directories in the reference data repository:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Directory</th>\n      <th>Contents</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td><code class=\"language-plaintext highlighter-rouge\">/managed</code></td>\n      <td>Data generated with Galaxy Data Managers, organized by data table (index format), then by genome build.</td>\n    </tr>\n    <tr>\n      <td><code class=\"language-plaintext highlighter-rouge\">/byhand</code></td>\n      <td>Data generated prior to the existence/use of Data Managers, manually curated. (For legacy reasons, this directory is shared as <code class=\"language-plaintext highlighter-rouge\">/indexes</code> on the HTTP and rsync servers.)</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>These directories have somewhat different structures:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">/managed</code> is organized by index type, then by genome build (Galaxy dbkey)</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">/byhand</code> is organzied by genome build, then by index type</li>\n</ul>\n\n<p>Both directories contain a location subdirectory, and each of these contain a <code class=\"language-plaintext highlighter-rouge\">tool_data_table_conf.xml</code> file:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">/managed/location/tool_data_table_conf.xml</code></li>\n  <li><code class=\"language-plaintext highlighter-rouge\">/byhand/location/tool_data_table_conf.xml</code></li>\n</ul>\n\n<p>Galaxy consumes these <code class=\"language-plaintext highlighter-rouge\">tool_data_table_conf.xml</code> files and the <code class=\"language-plaintext highlighter-rouge\">.loc</code> “location” files they reference. The paths contained in these files are valid if the data is mounted via CVMFS.</p>\n\n<p>Examples of data include:</p>\n\n<ul>\n  <li>twoBit (<code class=\"language-plaintext highlighter-rouge\">.2bit</code>) and FASTA (<code class=\"language-plaintext highlighter-rouge\">.fa</code>) sequence files</li>\n  <li>Bowtie 2 and BWA indexes</li>\n  <li>Multiple Alignment Format (<code class=\"language-plaintext highlighter-rouge\">.maf</code>) files</li>\n  <li>SAMTools FASTA indexes (<code class=\"language-plaintext highlighter-rouge\">.fai</code>)</li>\n</ul>\n\n<p id=\"spoken-7\">Now all we need to do is tell Galaxy how to find it! This tutorial assumes that you have run the tutorial in the requirements, <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">Galaxy Installation with Ansible</a>. The hands-on below will use the Galaxy Project Ansible role to configure everything.</p>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#spoken-7\">\n  <p>So that’s what we’re going to do now. Okay. So now we’re going to try and\nconfigure Galaxy to use this CVMFS data. And and to have it so that we can run\nthings like bwa and bwa mem and run them against the human genome or the bee\ngenome or the mouse genome and take advantage of the fact that a lot of other\npeople in the Galaxy community have done a lot of work for reference data for\nus already.</p>\n\n  <p>So the way to do this is we’re going to edit the groupvars galaxyservers\nfile and we’re going to add a variable called tool_data_table_config_path.\nAnd then we’re going to point it to the two files that are in - there’s one\nin byhand and one in managed.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd /cvmfs/data.galaxyproject.org/byhand;  ls location;\">\n  <p>If we go into byhand you can see here. And then we’re going to location. As\nyou can see in here, are all the lock files, but you’ll also see there’s an\nxml file here called tool_data_table_conf xml and we’re going to point Galaxy\nat this file and there’s another one in the same position in managed.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd ../; ls managed/location\">\n  <p>And you can see here there’s another one in managed there. And so we’re going to\nadd both of these files to our Galaxy configuration and then Galaxy will be\nable to use all of the data contained within this repository.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"terminal\" data-cmd=\"cd ~/galaxy/\">\n  <p>Okay, so we’ll go back to our Ansible directory.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Configuring Galaxy to use CVMFS</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Edit the <code class=\"language-plaintext highlighter-rouge\">group_vars/galaxyservers.yml</code> file and add a <code class=\"language-plaintext highlighter-rouge\">tool_data_table_config_path</code> entry under the <code class=\"language-plaintext highlighter-rouge\">galaxy</code> key of the <code class=\"language-plaintext highlighter-rouge\">galaxy_config</code> section in the <code class=\"language-plaintext highlighter-rouge\">group_vars/galaxyservers.yml</code> file. This new entry should be a list containing the paths to both <code class=\"language-plaintext highlighter-rouge\">tool_data_table_conf.xml</code> files referenced above.</p>\n\n      <div data-commit=\"Add tool_data_table_config_path to group variables\" data-ref=\"gvconf\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/galaxyservers.yml\n</span><span class=\"gi\">+++ b/group_vars/galaxyservers.yml\n</span><span class=\"p\">@@ -73,6 +73,8 @@</span> galaxy_config:\n     # TUS\n     galaxy_infrastructure_url: \"https://{{ inventory_hostname }}\"\n     tus_upload_store: \"{{ galaxy_tus_upload_store }}\"\n<span class=\"gi\">+    # CVMFS\n+    tool_data_table_config_path: /cvmfs/data.galaxyproject.org/byhand/location/tool_data_table_conf.xml,/cvmfs/data.galaxyproject.org/managed/location/tool_data_table_conf.xml\n</span>   gravity:\n     process_manager: systemd\n     galaxy_root: \"{{ galaxy_root }}/server\"\n   \n</code></pre></div>      </div>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"gvconf\">\n        <p>This time I’m going to edit the groupvars galaxyservers.yml file. And in\nour Galaxy section. Which is here. Which is here. At the bottom of that\nI’m going to add a variable called tool_data_table_config_path. And I’m\ngoing to point it to the locations that we um I showed you before. um I\ncan’t remember what they are off the top of my head but luckily they’re\ninside this solution box and so I will just copy them. And paste. And as\nyou can see pointing to /cvmfs/data.galaxyproject.org/byhand/location\nand then that tool data table conf xml file. And then we have a list\nhere and we separate it by commas and then we point it to the second\none. Right, so we save this file.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Re-run the playbook</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" data-ref=\"pb-run2\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n\n      <blockquote class=\"spoken\" data-visual=\"terminal\" data-ref=\"pb-run2\">\n        <p>So this time what we’re going to do, all we’re doing is making a minor change\nto the Galaxy yaml file in the Galaxy config to add that one line and then\nwe’re going to restart Galaxy. And yeah, Galaxy will suddenly automatically\nhave access to all of that data. So you can see here we’ve changed the Galaxy\nconfiguration file. And then Galaxy is now restarting and it’s done.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Install the BWA-MEM tool, if needed.</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-install-tools-via-the-admin-ui\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-install-tools-via-the-admin-ui\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Install tools via the Admin UI</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Open Galaxy in your browser and type <code class=\"language-plaintext highlighter-rouge\">bwa</code> in the tool search box on the left. If “Map with BWA-MEM” is among the search results, you can skip the following steps.</li>   <li>Access the Admin menu from the top bar (you need to be logged-in with an email specified in the <code class=\"language-plaintext highlighter-rouge\">admin_users</code> setting)</li>   <li>Click “Install and Uninstall”, which can be found on the left, under “Tool Management”</li>   <li>Enter <code class=\"language-plaintext highlighter-rouge\">bwa</code> in the search interface</li>   <li>Click on the first hit, having <code class=\"language-plaintext highlighter-rouge\">devteam</code> as owner</li>   <li>Click the “Install” button for the latest revision</li>   <li>Enter “Mapping” as the target section and click “OK”.</li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>In your Galaxy server, open the <strong>Map with BWA-MEM</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool. Now check that there are a lot more reference genomes available for use!</p>\n\n      <p><a href=\"../../images/available_genomes.png\" rel=\"noopener noreferrer\"><img src=\"../../images/available_genomes.png\" alt=\"available_genomes.png. \" width=\"821\" height=\"362\" loading=\"lazy\" /></a></p>\n    </li>\n    <li>\n      <p>Login to Galaxy as the admin user, and go to <strong>Admin → Data Tables → bwa_mem indexes</strong></p>\n\n      <p><a href=\"../../images/bwa_mem_indices.png\" rel=\"noopener noreferrer\"><img src=\"../../images/bwa_mem_indices.png\" alt=\"bwa_mem_indices.png. \" width=\"1546\" height=\"845\" loading=\"lazy\" /></a></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\"#analysis a\" data-action=\"click\">\n  <p>Okay let’s go and have a look at our Galaxy server and see if bwa can\nsuddenly see all of those - that stuff. All right so we’re back on our Galaxy\nserver. I’ll click on Analyze Data to just to reload the page.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\".search-input input\" data-action=\"click\">\n  <p>I’ll go back to Mapping</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\".search-input input\" data-action=\"fill\" data-value=\"bwa-mem\">\n  <p>and load bwa-mem.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\"/?tool_id=bwa_mem\" data-action=\"goto\">\n  <p>And then suddenly, instead of\nhaving no options available, you can see here we’ve got the Bee genome.</p>\n</blockquote>\n\n<blockquote class=\"spoken\" data-visual=\"galaxy\" data-target=\"s2id_field-uid-12_select a\" data-action=\"click\">\n  <p>Now click on that. Oh look at that, there are lots and lots and lots of\n available genomes now including: lots of human, mouse, rat, yeast, all sorts\n of things. And in fact if you want to see the list of all the different\n available genomes now, that we have available to us.</p>\n\n  <p>If you go to admin. We go to data tables over here. You can see here that we\n have um a couple of data tables for managed and for all fasta. So if we\n click on that one, you can see that we have a lot of genomes available now\n in the all fasta data table that Galaxy can get access to. If we go back to\n the data tables again, and go down to bwa indexes or bwa mem indexes here.\n You can see we have access to a lot of pre-built indexes for bwa for all of\n these different genomes. That is pretty powerful.</p>\n\n  <p>So what did that take us? Maybe 30 minutes? And uh suddenly our Galaxy\n server has access to all the uh the data the reference data and the tool\n indices that the community have built over a number of years and it’s super\n simple.</p>\n</blockquote>\n\n<blockquote class=\"hidden\">\n  <div data-test=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1.sh\n</code></pre></div>  </div>\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"hands_on\">   <div class=\"box-title hands_on-title\" id=\"hands-on-time-to-git-commit\"><i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i> Hands-on: Time to git commit</div>   <p>It’s time to commit your work! Check the status with</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git status<br /></code></pre></div></div>   <p>Add your changed files with</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git add ... # any files you see that are changed<br /></code></pre></div></div>   <p>And then commit it!</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git commit -m 'Finished Reference Data with CVMFS'<br /></code></pre></div></div> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-got-lost-along-the-way\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Got lost along the way?</div>   <p>If you missed any steps, you can compare against the <a href=\"https://github.com/hexylena/git-gat/tree/step-5\">reference files</a>, or see what changed since <a href=\"https://github.com/hexylena/git-gat/compare/step-4...step-5#files_bucket\">the previous tutorial</a>.</p>   <p>If you’re using <code class=\"language-plaintext highlighter-rouge\">git</code> to track your progress, remember to add your changes and commit with a good commit message!</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"common-production-questions\">Common Production Questions</h1>\n\n<blockquote class=\"question\">\n  <question-title>For the most used datasets (for ex. hg38) could we have a local copy, or would that be irrelevant?</question-title>\n  <p>This would be irrelevant, the most used datasets will stay in the cache. CVMFS uses a Least Recently Used (LRU) cache (see their <a href=\"https://cvmfs.readthedocs.io/en/latest/cpt-details.html#disk-cache\">docs</a>), so whenever it runs out of space, it will remove the least recently used file. If you have a file that is very commonly used, it will remain in the cache.</p>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title>Could you explain how to calculate a good cache space?</question-title>\n  <p>Here are two approaches, there are others:</p>\n  <ol>\n    <li>Allocate some cache, see how it is, make it larger if it is fully used + users complain of speed.</li>\n    <li>Enable reference data, and collect a week or two of data, analyse which reference datasets are being used, and allocate enough space for all of them.</li>\n  </ol>\n\n  <p>Essentially you just need data on how your users will behave and what reference data they want, combined with “when will they accept a wait period” to determine how much space you must allocate.</p>\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title>If I use a cluster, will I need to configure this FS in each node (given that the folder is at / directly)?</question-title>\n  <p>Yes. Often admins with a cluster keep a smaller cache local to each compute node, and then setup a Squid proxy to hold the most commonly accessed data on a machine with more storage. E.g. each compute node could have 10-50GB of CVMFS storage while you might setup a Squid proxy with 200-300 GB of storage that will store everything your site uses.</p>\n</blockquote>\n\n<blockquote class=\"tip\">\n  <tip-title>Debugging failed mounting</tip-title>\n\n  <p>Are you having issues mounting your CVMFS mount? Is it giving strange errors like “Endpoint not connected”\nTry running this command as root:</p>\n\n  <blockquote class=\"code-2col\">\n    <blockquote class=\"code-in\">\n      <code-in-title>Bash</code-in-title>\n      <div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">/usr/bin/cvmfs2 -d -o rw,system_mount,fsname=cvmfs2,allow_other,grab_mountpoint singularity.galaxyproject.org /mnt\n</span></code></pre></div>      </div>\n    </blockquote>\n\n    <blockquote class=\"code-out\">\n      <code-out-title>Consolue</code-out-title>\n      <div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"go\">Debug: using library /usr/lib/libcvmfs_fuse3_stub.so\nCernVM-FS: running in debug mode\nCernVM-FS: loading Fuse module... (cvmfs) Parsing config file /etc/cvmfs/default.conf    [07-21-2022 11:11:20 UTC]\n(cvmfs) execve'd /bin/sh (PID: 280373)    [07-21-2022 11:11:20 UTC]\n(cvmfs) Parsing config file /etc/cvmfs/default.d/50-cern-debian.conf    [07-21-2022 11:11:20 UTC]\n(cvmfs) execve'd /bin/sh (PID: 280375)    [07-21-2022 11:11:20 UTC]\n(cvmfs) Parsing config file /etc/cvmfs/default.d/80-ansible-galaxyproject-cvmfs.conf    [07-21-2022 11:11:20 UTC]\n(cvmfs) execve'd /bin/sh (PID: 280378)    [07-21-2022 11:11:20 UTC]\n[...]\n(dns) empty hostname    [07-21-2022 11:11:20 UTC]\n(download) installed 1 proxies in 1 load-balance groups    [07-21-2022 11:11:20 UTC]\n(cvmfs) DNS roaming is disabled for this repository.    [07-21-2022 11:11:20 UTC]\n(catalog) constructing client catalog manager    [07-21-2022 11:11:20 UTC]\n(catalog) Initialize catalog    [07-21-2022 11:11:20 UTC]\n(cache) unable to read local checksum    [07-21-2022 11:11:20 UTC]\n(download) escaped http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/.cvmfspublished to http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/.cvmfspublished    [07-21-2022 11:11:20 UTC]\n(download) Verify downloaded url /.cvmfspublished, proxy DIRECT (curl error 0)    [07-21-2022 11:11:20 UTC]\n(cache) miss ./e2/ab48b0984729d99951cb62c4312f501b3ddc6b (-2)    [07-21-2022 11:11:20 UTC]\n(download) escaped http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/data/e2/ab48b0984729d99951cb62c4312f501b3ddc6bX to http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/data/e2/ab48b0984729d99951cb62c4312f501b3ddc6bX    [07-21-2022 11:11:20 UTC]\n(download) Verify downloaded url /data/e2/ab48b0984729d99951cb62c4312f501b3ddc6bX, proxy DIRECT (curl error 0)    [07-21-2022 11:11:20 UTC]\n(download) escaped http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/.cvmfswhitelist to http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/.cvmfswhitelist    [07-21-2022 11:11:20 UTC]\n[...]\n(download) escaped http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/data/c7/f1555f421b1868b979291dc23f34a83132eadbC to http://cvmfs1-psu0.galaxyproject.org/cvmfs/singularity.galaxyproject.org/data/c7/f1555f421b1868b979291dc23f34a83132eadbC    [07-21-2022 11:11:20 UTC]\n(download) Verify downloaded url /data/c7/f1555f421b1868b979291dc23f34a83132eadbC, proxy DIRECT (curl error 0)    [07-21-2022 11:11:25 UTC]\n(cache) finished downloading of /data/c7/f1555f421b1868b979291dc23f34a83132eadbC    [07-21-2022 11:11:25 UTC]\n(cache) commit ./c7/f1555f421b1868b979291dc23f34a83132eadb ./txn/fetchJWcwtt    [07-21-2022 11:11:25 UTC]\n(quota) pin into lru c7f1555f421b1868b979291dc23f34a83132eadb, path file catalog at singularity.galaxyproject.org:/ (c7f1555f421b1868b979291dc23f34a83132eadb)    [07-21-2022 11:11:25 UTC]\n(cache) commit failed: cannot pin c7f1555f421b1868b979291dc23f34a83132eadb    [07-21-2022 11:11:25 UTC]\n(catalog) failed to load catalog '' (2 - not enough space to load catalog)    [07-21-2022 11:11:25 UTC]\n(catalog) failed to initialize root catalog    [07-21-2022 11:11:25 UTC]\nFailed to initialize root file catalog (16 - file catalog failure)\n(cache) unpinning / unloading all catalogs    [07-21-2022 11:11:25 UTC]\n</span></code></pre></div>      </div>\n    </blockquote>\n  </blockquote>\n</blockquote>\n\n<h1 id=\"other-aspects\">Other Aspects</h1>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#other-aspects\">\n  <p>Right, we’ll go back to our tutorial. um Yeah. Just finally, just before we\nfinish up. um If we are developing a new tool and you want to add a reference\ngenome or a different index just give us - drop us a line on Gitter and we’ll\nbe able to add it into our - into the reference data for the community. um\nWe’re looking at automating the process of building all of this material\nusing data managers and ephemeris. And we’re working with a group of people\ncalled the IDC, which is the Intergalactic Data Commission, which is a funny\nname for everyone in Galaxy - in the Galaxy community who likes reference\ndata. And we’re looking at making a community controlled resource that will\nbe semi-automatic. One of the other things that you can do is have automatic\nfallbacks. So, if say, you’re in Australia and you’re hooked up to the\nAustralian mirror of the CVMFS repository and the Australian mirror dies, the\nCVMFS client is smart enough to automatically go to the next closest one and\nso you won’t lose anything. If you’re interested in looking at plant data\nthere’s a link here for that.</p>\n</blockquote>\n\n<h2 id=\"development\">Development</h2>\n\n<p>If you are developing a new tool, and want to add a reference genome, we recommend you <a href=\"https://gitter.im/galaxy-iuc/iuc\">talk to us on Gitter</a>. You can also look at one of the tools that uses reference data, and try and copy from that. If you’re developing the location files completely new, you need to write the data manager.</p>\n\n<h2 id=\"automation\">Automation</h2>\n\n<p>You can automate the process of installing and setting up data managers and data with ephemeris. We’re working in the <a href=\"https://github.com/galaxyproject/idc\">IDC</a> to democratise this CVMFS repository, and make this a community-controlled resource. You can also look here for ideas on automating your data management.</p>\n\n<h2 id=\"access-control\">Access Control</h2>\n\n<p>It is not easily possible to filter access to reference data depending on the user’s role or group.</p>\n\n<p>You could set up a tool per user/group, <a href=\"https://galaxyproject.org/admin/config/access-control/\">secure access to running this tool</a>, and then allow this private tool to access a private tool data table. But you will not get tool updates, you will have to copy and edit this tool every time it gets updated. Or write more advanced job control rules to reject specific jobs which use specific datasets.</p>\n\n<h2 id=\"proxying-recap\">Proxying Recap</h2>\n\n<p>The client talks directly to the stratum 1 (or to a proxy), and manages the data, and exposes it to the user. The proxy stores an opaque cache, that can’t really be used, except as a proxy to a stratum 1.</p>\n\n<h2 id=\"plant-data\">Plant Data</h2>\n\n<p>If you are working with plants, you can find separate reference data here: <a href=\"https://github.com/frederikcoppens/galaxy_data_management\">frederikcoppens/galaxy_data_management</a></p>\n\n<blockquote class=\"spoken\" data-visual=\"gtn\" data-target=\"#feedback\">\n  <p>And finally if you could please click on this link here and give us some\nfeedback on how you think the tutorial went, whether it was useful, if you\nenjoyed it or um if you have any criticisms, could you please put them in\nhere as well. And if you end up using this to build a Galaxy server and you\npublish that Galaxy server um could you cite the tutorial for us please. That\nwould be make a big difference to us. All right, thank you very much and I\nhope you enjoyed it and hopefully I’ll get to meet some of you in person one\nday soon at a Galaxy conference. Thank you and goodbye.</p>\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path-1\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n"],"ref_slides":["# Built in Data\n\n![List_of_data.png](../../images/i06-List_of_data.png)\n\n???\n\n- Many tools need reference data\n- E.g. this BWA-MEM tool requires a reference genome\n- But where do you get this data?\n- And how do tools know where to find it?\n\n---\n\n# Data, what data?\n\n.large[\n* Some genomes are large! Human, Mouse, Coral\n* Some tools require indices of the genomes.\n* The indices take a long time to build!\n* Better to pre-build the indices.\n]\n\n???\n\n- Much of this reference data requires calculation to generate it\n- For example, building dataset indexes\n- It is better to build them beforehand, so Galaxy has a concept of reference data\n\n---\n\n# Data schematics in Galaxy\n\n![schematic](../../images/data_managers_schematic_overview.png)\n\n???\n\n- Here is a more conrete example\n- A reference dataset is required as input\n- A tool (e.g. bwa) is used to build the index\n- The outputs are registered with Galaxy's data registry in a loc file\n- The tool data table xml file has a listing of all of the loc files\n- When a user runs the BWA tool, Galaxy knows where to find this reference data\n\n---\n\n# Index Generation with Data Manager\n\n- Allows for the **creation of built-in** (reference) data\n\t- underlying data\n\t- data tables\n\t- \\*.loc files\n- Specialized Galaxy tools that can only be accessed by an admin\n- Defined **locally** or installed from **ToolShed**\n\n???\n\n- Data managers are special tools in Galaxy\n- They create the reference data\n- And update the loc files\n\n---\n\n# \"loc\" files - Short for location!\n\n```text\n#\n#<unique_build_id>   <dbkey>   <display_name>   <file_path>\n#\nbosTau7 bosTau7 Cow (bosTau7)   /genomes/bosTau7/bwa_mem_index/bosTau7/bosTau7.fa\nce10    ce10    C. elegans (ce10)       /genomes/ce10/bwa_mem_index/ce10/ce10.fa\ndanRer7 danRer7 Zebrafish (danRer7)     /genomes/danRer7/bwa_mem_index/danRer7/danRer7.fa\ndm3     dm3     D. melanogaster Apr. 2006 (BDGP R5/dm3) (dm3)   /genomes/dm3/bwa_mem_index/dm3/dm3.fa\nhg19    hg19    Human (hg19)    /genomes/hg19/bwa_mem_index/hg19/hg19.fa\nhg38    hg38    Human (hg38)    /genomes/hg38/bwa_mem_index/hg38/hg38.fa\nmm10    mm10    Mouse (mm10)    /genomes/mm10/bwa_mem_index/mm10/mm10.fa\n```\n\n???\n\n- Here is an example loc file\n- They list all of the indexes of a specific type\n- Some of these indexes will be tool specific like this one, and some will be more general like a list of genomes\n- This file is updated by the data manager.\n\n---\n\n# Where are the data tables?\n\n(Usually located in `galaxy/config/tool_data_table_conf.xml`)\n\n```xml\n  <tables>\n    <!-- Locations of indexes in the BWA mapper format -->\n    <table name=\"bwa_mem_indexes\" comment_char=\"#\" allow_duplicate_entries=\"False\">\n      <columns>value, dbkey, name, path</columns>\n      <file path=\"tool-data/bwa_index.loc\" />\n    </table>\n  </tables>\n```\n\n???\n\n- The tool data table conf file lists table names, and their associated loc file\n- Additionally it defines the meaning of each column in the loc file\n\n---\n\n# Using reference data in a tool\n\n#### bwa.xml\n\n```xml\n<param name=\"ref_file\" type=\"select\" label=\"Using reference genome\" help=\"Select genome from the list\">\n  <options from_data_table=\"bwa_mem_indexes\">\n    <filter type=\"sort_by\" column=\"2\" />\n    <validator type=\"no_options\" message=\"No indexes are available\" />\n  </options>\n  <validator type=\"no_options\" message=\"A built-in reference genome is not available for the build associated with the selected input file\"/>\n</param>\n\n```\n\n???\n\n- When a tool wants to use the data from those tables, it needs to declare which tables it wants to access (see previous slide)\n- A select type parameter is created for the user's selections\n- The tool knows that the options should come from a BWA-MEM indexes loc file\n- These reference datasets are sorted by column 2, the name\n- An some validators ensure a helpful message is shown if no data is available\n\n---\n\n# Some Problems!\n\n- Super complex, right?\n- Time consuming!\n  - ~30 minutes work just to add a new genome to 1 tool!\n- Administrator needs to know:\n  - how to index **every** tool\n  - expected format of the reference data\n  - format of the .loc file\n- Some parts solved by Data Managers\n- **But there's an easier way!**\n\n???\n\n- This was a lot of information\n- And very genomics specific in some places\n- A lot of work to create and update the reference data\n- But there is a better way!\n\n---\n\n# There's a lot of reference data\n\n.large[\n(and it's hard to keep up with)\n]\n![ref_data_prob_flow.png](../../images/ref_data_prob_flow.png)\n\n???\n\n- Imagine going through this process every time a user request comes in\n- It would be unpleasant\n\n---\n\n# CernVM-FS to the rescue\n\n- Needed a method of sharing reference data across country efficiently\n- **CVMFS** is an efficient method for read only data sharing between systems\n    - Originally designed for distributed software installation at Cern\n    - Turns out it's really useful for read only data sets as well\n    - HTTP-based, firewall friendly\n- All nodes of Galaxy Main get their reference genomes and indices from CVMFS\n    - Shared via mirroring and caching across the country\n- It's also really useful to share data **globally**\n    - The **usegalaxy.\\*** initiative has taken full advantage of this.\n\n???\n\n- CVMFS and the IDC solves these issues\n- CVMFS provides a global repository of reference data\n- Originally built by CERN for sharing software, we use it for data\n- It's an HTTP based protocol and very firewall friendly\n- All of the usegalaxy.* servers host a CVMFS repository\n\n---\n\n# IDC\n\n- Group of admins working on the CVMFS data repository\n- Wish to automate the management of data and generation of new indicies\n- Come join us: [github.com/galaxyproject/idc](https://github.com/galaxyproject/idc)\n\n???\n\n- The IDC is the other half of the puzzle\n- CVMFS provides the storage, and the IDC provides the data\n- Join us on github if you are interested\n\n---\n\n# CVMFS Global Structure\n\n.widen_image[\n![cvmfs_global_structure.png](../../images/cvmfs_global_structure.png)\n]\n\n???\n\n- CVMFS has a hierarchical structure\n- At the top is the stratum 0 server, the original copy of the datasets\n- This is replicated to the read-only stratum 1 servers\n- Anyone can connect to these stratum 1 servers\n- And whenever connections fail, CVMFS will fail over to another mirror\n- The mirror selection process is based on connection round trip times\n- As a result, the nearest mirror is usually selected.\n\n---\n\n.widen_image[\n![cvmfs_server_distribution.png](../../images/cvmfs_server_distribution.png)\n]\n\n???\n\n- There are CVMFS servers across the entire world\n- The primary mirrors are run by Galaxy project, Galaxy Europe, and Galaxy Australia\n- If one of these mirrors fails, you will still be able to use the reference data\n"],"video_library":{"tutorial":{"description":null,"materials":[{"link":"topics/admin/tutorials/cvmfs/tutorial.html","type":"Tutorial"}],"tags":["admin"],"type":"Tutorial","versions":[{"captions":["slugger70"],"date":"2021-02-15","galaxy_version":"21.01","length":"23M","link":"X3iFMZP_fQ8","speakers":["slugger70"]}],"gtn_id":"admin/cvmfs","title":"Reference Data with CVMFS","captioned":true},"slides":{"description":null,"materials":[{"link":"topics/admin/tutorials/cvmfs/slides.html","type":"Slides"}],"tags":["admin"],"type":"Tutorial","versions":[{"captions":["galaxycommunity"],"date":"2021-02-15","galaxy_version":"21.01","length":"3M","link":"g_cavAO-fBM","speakers":["awspolly"]}],"gtn_id":"admin/cvmfs","title":"Reference Data with CVMFS","captioned":true},"demo":null,"both":null,"session":{"title":"CVMFS","description":"Reference data management is easier than ever with CVMFS","videos":["admin/cvmfs/slides","admin/cvmfs/tutorial"]}},"hands_on":true,"slides":true,"mod_date":"2024-01-31 16:33:56 +0000","pub_date":"2019-01-27 16:50:26 +0000","version":96,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/cvmfs/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":true,"translations":{"tutorial":[],"slides":[],"video":true},"license":"CC-BY-4.0","type":"tutorial","logo":"assets/images/gat.png","redirect_from":["/short/admin/cvmfs/slides","/short/S00006"]}