{"layout":"tutorial_hands_on","title":"Reference Data with CVMFS without Ansible","zenodo_link":"","questions":null,"objectives":["Have an understanding of what CVMFS is and how it works","Install and configure the CVMFS client on a linux machine and mount the Galaxy reference data repository","Configure your Galaxy to use these reference genomes and indices"],"time_estimation":"1h","key_points":null,"contributors":[{"name":"Simon Gladman","email":"simon.gladman@unimelb.edu.au","joined":"2017-09","elixir_node":"au","orcid":"0000-0002-6100-4385","in_memoriam":"<a href=\"https://www.biocommons.org.au/news/simon-gladman\">Simon Gladman, system administrator of UseGalaxy.org.au, passed away on November 26, 2022</a>\n\n<a href=\"https://galaxyproject.org/news/2022-11-28-simon-gladman/\">He was a fantastic teacher, tutorial author, system administrator, and warm and welcoming friend.</a> He contributed heavily to the Galaxy Training Network and especially the Galaxy Administration community over the years, we will miss him dearly. The GTN and GAT would not be what they are today, without him.\n\n“Have I told you about my watch?”","id":"slugger70","url":"https://training.galaxyproject.org/training-material/api/contributors/slugger70.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/slugger70/"},{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"}],"subtopic":"data","js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00004","url":"/topics/admin/tutorials/cvmfs-manual/tutorial.html","topic_name":"admin","tutorial_name":"cvmfs-manual","dir":"topics/admin/tutorials/cvmfs-manual","symlink":null,"id":"admin/cvmfs-manual","ref_tutorials":["<h1 id=\"overview\">Overview</h1>\n\n<p>The CernVM-FS is a distributed filesystem perfectly designed for sharing readonly data across the globe. We use it in the <a href=\"https://galaxyproject.org\">Galaxy Project</a> for sharing things that a lot of Galaxy servers need. Namely:</p>\n<ul>\n  <li><strong>Reference Data</strong>\n    <ul>\n      <li>Genome sequences for hundreds of useful species.</li>\n      <li>Indices for the genome sequences</li>\n      <li>Various bioinformatic tool indices for the available genomes</li>\n    </ul>\n  </li>\n  <li><strong>Tool containers</strong>\n    <ul>\n      <li><a href=\"https://www.sylabs.io/\">Singularity</a> containers of everything stored in <a href=\"https://biocontainers.pro/\">Biocontainers</a> (A bioinformatic tool container repository.) You get these for free every time you build a <a href=\"https://bioconda.github.io/\">Bioconda</a> recipe/package for a tool.</li>\n    </ul>\n  </li>\n  <li>Others too..</li>\n</ul>\n\n<p>From the Cern website:</p>\n\n<blockquote class=\"quote\" cite=\"https://cernvm.cern.ch/portal/filesystem\">\n  <p>The CernVM File System provides a scalable, reliable and low-maintenance software distribution service. It was developed to assist High Energy Physics (HEP) collaborations to deploy software on the worldwide-distributed computing infrastructure used to run data processing applications. CernVM-FS is implemented as a POSIX read-only file system in user space (a FUSE module). Files and directories are hosted on standard web servers and mounted in the universal namespace /cvmfs.”</p>\n\n</blockquote>\n\n<p><a href=\"/training-material/topics/admin/tutorials/cvmfs/slides.html\">A slideshow presentation on this subject</a> is available. More <a href=\"https://galaxyproject.org/admin/reference-data-repo/#usegalaxyorg-reference-data\">details are available on usegalaxy.org (Galaxy Main’s) reference data setup</a> and CVMFS system.</p>\n\n<p>This exercise describes a manual process to install and configure CVMFS and Galaxy’s access to CVMFS. For a tutorial that uses Ansible to perform these tasks, see <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">the Reference Data with CVMFS tutorial</a>.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#overview\" id=\"markdown-toc-overview\">Overview</a></li>\n  <li><a href=\"#cvmfs-and-galaxy-without-ansible\" id=\"markdown-toc-cvmfs-and-galaxy-without-ansible\">CVMFS and Galaxy without Ansible</a>    <ol>\n      <li><a href=\"#configuring-cvmfs\" id=\"markdown-toc-configuring-cvmfs\">Configuring CVMFS</a></li>\n      <li><a href=\"#testing-it-out\" id=\"markdown-toc-testing-it-out\">Testing it out</a></li>\n      <li><a href=\"#look-at-the-repository\" id=\"markdown-toc-look-at-the-repository\">Look at the repository</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"cvmfs-and-galaxy-without-ansible\">CVMFS and Galaxy without Ansible</h1>\n\n<blockquote class=\"comment\">\n  <comment-title>Manual version of Ansible Commands</comment-title>\n  <p>If you wish to perform the same thing that we’ve just done, but by building the ansible script manually, follow these instructions. Otherwise, you have already done everything below and do not need to re-do it.</p>\n</blockquote>\n\n<p>We are going to setup a CVMFS mount to the Galaxy reference data repository on our machines. To do this we have to install and configure the CVMFS client and then mount the appropriate CVMFS repository using the publicly available keys.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Installing the CVMFS Client</hands-on-title>\n\n  <ol>\n    <li>\n      <p>On your remote machine, we need to first install the Cern software apt repo and then the CVMFS client and config utility:</p>\n\n      <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>apt <span class=\"nb\">install </span>lsb-release\nwget https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest_all.deb\n<span class=\"nb\">sudo </span>dpkg <span class=\"nt\">-i</span> cvmfs-release-latest_all.deb\n<span class=\"nb\">rm</span> <span class=\"nt\">-f</span> cvmfs-release-latest_all.deb\n<span class=\"nb\">sudo </span>apt-get update\n\n<span class=\"nb\">sudo </span>apt <span class=\"nb\">install </span>cvmfs cvmfs-config\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Now we need to run the CVMFS setup script.</p>\n\n      <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>cvmfs_config setup\n</code></pre></div>      </div>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"configuring-cvmfs\">Configuring CVMFS</h2>\n\n<p>The configuration is not complex for CVMFS:</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Configuring CVMFS</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/default.local</code> file with the following contents:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CVMFS_REPOSITORIES=\"data.galaxyproject.org\"\nCVMFS_HTTP_PROXY=\"DIRECT\"\nCVMFS_QUOTA_LIMIT=\"500\"\nCVMFS_CACHE_BASE=\"/srv/cvmfs/cache\"\nCVMFS_USE_GEOAPI=yes\n</code></pre></div>      </div>\n\n      <p>This tells CVMFS to mount the Galaxy reference data repository and use a specific location for the cache which is limited to 500MB in size and to use the instance’s geo-location to choose the best CVMFS repo server to connect to. You can use the <code class=\"language-plaintext highlighter-rouge\">cvmfs_quota_limit</code> role variable to control this setting.</p>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>What is a good size for CVMFS_QUOTA_LIMIT?</tip-title>\n    <p>In production UseGalaxy.org.au uses 100GB, different sites have different needs and you can make your cache smaller depending on your usage. E.g. if your users only use one dataset from the reference data (e.g. just hg38) then perhaps you don’t need such a large cache.</p>\n  </blockquote>\n\n  <ol>\n    <li>\n      <p>Create a <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/domain.d/galaxyproject.org.conf</code> file with the following contents:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CVMFS_SERVER_URL=\"http://cvmfs1-tacc0.galaxyproject.org/cvmfs/@fqrn@;http://cvmfs1-iu0.galaxyproject.org/cvmfs/@fqrn@;http://cvmfs1-psu0.galaxyproject.org/cvmfs/@fqrn@;http://galaxy.jrc.ec.europa.eu:8008/cvmfs/@fqrn@;http://cvmfs1-mel0.gvl.org.au/cvmfs/@fqrn@;http://cvmfs1-ufr0.galaxyproject.eu/cvmfs/@fqrn@\"\n</code></pre></div>      </div>\n\n      <p>This is a list of the available stratum 1 servers that have this repo.</p>\n    </li>\n    <li>\n      <p>Create a <code class=\"language-plaintext highlighter-rouge\">/etc/cvmfs/keys/data.galaxyproject.org.pub</code> file with the following contents:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5LHQuKWzcX5iBbCGsXGt\n6CRi9+a9cKZG4UlX/lJukEJ+3dSxVDWJs88PSdLk+E25494oU56hB8YeVq+W8AQE\n3LWx2K2ruRjEAI2o8sRgs/IbafjZ7cBuERzqj3Tn5qUIBFoKUMWMSIiWTQe2Sfnj\nGzfDoswr5TTk7aH/FIXUjLnLGGCOzPtUC244IhHARzu86bWYxQJUw0/kZl5wVGcH\nmaSgr39h1xPst0Vx1keJ95AH0wqxPbCcyBGtF1L6HQlLidmoIDqcCQpLsGJJEoOs\nNVNhhcb66OJHah5ppI1N3cZehdaKyr1XcF9eedwLFTvuiwTn6qMmttT/tHX7rcxT\nowIDAQAB\n-----END PUBLIC KEY-----\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Make a directory for the cache files</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sudo mkdir /srv/cvmfs\n</code></pre></div>      </div>\n    </li>\n  </ol>\n</blockquote>\n\n<h2 id=\"testing-it-out\">Testing it out</h2>\n\n<p>Probe the connection.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Testing it out</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Run <code class=\"language-plaintext highlighter-rouge\">sudo cvmfs_config probe data.galaxyproject.org</code></p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What does it output?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>OK\n</code></pre></div>          </div>\n\n          <p>If this doesn’t return <code class=\"language-plaintext highlighter-rouge\">OK</code> then you may need to restart autofs: <code class=\"language-plaintext highlighter-rouge\">sudo systemctl restart autofs</code></p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li>\n      <p>Change directory into <code class=\"language-plaintext highlighter-rouge\">/cvmfs/</code> and list the files in that folder</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What do you see?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>You should see nothing, as CVMFS uses <code class=\"language-plaintext highlighter-rouge\">autofs</code> in order to mount paths only upon request.</p>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n    <li>\n      <p>Change directory into <code class=\"language-plaintext highlighter-rouge\">/cvmfs/data.galaxyproject.org/</code>.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd /cvmfs/data.galaxyproject.org/\nls\nls byhand\nls managed\n</code></pre></div>        </div>\n      </blockquote>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What do you see now?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>You’ll see <code class=\"language-plaintext highlighter-rouge\">.loc</code> files, genomes and indices.\nAutoFS only mounts the files when they’re accessed, so it appears like there is no folder there.</p>\n        </blockquote>\n\n      </blockquote>\n\n      <p>And just like that we all have access to all the reference genomes and associated tool indices thanks to the Galaxy Project, IDC, and Nate’s hard work!</p>\n\n      <blockquote class=\"tip\">\n        <tip-title>Contributing Reference Genomes</tip-title>\n        <p>If you are developing a new tool, and want to add a reference genome, we recommend you <a href=\"https://gitter.im/galaxy-iuc/iuc\">talk to us on Gitter</a>. You can also look at one of the tools that uses reference data, and try and copy from that. If you’re developing the location files completely new, you need to write the data manager.</p>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"look-at-the-repository\">Look at the repository</h2>\n\n<p>Now to configure Galaxy to use the CVMFS references we have just installed, see <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html#configuring-galaxy-to-use-the-cvmfs-references\">the Ansible tutorial.</a></p>\n\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-11-21 17:39:08 +0000","pub_date":"2020-06-17 17:37:46 +0000","version":13,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/cvmfs-manual/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}