{"layout":"tutorial_hands_on","title":"Automation with Jenkins","questions":["What sort of tasks should be automated?","What are my options for automation?","How can I automate repetitive tasks?"],"objectives":["Setup Jenkins","Setup a simple job","Automate running of the Galaxy playbook","Secure Jenkins"],"time_estimation":"1h","tags":["ansible","automation"],"subtopic":"features","key_points":["Automate all the things!","Especially regular tasks you might forget to do","Automatically run Ansible to ensure machines are in compliance"],"contributors":[{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"}],"requirements":[{"type":"internal","topic_name":"admin","tutorials":["ansible","ansible-galaxy"]}],"abbreviations":{"CI":"Continuous Integration"},"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00011","url":"/topics/admin/tutorials/jenkins/tutorial.html","topic_name":"admin","tutorial_name":"jenkins","dir":"topics/admin/tutorials/jenkins","symlink":null,"id":"admin/jenkins","ref_tutorials":["<h1 id=\"overview\">Overview</h1>\n\n<p>Automation is a key component for making your life easier. There are dozens of regular, boring tasks involved in server administration, and many of these can be automated in order to make your life easier.\nContinuous Integration (CI) systems provide one way to accomplish this.\nMany of these systems focus on testing and deploying code, and provide some built-in shortcuts to accomplish this.\nTesting and deploying code boils down to “please run this command, when X happens”, and they tend to function as “commands as a service”.\nYou can often configure them to “test code when it is pushed to a branch on GitHub”, or “test this code daily” or “deploy this code daily”.\nIf you need to automatically run a command whenever some event happens, and then to report this back in some standardised way (GitHub PR statuses, automatically deploying, notifications in chat), then a CI system can do this for you.</p>\n\n<p>There are many options for, some of these have different features which may be desirable in one or another scenario.\nThis tutorial will specifically cover automation with Jenkins as that is one of the tools <code class=\"language-plaintext highlighter-rouge\">usegalaxy.*</code> use for a subset of their automation.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#overview\" id=\"markdown-toc-overview\">Overview</a></li>\n  <li><a href=\"#comparison-of-ci-systems\" id=\"markdown-toc-comparison-of-ci-systems\">Comparison of CI Systems</a></li>\n  <li><a href=\"#infrastructure\" id=\"markdown-toc-infrastructure\">Infrastructure</a>    <ol>\n      <li><a href=\"#jenkins\" id=\"markdown-toc-jenkins\">Jenkins</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#building-things-with-jenkins\" id=\"markdown-toc-building-things-with-jenkins\">Building things with Jenkins</a>    <ol>\n      <li><a href=\"#a-simple-job\" id=\"markdown-toc-a-simple-job\">A simple job</a></li>\n      <li><a href=\"#ansible-in-jenkins\" id=\"markdown-toc-ansible-in-jenkins\">Ansible in Jenkins</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#securing-jenkins\" id=\"markdown-toc-securing-jenkins\">Securing Jenkins</a></li>\n  <li><a href=\"#advanced-topics\" id=\"markdown-toc-advanced-topics\">Advanced Topics</a>    <ol>\n      <li><a href=\"#updating-jenkins\" id=\"markdown-toc-updating-jenkins\">Updating Jenkins</a></li>\n      <li><a href=\"#updating-plugins\" id=\"markdown-toc-updating-plugins\">Updating Plugins</a></li>\n      <li><a href=\"#plugins\" id=\"markdown-toc-plugins\">Plugins</a></li>\n      <li><a href=\"#real-life-examples\" id=\"markdown-toc-real-life-examples\">Real Life Examples</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"comparison-of-ci-systems\">Comparison of CI Systems</h1>\n\n<p>There are dozens of <abbr title=\"Continuous Integration\">CI</abbr> systems available meeting different needs, which CI system you want to use depends largely on the task you are trying to automate. A couple of key factors you may wish to consider are:</p>\n\n<ul>\n  <li>How long will jobs run for? Free services often have time and log-output limits.</li>\n  <li>Are you concerned about secret storage? Self-hosted can be a better option here, but it depends on your security posture and threat matrix.</li>\n  <li>Do you have infrastructure available? Self-hosted could be worth it for the extra freedoms.</li>\n</ul>\n\n<p>In general, self-hosted options have the overhead of managing and securing and updating the service, but offer significantly more freedom if you need it. They generally provide poor per-job isolation and assume you trust all of the jobs and people with access to build scripts used in the build pipeline. The free services (Travis, Circle CI) often have much better user-experiences and are easier to get started with and provide better out-of-the-box isolation.</p>\n\n<p>We will look at setting up and managing a Jenkins server today, how to setup tasks, and some of the things that <code class=\"language-plaintext highlighter-rouge\">usegalaxy.*</code> automate with their Jenkins servers.</p>\n\n<h1 id=\"infrastructure\">Infrastructure</h1>\n\n<p>As per many of the tutorials, we will use Ansible to setup and manage our Jenkins server so we can easily leverage the work of a large community. Jenkins is one choice, there are other self-hosted systems you could use, but it is the one with which many of us are familiar.</p>\n\n<h2 id=\"jenkins\">Jenkins</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Setting up Jenkins</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Edit your <code class=\"language-plaintext highlighter-rouge\">requirements.yml</code> and add the following:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">geerlingguy.java</span>\n  <span class=\"na\">version</span><span class=\"pi\">:</span> <span class=\"s\">1.10.0</span>\n<span class=\"pi\">-</span> <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">geerlingguy.jenkins</span>\n  <span class=\"na\">version</span><span class=\"pi\">:</span> <span class=\"s\">3.7.0</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Install the requirements</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-galaxy install -p roles -r requirements.yml\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Create a new playbook, <code class=\"language-plaintext highlighter-rouge\">build.yml</code> with the following:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"pi\">-</span> <span class=\"na\">hosts</span><span class=\"pi\">:</span> <span class=\"s\">build</span>\n  <span class=\"na\">become</span><span class=\"pi\">:</span> <span class=\"kc\">true</span>\n  <span class=\"na\">pre_tasks</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Allow jenkins user to execute things as root</span>\n      <span class=\"na\">copy</span><span class=\"pi\">:</span>\n        <span class=\"na\">content</span><span class=\"pi\">:</span> <span class=\"pi\">|</span>\n          <span class=\"s\">jenkins ALL=(ALL:ALL) NOPASSWD:ALL</span>\n        <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s\">/etc/sudoers.d/jenkins</span>\n        <span class=\"na\">validate</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">visudo</span><span class=\"nv\"> </span><span class=\"s\">-cf</span><span class=\"nv\"> </span><span class=\"s\">%s'</span>\n        <span class=\"na\">mode</span><span class=\"pi\">:</span> <span class=\"m\">0440</span>\n  <span class=\"na\">roles</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">geerlingguy.java</span>\n    <span class=\"pi\">-</span> <span class=\"s\">geerlingguy.jenkins</span>\n</code></pre></div>      </div>\n\n      <p>During this tutorial we will install everything on the same host, but often one keeps the build infrastructure on a separate host. We permit the Jenkins user to run everything as root, because later we will run Ansible with Jenkins, and we have <code class=\"language-plaintext highlighter-rouge\">become: true</code> in our <code class=\"language-plaintext highlighter-rouge\">galaxy.yml</code> playbook, so the <code class=\"language-plaintext highlighter-rouge\">jenkins</code> user will need to be able to become root.</p>\n    </li>\n    <li>\n      <p>Edit the inventory file (<code class=\"language-plaintext highlighter-rouge\">hosts</code>) an add a group for monitoring like:</p>\n\n      <div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[build]</span>\n<span class=\"err\">localhost</span> <span class=\"py\">ansible_connection</span><span class=\"p\">=</span><span class=\"s\">local</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Create and edit the group variables for the <code class=\"language-plaintext highlighter-rouge\">build</code> group, <code class=\"language-plaintext highlighter-rouge\">group_vars/build.yml</code>, and include the following:</p>\n\n      <div class=\"language-yml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">jenkins_http_port</span><span class=\"pi\">:</span> <span class=\"m\">4000</span>\n<span class=\"na\">jenkins_admin_username</span><span class=\"pi\">:</span> <span class=\"s\">admin</span>\n<span class=\"c1\"># Please change at least the password to something more suitable</span>\n<span class=\"na\">jenkins_admin_password</span><span class=\"pi\">:</span> <span class=\"s\">admin</span>\n<span class=\"na\">jenkins_url_prefix</span><span class=\"pi\">:</span> <span class=\"s\">/jenkins</span>\n<span class=\"na\">jenkins_plugins</span><span class=\"pi\">:</span>\n<span class=\"pi\">-</span> <span class=\"s\">matrix-auth</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the build server playbook:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook -i hosts build.yml\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Update the nginx configuration in <code class=\"language-plaintext highlighter-rouge\">templates/nginx/galaxy.j2</code> to proxy jenkins with the following. Add it <em>before the last curly brace</em> at the end of the file.</p>\n\n      <div class=\"language-nginx highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>    <span class=\"k\">location</span> <span class=\"n\">/jenkins</span> <span class=\"p\">{</span>\n        <span class=\"kn\">proxy_set_header</span>        <span class=\"s\">Host</span> <span class=\"nv\">$host</span><span class=\"p\">:</span><span class=\"nv\">$server_port</span><span class=\"p\">;</span>\n        <span class=\"kn\">proxy_set_header</span>        <span class=\"s\">X-Real-IP</span> <span class=\"nv\">$remote_addr</span><span class=\"p\">;</span>\n        <span class=\"kn\">proxy_set_header</span>        <span class=\"s\">X-Forwarded-For</span> <span class=\"nv\">$proxy_add_x_forwarded_for</span><span class=\"p\">;</span>\n        <span class=\"kn\">proxy_set_header</span>        <span class=\"s\">X-Forwarded-Proto</span> <span class=\"nv\">$scheme</span><span class=\"p\">;</span>\n\n        <span class=\"c1\"># Fix the \"It appears that your reverse proxy set up is broken\" error.</span>\n        <span class=\"kn\">proxy_pass</span>          <span class=\"s\">http://127.0.0.1:4000</span><span class=\"p\">;</span>\n        <span class=\"kn\">proxy_read_timeout</span>  <span class=\"mi\">90</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the galaxy playbook which contains Nginx:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook -i hosts galaxy.yml\n</code></pre></div>      </div>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>With this, we’re done, Jenkins is set up and ready to use!</p>\n\n<h1 id=\"building-things-with-jenkins\">Building things with Jenkins</h1>\n\n<p>We will look at a couple basic cases of how to build things with Jenkins, and wrap up with some advanced usage documentation that is not so practical for a tutorial environment.</p>\n\n<p>Start by <strong>visiting your Jenkins instance</strong>, at <code class=\"language-plaintext highlighter-rouge\">https://your-domain/jenkins</code></p>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"../../images/jenkins-01-welcome.png\" alt=\"Welcome to Jenkins. \" width=\"1713\" height=\"499\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/jenkins-01-welcome.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> Welcome to Jenkins! This is how it looks once you've run the playbook and logged in. The menu on the left gives you some ability to configure Jenkins, below it is the job queue where running and queued jobs will appear. When you have configured some jobs, they will be visible in the central panel.</figcaption></figure>\n\n<h2 id=\"a-simple-job\">A simple job</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Create a simple job</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Visit your Jenkins and login with the credentials you set up in the group variables file</p>\n    </li>\n    <li>\n      <p>Click <strong>New Item</strong> in the left hand menu</p>\n    </li>\n    <li>\n      <p>Give your job a name like <code class=\"language-plaintext highlighter-rouge\">my-project</code>, and select that it is a <code class=\"language-plaintext highlighter-rouge\">freestyle project</code>, and click “OK”</p>\n\n      <figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"../../images/jenkins-02-create-job.png\" alt=\"Create a job. \" width=\"976\" height=\"389\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/jenkins-02-create-job.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> There are other types of jobs if you install plugins, but we will mostly use freestyle jobs as they are the most appropriate for our case.</figcaption></figure>\n    </li>\n    <li>\n      <p>The job configuration interface is split into a few sections, visible in the tabs at the top of the page:</p>\n\n      <figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"../../images/jenkins-03-job-config.png\" alt=\"Job configuration interface. \" width=\"967\" height=\"626\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/jenkins-03-job-config.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> The job configuration interface, split into 'General', 'Source Code Management', 'Build Triggers', 'Build', and 'Post-build Actions'</figcaption></figure>\n    </li>\n    <li>\n      <p>In the <strong>Build Triggers</strong> section:</p>\n\n      <ul>\n        <li>Build Periodically\n          <ul>\n            <li><em>“Schedule”</em>: <code class=\"language-plaintext highlighter-rouge\">H * * * * </code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"details\">\n        <details-title>Cron syntax</details-title>\n        <p>Jenkins uses the <a href=\"https://en.wikipedia.org/wiki/Cron#Overview\">cron syntax</a>, with the addition that <code class=\"language-plaintext highlighter-rouge\">H</code> can be used to randomly choose a value for that place, rather than running at precisely that minute or hour. This allows you to spread the load of multiple jobs over a period of time, rather than having maybe 10 jobs all attempting to run simultaneously if they do not need to.\nFor the above example it will choose one value for the <code class=\"language-plaintext highlighter-rouge\">H</code>, a random minute in the hour, and then run every hour, every day, at that minute.\nYou can enter different expressions to see when Jenkins would run it next.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Add a build step:</p>\n\n      <ul>\n        <li>Add build step\n          <ul>\n            <li><strong>Click</strong> “Execute shell”</li>\n          </ul>\n        </li>\n        <li>In the new step\n          <ul>\n            <li><em>“Command”</em>:\n              <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>echo Hello world!\ndate\nenv | sort\n</code></pre></div>              </div>\n            </li>\n          </ul>\n\n          <p><a href=\"../../images/jenkins-05-job1.png\" rel=\"noopener noreferrer\"><img src=\"../../images/jenkins-05-job1.png\" alt=\"Executing a shell. \" width=\"937\" height=\"350\" loading=\"lazy\" /></a></p>\n        </li>\n      </ul>\n\n      <blockquote class=\"warning\">\n        <warning-title>Danger!</warning-title>\n        <p>This field allows you to execute arbitrary bash scripts. This is a reason Jenkins <strong>must</strong> be secured with HTTPS and a good username/password.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Click <strong>Save</strong> at the bottom</p>\n    </li>\n    <li>\n      <p>You will be brought back to the job information page. Click <strong>Build Now</strong></p>\n    </li>\n    <li>\n      <p>Your job will appear in the <em>Build History</em> box at the left. <strong>Click</strong> the ball associated with your job, to see the console.</p>\n\n      <figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"../../images/jenkins-06-job1-run.png\" alt=\"Seeing a Jenkins job's console. \" width=\"366\" height=\"172\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/jenkins-06-job1-run.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> The build history box lets you see the status of previous, running, and queued builds. The 'sun' icon indicates that all builds have been successful, it will become more cloudy/overcast if you experience failures. The 'trend' button allows you to visualise how quickly builds have run historically.</figcaption></figure>\n\n      <p>Clicking the number will bring you to a job information page, where you can click “Console Output” to see the jobs output</p>\n\n      <figure id=\"figure-5\" style=\"max-width: 90%;\"><img src=\"../../images/jenkins-07-job1-out.png\" alt=\"Jenkins job output. \" width=\"871\" height=\"857\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/jenkins-07-job1-out.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 5</strong>:</span> The output of your first Jenkins job. All jenkins jobs log both the commands that were run, and their outputs. Use this to see which step potentially failed.</figcaption></figure>\n    </li>\n  </ol>\n</blockquote>\n\n<p>Setting up Jenkins jobs is as simple as setting up a cron job, but the results are stored in a nice visual interface that may provide better visibility than a <code class=\"language-plaintext highlighter-rouge\">cron</code> job.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>Author's commentary</comment-title>\n  <p>Cron jobs are great and often useful, but most people ignore the emails that cron sends them. I know I have mailboxes across N servers with dozens and dozens of unread emails from cron jobs. Jenkins is an improvement here because it shows “success” and “failure” messages that are clear, while storing the output in case you later decide that you want to look at it. For the most part, cron jobs write output that is never read, and we really only want to see the output if something has failed, but writing a cron job that behaves like this is unnecessarily complex.</p>\n</blockquote>\n\n<h2 id=\"ansible-in-jenkins\">Ansible in Jenkins</h2>\n\n<p>We will now setup Jenkins to run Ansible on cron. In the <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">Galaxy Installation with Ansible</a> tutorial we emphasised that it is useful to often run the entire playbook to ensure that all changes are applied. UseGalaxy.eu likes to accomplish this by having Jenkins run the playbooks every day. We know that even if our coworkers made some changes to the servers, that by tomorrow it will be reverted to a known-good configuration.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Jenkins running Ansible</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Go back to the Jenkins homepage (click the logo in the top left)</p>\n    </li>\n    <li>\n      <p>Click <strong>New Item</strong> in the left hand menu.</p>\n    </li>\n    <li>\n      <p>Give your job a name like “ansible-galaxy”, and select that it is a “freestyle project”, and click “OK”</p>\n    </li>\n    <li>\n      <p>Configure your job</p>\n\n      <ul>\n        <li>Build Triggers\n          <ul>\n            <li>Build Periodically\n              <ul>\n                <li><em>“Schedule”</em>: <code class=\"language-plaintext highlighter-rouge\">H * * * * </code></li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li>Build\n          <ul>\n            <li>Add build step\n              <ul>\n                <li><strong>Click</strong> “Execute shell”</li>\n              </ul>\n            </li>\n            <li>In the new step\n              <ul>\n                <li><em>“Command”</em>:\n                  <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>cd /home/ubuntu/galaxy/ # Change this to wherever your galaxy.yml is, you can check with the command pwd\nansible-playbook -i hosts galaxy.yml --diff\n</code></pre></div>                  </div>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li>Save</li>\n      </ul>\n    </li>\n    <li>\n      <p>Click <strong>Build Now</strong> and check the console output of the job</p>\n\n      <p>What do you see? It should look like Jenkins is running the playbook:</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Started by user admin\nRunning as SYSTEM\nBuilding in workspace /var/lib/jenkins/workspace/ansible-galaxy\n[ansible-galaxy] $ /bin/sh -xe /tmp/jenkins6010384499214486550.sh\n+ cd /home/ubuntu/galaxy/\n+ ansible-playbook -i hosts galaxy.yml --diff\n\nPLAY [galaxyservers] ***********************************************************\n\nTASK [Gathering Facts] *********************************************************\nok: [gcc-3.training.galaxyproject.eu]\n\nTASK [Install Dependencies] ****************************************************\n [WARNING]: Could not find aptitude. Using apt-get instead\nok: [gcc-3.training.galaxyproject.eu]\n</code></pre></div>      </div>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>With this we have Jenkins running our playbook for us! You can imaging several steps you could take to follow up from this:</p>\n\n<ol>\n  <li>Storing your playbooks in <code class=\"language-plaintext highlighter-rouge\">git</code> like UseGalaxy.*\n    <ul>\n      <li><a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook\">UseGalaxy.eu’s playbooks</a> are public, anyone can contribute and if the PR is merged, it is automatically applied to our infrastructure within the next day. We store our job configuration in here as well which specifies how much memory and how many CPUs tools receive. Our teammates often can contribute fixes themselves when they notice a tool needs more memory.</li>\n      <li><a href=\"https://github.com/galaxyproject/infrastructure-playbook\">UseGalaxy.org’s playbooks</a> are also public, but run manually.</li>\n    </ul>\n  </li>\n  <li>Running this job regularly\n    <ul>\n      <li>This can prevent mistakes, if a coworker edits some configuration on the server and forgets to commit it, this ensures everything is reverted back to the expected state.</li>\n      <li>The amount of time the Galaxy playbook takes can be quite annoying when done manually but no one is upset if it takes 30 minutes when it is run on cron.</li>\n    </ul>\n  </li>\n  <li>Alerting you if something went wrong\n    <ul>\n      <li>There are numerous plugins that can send notifications of build success/failure to various places like Slack, etc.</li>\n    </ul>\n  </li>\n</ol>\n\n<p>These are all next steps that are great to look into, and will make your systems more reliable and trustworthy as you will know when things change, and you can be certain that the code is configured how you specified.</p>\n\n<h1 id=\"securing-jenkins\">Securing Jenkins</h1>\n\n<p>You have already secured Jenkins in that it is protected with a good password and HTTPS. This is one important thing. The other portion is the visibility of jobs and their outputs. In the above Ansible Galaxy deployment job we set the parameter <code class=\"language-plaintext highlighter-rouge\">--diff</code>, so we could see what changed. This is an extremely helpful thing to do to be able to audit changes from a particular run. But! If you change the <code class=\"language-plaintext highlighter-rouge\">id_secret</code> or other secret variables, then this diff will be visible in the job’s console logs. This is useful to see for admins but needs to be restricted so that the whole world cannot see this.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Securing Jenkins</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Return to the Jenkins home page</p>\n    </li>\n    <li>\n      <p>Click on <strong>Manage Jenkins</strong></p>\n    </li>\n    <li>\n      <p>Click on <strong>Configure Global Security</strong></p>\n\n      <ol>\n        <li>\n          <p>In the first block <em>Access Control</em> Change the <em>Authorization</em> strategy from “Logged-in users can do anything” to “Matrix-based security”</p>\n        </li>\n        <li>\n          <p>Click “Add user or group” and add the <code class=\"language-plaintext highlighter-rouge\">admin</code> user</p>\n        </li>\n        <li>\n          <p>Configure the permissions like below. Clicking on the checked checkbox icon at the right will allow you to enable/disable all of the checkboxes for that row.</p>\n\n          <p><a href=\"../../images/jenkins-09-permissions.png\" rel=\"noopener noreferrer\"><img src=\"../../images/jenkins-09-permissions.png\" alt=\"Configuring matrix based permissions. \" width=\"780\" height=\"265\" loading=\"lazy\" /></a></p>\n\n          <p>The matrix based security plugin is provided by a plugin, we installed this by setting the variable <code class=\"language-plaintext highlighter-rouge\">jenkins_plugins: [matrix-auth]</code> in our group variables earlier.\nThe checkboxes give you the ability to grant or deny permissions to certain classes of users. Each column is an individual permission, and you can hover over each column to get more information about what that permission allows.</p>\n\n          <p>In the above example we have configured that:</p>\n          <ul>\n            <li><em>Anonymous users</em> (not logged in) may <code class=\"language-plaintext highlighter-rouge\">Read</code>, so they can access the Jenkins page, but by default will not see any jobs. The <code class=\"language-plaintext highlighter-rouge\">Discover</code> permission is also granted so that if a user has bookmarked the ansible-galaxy job page, they will automatically be redirected through the login page, if they are not already logged in.</li>\n            <li>Once they login and are <em>Authenticated Users</em>, they can see that <code class=\"language-plaintext highlighter-rouge\">Manage</code> and <code class=\"language-plaintext highlighter-rouge\">Run</code> Jobs and Views</li>\n            <li>Only the <em>admin</em> user, however, can configure <code class=\"language-plaintext highlighter-rouge\">Agents</code> to run those jobs.</li>\n          </ul>\n        </li>\n        <li>\n          <p>Under <strong>CSRF Protection</strong>, check the box to prevent CSRF, and select the default crumb issuer, and then enable proxy compatibility.</p>\n        </li>\n      </ol>\n    </li>\n    <li>\n      <p>Save</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Try accessing your Jenkins from a private browsing session. How does it look?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n          <p>It should appear as if there are no jobs, until you log in.</p>\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"advanced-topics\">Advanced Topics</h1>\n\n<p>These topics are outside the scope of a training or do not lend themselves well to interesting exercises, but some discussion and configuration information will be provided below documenting common issues and questions that can be useful if you start using Jenkins “in anger”.</p>\n\n<h2 id=\"updating-jenkins\">Updating Jenkins</h2>\n\n<p>Jenkins updates regularly due to security issues. We recommend that you either:</p>\n\n<ol>\n  <li>Regularly check the <a href=\"https://jenkins.io/changelog/\">Jenkins Changelog</a>, and update the server whenever there are important security fixes</li>\n  <li>OR include some sort of yum or apt auto-updater on whichever system that Jenkins is running on</li>\n</ol>\n\n<p>The downside of automatic updating is that Jenkins will restart and kill any jobs that had been running. Choose which works best for your environment. UseGalaxy.eu chose a completely automated setup because their jobs can be killed and few things are affected. UseGalaxy.org chose a more manual setup because their jobs are more critical, there if jobs fail, Galaxy pull request tests will fail unexpectedly and unhelpfully.</p>\n\n<h2 id=\"updating-plugins\">Updating Plugins</h2>\n\n<p>Plugins also regularly receive updates due to security issues. You should either check in with your Jenkins server regularly and apply updates when they are available, or automate this as well. UseGalaxy.eu uses a script like:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/bash</span>\n<span class=\"nv\">ARGS</span><span class=\"o\">=</span><span class=\"s2\">\"-jar /opt/jenkins-cli.jar -s http://localhost:4000/ -auth user:password\"</span>\n<span class=\"nv\">UPDATE_LIST</span><span class=\"o\">=</span><span class=\"si\">$(</span>java <span class=\"nv\">$ARGS</span> list-plugins | <span class=\"nb\">grep</span> <span class=\"s1\">')$'</span> | <span class=\"nb\">awk</span> <span class=\"s1\">'{print $1}'</span><span class=\"si\">)</span>\n\n<span class=\"k\">if</span> <span class=\"o\">[</span> <span class=\"o\">!</span> <span class=\"nt\">-z</span> <span class=\"s2\">\"</span><span class=\"k\">${</span><span class=\"nv\">UPDATE_LIST</span><span class=\"k\">}</span><span class=\"s2\">\"</span> <span class=\"o\">]</span><span class=\"p\">;</span> <span class=\"k\">then\n    </span><span class=\"nb\">echo </span>Updating Jenkins Plugins: <span class=\"k\">${</span><span class=\"nv\">UPDATE_LIST</span><span class=\"k\">}</span><span class=\"p\">;</span>\n    java <span class=\"nv\">$ARGS</span> install-plugin <span class=\"k\">${</span><span class=\"nv\">UPDATE_LIST</span><span class=\"k\">}</span><span class=\"p\">;</span>\n    java <span class=\"nv\">$ARGS</span> safe-restart<span class=\"p\">;</span>\n<span class=\"k\">fi</span>\n</code></pre></div></div>\n\n<p>And we run this on cron hourly. The <code class=\"language-plaintext highlighter-rouge\">safe-restart</code> at the end causes Jenkins to stop processing new jobs, and wait until all jobs are complete before restarting. Unfortunately this is not an option for Jenkins server updates.</p>\n\n<h2 id=\"plugins\">Plugins</h2>\n\n<p>Jenkins provides an impressive number of plugins for a lot of different environments. Here are some of the ones we use and their purposes:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Plugin</th>\n      <th>Comments</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Git Plugin</td>\n      <td>Allow cloning git repositories to build</td>\n    </tr>\n    <tr>\n      <td>Build Timeout</td>\n      <td>Allows us to automatically kill jobs which run longer than we expect. We can use this to set per-build timeouts</td>\n    </tr>\n    <tr>\n      <td>Credentials Binding Plugin</td>\n      <td>This can be used to inject secrets into builds, e.g. vault passwords. <!-- TODO: use this with vault in ansible-galaxy tuto --></td>\n    </tr>\n    <tr>\n      <td>Embeddable Build Status Plugin</td>\n      <td>Produces nice build statuses like Travis does, e.g. <a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook#build-statuses\">UseGalaxy.eu’s playbook statuses</a></td>\n    </tr>\n    <tr>\n      <td>GitHub Authentication plugin</td>\n      <td>The UseGalaxy.eu build server requires login with GitHub and ensures membership in the correct organisation to be able to access group secrets and build logs.</td>\n    </tr>\n    <tr>\n      <td>Job Configuration History plugin</td>\n      <td>This plugin tracks changes made in the configuration of jobs over time, so you can see what was changed in the Jenkins configuration which may have caused the job to start succeeding or failing.</td>\n    </tr>\n    <tr>\n      <td>ShiningPanda Plugin</td>\n      <td>Allows easily running jobs within a per-job python virtualenv.</td>\n    </tr>\n    <tr>\n      <td>SSH Agent Plugin</td>\n      <td>Allows providing specific SSH credentials to a build</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>These plugins can be installed via the Ansible automation by expanding <code class=\"language-plaintext highlighter-rouge\">jenkins_plugins</code> in your <code class=\"language-plaintext highlighter-rouge\">group_vars/build.yml</code>, or installed with the web interface.</p>\n\n<h3 id=\"source-code-management\">Source Code Management</h3>\n\n<p>Jenkins supports most VCSs that are in use today. For the Git plugin, it allows you to clone a git repository into the job’s directory, and then run scripts from there. It forms the foundation of most jobs.</p>\n\n<p>You may need to specify credentials for cloning from private repositories, in this case you should beware that when you configure the SSH credentials you should specify the <code class=\"language-plaintext highlighter-rouge\">user</code> as <code class=\"language-plaintext highlighter-rouge\">git</code>. You will also need to ensure that the server’s SSH public key is known to your Jenkins system which generally requires <code class=\"language-plaintext highlighter-rouge\">su</code>ing as the Jenkins user and running <code class=\"language-plaintext highlighter-rouge\">ssh git@...</code> once, and accepting the “Unknown host” key prompt. We recommend that you use repository URLs of the format <code class=\"language-plaintext highlighter-rouge\">git@github.com:org/repo.git</code>, if you are using one of the GitHub PR builder plugins, then this URL has to match a value in the incoming webhook and it is not always obvious that this needs to be set like this.</p>\n\n<p>The “Branches to build” section allows you to specify which branches. Whenever you click “Build now”, Jenkins usually just picks the main branch to build, and doesn’t run a build job per-branch. If you are automatically triggering Jenkins builds based on GitHub (or other) webhooks, then you can ensure that branches that should not be built are filtered out here. Real life example: UseGalaxy.eu has one Jenkins job which should only build the main branch of a repository, and another job that only builds the PRs for that repository. We know the first job will only ever build the main branch so we can hardcode that there. With the Git plugin, many “Additional Behaviours” are available. If you have submodules in your repository, you will need to enable one of these to ensure that the repository is cloned recursively. If you want to ensure a fresh start each time because you write out temporary files to the current working directory, then there is a behaviour to wipe out the repository before each build.</p>\n\n<h3 id=\"build-triggers\">Build Triggers</h3>\n\n<p>The GitHub Pull Request Builder plugin is not always easy to configure, here systems like Travis are generally significantly easier. Consider if that is an option. It is not a bad thing to use multiple <abbr title=\"Continuous Integration\">CI</abbr> systems, it provides some degree of redundancy where if one system is experiencing an outage it may not affect all CI jobs.</p>\n\n<h3 id=\"credential-binding\">Credential Binding</h3>\n\n<p>If you provide credentials to Jenkins builds, they will automatically be stripped from log outputs. So if your job will not “leak” any private information (e.g. in <code class=\"language-plaintext highlighter-rouge\">--diff</code>) and you want to share the build logs with your users to prove that actions were taken or that things are working and automated, then the credential binding plugin ensures that any secrets will be stripped from output and replaced with <code class=\"language-plaintext highlighter-rouge\">******</code>. They can be made available as environment variables, or in files that can be accessed.</p>\n\n<p>We often upload a configuration file with secrets (e.g. <code class=\"language-plaintext highlighter-rouge\">.parsec.yml</code> ), and then can just call our software <code class=\"language-plaintext highlighter-rouge\">parsec -c $PARSEC_CONFIG_FILE_LOCATION ...</code> passing in that file, wherever Jenkins has stored it securely.</p>\n\n<h3 id=\"ssh-agent\">SSH Agent</h3>\n\n<p>This allows you to automatically inject credentials into your build’s SSH agent. If you want to <code class=\"language-plaintext highlighter-rouge\">rsync</code> some build outputs to another server, or <code class=\"language-plaintext highlighter-rouge\">ssh</code> to a server to run some one-off command, or to run <code class=\"language-plaintext highlighter-rouge\">ansible</code>, then this is the feature you want. Beware that if you are pulling from and pushing to git repositories on GitHub with separate SSH credentials you may need to use a combination of the SSH Agent plugin, and injecting an SSH key through credential binding.</p>\n\n<h2 id=\"real-life-examples\">Real Life Examples</h2>\n\n<p>Here are some examples of how Jenkins is used in the wild, maybe it can provide some reference for potential uses within your organisation or solutions to various problems. The examples are mostly pulled from UseGalaxy.eu’s experiences, as the author is most familiar with those.</p>\n\n<h3 id=\"compute-nodes\">Compute Nodes</h3>\n\n<p>We attach VMs as compute nodes for Jenkins to use as executors. We have an OpenStack cloud available so that is an easy option for us. We setup the VMs such that Jenkins just logs in as the default <code class=\"language-plaintext highlighter-rouge\">centos</code> user and uses the home directory for building jobs. There is a Jenkins plugin to manage the VMs in the cloud automatically (scaling up/down as necessary, removing VMs with full disk) but our cloud was upgraded and we could not get this working. It is worth trying if that is an option! There are other cloud provider plugins available with similar features.</p>\n\n<p>We also use a custom image that includes a lot of our requirements pre-installed. We include e.g. LaTeX, Ruby/RVM, Java, Node, anything we think we might need for our jobs. This also lets us reduce the privileges of the jobs, nothing <em>needs</em> <code class=\"language-plaintext highlighter-rouge\">root</code> access to install packages globally. Python, Ruby, and Node all have something similar to virtualenvs.</p>\n\n<h3 id=\"job-apollo-builder\">Job: Apollo Builder</h3>\n\n<p>This is a relatively straightforward job to build a WAR file and upload it to our depot server.</p>\n\n<div class=\"language-console highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gp\">#</span><span class=\"w\"> </span>some <span class=\"nb\">env </span>vars that are needed, it<span class=\"s1\">'s kind of gross but it works :(\n</span><span class=\"go\">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.212.b04-0.el7_6.x86_64/\n</span><span class=\"gp\">export PERL5LIB=/home/centos/workspace/usegalaxy-eu/apollo-builder/extlib/lib/perl5:$</span>PERL5LIB\n<span class=\"gp\">#</span><span class=\"w\"> </span>setting a variable from some build data\n<span class=\"gp\">APOLLO_VERSION=$</span><span class=\"o\">(</span><span class=\"nb\">cat </span>application.properties | <span class=\"nb\">grep </span>app.version | <span class=\"nb\">sed</span> <span class=\"s1\">'s/.*=//g'</span><span class=\"o\">)</span>\n<span class=\"go\">\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Check <span class=\"k\">if </span>this version needs to be built\n<span class=\"go\">curl --silent https://usegalaxy.eu/static/vgcn/ | \\\n</span><span class=\"gp\">\tgrep -F \"apollo-$</span><span class=\"o\">{</span>APOLLO_VERSION<span class=\"o\">}</span><span class=\"s2\">\" &amp;&amp; echo \"</span>Already built!<span class=\"s2\">\" &amp;&amp; exit 0;\n</span><span class=\"go\">\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Build the thing\n<span class=\"go\">./apollo deploy\n\n</span><span class=\"gp\">#</span><span class=\"w\"> </span>Deploy it to our server\n<span class=\"gp\">scp -i $</span>PRIV_KEY <span class=\"se\">\\</span>\n<span class=\"go\">\ttarget/*.war \\\n</span><span class=\"gp\">    user@server:/static/apollo-$</span><span class=\"o\">{</span>APOLLO_VERSION<span class=\"o\">}</span>.war\n</code></pre></div></div>\n\n<ul>\n  <li>We use the “Secret file” binding to inject a specific private key (available in the build as <code class=\"language-plaintext highlighter-rouge\">$PRIV_KEY</code>) but the SSH agent plugin would work equally well.</li>\n  <li>We could also use the “Archive Artifacts” plugin to have Jenkins retain all of the artefacts (build outputs that you care about) but we wanted to have an Ansible role pull those files and it was simpler to have them accessible at predictable URLs.</li>\n</ul>\n\n<h3 id=\"job-chado-schema-builder\">Job: Chado Schema Builder</h3>\n\n<p>Similar to the Apollo builder but it uploads outputs as GitHub releases which is useful for public projects with complex build pipelines. The CSB takes on average 5-6 hours to run so we cannot easily run this on free infrastructure.</p>\n\n<p>Here we store both the <a href=\"https://github.com/hexylena/chado-schema-builder/blob/master/.ci/run.sh\">build</a> and <a href=\"https://github.com/hexylena/chado-schema-builder/blob/master/.ci/upload.sh\">deploy</a> scripts in the GitHub repository. If you do this, you have to be careful about building PRs, as anyone can edit the build scripts and access your internal infrastructure!</p>\n\n<h3 id=\"job-website\">Job: Website</h3>\n\n<p>We build our own Jekyll website because we have some plugins GitHub will not compile for us. The configuration here is more complex:</p>\n\n<ul>\n  <li>Throttle builds, since GitHub will only accept so many deploy requests in a time period</li>\n  <li>One SSH key used to clone the repository using the Git SCM, with “Wipe out repository &amp; force clone” set.</li>\n  <li>Triggers on both:\n    <ul>\n      <li>Cron, daily</li>\n      <li>GitHub webhooks notifying us of pushes to master</li>\n    </ul>\n  </li>\n  <li>SSH Agent is configured with a deploy SSH key (because git really prefers you provide keys in the SSH agent, I don’t know if it is possible to pass a keyfile on the CLI)</li>\n  <li>The <a href=\"https://github.com/usegalaxy-eu/website/blob/master/.build.sh\">.build.sh</a> is run which activates the RVM pre-installed on the VMs</li>\n  <li>If the master branch is checked out, <a href=\"https://github.com/usegalaxy-eu/website/blob/master/.publish.sh\"><code class=\"language-plaintext highlighter-rouge\">.publish.sh</code></a> is run</li>\n  <li>Empty <a href=\"https://github.com/usegalaxy-eu/website/blob/master/.nojekyll\"><code class=\"language-plaintext highlighter-rouge\">.nojekyll</code></a> file to prevent GitHub from trying to build this.</li>\n</ul>\n\n<h3 id=\"job-install-tools\">Job: Install Tools</h3>\n\n<p>For this job we use Jenkin’s “Trigger other builds” feature:</p>\n<ul>\n  <li>We have one job that fetches all of the latest updates for IUC tools and writes those into yaml files. This job runs on cron every week.</li>\n  <li>This triggers a separate job to actually apply the changes to our server.</li>\n</ul>\n\n<p>By splitting these up, we can run the “actually apply” portion without having to fetch updates to the tools first. Additionally we can have the second portion run only if the first portion succeeds, so we have some check that everything looks OK before trying to apply it.</p>\n\n<p>We include a Galaxy API key as a credential and then use a <code class=\"language-plaintext highlighter-rouge\">Makefile</code> contained in the project to do the steps. We don’t automatically test PRs so we don’t care if people change the Makefile because we visually validate it before merging their PR.</p>\n\n<h3 id=\"configuration-themes\">Configuration: Themes</h3>\n\n<p>Many people find the “blue/red ball” icons a bit hard to understand. Using the “Simple Theme Plugin” you can easily add custom CSS files or directly enter custom CSS. UseGalaxy.* use the <a href=\"http://afonsof.com/jenkins-material-theme/\">jenkins-material-theme</a> as it provides a slightly cleaner view of Jenkins with better iconography.</p>\n\n<h3 id=\"configuration-folder-permissions\">Configuration: Folder Permissions</h3>\n\n<p>We have the aforementioned problem that our playbooks run with <code class=\"language-plaintext highlighter-rouge\">--diff</code> and while we want to capture this output and be able to review it, it is not necessary that the public can see it. So permissions are configured not only on the global Jenkins level, but also within a single folder of jobs. The folder permissions involve setting:</p>\n\n<ul>\n  <li>Properties\n    <ul>\n      <li><em>“Inheritance Strategy”</em>: <code class=\"language-plaintext highlighter-rouge\">Do not inherit permission grants from other ACLs</code></li>\n      <li>Allowing <code class=\"language-plaintext highlighter-rouge\">Discover</code> and nothing else for Anonymous + Authenticated</li>\n      <li>Explicitly granting all permissions for the admins</li>\n    </ul>\n  </li>\n</ul>\n"],"ref_slides":[],"video_library":{"tutorial":null,"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":false,"mod_date":"2022-10-18 14:23:35 +0000","pub_date":"2019-08-06 13:56:16 +0000","version":13,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/jenkins/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}