{"layout":"tutorial_hands_on","title":"Mass spectrometry imaging: Loading and exploring MSI data","edam_ontology":["topic_0121"],"zenodo_link":"https://doi.org/10.5281/zenodo.1560645","level":"Introductory","questions":["Did the tryptic digestions work?","Is there an intensity gradient in the data?","How good is the m/z accuracy?"],"objectives":["How to upload an imzML file into Galaxy","Getting an overview of the MSI data with the MSI quality control tool","How to export MSI data as tabular files"],"time_estimation":"45m","key_points":["imzML (continuous or processed file type) and Analyze7.5 can be uploaded into Galaxy via the composite upload.","The MSI Qualitycontrol tool gives valuable information before starting the analysis.","The MSI data exporter can be used any time during the analysis when it is necessary to dig deeper into the data. Galaxy provides many text manipulation tools that can directly be applied on the exported tabular file to filter, sort, plot, ... the data."],"contributors":[{"name":"Melanie Föll","email":"melanie.foell@mol-med.uni-freiburg.de","twitter":"MCFoell","matrix":"foellmelanie:matrix.org","orcid":"0000-0002-1887-7543","joined":"2018-10","affiliations":["uni-freiburg"],"id":"foellmelanie","url":"https://training.galaxyproject.org/training-material/api/contributors/foellmelanie.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/foellmelanie/"},{"name":"Björn Grüning","email":"bjoern.gruening@gmail.com","twitter":"bjoerngruening","fediverse":"https://fosstodon.org/@bgruening","fediverse_flavor":"mastodon","matrix":"bgruening:matrix.org","orcid":"0000-0002-3079-6586","elixir_node":"de","linkedin":"bgruening","contact_for_training":true,"joined":"2017-09","location":{"country":"DE","lat":47.997791,"lon":7.842609},"affiliations":["eurosciencegateway","eosc-life","by-covid","deNBI","sfb992","elixir-converge","uni-freiburg","elixir-europe"],"id":"bgruening","url":"https://training.galaxyproject.org/training-material/api/contributors/bgruening.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/bgruening/"}],"subtopic":"special","tags":["mouse","imaging"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00217","url":"/topics/proteomics/tutorials/mass-spectrometry-imaging-loading-exploring-data/tutorial.html","topic_name":"proteomics","tutorial_name":"mass-spectrometry-imaging-loading-exploring-data","dir":"topics/proteomics/tutorials/mass-spectrometry-imaging-loading-exploring-data","symlink":null,"id":"proteomics/mass-spectrometry-imaging-loading-exploring-data","ref_tutorials":["<p>Mass spectrometry imaging (MSI) is applied to measure the spatial distribution of hundreds of biomolecules in a sample. A mass spectrometer scans over the entire sample and collects a mass spectrum every 5-200 µm. This results in thousands of spots in which a mass spectrum is acquired. Each mass spectrum consists of hundreds of analytes that are measured by their mass-to-charge (m/z) ratio. For each analyte the peak intensity in the mass spectra of every pixel is known and can be set together to map the spatial distribution of the analyte in the sample.</p>\n\n<p>The technique has a broad range of applications as it is able to measure many different kinds of analytes such as peptides, proteins, metabolites or chemical compounds in a large variety of samples such as cells, tissues and liquid biopsies. Application areas include pharmacokinetic studies, biomarker discovery, molecular pathology, forensic studies, plant research and material sciences. The strength of MSI is the simultaneous analysis of hundreds of analytes in an unbiassed, untargeted, label free, fast and affordable measurement while maintaining morphological information.</p>\n\n<p>Depending on the analyte of interest and the application, different mass spectrometers are used. A mass spectrometer measures the analytes by ionizing, evaporating and sorting them by their mass-to-charge (m/z) ratio. Put simply, a mass spectrometer needs basically three parts: an ionization source, a mass analyzer and a detector. Most common ionization sources for MSI are MALDI (Matrix Assisted Laser Desorption/Ionization), DESI (Desorption Electrospray Ionization) and SIMS (Secondary Ion Mass Spectrometry).</p>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_maldi_tof_imaging.png\" alt=\"MSI measurement. \" width=\"1131\" height=\"354\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_maldi_tof_imaging.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> MALDI TOF imaging of a mouse kidney</figcaption></figure>\n\n<p>One common type of mass spectrometer for MSI is a MALDI Time-Of-Flight (MALDI-TOF) device. During MALDI ionization a laser shoots onto the sample that was covered with a special matrix which absorbs the laser energy and transfers it to the analytes. This process evaporizes and ionizes the analytes that due to their charge can then be accelerated in an electrical field towards the TOF tube. The time of flight through the tube to the detector is measured and as this correlates with the mass over charge (m/z) of the analyte, the flight time allows the calculation of m/z. During measurement complete mass spectra with hundreds of m/z - intensity pairs are acquired in thousands of sample plots leading to big and complex data. Each mass spectrum is annotated with coordinates (x,y) that define its location in the sample. This allows to visualize the intensity distribution of each m/z feature in the sample as a heatmap. Depending on the analyte of interest, the sample type and the mass spectrometer the sample preparation steps as well as the properties of the acquired data differ.</p>\n\n<p>This tutorial introduces the handling of the mass spectrometry imaging (MSI) file type imzML in Galaxy and some first steps to explore the data.\nThe imzML file format was introduced to ease the exchange of MSI data between different instruments and data analysis software (<span class=\"citation\"><a href=\"#Schramm_2012\">Schramm <i>et al.</i> 2012</a></span>). More and more vendors provide an imzML export option and there are <a href=\"https://ms-imaging.org/wp/imzml/software-tools/\">software solutions</a> to convert proprietary files into imzML files. Before starting any analysis it is recommended to visualize all features of the data in different ways to better understand the data and to obtain an idea about it’s quality and usefulness.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will deal with:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#uploading-an-imzml-file-into-galaxy\" id=\"markdown-toc-uploading-an-imzml-file-into-galaxy\">Uploading an imzML file into Galaxy</a></li>\n  <li><a href=\"#exploring-msi-data-with-the-msi-qualitycontrol-tool\" id=\"markdown-toc-exploring-msi-data-with-the-msi-qualitycontrol-tool\">Exploring MSI data with the MSI Qualitycontrol tool</a></li>\n  <li><a href=\"#exporting-msi-data-to-tabular-files-for-further-exploration-of-the-data\" id=\"markdown-toc-exporting-msi-data-to-tabular-files-for-further-exploration-of-the-data\">Exporting MSI data to tabular files for further exploration of the data</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"uploading-an-imzml-file-into-galaxy\">Uploading an imzML file into Galaxy</h1>\n\n<p>In case no direct imzML export is provided by the mass spectrometer software, proprietary files can be converted to imzML files with the tools provided on the following website: <a href=\"https://ms-imaging.org/wp/imzml/software-tools/\">ms-imaging.org</a>.\nThe imzML file consists of two files: The first file contains the metadata in an XML file and has the extension <code class=\"language-plaintext highlighter-rouge\">.imzML</code>. The second file contains the mass spectra data and is saved as binary file and its extension is <code class=\"language-plaintext highlighter-rouge\">.ibd</code>. To be valid both files must have the same filename before the extension. More information about the imzML file structure can be found here: <a href=\"https://ms-imaging.org/wp/imzml/data-structure/\">ms-imaging.org</a>. Galaxy provides the <code class=\"language-plaintext highlighter-rouge\">composite</code> upload for files consisting of several components.</p>\n\n<p>The data for this tutorial comes from MALDI-TOF imaging of peptides in a mouse kidney. To make computation times more suitable for this training, only the m/z range from 1220 - 1625 and a part of the pixels (purple rectangle in figure 1) containing about half of the kidney and one digestion control spot were kept.</p>\n\n<figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_mouse_kidney.png\" alt=\"mouse kidney image. \" width=\"1050\" height=\"489\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_mouse_kidney.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> Mouse kidney sample before and after mass spectrometry measurement and H&amp;E staining</figcaption></figure>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Uploading an imzML file</hands-on-title>\n\n  <ol>\n    <li>\n      <p><strong>Create a new history</strong> and give it a name.</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Upload the data from <a href=\"https://zenodo.org/record/1560646\">Zenodo</a> via the <strong>composite</strong> option</p>\n\n      <blockquote class=\"tip\">\n        <tip-title>Upload via the composite option</tip-title>\n        <ul>\n          <li>Open the Galaxy Upload Manager(<i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> on the top-right of the tool panel)</li>\n          <li>Click on <strong>Composite</strong> on the top</li>\n          <li>Set <strong>Composite Type</strong> to <code class=\"language-plaintext highlighter-rouge\">imzml</code></li>\n          <li>Expand the first <strong>Select</strong> button (for the imzML metadata component)</li>\n          <li>Select <strong>Paste/Fetch data</strong> and paste\n            <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/1560646/files/mouse_kidney_cut.imzML\n</code></pre></div>            </div>\n          </li>\n          <li>Expand the second <strong>Select</strong> button (for the mass spectral data component)</li>\n          <li>Select <strong>Paste/Fetch data</strong> and paste\n            <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/1560646/files/mouse_kidney_cut.ibd\n</code></pre></div>            </div>\n          </li>\n          <li>Press <strong>Start</strong></li>\n          <li><strong>Close</strong> the window</li>\n        </ul>\n      </blockquote>\n\n      <figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_upload_composite.png\" alt=\"Upload imzML files. \" width=\"623\" height=\"280\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_upload_composite.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> Upload an imzML file via the composite upload</figcaption></figure>\n\n      <blockquote class=\"tip\">\n        <tip-title>FTP upload for large files</tip-title>\n        <ul>\n          <li>In case one subfile is larger than 2 GB the uploading needs to be done via ftp.</li>\n          <li>The necessary steps are explained in this tutorial <a href=\"/training-material/topics/galaxy-interface/tutorials/get-data/slides.html\">Getting data into Galaxy</a></li>\n        </ul>\n      </blockquote>\n\n      <blockquote class=\"tip\">\n        <tip-title>Uploading an Analyze7.5 file</tip-title>\n        <ul>\n          <li><code class=\"language-plaintext highlighter-rouge\">Analyze7.5</code> files are also supported by Galaxy.</li>\n          <li>The file consists of three components and is therefore uploaded via the ‘composite’ function, analogously to the imzML upload.</li>\n          <li>The files to select in the <code class=\"language-plaintext highlighter-rouge\">composite</code> tab are the header file <code class=\"language-plaintext highlighter-rouge\">.hdr</code>, the m/z values file <code class=\"language-plaintext highlighter-rouge\">.t2m</code> and the spectra file <code class=\"language-plaintext highlighter-rouge\">.img</code>.</li>\n        </ul>\n      </blockquote>\n    </li>\n    <li>\n      <p>Rename the data into <code class=\"language-plaintext highlighter-rouge\">mouse_kidney_cut</code></p>\n\n      <blockquote class=\"tip\">\n        <tip-title>Rename a dataset</tip-title>\n        <ul>\n          <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>\n          <li>In the central panel, change the <strong>Name</strong> field to <code class=\"language-plaintext highlighter-rouge\">mouse_kidney_cut</code></li>\n          <li>Click the <strong>Save</strong> button</li>\n        </ul>\n      </blockquote>\n    </li>\n  </ol>\n</blockquote>\n\n<h1 id=\"exploring-msi-data-with-the-msi-qualitycontrol-tool\">Exploring MSI data with the MSI Qualitycontrol tool</h1>\n\n<p>Before starting any analysis, it is important to confirm that the quality of the acquired data is sufficient.\nFurthermore, knowing the data’s properties is important to choose the right preprocessing steps and parameters.\nThe steps that most influence the spatial delocalization and preparation quality in an MALDI imaging experiment is the homogeneous matrix deposition and for peptide analysis in addition the trypsin deposition and digestion step as reported by <span class=\"citation\"><a href=\"#Ly_2019\">Ly <i>et al.</i> 2019</a></span>. To monitor the digestion quality, three <em>Bombesin</em> peptide drops were spotted close to the tissue. Furthermore, the mouse kidney dataset contains internal calibrants that were sprayed together with the matrix onto the tissue and can be used to monitor intensity gradients and mass accuracy. The used calibrants were <em>Angiotensin I</em>, <em>Substance P</em>, <em>Fibrinopeptide B</em> and <em>ACTH_18-39</em>.</p>\n\n<p>The <em>*MSI Qualitycontrol</em> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> provides a fast way to obtain plenty of descriptive statistic plots for MSI datasets.\nInternal calibrants or other known, ubiquitous m/z features can be used to obtain further quality measures, such as m/z accuracies.</p>\n\n<p>The mouse kidney dataset contains internal calibrants that were sprayed together with the matrix onto the tissue. The used calibrants were <em>Angiotensin I</em>, <em>Substance P</em>,\n<em>Fibrinopeptide B</em> and <em>ACTH_18-39</em>. We furthermore spotted <em>Bombesin</em> peptides close to the tissue to monitor the digestion quality with the fold change of digested vs. undigested <em>Bombesin</em>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Running the MSI Qualitycontrol tool</hands-on-title>\n  <ol>\n    <li>Create the tabular file with the m/z values of the internal calibrants:\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>m/z       name\n1296.69    Angiotensin_I\n1347.72    Substance_P\n1570.68    Fibrinopeptide_B\n2465.19    ACTH_18-39\n</code></pre></div>      </div>\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-file\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-file\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new file</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong> at the bottom</li>   <li>Paste the file contents into the text field</li>   <li>From the Settings menu (<i class=\"fas fa-cog\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-gear</span>) select <strong>Convert spaces to tabs</strong>* Press <strong>Start</strong> and <strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p><strong>Rename dataset</strong> to <code class=\"language-plaintext highlighter-rouge\">Calibrants</code></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-dataset\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-dataset\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a dataset</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field  to <code class=\"language-plaintext highlighter-rouge\">Calibrants</code></li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Run the <strong>MSI Qualitycontrol</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“MSI data”</em>: <code class=\"language-plaintext highlighter-rouge\">mouse_kidney_cut imzML</code> will be automatically recognized as input file</li>\n        <li><em>“Title”</em>: <code class=\"language-plaintext highlighter-rouge\">Mouse kidney introduction tutorial</code></li>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“m/z of interest”</em>: Select the <code class=\"language-plaintext highlighter-rouge\">Calibrants</code> tabular file</li>\n        <li><em>“Column with m/z values”</em>: <code class=\"language-plaintext highlighter-rouge\">Column: 1</code></li>\n        <li><em>“Column with name of m/z values”</em>: <code class=\"language-plaintext highlighter-rouge\">Column: 2</code></li>\n        <li><em>“Tabular file contains a header line”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Plot fold change of two m/z”</em>: <code class=\"language-plaintext highlighter-rouge\">Insert Plot fold change of two m/z</code></li>\n        <li><em>“M/z 1”</em>: <code class=\"language-plaintext highlighter-rouge\">1224.63</code> (digested <em>Bombesin</em>)</li>\n        <li><em>“M/z 2”</em>: <code class=\"language-plaintext highlighter-rouge\">1619.89</code> (full length <em>Bombesin</em>)</li>\n        <li>Press <strong>Run Tool</strong></li>\n      </ul>\n    </li>\n  </ol>\n</blockquote>\n\n<p>Open the pdf by clicking on the eye icon (view data) and answer the following questions according to the summary table on the first page.</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many m/z features does the dataset contain?</li>\n    <li>Are the spectra in profile mode or centroided?</li>\n    <li>What is the median number of peaks per spectrum and how can this number be interpreted?</li>\n    <li>How many of the provided Calibrants were valid?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <ol>\n      <li>9013</li>\n      <li>Centroided = FALSE means that the data were read in profile mode. The user has to define in every tool if the input data is in profile or centroided mode. The Centroid value reported here corresponds to the choice the user has made in the tool and not by automatic recognition. To find out what the correct choice is visit <a href=\"/training-material/topics/metabolomics/tutorials/msi-analyte-distribution/tutorial.html#quality-control-of-the-data\">Mass spectrometry imaging: Examining the spatial distribution of analytes</a>.</li>\n      <li>Median # peaks per spectrum: 4158. The <strong>MSI Qualitycontrol</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> consideres intensities &gt; 0 as peaks. Before peak picking this means that also noise with small intensities is counted as peak what explains why nearly every second m/z value has an intensity &gt; 0 (4158 peaks /9013 m/z values). After peak picking the number of peaks will decrease dramatically because only real peaks will be left.</li>\n      <li>3 Calibrants out of the 4 Calibrants in the tabular files were valid, that means in the m/z range of the dataset. As we cut the m/z axis for this tutorial, <em>ACTH</em> is outside the m/z range that we kept (1220 - 1625).</li>\n    </ol>\n  </blockquote>\n</blockquote>\n\n<p>Each plot of the <strong>MSI Qualitycontrol</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> is described in the help section at the bottom of the tool, this tutorial will discuss a few selected plots in more detail.</p>\n\n<h4 id=\"digestion-efficiency\">Digestion efficiency</h4>\n\n<p>The complete digestion of proteins into peptides is a crucial step when performing mass spectrometry of peptides. In MSI the digestion is further hindered by the fact that digestion has to occur on the tissue. One way to control digestion efficiency was suggested by <a href=\"https://www.sciencedirect.com/science/article/pii/S1570963916301820?via%3Dihub\">Erich et al.</a>. They spotted <em>cytochrome c</em> next to the tissue before and after digestion and compared the protein intensities in the two spots.</p>\n\n<p>For the mouse kidney dataset we applied a similar approach and added three <em>bombesin</em> spots next to the kidney tissue (Figure 2) before digestion. <em>Bombesin</em> has the amino acid sequence QRLGNQWAVGHLM and a mass of 1619.89 Da. During trypsin digestion <em>bombesin</em> is cleaved by trypsin after arginin (R) what leads to the cleaved peptide LGNQWAVGHLM with a mass of 1224.63 Da. The digestion efficiency can be estimated from the log2 ratio (fold change) of these two peptides in the pixels of the <em>bombesin</em> spot.</p>\n\n<p>The fold change plots are on page 4 and 5 of the pdf report. The first plot shows the average mass spectra for the digested and the undigested <em>bombesin</em> peptides. The blue lines indicate the provided m/z value and the chosen ppm range. The average intensity of the full length <em>bombesin</em> peptide is higher than the one of the digested peptide but the average intensity is not helpful here, because we only spotted one drop next to the tissue and only the intensity fold change in those pixels is important. The spectra plot is useful to control the chosen m/z value and ppm range. To obtain the log2 fold change in each spectrum, for each peptide the intensities in the m/z ranges are averaged, the intensity of the first m/z feature is divided by the intensity of the second m/z feature and log2 transformed. The log2 fold change for each spectrum (pixel) is plotted on page 5 and reveals that many spectra in the upper left corner (where the <em>bombesin</em> spot is) have a log2 fold change &gt;= 0 what indicates that there is more digested than undigested <em>bombesin</em> peptides and that the tryptic digestion was successful.</p>\n\n<figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_foldchange.png\" alt=\"Fold Change. \" width=\"1128\" height=\"568\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_foldchange.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> Avererage mass spectra and log2 fold change for Bombesin and its digested peptide</figcaption></figure>\n\n<h4 id=\"distribution-images-for-calibrants\">Distribution images for Calibrants</h4>\n\n<p>Have a look at the calibrant plots from page 6 on, especially regarding the distribution patterns. The colour code shows the intensity of the m/z value that is closest to the input m/z and if the ppm range contains several m/z features their intensities are averaged. The input m/z value and its name are printed on top of the image, the m/z number in the box shows the closest m/z value (that is 1296.68, as the m/z axis consists of mass bins slight differences are expected). Low <em>angiotensin</em> intensities occur at the boarder of the <em>bombesin</em> spot and at the boarder of the kidney tissue and on some spots in the kidney. In general calibrant intensities are higher in the matrix background than on the tissue due to ion suppression effects. <em>Substance P</em> shows also ion suppression in the <em>bombesin</em> spot. The heatmap shows no spatial intensity gradient what indicates that spraying of calibrants and matrix was homogeneous and that the MS performed stable during data acquisition.</p>\n\n<figure id=\"figure-5\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_angiotensin_image.png\" alt=\"Angiotensin heatmap. \" width=\"587\" height=\"543\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_angiotensin_image.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 5</strong>:</span> Intensity distribution image of Angiotensin I</figcaption></figure>\n\n<blockquote class=\"comment\">\n  <comment-title>Plotting heatmaps</comment-title>\n  <ul>\n    <li>The <strong>MSI mz images</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool allows to generate heatmaps with futher options such as contrast enhancement and smoothing functions. The usage of the tool is explained in more detail in the tutorial <a href=\"/training-material/topics/metabolomics/tutorials/msi-analyte-distribution/tutorial.html\">Mass spectrometry imaging: Examining the spatial distribution of analytes</a>.</li>\n  </ul>\n</blockquote>\n\n<h4 id=\"number-of-peaks-and-total-ion-current-images\">Number of peaks and total ion current images</h4>\n\n<p>On page 9 the number of peaks per spectrum is plotted and the shape of the kidney can be estimated due to slightly higher number of peaks. The number of peaks is defined as intensity &gt; 0 what means that before peak picking also noise with intensity &gt; 0 is counted in. It is quite common for raw MALDI datasets to have a noise baseline in each spectrum and therefore high amounts of ‘peaks’ before baseline removal is performed. For the mouse kidney dataset baseline removal was already done during acquisition but as also suggested by the median number of peaks per spectrum in the summary table, about half of every m/z value has an intensity &gt; 0. This suggests to check the mass spectra for a baseline and if applicable remove the baseline during preprocessing of the data.</p>\n\n<p>The plot on page 10 shows the total ion current (TIC) for each spectrum with a few outlier TIC &gt; 25000. The TIC is the sum of all intensities of a spectrum. Therefore with more peaks in a spectrum the TIC should also be higher. Due to their low intensities, noise peaks contribute less to the TIC than analyte peaks, but with the large amount of noise we have in this dataset, this of course also sums up. Deviations in TICs are common in MALDI MSI due to e.g. unhomogeneous matrix spray, ion source contamination or pH gradients. To render the spectra more comparable TIC normalization is a default preprocessing step for MALDI MSI data but is based on the assumption that there are comparable numbers of signals present in each spectrum <a href=\"https://link.springer.com/article/10.1007%2Fs00216-011-4929-z\">Deininger et al.</a>.\nBoth plots can also serve to check for spraying gradients or reduced machine performance during acquisition time. The mouse kidney was measured from bottom to top (plot on page 2), the performance over time can be easier spotted in the upper plots on page 14 and 15, where the x axis represents the spectra in the order they were measured.</p>\n\n<figure id=\"figure-6\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_npeaks_TIC.png\" alt=\"Npeaks and TIC heatmap. \" width=\"958\" height=\"524\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_npeaks_TIC.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 6</strong>:</span> Number of peaks and TIC per spectrum</figcaption></figure>\n\n<h4 id=\"most-abundand-mz-features\">Most abundand m/z features</h4>\n\n<p>The plot on page 13 shows for each spectrum the m/z with the highest intensity (‘base peak’). This plot can already reveal some morphological features of the dataset. The plot for the mouse kidney dataset shows that the base peak is the same on the kidney tissue and the matrix background but a different one in the <em>bombesin</em> spot. According to the legend the base peak in most spectra is roughly at m/z 1350, the base peak in the <em>bombesin</em> spot is roughly at 1280 and in a few spectra at 1570. Later, we will export the spectra information, including the base peak of each spectrum, as a tabular file to find the correct m/z values of the most abundant features in the following spectra: x = 40 y = 50; x = 23, y = 70; x = 20, y = 73.</p>\n\n<figure id=\"figure-7\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_most_abundant.png\" alt=\"most abundant. \" width=\"350\" height=\"455\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_most_abundant.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 7</strong>:</span> Most abundant m/z for each spectrum and three selected pixel for further investigations</figcaption></figure>\n\n<p>As the feature around m/z 1350 is the highest feature in most of the spectra it is no suprise to find this feature as highest peak in the average spectra plot on page 20. The second highest peak is around 1300 m/z. It is obvious that those features are the calibrants <em>substance P</em> and <em>angiotensin</em> as they occur as high intensity peaks on the tissue as well as on the background. At least the concentration of <em>substance P</em> but also the concentration of <em>angiotensin I</em> could be reduced in further experiments. The concentration of <em>fibrinopeptide B</em> is chosen well as the peak at m/z 1570 is visible in most of the spectra plots but does not dominate the spectra as the other two calibrants do.</p>\n\n<h4 id=\"mz-accuracy\">m/z accuracy</h4>\n\n<p>A MSI dataset has not only deviations in the intensity dimension but also in the m/z dimension. Mass shifts can occur due to sample topography, small length changes in the flight tube or instable high voltage power supply. Mass accuracy is important for two reasons: First, the identification of m/z relies on accurate mass values and second, comparing m/z features across several spectra or even samples requires them to have similar values in order to be considered as the same molecule.</p>\n\n<p>For precise m/z measurements the mass spectrometers are regularly calibrated with external calibrants that are often applied next to the sample. <a href=\"https://www.sciencedirect.com/science/article/pii/S1874391912003259?via%3Dihub\">Gustafsson et al.</a> sprayed calibrants onto the complete sample and after MSI measurement used those internal calibrants to recalibrate every spectra what dramatically reduced the m/z error and improved the identification of the m/z features. The same approach was used for the mouse kidney dataset that we use in this tutorial: three internal calibrants are in the m/z range that we work with. These calibrants enable the calculation of the average m/z error as well as the m/z error in each spectrum.</p>\n\n<p>Starting at page 22 for each of the three calibrants average mass spectra are plotted. Three different m/z ranges are visualized while the fourth plot represents each datapoint as blue dot what helps to estimate the correct window sizes during preprocessing of the data. The dashed blue line represents the theoretical m/z, the red line indicates the m/z with the highest average intensity and the green line shows the m/z value that is closest to the theoretical m/z. For <em>angiotensin I</em> the theoretical m/z value is ~0.06 m/z higher than the peak maximum. There is no m/z value with the exact m/z of <em>angiotensin I</em> (1296.69), the closest m/z value is 1296.6776 (green line). The following barplot (on page 25) shows the average m/z error for each calibrant by taking the difference between the m/z of the peak maximum and the theoretical m/z. For <em>angiotensin I</em> this is 1296.6346 - 1296.69 = -0.0554 m/z and corresponds to 0.0554/1296.69*1000000 = 42.7 ppm. The next barplot shows the smallest m/z error that is possible due to the discrete m/z bins of the dataset: the difference between the closest m/z value and the theoretical m/z value.</p>\n\n<p>The average m/z error already gives a hint about the m/z accuracy but it is even more important to consider the m/z error in each individual spectrum. The plot on page 27 shows for each calibrant the m/z error in each spectrum. The spectra index corresponds to the order in which the spectra were measured and it becomes obvious that for all calibrants there is a m/z shift of about 200 ppm happening during acquisition. This gradient is also visible in the following plots where the m/z error in ppm is plotted in each pixel. The ppm error for <em>angiotensin</em> is about +50 ppm at the bottom of the dataset (start of acquisition) and decreases to about -150 ppm at the top of the image (end of acquisition). To be able to compare m/z features across the spectra they need to have the same m/z value, therefore recalibration with the <strong>MALDIquant preprocessing</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> or binning with the <strong>MSI preprocessing</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> and a  tolerance of 200 ppm is highly recommended.</p>\n\n<figure id=\"figure-8\" style=\"max-width: 90%;\"><img src=\"../../images/MSI1_mz_error.png\" alt=\"mz error. \" width=\"1142\" height=\"929\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/MSI1_mz_error.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 8</strong>:</span> Plots that show the average and individual m/z errors</figcaption></figure>\n\n<blockquote class=\"comment\">\n  <comment-title>Plotting mass spectra</comment-title>\n  <ul>\n    <li>The <strong>MSI plot spectra</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool allows to single, average or overlayed mass spectra plots and to zoom into m/z regions of interest. The tool is explained in more detail in the tutorial <a href=\"/training-material/topics/metabolomics/tutorials/msi-analyte-distribution/tutorial.html\">Mass spectrometry imaging: Examining the spatial distribution of analytes</a>.</li>\n  </ul>\n</blockquote>\n\n<h1 id=\"exporting-msi-data-to-tabular-files-for-further-exploration-of-the-data\">Exporting MSI data to tabular files for further exploration of the data</h1>\n\n<p>The data from the imzML file format is not directly readable, therefore special tools are needed to extract its information. The <strong>MSI data exporter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> provides the option to export spectra, feature and intensity data from imzML files as tabular files. The underlaying values of the quality report can be found in the tabular files and allow to follow up on interesting aspects seen in the quality report plots. Furthermore, tabular files are compatible with most software for statistical analysis and visualization. The intensity matrix of an unprocessed file might be huge as all pixels and all m/z values are stored in the file - therefore, the intensity matrix is often more helpful after preprocessing and filtering of the data. Despite preprocessing and filtering, the output tabular files are often too large for visual inspection. Galaxy offers many different text manipulation tools that are helpful to sort and filter such large tabular files.</p>\n\n<p>To find the m/z value that has the highest mean intensity across all pixels, the feature data can be sorted on the column with the mean intensities. Keep in mind that so far also background spectra are included in the calculation of the mean intensity and those would need to be removed before the mean intensities for the tissue can be calculated.\nThe spectra data output can be filtered for certain spectra to obtain some spectra properties such as the accurate value of its base peak that could not be accurately determined in the corresponding plot of the quality report before.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Export and explore information from MSI data</hands-on-title>\n\n  <ol>\n    <li>Run <strong>MSI data exporter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“MSI data”</em>: <code class=\"language-plaintext highlighter-rouge\">mouse_kidney_cut imzML</code></li>\n        <li><em>“Multiple output files can be selected”</em>: <code class=\"language-plaintext highlighter-rouge\">mz feature output</code> and <code class=\"language-plaintext highlighter-rouge\">pixel output</code></li>\n      </ul>\n    </li>\n    <li>Run <strong>Sort data in ascending or descending order</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> from the ‘text manipulation’ category with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Sort Query”</em>: <code class=\"language-plaintext highlighter-rouge\">Data exporter features</code> (output of <strong>MSI data exporter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li><em>“Number of header lines”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code></li>\n        <li><em>“on column”</em>: <code class=\"language-plaintext highlighter-rouge\">column: 3</code></li>\n        <li><em>“in”</em>: <code class=\"language-plaintext highlighter-rouge\">descending order</code></li>\n        <li><em>“Flavor”</em>: <code class=\"language-plaintext highlighter-rouge\">general numeric sort</code></li>\n      </ul>\n    </li>\n    <li>Run <strong>Select lines that match an expression</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> from the ‘filter and sort’ category with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Select lines from”</em>: <code class=\"language-plaintext highlighter-rouge\">Data exporter spectra</code> (output of <strong>MSI data exporter</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>)</li>\n        <li><em>“the pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">(xy_40_40)|(xy_23_70)|(xy_20_73)</code></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many spectra does the dataset contain?</li>\n    <li>How many numeric properties does the m/z feature output report?</li>\n    <li>Which m/z values have the highest mean intensities over all pixels?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n    <ol>\n      <li>1581 - Clicking on pixel output file name reveals that it has 1582 lines, every line contains the information of one spectrum, but the first line is a header line (click on dataset “MSI data exporter on data 1: spectra” in the history, the line number of the file is written below the dataset name)</li>\n      <li>7 - The feature file has 8 columns and except for the mz_names, all columns contain numeric properties, that can be used for further calculations.</li>\n      <li>The top m/z values are around 1347.71 and its isotopes (+1 m/z). This m/z feature derives from the <em>substance P</em> internal calibrant (the m/z value is not accurate and ondolates a bit because the data was not yet binned or aligned).</li>\n    </ol>\n  </blockquote>\n</blockquote>\n\n<p>Exporting and sorting the feature information reveals that <em>substance P</em> has the highest mean intensity across all spectra what confirms our estimation when examining the average spectrum plot.\nExporting and filtering the spectra information for three pixel that have different base peaks confirms that the calibrants are the most abundant peaks in most of the spectra. <em>Substance P</em> is the base peak in spectrum xy_40_40 and thereby also the most abundant peak in most of the spectra (according to the colouring in the ‘most abundant m/z in each spectrum’ plot) regardless if they belong to tissue or matrix. Only the pixels that belong to the <em>bombesin</em> spot show different base peaks. In spectrum xy_23_70 <em>angiotensin I</em> is the highest feature while in spectrum xy_20_73 <em>fibrinopeptide B</em> appears as base peak.</p>\n\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-11-03 14:30:27 +0000","pub_date":"2018-11-27 16:18:26 +0000","version":30,"workflows":[{"workflow":"ms_imaging_loading_exploring_data.ga","tests":false,"url":"https://training.galaxyproject.org/training-material/topics/proteomics/tutorials/mass-spectrometry-imaging-loading-exploring-data/workflows/ms_imaging_loading_exploring_data.ga","path":"topics/proteomics/tutorials/mass-spectrometry-imaging-loading-exploring-data/workflows/ms_imaging_loading_exploring_data.ga","wfid":"proteomics-mass-spectrometry-imaging-loading-exploring-data","wfname":"ms_imaging_loading_exploring_data","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/proteomics-mass-spectrometry-imaging-loading-exploring-data/versions/ms_imaging_loading_exploring_data","license":null,"creators":[],"name":"MS Imaging Loading Exploring Data","title":"MS Imaging Loading Exploring Data","test_results":null,"modified":"2024-06-20 00:05:29 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nmouse_kidney_cut.i\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"ℹ️ Input Dataset\\ninternal calibrants.tab\"];\n  style 1 stroke:#2c3143,stroke-width:4px;\n  2[\"MSI data exporter\"];\n  0 -->|output| 2;\n  3[\"MSI Qualitycontrol\"];\n  1 -->|output| 3;\n  0 -->|output| 3;\n  4[\"Sort\"];\n  2 -->|feature_output| 4;\n  5[\"Select\"];\n  2 -->|pixel_output| 5;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/proteomics/tutorials/mass-spectrometry-imaging-loading-exploring-data/tutorial.json","tools":["Grep1","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_sort_header_tool/1.1.1","toolshed.g2.bx.psu.edu/repos/galaxyp/cardinal_data_exporter/cardinal_data_exporter/1.12.1.1","toolshed.g2.bx.psu.edu/repos/galaxyp/cardinal_quality_report/cardinal_quality_report/1.12.1.2"],"supported_servers":{"exact":[{"url":"https://usegalaxy.be/","name":"UseGalaxy.be","usegalaxy":false},{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.cz/","name":"UseGalaxy.cz","usegalaxy":false},{"url":"https://usegalaxy.fr/","name":"UseGalaxy.fr","usegalaxy":false},{"url":"https://usegalaxy.no/","name":"UseGalaxy.no","usegalaxy":false},{"url":"https://usegalaxy.org.au","name":"UseGalaxy.org.au","usegalaxy":true}]},"topic_name_human":"Proteomics","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"cardinal_data_exporter","owner":"galaxyp","revisions":"d94770c22f13","tool_panel_section_label":"Proteomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"cardinal_quality_report","owner":"galaxyp","revisions":"16556ca0196b","tool_panel_section_label":"Proteomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: cardinal_data_exporter\n  owner: galaxyp\n  revisions: d94770c22f13\n  tool_panel_section_label: Proteomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: cardinal_quality_report\n  owner: galaxyp\n  revisions: 16556ca0196b\n  tool_panel_section_label: Proteomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}