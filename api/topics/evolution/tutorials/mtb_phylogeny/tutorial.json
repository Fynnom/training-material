{"layout":"tutorial_hands_on","title":"Tree thinking for tuberculosis evolution and epidemiology","zenodo_link":"https://zenodo.org/record/6010176","level":"Introductory","questions":["What information can I get from a phylogenetic tree?","How do I estimate a phylogeny?"],"objectives":["Understand the basic concepts behind phylogenetic trees, as applied to *Mycobacterium tuberculosis*","Be able to read and interrogate a phylogeny encountered in the literature"],"time_estimation":"1H","requirements":[{"type":"internal","topic_name":"variant-analysis","tutorials":["tb-variant-analysis"]},{"type":"internal","topic_name":"evolution","tutorials":["mtb_transmission"]}],"contributions":{"authorship":["cstritt","dbrites","GaloGS"],"editing":["wm75"]},"tags":["prokaryote","one-health","phylogenetics","microgalaxy"],"edam_ontology":["topic_0622","topic_3301","topic_0084","topic_3324"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00144","url":"/topics/evolution/tutorials/mtb_phylogeny/tutorial.html","topic_name":"evolution","tutorial_name":"mtb_phylogeny","dir":"topics/evolution/tutorials/mtb_phylogeny","symlink":null,"id":"evolution/mtb_phylogeny","ref_tutorials":["<blockquote class=\"quote\" author=\"Theodosius Dobzhansky\" year=\"1973\">\n  <p>“Nothing in biology makes sense except in the light of evolution.”</p>\n</blockquote>\n\n<p>Phylogenetic trees are a tool for organizing biological diversity. Just as maps provide a spatial framework to the geographer, phylogenies provide an evolutionary context to the biologist: they capture the relationship among “things” (species, individuals, genes), represented as tips in the tree, based on common ancestry.</p>\n\n<p>In evolutionary and epidemiological studies of <em>Mycobacterium tuberculosis</em>, it is now common to encounter large phylogenetic trees. Being able to read and critically examine them is extremely useful. Phylogenies can be used to understand the origin of a disease or the onset of an epidemic, to distinguish ongoing transmission from imported cases, to investigate how specific traits like antibiotic resistance evolve <em>et cetera et cetera</em>. Many research ideas originate from looking at and discussing patterns present in phylogenies.</p>\n\n<p>This tutorial provides an introduction to phylogenetic trees in the context of whole genome sequencing of <em>Mycobacterium tuberculosis</em> strains. Phylogenetics is a vast topic, and we can only scratch its surface here. For those motivated to delve deeper into the topic, the <a href=\"#resources\">Resources section</a> contains links and reading suggestions.</p>\n\n<h2 id=\"basic-concepts-how-to-read-a-phylogeny\">Basic concepts: How to read a phylogeny</h2>\n\n<p>Below are two phylogenies of the <em>Mycobacterium tuberculosis</em> complex (MTBC) to illustrate some basic vocabulary and concepts.</p>\n\n<blockquote class=\"details\">\n  <details-title>Need a more thorough introduction to the topic?</details-title>\n\n  <p>If the following discussion sounds a bit too esoteric, you might be interested in a more thorough introduction to the topic of phylogeny like provided, for example, by the <a href=\"https://www.ebi.ac.uk/training/online/courses/introduction-to-phylogenetics/\">introduction to phylogenetics</a> from the <a href=\"https://www.ebi.ac.uk/training/on-demand?facets=type:Online%20tutorial\">EMBL-EBI collection of online tutorials</a>.</p>\n\n</blockquote>\n\n<h3 id=\"rooted-trees-and-tree-topology\">Rooted trees and tree topology</h3>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><div style=\"overflow-x: auto\"><object data=\"./images/mtbc_1strainPerLineage.nwk.COMB.svg\" type=\"image/svg+xml\" alt=\"Phylogeny. \">Phylogeny.</object></div><a target=\"_blank\" href=\"./images/mtbc_1strainPerLineage.nwk.COMB.svg\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> Rooted [A] and unrooted [B] phylogeny of the MTBC. Some basic tree vocabulary is shown in red.</figcaption></figure>\n\n<p>The trees in figure 1 look rather different at a first glance, but they are identical except for one key aspect: tree A is <strong>rooted</strong> while tree B is not.</p>\n\n<p>What is the difference between the two? First, let’s state what is the same in the two trees: the tree <strong>topology</strong>, that is, the relative branching order. The same groupings are present in the two trees: they both contain the same information about the <strong>relatedness</strong> of strains. An example: TB isolated from Peruvian mummies is most similar to <em>M. pinnipedii</em> known from marine mammals; they share a most recent common ancestor. This can be seen in the rooted as well as in the unrooted tree.</p>\n\n<p>The key difference between the rooted and the unrooted tree is that only the rooted tree shows the <strong>direction</strong> and sequence of branching events. The unrooted tree does not tell us, for example, whether <em>M. bovis</em> diverged early or late in the history of the MTBC. It is thus compatible with the old hypothesis that human TB evolved from animal TB. The rooted tree shows that this hypothesis is most likely wrong: animal-associated strains are not ancestral to human-associated strains.</p>\n\n<p>The best way to root a tree is by including an <strong>outgroup</strong>: a species or lineage which we know <em>a priori</em> to lay outside the phylogeny we’re interested in. <em>M. canettii</em> usually serves this purpose for studying the MTBC, but you can also root, for example, a phylogeny of lineage 2 by including a lineage 4 strain.</p>\n\n<h3 id=\"branch-lengths\">Branch lengths</h3>\n\n<p>Besides relatedness and direction, a third important piece of information contained in a phylogeny is the branch length. When a phylogeny has been estimated from DNA or protein sequences, branch lengths usually reflect the evolutionary distance between nodes in the tree. This information can be used to translate distance in terms of expected nucleotide changes into years, and thus to connect evolutionary change to historical events.</p>\n\n<figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"./images/eldholm2016_tree.png\" alt=\"Phylogeny. \" width=\"310\" height=\"734\" loading=\"lazy\" /><a target=\"_blank\" href=\"./images/eldholm2016_tree.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> Phylogeny of the central Asian clade, including the Oslo outbreak. Modified Eldholm et al. 2016.</figcaption></figure>\n\n<p>As branch lengths reflect evolutionary distances, they can also be used to identify transmission clusters and outbreaks. Figure 2 shows a (rooted) tree of the Central Asian Clade (CAC), which is part of lineage 2 (<span class=\"citation\"><a href=\"#Eldholm2016\">Eldholm <i>et al.</i> 2016</a></span>). The orange color highlights the Afghan strain family within the CAC. At the bottom of the tree, note the clade with short branch lengths. This is how one would expect an outbreak to look in a phylogenetic tree: a set of strains clustering together and separated by extremely short branches, reflecting their almost identical genomes.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>Phylogenetics with <i>Mycobacterium tuberculosis</i></comment-title>\n\n  <p>Phylogenetics with MTB has some particularities rarely encountered with other organisms.</p>\n\n  <ol>\n    <li>\n      <p>There seems to be <strong>no horizontal gene transfer</strong> (HGT) in the MTBC. HGT complicates phylogenetic inference in many bacteria because a piece of DNA introduced by HGT has a different history and thus phylogeny than genes not affected by HGT.</p>\n    </li>\n    <li>\n      <p>There is <strong>little genetic diversity</strong> in the MTBC: any two strains differ by only around 2,500 SNPs over the whole genome. To achieve a good resolution of recent evolution (e.g. during an outbreak), whole genome sequences are thus extremely useful.</p>\n    </li>\n    <li>\n      <p>A large proportion of DNA polymorphisms in the MTBC are <strong>singletons</strong>, that is, variants present only in a single strain. This adds to the problem of low diversity, since singletons are not informative about tree topology.</p>\n    </li>\n    <li>\n      <p>In this workshop, and indeed in many studies of the MTBC, SNPs are called not against the reference strain H37Rv, but against a reconstructed ancestral genome. This means that the number of SNPs identified does not reflect the evolutionary distance from some random strain like H37Rv, but from the most recent common ancestor of the MTBC. Take a look at Figure 3 in <span class=\"citation\"><a href=\"#Goig2018\">Goig <i>et al.</i> 2018</a></span> to see how this affects the number of SNPs identified in a genome. Below we will see that this has implications for the interpretation of a tree.</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"infering-phylogeny-from-snp-alignments\">Infering phylogeny from SNP alignments</h2>\n\n<p>Aligned DNA or protein sequences are the starting material for phylogenetic inference with molecular data.</p>\n\n<p>In this tutorial we will explore the phylogenetic relationship between 19 MTBC strains and 1 strain of <em>M. canettii</em>, where the latter is included as outgroup, allowing us to root the phylogeny. Our starting point will be an alignment of all SNPs identified from whole-genome sequencing data of these 20 strains. This <em>SNP alignment</em> was generated by</p>\n\n<ol>\n  <li>mapping short sequenced reads from each sample to the infered sequence of the most recent common ancestor of the MTBC as the reference</li>\n  <li>calling variants against that reference from the mapped reads of each sample</li>\n  <li>incorporating the SNP variants of each sample into the reference to obtain a consensus genome of that sample</li>\n  <li>combining the consensus genomes into a single multi-sequence fasta dataset</li>\n  <li>discarding bases found to be identical in all samples from all sequences</li>\n</ol>\n\n<blockquote class=\"comment\">\n  <comment-title>Recommended tutorials</comment-title>\n\n  <p>Steps 1 and 2 are explained in detail in the tutorial <a href=\"/training-material/topics/variant-analysis/tutorials/tb-variant-analysis/tutorial.html\">MTB variant analysis</a>.\nSteps 3 - 5 are conducted for the exact same 20 samples used here in the <a href=\"/training-material/topics/evolution/tutorials/mtb_transmission/tutorial.html\">tutorial on transmission clusters</a>.</p>\n\n  <p>If you want to gain a complete understanding of the whole process of sequencing-based analysis of MTBC strains, we recommend you, if you have not done so yet, to work through these two tutorials in the order above before continuing with this one here.</p>\n\n</blockquote>\n\n<p>Figure 3 shows a snapshot of an illustrative SNP alignment.\nEach row in the alignment represents a different strain, each column a position in the reference genome.</p>\n\n<figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"./images/MEGA_alignment.png\" alt=\"Alignment. \" width=\"1478\" height=\"840\" loading=\"lazy\" /><a target=\"_blank\" href=\"./images/MEGA_alignment.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> Illustrative example of a SNP alignment. Note the absence of conserved positions.</figcaption></figure>\n\n<p>Because this alignment is based on SNPs, it contains <em>only variable positions</em>. This is important to keep in mind! Genetic distances between strains will be hugely overestimated if we leave out all the positions which show no variation!</p>\n\n<p>Near the end of this tutorial, we will show and discuss ways to correct for this.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>The alternative approach: genome assembly</comment-title>\n\n  <p>A frequently used alternative approach to obtain a phylogeny from short read data is to a) assemble the genomes (see the numerous <a href=\"/training-material/topics/assembly/index.html\">Galaxy tutorials</a> on this topic), b) annotate genes, c) extract genes present in all strains (the “core” genes), d) align the core genes. This approach underlies core genome multilocus sequence typing (cgMLST), which is often used to genotype bacterial pathogens (e.g. <span class=\"citation\"><a href=\"#Zhou2021\">Zhou <i>et al.</i> 2021</a></span>).</p>\n\n</blockquote>\n\n<p>With this bit of introduction you should, hopefully, be prepared to follow the flow and purpose of the analysis presented here.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#basic-concepts-how-to-read-a-phylogeny\" id=\"markdown-toc-basic-concepts-how-to-read-a-phylogeny\">Basic concepts: How to read a phylogeny</a></li>\n  <li><a href=\"#infering-phylogeny-from-snp-alignments\" id=\"markdown-toc-infering-phylogeny-from-snp-alignments\">Infering phylogeny from SNP alignments</a></li>\n  <li><a href=\"#phylogenetic-analysis-of-mtbc-strains-with-galaxy-and-rstudio\" id=\"markdown-toc-phylogenetic-analysis-of-mtbc-strains-with-galaxy-and-rstudio\">Phylogenetic analysis of MTBC strains with Galaxy and Rstudio</a>    <ol>\n      <li><a href=\"#get-the-data\" id=\"markdown-toc-get-the-data\">Get the data</a></li>\n      <li><a href=\"#estimate-a-phylogeny\" id=\"markdown-toc-estimate-a-phylogeny\">Estimate a phylogeny</a></li>\n      <li><a href=\"#visualize-and-manipulate-the-tree\" id=\"markdown-toc-visualize-and-manipulate-the-tree\">Visualize and manipulate the tree</a></li>\n      <li><a href=\"#plot-the-raxml-output\" id=\"markdown-toc-plot-the-raxml-output\">Plot the RAxML output</a></li>\n      <li><a href=\"#root-the-tree\" id=\"markdown-toc-root-the-tree\">Root the tree</a></li>\n      <li><a href=\"#create-tree-with-lineage-as-tip-label-instead-of-strain-name\" id=\"markdown-toc-create-tree-with-lineage-as-tip-label-instead-of-strain-name\">Create tree with lineage as tip label instead of strain name</a></li>\n      <li><a href=\"#first-round-of-exercises\" id=\"markdown-toc-first-round-of-exercises\">First round of exercises</a></li>\n      <li><a href=\"#map-a-trait-onto-the-tree\" id=\"markdown-toc-map-a-trait-onto-the-tree\">Map a trait onto the tree</a></li>\n      <li><a href=\"#exercises-continued\" id=\"markdown-toc-exercises-continued\">Exercises continued</a></li>\n      <li><a href=\"#date-the-phylogeny-advanced\" id=\"markdown-toc-date-the-phylogeny-advanced\">Date the phylogeny (advanced)</a></li>\n      <li><a href=\"#final-exercise\" id=\"markdown-toc-final-exercise\">Final exercise</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n  <li><a href=\"#resources\" id=\"markdown-toc-resources\">Resources</a>    <ol>\n      <li><a href=\"#books\" id=\"markdown-toc-books\">Books</a></li>\n      <li><a href=\"#useful-links\" id=\"markdown-toc-useful-links\">Useful links</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"phylogenetic-analysis-of-mtbc-strains-with-galaxy-and-rstudio\">Phylogenetic analysis of MTBC strains with Galaxy and Rstudio</h1>\n\n<h2 id=\"get-the-data\">Get the data</h2>\n\n<p>If you have worked at least through the first part of the <a href=\"/training-material/topics/evolution/tutorials/mtb_transmission/tutorial.html\">tutorial on transmission clusters</a> before coming here, you are all set.</p>\n\n<p>You can continue working in the same history you created for the other tutorial, or copy the <em>SNP alignment</em> (the output of <strong>Finds SNP sites</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>) over to a new one, and can safely skip the following first hands-on part.</p>\n\n<p>If you are not interested in that other tutorial, here are the instructions for setting up a history for the analysis here, and for obtaining a copy of the SNP alignment from <a href=\"https://zenodo.org/record/6010176\">Zenodo</a>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Create a new history and prepare the input data</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a new history for this analysis</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Give the history a suitable name</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Click on <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name (which by default is “Unnamed history”)</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">MTB tree thinking tutorial</code></li>   <li>Click on <strong>Save</strong></li> </ol>   <p>If you do not have the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name:</p>   <ol>   <li>Click on <strong>Unnamed history</strong> (or the current name of the history) (<strong>Click to rename history</strong>) at the top of your history panel</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">MTB tree thinking tutorial</code></li>   <li>Press <kbd>Enter</kbd></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p><span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> a version of the SNP alignment via this URL</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/6010176/files/SNP_alignment.fasta\n</code></pre></div>      </div>\n\n      <p>and make sure the dataset format is set to <code class=\"language-plaintext highlighter-rouge\">fasta</code>.</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Change <strong>Type (set all):</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">fasta</code></p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_replace_in_line/1.1.2\" title=\"Replace Text in entire line tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace Text in entire line</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.2)</span> to clean up the aligned sequence names</p>\n\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: the uploaded SNP alignment</li>\n        <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Replacement”</em>:\n          <ul>\n            <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^(&gt;.+)\\.fastq.*</code></li>\n            <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">\\1</code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <p>From just a brief inspection of the downloaded SNP alignment, you should see that the sequence names in that file carry a <code class=\"language-plaintext highlighter-rouge\">.fastq.vcf</code> or <code class=\"language-plaintext highlighter-rouge\">.fastq.gz.vcf</code> suffix on the actual sample names.\nThe above replacement operation, drops these unnecessary endings, which we would otherwise carry over to all outputs generated in the analysis.</p>\n    </li>\n    <li>\n      <p>When the Replace Text tool run is finished, <strong>rename</strong> the output dataset to, for example, <strong>SNP alignment</strong></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-dataset\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-dataset\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a dataset</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field  to <code class=\"language-plaintext highlighter-rouge\">SNP alignment</code></li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Take a look at the alignment</p>\n\n      <p>Click on the dataset that you just renamed to expand it in the history, then click on <i class=\"fas fa-chart-column\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-barchart</span> <strong>Visualize</strong> and try both, the “Editor” and the “Multiple Sequence Alignment”.</p>\n\n      <p>Can you see one of the MTBC particularities mentioned above, the predominance of singletons?</p>\n\n      <p>How many sites are there in the alignment?</p>\n\n      <p>Also take a look at the M. canettii sequence: being the outgroup, it has a large number of SNPs.</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"estimate-a-phylogeny\">Estimate a phylogeny</h2>\n\n<p>There are numerous methods to infer phylogenetic trees, but the most frequently used with large-scale molecular data are based on maximum likelihood and Bayesian inference. The details of how these methods construct trees from an alignment are beyond the scope of this introductory course. To be able to read trees, it is not necessary to know the statistical and computational details of how the trees are estimated. The books listed in the <a href=\"#resources\">Resources</a> section provide in-depth introductions into the different principles of phylogenetic inference, in particular Baum &amp; Smith 2013 and Yang 2014.</p>\n\n<p>In this tutorial, we will use the maximum likelihood method <a href=\"https://cme.h-its.org/exelixis/web/software/raxml/\">RAxML</a> to estimate a phylogenetic tree for the 20 strains.</p>\n\n<p>An aspect we ignore in this tutorial is the uncertainty involved in phylogenetic inference. While RAxML will deliver a single tree, not all aspects of this tree are equally well supported by the data. This uncertainty can be quantified through <strong>bootstrapping</strong>, a procedure where a large number of trees are estimated from random samples of the original data. If a certain split in the original tree is present in all the bootstrapped trees, then we can be confident about this split. Published phylogenies should always include a measure of uncertainty, while for this tutorial you will have to believe me that we are looking at a solid phylogeny…</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Estimate a phylogeny for 20 MTBC strains</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/raxml/raxml/8.2.12+galaxy0\" title=\"Phyogenetic reconstruction with RAxML tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Phyogenetic reconstruction with RAxML</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 8.2.12+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Source file with aligned sequences”</em>: <code class=\"language-plaintext highlighter-rouge\">output</code> (Input dataset)</li>\n        <li><em>“Model type”</em>: <code class=\"language-plaintext highlighter-rouge\">Nucleotide</code></li>\n        <li><em>“RAxML options to use”</em>: <code class=\"language-plaintext highlighter-rouge\">Required options only</code></li>\n      </ul>\n    </li>\n    <li>\n      <p>The RAxML output we are interested in is the <em>“Best-scoring ML tree”</em>.</p>\n\n      <p>Select it in you Galaxy history and take a look at it with the different <i class=\"fas fa-chart-column\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-barchart</span> visualization options offered by Galaxy.</p>\n\n      <figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"./images/tree_unrooted_galaxy_vis.png\" alt=\"Unrooted tree Galaxy visualization. \" width=\"500\" height=\"746\" loading=\"lazy\" /><a target=\"_blank\" href=\"./images/tree_unrooted_galaxy_vis.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> (Unrooted) RAxML tree in Galaxy's Phylogenetic Tree Visualization</figcaption></figure>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"visualize-and-manipulate-the-tree\">Visualize and manipulate the tree</h2>\n\n<p>Phylogenetic trees are great tools because they are at the same time quantitative (we can do calculations on branch lengths, estimate uncertainty of a tree topology etc.) and visually appealing, allowing to actually “see” biologically interesting patterns. Often this requires some tweaking of the tree, for example by coloring parts of the tree according to some background information we have about the samples.</p>\n\n<p>We will use R to plot and manipulate the phylogeny obtained from RAxML. We will provide you with the exact code to produce the figures we need, and, conveniently, you can run this code from an RStudio session that you can start as an interactive tool inside Galaxy.</p>\n\n<blockquote class=\"details\">\n  <details-title>Can I use my own coding environment?</details-title>\n\n  <p>If you have worked with R or RStudio previously, feel free to use any kind of coding environment for exploring and manipulating the RAxML tree we have produced - just download it from your history and import it into any R session you have access to.</p>\n\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Starting an RStudio session and setting things up</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Note the dataset number (the number in front of and separated with a <strong>:</strong> from the dataset name) of the <em>“Best-scoring ML tree”</em> output of RAxML</p>\n    </li>\n    <li>\n      <p>Run <span class=\"tool\" data-tool=\"interactive_tool_rstudio\" title=\"RStudio tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>RStudio</strong></span></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"hands_on\">   <div class=\"box-title hands_on-title\" id=\"hands-on-launch-rstudio\"><i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i> Hands-on: Launch RStudio</div>   <p>Depending on which server you are using, you may be able to run RStudio directly in Galaxy. If that is not available, RStudio Cloud can be an alternative.</p>   <blockquote class=\"tip\">   <tip-title>Launch RStudio in Galaxy</tip-title>   <p>Currently RStudio in Galaxy is only available on <a href=\"https://usegalaxy.eu\">UseGalaxy.eu</a> and <a href=\"https://usegalaxy.org\">UseGalaxy.org</a></p>   <ol>     <li>Open the Rstudio tool <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> by clicking <a href=\"https://usegalaxy.eu/?tool_id=interactive_tool_rstudio\">here to launch RStudio</a></li>     <li>Click Run Tool</li>     <li>The tool will start running and will stay running permanently</li>     <li>Click on the “User” menu at the top and go to “Active InteractiveTools” and locate the RStudio instance you started.</li>   </ol> </blockquote>   <blockquote class=\"tip\">   <tip-title>Launch RStudio Cloud if not available on Galaxy</tip-title>   <p>If RStudio is not available on the Galaxy instance:</p>   <ol>     <li>Register for <a href=\"https://client.login.rstudio.cloud/oauth/login?show_auth=0&amp;show_login=1&amp;show_setup=1\">RStudio Cloud</a>, or login if you already have an account</li>     <li>Create a new project</li>   </ol> </blockquote> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Install and use the <a href=\"https://cran.r-project.org/web/packages/ape/index.html\">ape R package</a>\n      <ol>\n        <li>Click on the <strong>Terminal</strong> tab (at the top of the Rstudio window)</li>\n        <li>\n          <p>Execute the command: <code class=\"language-plaintext highlighter-rouge\">conda install r-ape</code></p>\n\n          <p>This will install the ape package into the environment of the running session.</p>\n        </li>\n        <li>\n          <p>When the previous step has finished, switch back to the <strong>Console</strong> tab and run the command</p>\n\n          <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"s2\">\"ape\"</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre></div>          </div>\n\n          <p>You might get a warning about R versions, which you can ignore.</p>\n        </li>\n      </ol>\n    </li>\n    <li>\n      <p>Import the RAxML *“Best-scoring ML tree into the Rstudio session</p>\n\n      <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">treefile</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">gx_get</span><span class=\"p\">(</span><span class=\"c1\">###)</span><span class=\"w\">\n</span></code></pre></div>      </div>\n\n      <p>where you have to replace <code class=\"language-plaintext highlighter-rouge\">###</code> with the dataset number of the RAxML output in your history.</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"plot-the-raxml-output\">Plot the RAxML output</h2>\n\n<p>We have now set up our R session and are ready to start exploring the tree interactively.</p>\n\n<p>As a first step we would like to parse the tree information from the imported dataset and plot the tree.</p>\n\n<blockquote class=\"comment\">\n  <comment-title></comment-title>\n\n  <p>If you are experienced with R, you are encouraged also to start playing with all the code from here on, to modify it, and to explore the numerous phylogenetics packages and functions available in R.</p>\n\n</blockquote>\n\n<blockquote class=\"hands-on\">\n  <hands-on-title>Parse the tree and plot it</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Parse the tree</span><span class=\"w\">\n</span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">read.tree</span><span class=\"p\">(</span><span class=\"n\">treefile</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"c1\"># Plot it</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre></div>  </div>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>Take a look at the tree generated by RAxML. Is it rooted or unrooted? What is the strain far apart from all other strains?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title>1</solution-title>\n\n      <p><a href=\"./images/tree_unrooted.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_unrooted.svg\" alt=\"Unrooted tree. \" width=\"449\" height=\"234\" loading=\"lazy\" /></a></p>\n\n      <ol>\n        <li>The tree is unrooted, and the outlier strain is <em>M. canettii</em>, our outgroup. The much longer branch leading to this strain shows that many SNPs separate <em>M. canettii</em> from the common ancestor of the MTBC.</li>\n      </ol>\n\n    </blockquote>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"root-the-tree\">Root the tree</h2>\n\n<p>To make the phylogeny more interpretable, we will now root the tree using the <em>M. canettii</em> strain as the outgroup, then exclude that strain, such that patterns <em>within</em> the MTBC become clearer.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Root the tree and drop its outgroup</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Root the tree</span><span class=\"w\">\n</span><span class=\"n\">tree_rooted</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ERR313115\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\"># Remove the outgroup to make distances within MTB clearer</span><span class=\"w\">\n</span><span class=\"n\">tree_rooted</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">drop.tip</span><span class=\"p\">(</span><span class=\"n\">tree_rooted</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ERR313115\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">tree_rooted</span><span class=\"o\">$</span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">0.005</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rooted</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cex</span><span class=\"o\">=</span><span class=\"m\">0.6</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre></div>  </div>\n</blockquote>\n\n<p><a href=\"./images/tree_rooted.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_rooted.svg\" alt=\"Rooted tree. \" width=\"522\" height=\"429\" loading=\"lazy\" /></a></p>\n\n<p>This already looks better, the tree topology stands out more clearly now, and we can identify groups of closely related strains.</p>\n\n<h2 id=\"create-tree-with-lineage-as-tip-label-instead-of-strain-name\">Create tree with lineage as tip label instead of strain name</h2>\n\n<p>A first piece of information we now want to add to the phylogeny is to which lineage the strains belong. This will allow us to assess whether our tree is consistent with the known phylogeny of the MTBC, shown in Figure 1A, and to visualize which lineages are present in our sample. The information to which lineage a strain belongs can be found in the output of TB-profiler, as explained in the <a href=\"/training-material/topics/variant-analysis/tutorials/tb-variant-analysis/tutorial.html\">tutorial on TB variant analysis</a>.</p>\n\n<blockquote class=\"hands-on\">\n  <hands-on-title>Generate a tree with lineage labels</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Assign lineages to samples, as identified by TB-profiler</span><span class=\"w\">\n\n</span><span class=\"n\">mtbc_lineages</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR181435\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L7\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR313115\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"canettii\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR551620\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L5\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR1203059\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L5\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2659153\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"orygis\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704678\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L3\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704679\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L1\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704687\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L6\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR5987300\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR5987352\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L4\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362078\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362138\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362139\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L4\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362156\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362253\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362333\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362484\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L4\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362653\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"SRR998584\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L5\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"SRR13046689\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bovis\"</span><span class=\"w\">\n</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\"># Replace the tree labels</span><span class=\"w\">\n</span><span class=\"n\">tree_lineages</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">tree_rooted</span><span class=\"w\">\n</span><span class=\"n\">tree_lineages</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">as.character</span><span class=\"p\">(</span><span class=\"n\">mtbc_lineages</span><span class=\"p\">[</span><span class=\"n\">tree_rooted</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">])</span><span class=\"w\">\n\n</span><span class=\"c1\"># Define some colors for the lineages</span><span class=\"w\">\n\n</span><span class=\"n\">color_code_lineages</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#ff00ff\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#0000ff\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#a000cc\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#ff0000\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#663200\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#00cc33\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">L7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#ede72e\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">bovis</span><span class=\"o\">=</span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">orygis</span><span class=\"o\">=</span><span class=\"s2\">\"black\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">pal_lineages</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">as.character</span><span class=\"p\">(</span><span class=\"n\">color_code_lineages</span><span class=\"p\">[</span><span class=\"n\">tree_lineages</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">])</span><span class=\"w\">\n\n</span><span class=\"c1\"># Plot the old and new tree version next to each other</span><span class=\"w\">\n</span><span class=\"n\">par</span><span class=\"p\">(</span><span class=\"n\">mfrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rooted</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_lineages</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tip.color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pal_lineages</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre></div>  </div>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>Looking at the different lineages present in the tree, does our phylogeny make sense? Or asked differently: does our phylogeny show the same branching patterns between lineages as the established phylogeny in Fig. 1A?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title>2</solution-title>\n\n      <p><a href=\"./images/tree_rooted_lineages.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_rooted_lineages.svg\" alt=\"Colored lineages. \" width=\"473\" height=\"286\" loading=\"lazy\" /></a></p>\n\n      <p>There is indeed a problem with our phylogeny: one L2 and one L5 strain do not cluster with the other strains of these lineages. Instead, they appear near the root of the tree, with very short (ERR5987300) to non-existent (ERR1203059) branches. Other parts of the tree are consistent with Fig. 1A, suggesting that we can focus our first round of troubleshooting on these two strains.</p>\n\n    </blockquote>\n  </blockquote>\n</blockquote>\n\n<h2 id=\"first-round-of-exercises\">First round of exercises</h2>\n\n<blockquote class=\"question\">\n  <question-title>Exercise 1</question-title>\n\n  <p>An important part of bioinformatics consists in trying to find out whether a surprising observation has biological significance — or reflects a mistake somewhere in the numerous steps leading to the result. Have we just discovered two new lineages of MTB, or did we commit a stupid mistake? To find out, take a look a the TB-profiler and the VCF files for the two strange strains, which should be present in your Galaxy history if you’ve followed the previous tutorial. Compare them with “normal” strains. Do you notice something?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>The VCF files hold an important hint to explain our puzzling observation: ERR1203059.vcf contains not a single SNP, ERR5987300.vcf only 81 SNPs. By contrast, the other strains have between 750 and 1250 SNPs. What happened here? To find out, we would have to take a closer look at the steps leading from BAM to VCF files. One possibility is that the sequencing depth for these samples was so low that most SNPs were filtered out because they did not pass the quality filtering.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<blockquote class=\"question\">\n  <question-title>Exercise 2</question-title>\n\n  <p>In the <a href=\"/training-material/topics/evolution/tutorials/mtb_transmission/tutorial.html\">tutorial on transmission clusters</a> two clusters of samples got identified and are reproduced below. How do these clusters show up in the phylogenetic tree? What additional information does the tree contain?</p>\n\n  <table>\n    <thead>\n      <tr>\n        <th>Sample</th>\n        <th>Cluster_id</th>\n        <th>DR profile</th>\n        <th>Clustering</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>ERR5987352</td>\n        <td>10</td>\n        <td>Pre-MDR</td>\n        <td>Clustered</td>\n      </tr>\n      <tr>\n        <td>ERR6362484</td>\n        <td>10</td>\n        <td>Pre-MDR</td>\n        <td>Clustered</td>\n      </tr>\n      <tr>\n        <td>ERR6362138</td>\n        <td>12</td>\n        <td>MDR</td>\n        <td>Clustered</td>\n      </tr>\n      <tr>\n        <td>ERR6362156</td>\n        <td>12</td>\n        <td>Pre-XDR</td>\n        <td>Clustered</td>\n      </tr>\n      <tr>\n        <td>ERR6362253</td>\n        <td>12</td>\n        <td>MDR</td>\n        <td>Clustered</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p>Clusters 10 and 12 appear as clades of closely related strains in the phylogeny: cluster 12 being part of lineage 2, cluster 10 of lineage 4. The phylogeny additionally reveals that cluster 12 is part of a larger clade of rather closely related lineage 2 strains. While clustering with a fixed SNP threshold produces a binary outcome (clustered/unclustered), the phylogeny reveals the gradual nature of relatedness. With a more permissive SNP threshold for clustering, or a different pipeline to call SNPs, we might well identify a larger cluster of L2 strains.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"map-a-trait-onto-the-tree\">Map a trait onto the tree</h2>\n\n<p>Phylogenies are particularly useful when combined with additional information. For our 19 MTB strains, for example, we might know such things as the country of origin, the sampling date, or various phenotypes determined in the lab, for example the virulence of the strains in an animal model. By mapping this additional information onto the phylogeny, we can gain insights into how, where and when these traits evolved.</p>\n\n<p>For our 20 samples, a trait you previously identified (if you have been doing the <a href=\"/training-material/topics/evolution/tutorials/mtb_transmission/tutorial.html\">tutorial on transmission clusters</a>, is the DR profile. Let us map this trait onto the tree and see if we can learn something from the observed patterns.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Generate a tree with DR profiles as labels</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Same as before, but with DR profiles instead of lineages</span><span class=\"w\">\n\n</span><span class=\"n\">mtbc_dr</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR181435\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR313115\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR551620\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR1203059\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2659153\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704678\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704679\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR2704687\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR5987300\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreXDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR5987352\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreMDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362078\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362138\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362139\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreMDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362156\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreXDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362253\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362333\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreXDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362484\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"PreMDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"ERR6362653\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MDR\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"SRR998584\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Sensitive\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"SRR13046689\"</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Other\"</span><span class=\"w\">\n</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">tree_dr</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">tree_rooted</span><span class=\"w\">\n</span><span class=\"n\">tree_dr</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">as.character</span><span class=\"p\">(</span><span class=\"n\">mtbc_dr</span><span class=\"p\">[</span><span class=\"n\">tree_rooted</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">])</span><span class=\"w\">\n\n</span><span class=\"n\">color_code_dr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"n\">Sensitive</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#ff00ff\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">PreXDR</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#0000ff\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">PreMDR</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#a000cc\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">MDR</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#ff0000\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">Other</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"#663200\"</span><span class=\"w\">\n</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">pal_dr</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">as.character</span><span class=\"p\">(</span><span class=\"n\">color_code_dr</span><span class=\"p\">[</span><span class=\"n\">tree_dr</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">])</span><span class=\"w\">\n\n</span><span class=\"n\">par</span><span class=\"p\">(</span><span class=\"n\">mfrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rooted</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_dr</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tip.color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pal_dr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n</span></code></pre></div>  </div>\n\n</blockquote>\n\n<h2 id=\"exercises-continued\">Exercises continued</h2>\n\n<blockquote class=\"question\">\n  <question-title>Exercise 3</question-title>\n\n  <p>In the previous tutorial on clustering, you have come across the hypothesis that unclustered cases of DR represent <em>de novo</em> evolution of DR, while clustered cases of DR represent instances of DR transmission. Looking at lineage 2 in the phylogeny above, does this hypothesis hold? How many times would MDR have evolved independently in lineage 2? Is there an alternative explanation for the prevalence of MDR in lineage 2?</p>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <p><a href=\"./images/tree_rooted_dr.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_rooted_dr.svg\" alt=\"Colored DR profiles. \" width=\"490\" height=\"286\" loading=\"lazy\" /></a></p>\n\n    <p>MDR would have evolved three times according to the clustering perspective mentioned above: once in cluster 12, once in ERR6362078, and once in ERR6362653. The phylogeny suggest a simpler alternative: MDR could have been already present in the common ancestor of the six L2 strains in our sample; it could have evolved only once, along the long branch leading from the split from lineage 3 to the most recent common ancestor of the six samples. This picture, however, might change with a more extensive sampling of lineage 2. Six samples are hardly sufficient to make claims about the prevalence and evolution of MDR in lineage 2. As for the interpretation of clustering, sampling design is crucial for the interpretation of phylogenies and should always be kept in mind in order to avoid overinterpretation.</p>\n\n  </blockquote>\n\n</blockquote>\n\n<h2 id=\"date-the-phylogeny-advanced\">Date the phylogeny (advanced)</h2>\n\n<p>As a last exercise, we are going to put a timescale on our phylogeny, assuming that mutations accumulate in a regular, clock-wise manner. In the tree, phylogenetic distance = time*rate. As we know the phylogenetic distance, we can get an estimate of time by assuming a mutation rate. This sounds simple in theory, but will require some big assumptions:</p>\n\n<ul>\n  <li>\n    <p>As noted above, the starting alignment only contains variable positions, phylogenetic distances in the trees are thus overestimated. To correct for this, we assume that all other sites in the genome are invariant, and rescale branch lengths according to <code class=\"language-plaintext highlighter-rouge\">rescaled branch lengths = (branch lengths * alignment length) / genome size</code>, as in <span class=\"citation\"><a href=\"#Menardo2019\">Menardo <i>et al.</i> 2019</a></span>.</p>\n  </li>\n  <li>\n    <p>We assume that all strains were sampled at time point 0, in the present.</p>\n  </li>\n  <li>\n    <p>We assume a mutation rate of 2.01e-10 mutations per site per generation (<span class=\"citation\"><a href=\"#Ford2013\">Ford <i>et al.</i> 2013</a></span>)</p>\n  </li>\n  <li>\n    <p>To translate generations into years, we assume 200 generations per year.</p>\n  </li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Rescale branches</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Rescale branch lengths (here called edge lenghts)</span><span class=\"w\">\n</span><span class=\"n\">genome_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4411532</span><span class=\"w\">\n</span><span class=\"n\">alignment_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">18077</span><span class=\"w\">\n</span><span class=\"n\">invariant_sites</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">genome_size</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">alignment_length</span><span class=\"w\">\n\n</span><span class=\"n\">tree_rescaled</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">tree_rooted</span><span class=\"w\">\n</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">edge.length</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">edge.length</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alignment_length</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">genome_size</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">alignment_length</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">genome_size</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">par</span><span class=\"p\">(</span><span class=\"n\">mfrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rooted</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"original\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">axisPhylo</span><span class=\"p\">()</span><span class=\"w\">\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rescaled</span><span class=\"p\">,</span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"n\">root.edge</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"rescaled\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">axisPhylo</span><span class=\"p\">()</span><span class=\"w\">\n</span><span class=\"n\">dev.off</span><span class=\"p\">()</span><span class=\"w\">\n</span></code></pre></div>  </div>\n\n</blockquote>\n\n<p>Look at the scale bars of the two trees. Accounting for invariable sites has a huge effect on phylogenetic distances!</p>\n\n<p><a href=\"./images/tree_rescaled.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_rescaled.svg\" alt=\"Rescaled phylogeny. \" width=\"436\" height=\"300\" loading=\"lazy\" /></a></p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Remove outliers, perform dates estimation and plot with time-scale</hands-on-title>\n\n  <div class=\"language-r highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\"># Let's also remove the two outlier strains, they would cause troubles and are anyway useless</span><span class=\"w\">\n</span><span class=\"n\">tree_rescaled</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">drop.tip</span><span class=\"p\">(</span><span class=\"n\">tree_rescaled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"ERR1203059\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ERR5987300\"</span><span class=\"p\">))</span><span class=\"w\">\n\n</span><span class=\"c1\"># Estimate dates: translate phylogenetic distance into years by assuming a mutation rate and the number of generations per year</span><span class=\"w\">\n</span><span class=\"n\">mutation_rate</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2.01e-10</span><span class=\"w\">\n</span><span class=\"n\">generations_per_year</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">200</span><span class=\"w\">\n\n</span><span class=\"c1\">## Ape has a function, estimate.dates(), to date a tree by assuming a specific mutation rate</span><span class=\"w\">\n</span><span class=\"n\">node.date</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">estimate.dates</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"n\">tree_rescaled</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"n\">node.dates</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">rep</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"c1\"># set sampling dates to 0</span><span class=\"w\">\n  </span><span class=\"n\">mu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">mutation_rate</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">generations_per_year</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># mutation rate per year</span><span class=\"w\">\n</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">edge.length</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">node.date</span><span class=\"p\">[</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">edge</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">]]</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">node.date</span><span class=\"p\">[</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">edge</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">]]</span><span class=\"w\">\n</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">as.character</span><span class=\"p\">(</span><span class=\"n\">mtbc_lineages</span><span class=\"p\">[</span><span class=\"n\">tree_rescaled</span><span class=\"o\">$</span><span class=\"n\">tip.label</span><span class=\"p\">])</span><span class=\"w\">\n\n</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">tree_rescaled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Dated phylogeny (years)\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">axisPhylo</span><span class=\"p\">()</span><span class=\"w\">\n</span></code></pre></div>  </div>\n\n</blockquote>\n\n<p><a href=\"./images/tree_dated.svg\" rel=\"noopener noreferrer\"><img src=\"./images/tree_dated.svg\" alt=\"Dated phylogeny. \" width=\"406\" height=\"333\" loading=\"lazy\" /></a></p>\n\n<h2 id=\"final-exercise\">Final exercise</h2>\n\n<blockquote class=\"question\">\n  <question-title>Exercise 4 (advanced)</question-title>\n\n  <ol>\n    <li>\n      <p>What could be the problem with the assumption that all sites in the reference genome which do not appear in our SNP alignment are invariable?</p>\n    </li>\n    <li>\n      <p>Imagine that a recent breakthrough study has found that the mutation rate in MTB is 10 times higher than we assumed. How would this change the estimated dates?</p>\n    </li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>\n        <p>About 5 % of the MTB reference genome consists of repetitive or otherwise complicated regions where mapping and SNP calling cannot be done reliably. Most SNP calling pipelines exclude such regions, also the one used in this course. Rather than to assume that these regions are invariant, we should ignore them in our calculations. By not doing this, genomes seem more similar than they are; we underestimate phylogenetic distances.</p>\n      </li>\n      <li>\n        <p>A rate 10 times higher implies that there will be 10 times more mutations observed in the same time span, or, the other way around, that it will take a time span 10 times shorter to observe the same number of mutations. The timescale of the phylogeny would thus shift one order of magnitude, to hundreds rather than thousands of years. As this example shows, there are considerable uncertainties associated with molecular dating. This is also true for more sophisticated methods (see <span class=\"citation\"><a href=\"#Menardo2019\">Menardo <i>et al.</i> 2019</a></span> for a recent discussion of molecular dating with MTB).</p>\n      </li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>Any phylogenetic analysis requires careful exploration of results and an understanding of its limitations to avoid overinterpretaion. The combination of Galaxy and R accessed through an interactive tool is very powerful because the Galaxy platform provides the compute resources and tools necessary to calculate the phylogenetic tree, and offers straightforward access to RStudio. The flexibility of R and its packages then lets you take a deep dive into the results.</p>\n\n<h1 id=\"resources\">Resources</h1>\n<p>To develop a deeper understanding of phylogenetic trees, there is no better way than estimating phylogenies yourself — and work through a book on the topic in your own mind’s pace.</p>\n\n<h2 id=\"books\">Books</h2>\n<ul>\n  <li><em>Phylogenetics in the genomics era</em>, 2020. An <a href=\"https://hal.inria.fr/PGE\">open access book</a> covering a variety of contemporary topics.</li>\n  <li><em>Tree Thinking</em>, 2013, by David A. Baum &amp; Stacey D. Smith</li>\n  <li><em>Molecular Evolution</em>, 2014, by Ziheng Yang</li>\n</ul>\n\n<h2 id=\"useful-links\">Useful links</h2>\n<ul>\n  <li><a href=\"https://megasoftware.net/\">MEGA Software</a></li>\n  <li><a href=\"https://artic.network/how-to-read-a-tree.html\">Tutorial on how to read a tree, with a virus example</a></li>\n  <li><a href=\"http://tolweb.org\">Tree Of Life web project</a></li>\n  <li><a href=\"https://plato.stanford.edu/entries/phylogenetic-inference/\">Phylogenetic Inference in the Stanford Encyclopedia</a></li>\n</ul>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2023-02-15 00:53:30 +0000","pub_date":"2022-03-16 10:37:17 +0000","version":19,"workflows":[{"workflow":"main_workflow.ga","tests":false,"url":"https://training.galaxyproject.org/training-material/topics/evolution/tutorials/mtb_phylogeny/workflows/main_workflow.ga","path":"topics/evolution/tutorials/mtb_phylogeny/workflows/main_workflow.ga","wfid":"evolution-mtb_phylogeny","wfname":"main_workflow","trs_endpoint":"https://training.galaxyproject.org/training-material/api/ga4gh/trs/v2/tools/evolution-mtb_phylogeny/versions/main_workflow","license":null,"creators":[],"name":"Mtb phylogeny","title":"Mtb phylogeny","test_results":null,"modified":"2024-06-16 00:05:36 +0000","mermaid":"flowchart TD\n  0[\"ℹ️ Input Dataset\\nInput alignment\"];\n  style 0 stroke:#2c3143,stroke-width:4px;\n  1[\"RStudio\"];\n  2[\"Estimate phylogeny with RAxML\"];\n  0 -->|output| 2;\n  9f8ae577-c583-4a2d-b64d-14c25fb859d9[\"Output\\nBest-scoring ML Tree\"];\n  2 --> 9f8ae577-c583-4a2d-b64d-14c25fb859d9;\n  style 9f8ae577-c583-4a2d-b64d-14c25fb859d9 stroke:#2c3143,stroke-width:4px;\n  bdb8cf2f-b553-4a96-8b55-38b4b499ab88[\"Output\\nInfo\"];\n  2 --> bdb8cf2f-b553-4a96-8b55-38b4b499ab88;\n  style bdb8cf2f-b553-4a96-8b55-38b4b499ab88 stroke:#2c3143,stroke-width:4px;"}],"api":"https://training.galaxyproject.org/training-material/api/topics/evolution/tutorials/mtb_phylogeny/tutorial.json","tools":["interactive_tool_rstudio","toolshed.g2.bx.psu.edu/repos/iuc/raxml/raxml/8.2.12+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/raxml/raxml/8.2.4+galaxy2","upload1"],"supported_servers":{"exact":[{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.fr/","name":"UseGalaxy.fr","usegalaxy":false},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true}]},"topic_name_human":"Evolution","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"raxml","owner":"iuc","revisions":"ea30d3089354","tool_panel_section_label":"Phylogenetics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"raxml","owner":"iuc","revisions":"73a469f7dc96","tool_panel_section_label":"Phylogenetics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: raxml\n  owner: iuc\n  revisions: ea30d3089354\n  tool_panel_section_label: Phylogenetics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: raxml\n  owner: iuc\n  revisions: 73a469f7dc96\n  tool_panel_section_label: Phylogenetics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial","contributors":[{"name":"Christoph Stritt","joined":"2022-03","id":"cstritt","url":"https://training.galaxyproject.org/training-material/api/contributors/cstritt.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/cstritt/"},{"name":"Daniela Brites","joined":"2022-03","id":"dbrites","url":"https://training.galaxyproject.org/training-material/api/contributors/dbrites.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/dbrites/"},{"name":"Galo A. Goig","joined":"2022-03","id":"GaloGS","url":"https://training.galaxyproject.org/training-material/api/contributors/GaloGS.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/GaloGS/"},{"name":"Wolfgang Maier","orcid":"0000-0002-9464-6640","matrix":"wm75:matrix.org","joined":"2017-09","elixir_node":"de","fediverse":"https://scholar.social/@zerodivision","fediverse_flavor":"mastodon","affiliations":["by-covid","uni-freiburg","elixir-europe"],"id":"wm75","url":"https://training.galaxyproject.org/training-material/api/contributors/wm75.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/wm75/"}]}