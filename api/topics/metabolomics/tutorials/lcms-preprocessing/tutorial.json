{"layout":"tutorial_hands_on","title":"Mass spectrometry: LC-MS preprocessing with XCMS","zenodo_link":"https://zenodo.org/record/3757956","level":"Intermediate","questions":["What are the main steps of untargeted LC-MS data preprocessing for metabolomic analyses?","How to conduct metabolomic data preprocessing using Galaxy?"],"objectives":["To comprehend the diversity of steps necessary to perform untargeted LC-MS metabolomic preprocessing.","To get familiar with the way to use XCMS-based Galaxy modules dedicated to LC-MS data preprocessing.","To evaluate the potential of a workflow approach when dealing with LC-MS preprocessing."],"time_estimation":"3h","key_points":["To process untargeted LC-MS metabolomic data preprocessing, you need a large variety of steps and tools.","Although main steps are standard, various ways to combine and to set parameters for tools exist, depending on your data.","Resources are available in Galaxy, but do not forget that you need appropriate knowledge to perform a relevant analysis."],"contributors":[{"name":"Mélanie Petera","joined":"2019-06","id":"melpetera","url":"https://training.galaxyproject.org/training-material/api/contributors/melpetera.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/melpetera/"},{"name":"Jean-François Martin","joined":"2019-06","id":"jfrancoismartin","url":"https://training.galaxyproject.org/training-material/api/contributors/jfrancoismartin.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/jfrancoismartin/"},{"name":"Gildas Le Corguillé","joined":"2017-09","elixir_node":"fr","affiliations":["elixir-europe"],"id":"lecorguille","url":"https://training.galaxyproject.org/training-material/api/contributors/lecorguille.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/lecorguille/"},{"name":"Workflow4Metabolomics core team","joined":"2019-06","id":"workflow4metabolomics","url":"https://training.galaxyproject.org/training-material/api/contributors/workflow4metabolomics.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/workflow4metabolomics/"}],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00197","url":"/topics/metabolomics/tutorials/lcms-preprocessing/tutorial.html","topic_name":"metabolomics","tutorial_name":"lcms-preprocessing","dir":"topics/metabolomics/tutorials/lcms-preprocessing","symlink":null,"id":"metabolomics/lcms-preprocessing","ref_tutorials":["<p>Metabolomics is a <em>-omic</em> science known for being one of the most closely related to phenotypes.\nIt involves the study of different types of matrices, such as blood, urine, tissues, in various organisms including plants.\nIt focuses on studying the very small molecules which are called <em>metabolites</em>, to better understand matters linked to the metabolism.</p>\n\n<p>One of the three main technologies used to perform metabolomic analyses is <strong>Liquid-Chromatography Mass Spectrometry</strong> (LC-MS). Data analysis\nfor this technology requires a large variety of steps, ranging from extracting information from the raw data to statistical analysis and annotation.\nTo be able to perform a complete LC-MS analysis in a single environment, the <a href=\"http://workflow4metabolomics.org/\">Wokflow4Metabolomics</a>\nteam provides Galaxy tools dedicated to metabolomics. This tutorial details the steps involved in the first part of untargeted LC-MS\ndata processing: extracting information from raw data to obtain what is called a peak table. This step is commonly refered to as\nthe preprocessing step. This tutorial will show you how to perform such a step using the Galaxy implementation of the XCMS software.</p>\n\n<p>To illustrate this approach, we will use data from <span class=\"citation\"><a href=\"#Thvenot2015\">Thévenot <i>et al.</i> 2015</a></span>. The objectives of this paper was to analyze\nthe influence of age, body mass index, and gender on the urine metabolome. To do so, the authors collected samples\nfrom 183 employees from the French Alternative Energies and Atomic Energy Commission (CEA) and performed LC-HRMS LTQ-Orbitrap\n(negative ionization mode).</p>\n\n<p>Since the original dataset takes a few hours to be processed, we chose to take a limited subset of individuals for this tutorial.\nThis will enable you to perform an example of metabolomic preprocessing workflow in a limited time, even though\nthe results obtained may not be reliable enough for biological interpretation due to the small sample size.\nNevertheless, the chosen diversity of sample will allow you to explore the basics of a preprocessing workflow.</p>\n\n<p>We chose a subset of 12 samples, composed of 6 biological samples, 3 quality-control pooled samples (‘QC pools’ - mix of all\nbiological samples) and 3 blank samples (‘blanks’ - solvent injection).</p>\n\n<p>To analyze these data, we will then follow a Galaxy workflow\ndeveloped by the <a href=\"http://workflow4metabolomics.org/\">Wokflow4metabolomics group</a> (<span class=\"citation\"><a href=\"#Giacomoni2014\">Giacomoni <i>et al.</i> 2014</a></span>, <span class=\"citation\"><a href=\"#Guitton2017\">Guitton <i>et al.</i> 2017</a></span>).</p>\n\n<p><a href=\"../../images/lcmspreproc_wf.png\"><figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"../../images/lcmspreproc_wf.png\" alt=\"The full tutorial workflow represented as boxes linked with arrows, each box being labeled with the corresponding galaxy tool name. \" width=\"1500\" height=\"1030\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/lcmspreproc_wf.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br />&lt;figcaption&gt;<span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> The tutorial workflow&lt;/figcaption&gt;</figure></a></p>\n\n<blockquote class=\"comment\">\n  <comment-title>Workflow4Metabolomics public history</comment-title>\n\n  <p>This training material can be followed running it on any Galaxy instance holding the Galaxy modules needed.\nNonetheless, if you happen to be a W4M user and do not want to run the hands-on yourself, please note that\nyou can find the entire history in the ‘published histories’ section:\n<a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a></p>\n\n</blockquote>\n\n<p>The preprocessing steps presented in this tutorial are built around the solutions provided through the R package <strong>XCMS</strong>.</p>\n\n<p><strong>XCMS</strong> (<span class=\"citation\"><a href=\"#Smith2006\">Smith <i>et al.</i> 2006</a></span>) is a free and open source software dedicated to pre-processing of any type of mass spectrometry acquisition files from low to\nhigh resolution, including FT-MS data coupled with different kind of chromatography (liquid or gas). This software is\nused worldwide by a huge community of specialists in metabolomics using mass spectrometry methods.</p>\n\n<p>This software is based on different algorithms that have been published, and is provided and maintained using R software.</p>\n\n<p>Since sometimes a couple of pictures is worth a thousand words, you will find in the following slides some material to help\nyou understand how XCMS works:\n<a href=\"../../tutorials/lcms-preprocessing/slides.html\">link to slides</a>.\nThis document is refered to as “Check the next X slides” in the present training material.\nAs an example, <a href=\"../../tutorials/lcms-preprocessing/slides.html#raw-to-matrix\">check the next 2 slides</a>\nfor complementary material about XCMS R package.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#data-preparation-for-xcms\" id=\"markdown-toc-data-preparation-for-xcms\">Data preparation for XCMS</a>    <ol>\n      <li><a href=\"#importing-the-lc-ms-data-into-galaxy\" id=\"markdown-toc-importing-the-lc-ms-data-into-galaxy\">Importing the LC-MS data into Galaxy</a></li>\n      <li><a href=\"#first-galaxy-module-msnbase-readmsdata\" id=\"markdown-toc-first-galaxy-module-msnbase-readmsdata\">First Galaxy module: <em>MSnbase readMSData</em></a></li>\n      <li><a href=\"#importing-a-sample-metadata-file\" id=\"markdown-toc-importing-a-sample-metadata-file\">Importing a sample metadata file</a></li>\n      <li><a href=\"#getting-an-overview-of-your-samples-chromatograms\" id=\"markdown-toc-getting-an-overview-of-your-samples-chromatograms\">Getting an overview of your samples’ chromatograms</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#first-xcms-step-peak-picking\" id=\"markdown-toc-first-xcms-step-peak-picking\">First XCMS step: <em>peak picking</em></a></li>\n  <li><a href=\"#gathering-the-different-samples-in-one-rdata-file\" id=\"markdown-toc-gathering-the-different-samples-in-one-rdata-file\">Gathering the different samples in one Rdata file</a></li>\n  <li><a href=\"#second-xcms-step-determining-shared-ions-across-samples\" id=\"markdown-toc-second-xcms-step-determining-shared-ions-across-samples\">Second XCMS step: <em>determining shared ions across samples</em></a></li>\n  <li><a href=\"#optional-xcms-step-retention-time-correction\" id=\"markdown-toc-optional-xcms-step-retention-time-correction\">Optional XCMS step: <em>retention time correction</em></a></li>\n  <li><a href=\"#final-xcms-step-integrating-areas-of-missing-peaks\" id=\"markdown-toc-final-xcms-step-integrating-areas-of-missing-peaks\">Final XCMS step: <em>integrating areas of missing peaks</em></a></li>\n  <li><a href=\"#annotation-with-camera-optional\" id=\"markdown-toc-annotation-with-camera-optional\">Annotation with CAMERA [Optional]</a></li>\n  <li><a href=\"#finalising-your-pre-processing\" id=\"markdown-toc-finalising-your-pre-processing\">Finalising your pre-processing</a></li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"data-preparation-for-xcms\">Data preparation for XCMS</h1>\n\n<p>The <strong>XCMS</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> R package is composed of R functions able to extract, filter, align and fill gap, with the possibility to annotate isotopes,\nadducts and fragments using the CAMERA R package (<span class=\"citation\"><a href=\"#CAMERA\">Carsten Kuhl 2017</a></span>). This set of functions gives modularity, and thus is particularly well\nadapted to define workflows, one of the key points of Galaxy.</p>\n\n<p>The first Galaxy module, <strong>MSnbase readMSData</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>, is meant to read files with open format as <code class=\"language-plaintext highlighter-rouge\">mzXML</code>, <code class=\"language-plaintext highlighter-rouge\">mzMl</code>, <code class=\"language-plaintext highlighter-rouge\">mzData</code> and <code class=\"language-plaintext highlighter-rouge\">netCDF</code>,\nwhich are independent of the constructors’ formats.\nFirst of all, you need to upload your data (that must be in one of the cited open formats) into Galaxy.</p>\n\n<h2 id=\"importing-the-lc-ms-data-into-galaxy\">Importing the LC-MS data into Galaxy</h2>\n\n<p>In metabolomics studies, the number of samples can vary a lot (from a handful to several hundreds). Thus, extracting your\ndata from the raw files can be very fast, or take quite a long time. To optimise the computation time as much as possible,\nthe W4M core team chose to develop tools that can run single raw files in parallel for the first steps of\npre-processing, since the initial actions in the extraction process treat files independently.</p>\n\n<p>Since the first steps can be run on each file independently, the use of <strong>Dataset collections</strong> in Galaxy is recommended, to avoid\nhaving to launch jobs manually for each sample. You can start using the dataset collection option from the very beginning of your analysis, when uploading your data into Galaxy.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Data upload the mzXML with <b>Get data</b></hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create a new history for this tutorial</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-new-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-new-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a new history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>Click the <i class=\"fas fa-plus\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">new-history</span> icon at the top of the history panel:</p>   <p><img src=\"/training-material/shared/images/history_create_new.svg\" alt=\"UI for creating new history\" /></p>   <!-- the original drawing can be found here https://docs.google.com/drawings/d/1cCBrLAo4kDGic5QyB70rRiWJAKTenTU8STsKDaLcVU8/edit?usp=sharing --> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Import the 12 <code class=\"language-plaintext highlighter-rouge\">mzXML</code> files into a collection named <code class=\"language-plaintext highlighter-rouge\">mzML</code>\n      <ul>\n        <li>Option 1: from a shared data library (ask your instructor)</li>\n        <li>\n          <p>Option 2: from Zenodo using the URLs given below</p>\n\n          <p><a href=\"https://doi.org/10.5281/zenodo.3757956\"><a href=\"https://zenodo.org/badge/DOI/10.5281/zenodo.3757956.svg\" rel=\"noopener noreferrer\"><img src=\"https://zenodo.org/badge/DOI/10.5281/zenodo.3757956.svg\" alt=\"DOI. \" loading=\"lazy\" /></a></a></p>\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/3757956/files/Blanc05.mzML\nhttps://zenodo.org/record/3757956/files/Blanc10.mzML\nhttps://zenodo.org/record/3757956/files/Blanc16.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_048.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_090.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_123.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_157.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_173.mzML\nhttps://zenodo.org/record/3757956/files/HU_neg_192.mzML\nhttps://zenodo.org/record/3757956/files/QC1_002.mzML\nhttps://zenodo.org/record/3757956/files/QC1_008.mzML\nhttps://zenodo.org/record/3757956/files/QC1_014.mzML\n</code></pre></div>          </div>\n        </li>\n      </ul>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>     <p>Click on <strong>Collection</strong> on the top</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Change <strong>Type (set all):</strong> from “Auto-detect” to <code class=\"language-plaintext highlighter-rouge\">mzml</code></p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li>     <p>Click on <strong>Build</strong> when available</p>   </li>   <li>     <p>Enter a name for the collection</p>     <ul>       <li>mzML</li>     </ul>   </li>   <li>Click on <strong>Create list</strong> (and wait a bit)</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-data-from-a-data-library\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-data-from-a-data-library\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing data from a data library</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>As an alternative to uploading the data from a URL or your computer, the files may also have been made available from a <em>shared data library</em>:</p>   <ol>   <li>Go into <strong>Shared data</strong> (top panel) then <strong>Data libraries</strong></li>   <li>Navigate to  the correct folder as indicated by your instructor.     <ul>       <li>On most Galaxies tutorial data will be provided in a folder named <strong>GTN - Material –&gt; Topic Name -&gt; Tutorial Name</strong>.</li>     </ul>   </li>   <li>Select the desired files</li>   <li>Click on <strong>Add to History</strong> <i class=\"fas fa-caret-down\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-dropdown</span> near the top and select <strong>as a Collection</strong> from the dropdown menu</li>   <li>     <p>In the pop-up window, choose</p>     <ul>       <li><em>“Select history”</em>: the history you want to import the data to (or create a new one)</li>     </ul>   </li>   <li>Click on <strong>Import</strong></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Make sure your data is in a <strong>collection</strong>. Make sure it is named <code class=\"language-plaintext highlighter-rouge\">mzML</code>\n      <ul>\n        <li>If you forgot to select the collection option during import, you can create the collection now:</li>\n      </ul>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-creating-a-dataset-collection\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-creating-a-dataset-collection\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Creating a dataset collection</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on <i class=\"far fa-check-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-selector</span> <strong>Select Items</strong> at the top of the history panel <img src=\"/training-material/topics/galaxy-interface/images/historyItemControls.png\" alt=\"Select Items button\" /></li>   <li>Check all the datasets in your history you would like to include</li>   <li>     <p>Click <strong>n of N selected</strong> and choose <strong>Build Dataset List</strong></p>     <p><img src=\"/training-material/topics/galaxy-interface/images/buildList.png\" alt=\"build list collection menu item\" width=\"15%\" /></p>   </li>   <li>Enter a name for your collection</li>   <li>Click <strong>Create collection</strong> to build your collection</li>   <li>Click on the checkmark icon at the top of your history again</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>If you happen to be a W4M user, please note that you can find at the following link a ready-to-start history:\n<a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingmzml\">GTN_LCMSpreprocessing_mzML</a>.\nWe highly recommend to get started by importing this history.</p>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the dataset collection number 13.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>You should have in your history a green Dataset collection (<code class=\"language-plaintext highlighter-rouge\">mzML</code>) with 12 datasets in mzml format.</p>\n\n<p>Their size can be checked by clicking on the information icon <i class=\"fas fa-info-circle\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-info</span> on the individual datasets.</p>\n\n<h2 id=\"first-galaxy-module-msnbase-readmsdata\">First Galaxy module: <em>MSnbase readMSData</em></h2>\n\n<p>This first step is only meant to read your <code class=\"language-plaintext highlighter-rouge\">mzXML</code> file and generate an object usable by <strong>XCMS</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>.</p>\n\n<p><strong>MSnbase readMSData</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> takes as input your raw files and prepares <code class=\"language-plaintext highlighter-rouge\">RData</code> files for the first XCMS step.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>MSnbase readMSData</hands-on-title>\n\n  <ol>\n    <li>Run <span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/msnbase_readmsdata/msnbase_readmsdata/2.16.1+galaxy0\" title=\"MSnbase readMSData tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>MSnbase readMSData</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.16.1+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“File(s) from your history containing your chromatograms”</em>: the <code class=\"language-plaintext highlighter-rouge\">mzML</code> dataset collection</li>\n      </ul>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-selecting-a-dataset-collection-as-input\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-selecting-a-dataset-collection-as-input\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Selecting a dataset collection as input</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Click on <i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <strong>Dataset collection</strong> in  front of the input parameter you want to supply the collection to.</li>   <li>Select the collection you want to use from the list</li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the dataset collection number 14.</p>\n  </blockquote>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>What do you get as output?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <ol>\n        <li>A <strong>Dataset collection</strong> containing 12 datasets.</li>\n        <li>The datasets are some RData objects with the <strong>rdata.msnbase.raw</strong> datatype.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<p>Now that you have prepared your data, you can begin with the first XCMS extraction step: peakpicking. However, before beginning to\nextract meaningful information from your raw data, you may be interested in visualising your chromatograms. This can be of particular\ninterest if you want to check whether you should consider discarding some range of your analytical sequence (some scans or <em>retention\ntime</em> (RT) ranges).</p>\n\n<p>To do so, you can use a tool that is called <strong>xcms plot chromatogram</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> that will plot each sample’s chromatogram (see dedicated section\nfurther). However, to use this tool, you may need additional information about your samples for colouring purpose. Thus, you may need\nto upload into Galaxy a table containing metadata of your samples (a <em>sampleMetadata</em> file).</p>\n\n<h2 id=\"importing-a-sample-metadata-file\">Importing a sample metadata file</h2>\n\n<p>What we referenced here as a <em>sampleMetadata</em> file corresponds to a table containing information about your samples (= sample metadata).</p>\n\n<p>A sample metadata file contains various information for each of your raw files:</p>\n<ul>\n  <li><strong>Classes</strong> which will be used during the preprocessing steps</li>\n  <li><strong>Analytical batches</strong> which will be useful for a batch correction step, along with <strong>sample types</strong> (pool/sample) and <strong>injection order</strong></li>\n  <li>Different <strong>experimental conditions</strong> which can be used for statistics</li>\n  <li>Any information about samples that you want to keep, in a <em>column</em> format</li>\n</ul>\n\n<p>The content of your sample metadata file has to be filled by you, since it is not contained in your raw data.\nNote that you can either:</p>\n<ul>\n  <li>Upload an existing metadata file</li>\n  <li>Use a template to create one (because it can be painful to get the sample list without misspelling or omission)\n    <ol>\n      <li>Generate a template with the <strong>xcms get a sampleMetadata file</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool</li>\n      <li>Fill it using your favorite table editor (Excel, LibreOffice)</li>\n      <li>Upload it within Galaxy</li>\n    </ol>\n  </li>\n</ul>\n\n<blockquote class=\"tip\">\n  <tip-title>Optional: Generate the right template with <b>xcms get a sampleMetadata file</b></tip-title>\n\n  <p>In the case of this tutorial, we already prepared a <em>sampleMetadata</em> file with all the necessary information.\nBelow is an optional hands-on explaining how to get a template to fill, with the two following advantages:</p>\n  <ol>\n    <li>You will have the exact list of the samples you used in Galaxy, with the exact identifiers (<em>i.e.</em> exact sample names)</li>\n    <li>You will have a file with the right format (tabulation-separated text file) that only needs to be filled with the information you want.</li>\n  </ol>\n\n  <blockquote class=\"hands_on\">\n    <hands-on-title>xcms get a sampleMetadata file</hands-on-title>\n\n    <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_export_samplemetadata/xcms_export_samplemetadata/3.12.0+galaxy0\" title=\"xcms get a sampleMetadata file tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms get a sampleMetadata file</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n    <ul>\n      <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“RData file”</em>: the <code class=\"language-plaintext highlighter-rouge\">mzML.raw.RData</code> collection output from <strong>MSnbase readMSData</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span></li>\n    </ul>\n\n    <blockquote class=\"tip\">\n      <tip-title>Comment to W4M users</tip-title>\n\n      <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the dataset number 27.</p>\n    </blockquote>\n\n  </blockquote>\n\n  <p>An easy step for an easy sampleMetadata filling!</p>\n\n  <p>From this tool, you will obtain a <code class=\"language-plaintext highlighter-rouge\">tabular</code> file (meaning a tab-separated text file) with a first column of identifiers and a\nsecond column called <em>class</em> which is empty for the moment (only ‘.’ for each sample). You can now download this file by clicking on the <i class=\"far fa-save\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-save</span> icon.</p>\n\n</blockquote>\n\n<h4 id=\"prepare-your-samplemetadata-file\">Prepare your sampleMetadata file</h4>\n\n<p>The sampleMetadata file is a tab-separated table, in text format. This table has to be filled by the user. You can use any\nsoftware you find appropriate to construct your table, as long as you save your file in a compatible format. For example, you can\nuse a spreadsheet software such as Microsoft Excel or LibreOffice.</p>\n\n<blockquote class=\"warning\">\n  <warning-title> Save your table in the correct format</warning-title>\n\n  <p>The file has to be a <code class=\"language-plaintext highlighter-rouge\">.txt</code> or a <code class=\"language-plaintext highlighter-rouge\">.tsv</code> (tab-separated values). Neither <code class=\"language-plaintext highlighter-rouge\">.xlsx</code> nor <code class=\"language-plaintext highlighter-rouge\">.odt</code> are supported.\nIf you use a spreadsheet software, be sure to change the default format to <strong>Text (Tab delimited)</strong> or equivalent.</p>\n</blockquote>\n\n<p>Once your sampleMetadata table is ready, you can proceed to the upload. In this tutorial we already prepared the table for you ;)</p>\n\n<blockquote class=\"tip\">\n  <tip-title>Optional: Filling the <i>sampleMetadata</i> using the template obtained from Galaxy</tip-title>\n\n  <p>For this tutorial, we already provide the <em>sampleMetadata</em> file, so you only have to upload it to Galaxy. Below we\nexplain how we filled this file from the template we generated in Galaxy.</p>\n\n  <p>First, we used <strong>xcms get a sampleMetadata file</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> as mentioned in the previous tip box.</p>\n\n  <p>We obtained the following table:</p>\n\n  <table>\n    <thead>\n      <tr>\n        <th>sample_name</th>\n        <th>class</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>QC1_014</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>QC1_008</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>QC1_002</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_192</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_173</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_157</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_123</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_090</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>HU_neg_048</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>Blanc16</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>Blanc10</td>\n        <td>.</td>\n      </tr>\n      <tr>\n        <td>Blanc05</td>\n        <td>.</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <p>We used a spreadsheet software to open the file. First, we completed the class column. You will see in further XCMS steps that this\nsecond column matters.</p>\n\n  <table>\n    <thead>\n      <tr>\n        <th>sample_name</th>\n        <th>class</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>QC1_014</td>\n        <td>QC</td>\n      </tr>\n      <tr>\n        <td>QC1_008</td>\n        <td>QC</td>\n      </tr>\n      <tr>\n        <td>QC1_002</td>\n        <td>QC</td>\n      </tr>\n      <tr>\n        <td>HU_neg_192</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>HU_neg_173</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>HU_neg_157</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>HU_neg_123</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>HU_neg_090</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>HU_neg_048</td>\n        <td>sample</td>\n      </tr>\n      <tr>\n        <td>Blanc16</td>\n        <td>blk</td>\n      </tr>\n      <tr>\n        <td>Blanc10</td>\n        <td>blk</td>\n      </tr>\n      <tr>\n        <td>Blanc05</td>\n        <td>blk</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <p>With this column, we will be able to colour the samples depending on the sample type (QC, sample, blk).\nNext, we added columns with interesting or needed information, as following:</p>\n\n  <table>\n    <thead>\n      <tr>\n        <th>sample_name</th>\n        <th>class</th>\n        <th>sampleType</th>\n        <th>injectionOrder</th>\n        <th>batch</th>\n        <th>osmolality</th>\n        <th>sampling</th>\n        <th>age</th>\n        <th>bmi</th>\n        <th>gender</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>QC1_014</td>\n        <td>QC</td>\n        <td>pool</td>\n        <td>185</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n      <tr>\n        <td>QC1_008</td>\n        <td>QC</td>\n        <td>pool</td>\n        <td>105</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n      <tr>\n        <td>QC1_002</td>\n        <td>QC</td>\n        <td>pool</td>\n        <td>27</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n      <tr>\n        <td>HU_neg_192</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>165</td>\n        <td>ne1</td>\n        <td>1184</td>\n        <td>8</td>\n        <td>31</td>\n        <td>24.22</td>\n        <td>Male</td>\n      </tr>\n      <tr>\n        <td>HU_neg_173</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>148</td>\n        <td>ne1</td>\n        <td>182</td>\n        <td>7</td>\n        <td>55</td>\n        <td>20.28</td>\n        <td>Female</td>\n      </tr>\n      <tr>\n        <td>HU_neg_157</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>137</td>\n        <td>ne1</td>\n        <td>504</td>\n        <td>7</td>\n        <td>43</td>\n        <td>21.95</td>\n        <td>Female</td>\n      </tr>\n      <tr>\n        <td>HU_neg_123</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>100</td>\n        <td>ne1</td>\n        <td>808</td>\n        <td>5</td>\n        <td>49</td>\n        <td>24.39</td>\n        <td>Male</td>\n      </tr>\n      <tr>\n        <td>HU_neg_090</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>75</td>\n        <td>ne1</td>\n        <td>787</td>\n        <td>4</td>\n        <td>46</td>\n        <td>19.79</td>\n        <td>Male</td>\n      </tr>\n      <tr>\n        <td>HU_neg_048</td>\n        <td>sample</td>\n        <td>sample</td>\n        <td>39</td>\n        <td>ne1</td>\n        <td>997</td>\n        <td>3</td>\n        <td>39</td>\n        <td>19.49</td>\n        <td>Female</td>\n      </tr>\n      <tr>\n        <td>Blanc16</td>\n        <td>blk</td>\n        <td>blank</td>\n        <td>173</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n      <tr>\n        <td>Blanc10</td>\n        <td>blk</td>\n        <td>blank</td>\n        <td>94</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n      <tr>\n        <td>Blanc05</td>\n        <td>blk</td>\n        <td>blank</td>\n        <td>29</td>\n        <td>ne1</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n        <td>NA</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <p>In particular, the <code class=\"language-plaintext highlighter-rouge\">batch</code>, <code class=\"language-plaintext highlighter-rouge\">sampleType</code> and <code class=\"language-plaintext highlighter-rouge\">injectionOrder</code> columns are mandatory to correct the data from signal drift during later quality processing\n(see the <a href=\"../../tutorials/lcms/tutorial.html\">Mass spectrometry: LC-MS analysis</a>\nGalaxy training material for more information).\nOnce we completed the table filling, we saved the file, minding to stick with the original format. Then, our <em>sampleMetadata</em> was ready to\nbe uploaded into Galaxy.</p>\n\n</blockquote>\n\n<blockquote class=\"warning\">\n  <warning-title> The class column </warning-title>\n\n  <p>Depending on further choices, the sampleMetadata file can be decisive.\nIt can be used to colour some plots, but also for ion selection (see further in the tutorial). \nPlease note that the information needed for these steps <strong>should be given as the second column of the sampleMetadata file</strong>,\nthe first one being the samples’ identifiers.</p>\n</blockquote>\n\n<h4 id=\"upload-the-samplemetada-file-with-get-data\">Upload the sampleMetada file with ‘Get data’</h4>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Upload the sampleMetada</hands-on-title>\n\n  <ol>\n    <li>Import the <code class=\"language-plaintext highlighter-rouge\">sampleMetadata_completed.tsv</code> file from your computer, from Zenodo or from a shared data library\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://zenodo.org/record/3757956/files/sampleMetadata_12samp_completed.tsv\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-via-links-1\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-via-links-1\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing via links</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Click <i class=\"fas fa-upload\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-upload</span> <strong>Upload Data</strong> at the top of the tool panel</p>   </li>   <li>Select <i class=\"fa fa-edit\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-wf-edit</span> <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link(s) into the text field</p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-importing-data-from-a-data-library-1\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-importing-data-from-a-data-library-1\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Importing data from a data library</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>As an alternative to uploading the data from a URL or your computer, the files may also have been made available from a <em>shared data library</em>:</p>   <ol>   <li>Go into <strong>Shared data</strong> (top panel) then <strong>Data libraries</strong></li>   <li>Navigate to  the correct folder as indicated by your instructor.     <ul>       <li>On most Galaxies tutorial data will be provided in a folder named <strong>GTN - Material –&gt; Topic Name -&gt; Tutorial Name</strong>.</li>     </ul>   </li>   <li>Select the desired files</li>   <li>Click on <strong>Add to History</strong> <i class=\"fas fa-caret-down\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-dropdown</span> near the top and select <strong>as Datasets</strong> from the dropdown menu</li>   <li>     <p>In the pop-up window, choose</p>     <ul>       <li><em>“Select history”</em>: the history you want to import the data to (or create a new one)</li>     </ul>   </li>   <li>Click on <strong>Import</strong></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>Check the data type of your imported files.\n      <ul>\n        <li>The datatype should be <code class=\"language-plaintext highlighter-rouge\">tabular</code>, if this is not the case, please change the datatype now.</li>\n      </ul>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-changing-the-datatype\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-changing-the-datatype\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Changing the datatype</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, click <i class=\"fas fa-database\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-chart-select-data</span> <strong>Datatypes</strong> tab on the top</li>   <li>In the <i class=\"fas fa-database\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-chart-select-data</span> <strong>Assign Datatype</strong>, select  your desired datatype  from “<em>New type</em>” dropdown     <ul>       <li>Tip: you can start typing the datatype into the field to filter the dropdown menu</li>     </ul>   </li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <blockquote class=\"comment\">\n        <comment-title></comment-title>\n\n        <p>Here we provided the sampleMetadata file so we know that the upload led to a ‘tabular’ file. But from experience we also know that\nit can happen that, when uploading a sampleMetadata table, user obtained other inappropriate types of data. This is generally due to the file\nnot following all the requirements about the format (<em>e.g.</em> wrong separator, or lines with different numbers of columns).\nThus, we highly recommend that you always take a second to check the data type after the upload. This way you can handle the problem\nright away if you appear to get one of these obvious issues.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Rename your sampleMetadata file with a shorter name ‘sampleMetadata_completed.tsv’</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-dataset\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-dataset\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a dataset</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ul>   <li>Click on the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field</li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the dataset number 28.</p>\n  </blockquote>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <ol>\n      <li>How many columns should I have in my sampleMetadata file?</li>\n      <li>What kind of class can I have?</li>\n    </ol>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <ol>\n        <li>At least 2, with the identifiers and the class column. But as many as you need to describe the potential variability of your samples\n(<em>e.g.</em> the person in charge of the sample preparation, the temperature…). This will allow later statistical analysis to expose the relevant parameters.</li>\n        <li>Sample, QC, blank… The class (the 2nd column) is useful for the preprocessing step with XCMS to detect the metabolite across the samples.\nThus, it can be important to separate very different types of samples, as biological ones and blank ones for example. If you don’t have any specific class\nthat you want to consider in XCMS preprocessing, just fill everywhere with <code class=\"language-plaintext highlighter-rouge\">sample</code> or a dot <code class=\"language-plaintext highlighter-rouge\">.</code> for example.</li>\n      </ol>\n\n    </blockquote>\n\n  </blockquote>\n</blockquote>\n\n<h2 id=\"getting-an-overview-of-your-samples-chromatograms\">Getting an overview of your samples’ chromatograms</h2>\n\n<p>You may be interested in getting an overview of what your samples’ chromatograms look like, for example to see if some of\nyour samples have distinct overall characteristics, <em>e.g.</em> unexpected chromatographic peaks or huge overall intensity.</p>\n\n<p>You can use the <em>sampleMedata</em> file we previously uploaded to add some group colours to your samples when visualising your chromatograms.\nThe tool automatically takes the second column as colour groups when a file is provided.</p>\n\n<p>Note that you can also check the chromatograms at any moment during the workflow, in particular at the following steps:</p>\n<ul>\n  <li>After <strong>MSnbase readMSData</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> to help you to define retention time ranges that you may want to discard from the very beginning\n(<em>“Spectra Filters”</em> section in <strong>xcms findChromPeaks (xcmsSet)</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> parameters)</li>\n  <li>After <strong>adjustRtime</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> to check the result of the correction (and potentially rerun <em>adjustRtime</em> with other settings)</li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms plot chromatogram</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_plot_chromatogram/xcms_plot_chromatogram/3.12.0+galaxy0\" title=\"xcms plot chromatogram tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms plot chromatogram</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">mzML.raw.RData</code> (collection)</li>\n        <li><em>“Sample metadata file”</em>: <code class=\"language-plaintext highlighter-rouge\">sampleMetadata_completed.tsv</code> that you uploaded previously</li>\n      </ul>\n\n      <blockquote class=\"comment\">\n        <comment-title></comment-title>\n\n        <p>If you use this tool at a later step of XCMS workflow and provided in the Merger step a sampleMetadata with a second column containing groups\n(see further in this tutorial), you will get colouring according to these groups even without providing a sampleMetadata file as a ‘plot chromatogram’ parameter.</p>\n      </blockquote>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the datasets number 29 and 30.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>This tool generates Base Peak Intensity Chromatograms (BPIs) and Total Ion Chromatograms (TICs). If you provide groups as we do here, you obtain two plots:\none with colours based on provided groups, one with one colour per sample.</p>\n\n<figure id=\"figure-2\" style=\"max-width: 90%;\"><img src=\"../../images/lcmspreproc_BPC12samp.png\" alt=\"Screenshot of the PDF output corresponding to the Base Peak Intensity Chromatograms. It is composed of the layering of BPIs: one drawn line per sample.\" width=\"2578\" height=\"806\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/lcmspreproc_BPC12samp.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 2</strong>:</span> Base Peak Intensity Chromatograms</figcaption></figure>\n\n<p>How BPIs and TICs look like is dependant of the kind of data you have: LC-MS technology used, study design, type of samples, events that may have occured during the analysis…\nIt can vary a lot from one experiment to another due to these characteristics.\nSometimes you can see (un)expected effects on these plots as retention time variations accros samples, overall sample intensity differences due to analytical or biological\nmatters, specific peak areas… Generally, it is recommended to first focus on QC pooled samples if you have some, since they are not supposed to be affected by\nbiological variabilities: it helps you to focus on aspects uncorrelated to individual sample effects. Evaluation of blank samples (if any) can also be a good start:\n“Are all blanks globally less intense than real samples?” is a question that can generally be raised.</p>\n\n<h1 id=\"first-xcms-step-peak-picking\">First XCMS step: <em>peak picking</em></h1>\n\n<p>Now that your data is ready for XCMS processing, the first step is to extract peaks from each of your data files\nindependently. The idea here is, for each peak, to proceed to chromatographic peak detection.</p>\n\n<p>The XCMS solution provides two different algorithms to perform chromatographic peak detection: <em>matchedFilter</em> and\n<em>centWave</em>. The matchedFilter strategy is the first one provided by the XCMS R package. It is compatible with any\nLC-MS device, but was developed at a time when high resolution mass spectrometry was not common standard yet. On the\nother side, the <strong>centWave</strong> algorithm (<span class=\"citation\"><a href=\"#Tautenhahn2008\">Tautenhahn <i>et al.</i> 2008</a></span>) was specifically developed for high resolution mass spectrometry, dedicated to\ndata in centroid mode. In this tutorial, you will practice using the centWave algorithm.</p>\n\n<blockquote class=\"comment\">\n  <comment-title>How the centWave algorithm works</comment-title>\n\n  <p><a href=\"../../tutorials/lcms-preprocessing/slides.html#findchrompeaks\">Check the next 7 slides</a>\nto help you understand how the centWave algorithm works.\nRemember that these steps are performed for each of your data files independently.</p>\n  <ul>\n    <li>Firstly, the algorithm detects series of scans with close values of m/z. They are called ‘region of interest’ (ROI).\nThe m/z deviation is defined by the user. The tolerance value should be set according to the mass spectrometer accuracy.</li>\n    <li>On these regions of interest, a second derivative of a Gaussian model is applied to these consecutive scans in order to define\nthe extracted ion chromatographic peak. The Gaussian model is defined by the peak width which corresponds to the standard deviation\nof the Gaussian model. Depending on the shape, the peak is added to the peak list of the current sample.</li>\n  </ul>\n\n  <p>At the end of the algorithm, a list of peaks is obtained for each sample. This list is then considered to represent the content\nof your sample; if an existing peak is not considered a peak at this step, then it can not be considered in the next steps of\npre-processing.</p>\n\n</blockquote>\n\n<p>Let’s try performing the peakpicking step with the <strong>xcms findChromPeaks (xcmsSet)</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms findChromPeaks (xcmsSet)</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_xcmsset/abims_xcms_xcmsSet/3.12.0+galaxy0\" title=\"xcms findChromPeaks (xcmsSet) tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms findChromPeaks (xcmsSet)</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">mzML.raw.RData</code> (collection)</li>\n    <li><em>“Extraction method for peaks detection”</em>: <code class=\"language-plaintext highlighter-rouge\">CentWave - chromatographic peak detection using the centWave method</code>\n      <ul>\n        <li><em>“Max tolerated ppm m/z deviation in consecutive scans in ppm”</em>: <code class=\"language-plaintext highlighter-rouge\">3</code></li>\n        <li><em>“Min,Max peak width in seconds”</em>: <code class=\"language-plaintext highlighter-rouge\">5,20</code></li>\n        <li>In <strong>Advanced Options</strong>:\n          <ul>\n            <li><em>“Prefilter step for for the first analysis step (ROI detection)”</em>: <code class=\"language-plaintext highlighter-rouge\">3,5000</code></li>\n            <li><em>“Noise filter”</em>: <code class=\"language-plaintext highlighter-rouge\">1000</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ul>\n\n  <p>You can leave the other parameters with their default values.</p>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>Along with the parameters used in the core centWave algorithm, XCMS provides other filtering options allowing you to get\nrid of ions that you don’t want to consider. For example, you can use <em>Spectra Filters</em> allowing you to discard some RT or m/z\nranges, or <em>Noise filter</em> (as in this hands-on) not to use low intensity measures in the ROI detection step.</p>\n  </blockquote>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe dataset collections number 31 and 32.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>At this step, you obtain a dataset collection containing one <code class=\"language-plaintext highlighter-rouge\">RData</code> file per sample, with independent lists of ions. Although this\nis already a nice result, what you may want now is to get all this files together to identify which are the shared ions between samples.\nTo do so, XCMS provides a function that is called <em>groupChromPeaks</em> (or group). But before proceeding to this grouping step, first you\nneed to group your individual RData files into a single one.</p>\n\n<h1 id=\"gathering-the-different-samples-in-one-rdata-file\">Gathering the different samples in one Rdata file</h1>\n\n<p>A dedicated tool exists to merge the different <code class=\"language-plaintext highlighter-rouge\">RData</code> files into a single one: <strong>xcms findChromPeaks Merger</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>. Although you can simply take as\ninput your dataset collection alone, the tool also provides the possibility to take into account a sampleMetadata file. Indeed,\ndepending of your analytical sequence, you may want to treat part of your samples a different way when proceeding to\nthe grouping step using <strong>xcms groupChromPeaks (group)</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span>.</p>\n\n<p>This can be the case for example if you have in your analytical sequence some blank samples (your injection solvent) that you want to\nextract along with your biological samples to be able to use them as a reference for additional noise estimation and noise filtering. The fact that\nthese blank samples have different characteristics compared to your biological samples can be of importance when setting parameters of\nyour grouping step. You will see what this is all about in the ‘grouping’ section of this tutorial, but in the workflow order, it is\nat this step that you need to provide the needed information if you want distinction in your grouping step.</p>\n\n<p>In the case of our tutorial data, we have three sample types: the original biological samples (‘samples’), quality-control pooled samples (‘pools’)\ncorresponding to a mix of all biological samples, and blank samples (‘blanks’) constituted of injection solvent.\nWe will consider these three classes for the grouping step. Thus, we need to provide the sampleMetadata file during the merging step,\nwith the second column defining theses classes.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms findChromPeaks Merger</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_merge/xcms_merge/3.12.0+galaxy0\" title=\"xcms findChromPeaks Merger tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms findChromPeaks Merger</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">mzML.raw.xset.RData</code> (collection)</li>\n        <li><em>“Sample metadata file”</em>: <code class=\"language-plaintext highlighter-rouge\">sampleMetadata_completed.tsv</code></li>\n      </ul>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe dataset number 57.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>The tool generates a single <code class=\"language-plaintext highlighter-rouge\">RData</code> file containing information from all the samples in your dataset collection input.</p>\n\n<h1 id=\"second-xcms-step-determining-shared-ions-across-samples\">Second XCMS step: <em>determining shared ions across samples</em></h1>\n\n<p>The first peak picking step gave us lists of ions for each sample. However, what we want now is a single matrix of ions’ intensities for all samples.\nTo obtain such a table, we need to determine, among the individual ion lists, which ions are the same. This is the aim of the present step, called\n‘grouping’.</p>\n\n<p>Various methods are available to proceed to the grouping step. In this tutorial, we will focus on the ‘PeakDensity’ method\nthat performs peak grouping based on time dimension peak densities.</p>\n\n<p><a href=\"../../tutorials/lcms-preprocessing/slides.html#groupchrompeaks\">Check the next 8 slides</a>,\nyou will find additional material to help you understand the grouping algorithm.</p>\n\n<p>The group function aligns ions extracted with close retention time and close m/z values in the different samples. In order to define this\nsimilarity, we have to define on one hand a m/z window and on the other hand a retention time window. A binning is then performed in the\nmass domain. The size of the bins is called width of overlapping m/z slices. You have to set it according to your mass spectrometer resolution.</p>\n\n<p>Then, a kernel density estimator algorithm is used to detect region of retention time with high density of ions. This algorithm uses a Gaussian\nmodel to group together peaks with similar retention time.</p>\n\n<p>The inclusion of ions in a group is defined by the standard deviation of the Gaussian model, called bandwidth. This parameter has a large weight\non the resulting matrix. It must be chosen according to the quality of the chromatography. To be valid, the number of ions in a group must be greater\nthan a given number of samples. Either a percentage of the total number of samples or an absolute number of samples can be given. This is defined by the user.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms groupChromPeaks (group)</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_group/abims_xcms_group/3.12.0+galaxy0\" title=\"xcms groupChromPeaks (group) tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms groupChromPeaks (group)</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.RData</code></li>\n    <li><em>“Method to use for grouping”</em>: <code class=\"language-plaintext highlighter-rouge\">PeakDensity - peak grouping based on time dimension peak densities</code>\n      <ul>\n        <li><em>“Bandwidth”</em>: <code class=\"language-plaintext highlighter-rouge\">5.0</code></li>\n        <li><em>“Minimum fraction of samples”</em>: <code class=\"language-plaintext highlighter-rouge\">0.9</code></li>\n        <li><em>“Width of overlapping m/z slices”</em>: <code class=\"language-plaintext highlighter-rouge\">0.01</code></li>\n      </ul>\n    </li>\n    <li><em>“Get the Peak List”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n      <ul>\n        <li><em>“If NA values remain, replace them by 0 in the dataMatrix”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n      </ul>\n    </li>\n  </ul>\n\n  <blockquote class=\"comment\">\n    <comment-title>Minimum fraction of samples</comment-title>\n\n    <p>This parameter sets the minimum proportion of samples in a class where a peak should be found to keep the corresponding ion in the peaktable.\nThe idea is to look inside <strong>each class (<em>i.e.</em> each group of samples defined in the second column of the sampleMetadata file)</strong> and to keep\nan ion if there is at least one class where the ion is found in at least the specified proportion of samples.</p>\n\n    <p>The way to define what kind of classes would be relevant is not straightforward. It is a somehow complex combination of your study objectives,\nthe kind of biological matrix you analyse, assumptions you may have on the presence or absence of some compounds…\nWhat could typically be considered is whether you have radically different kind of samples (distinct parts of an organism, distinct kind of\nsample preparation…) and whether you expect huge composition differences between specific biological groups of individuals.\nFor example, if you study human blood samples in order to distinguish specificities between women and men, even if most of the metabolites\npresent may be expected to be find in both groups (at various levels but always present), some may be specific to one such as hormones.\nThus, you may consider putting men and women samples in distinct classes.</p>\n\n    <p>In the Sacurine study, no specific a priori groups were defined. Thus, no specific assumption was taken into consideration regarding biological\nclasses. Thus, in this tutorial we considered only three classes: one for samples, one for pools and one for blanks.\nSince pools are a mix of all biological samples,\nwe may want to consider an ion only if it is found in every pools. Thus, we may consider setting the ‘Minimum fraction of samples’ parameter to 1.\nConsidering that it sometimes happens that one sample can be a little out of the box for various reasons (pools do not make exception),\nwe may consider to lower a little this threshold, for example using a proportion of 0.9.</p>\n\n    <p>Please note that in our example, since the dataset contains only 3 pools, this would make no difference to 1.0 concerning the ‘pools’ class.</p>\n  </blockquote>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 58 to 61.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>This grouping step is very important because it defines the data matrix which will be used especially for the statistical analyses.\nUser has to check the effect of parameter values on the result.</p>\n\n<p>In order to check the result of the grouping function, a pdf file is created. It provides one plot per m/z slice found in the data. Each picture\nrepresents the peak density across samples, plotting the corresponding Gaussian model which width is defined by the bandwidth parameter. Each dot\ncorresponds to a sample, with colours corresponding to defined classes if any. The plot allows to assess the quality of alignment.\nThe grey areas’ width is associated with the bandwidth parameter.</p>\n\n<p>Here is an example of two m/z slices obtained from the hands-on:</p>\n\n<figure id=\"figure-3\" style=\"max-width: 90%;\"><img src=\"../../images/lcmspreproc_group12samp.png\" alt=\"Picture with two plots extracted from the plotChromPeakDensity.pdf output, one representing the 283.1127-283.1163 m/z slice and the other the 284.1198-284.1253 m/z slice. \" width=\"1689\" height=\"872\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/lcmspreproc_group12samp.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 3</strong>:</span> Extract from plotChromPeakDensity.pdf</figcaption></figure>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>Look at the <code class=\"language-plaintext highlighter-rouge\">283.1127 - 283.1163</code> m/z slice. How many peak groups are considered? Can you explain why some peaks are not affected to peak groups?</li>\n    <li>Look at the <code class=\"language-plaintext highlighter-rouge\">284.1198 - 284.1253</code> m/z slice. What do you think could have happened if you had used a smaller bandwidth value?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>There are 3 peak groups in this m/z slice. The two peaks that are not assigned to peak groups are alone in their retention time area. Thus,\nthe number of samples under the corresponding density peaks does not reach the minimum fraction of samples set by the user (0.9) to consider a peak group,\nin any specified class.</li>\n      <li>If the bandwidth value had been set to a smaller value, the density peak width would have been smaller. With a small-enough bandwidth value,\nthere could have been two density peaks instead of one under the current first density peak. Thus, the sample in line 5 would have been out of the\nprevious peak group, thus not assigned to any peak group due to the 0.9 minimum fraction limit.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>When performing a grouping step, you construct a peak table. Even if this step may not be the final extraction step, you can take this opportunity\nto check how your peak table looks at this point of the XCMS extraction. For this, you need to set the ‘Get the Peak List’ option to <code class=\"language-plaintext highlighter-rouge\">Yes</code>\nas done in this tutorial hands-on. This option generates two additional tables:</p>\n<ul>\n  <li>a data matrix (xset.merged.group.dataMatrix.tsv) with intensities for each ion and each sample;</li>\n  <li>a variable metadata file (xset.merged.group.variableMetadata.tsv) with information concerning the ions.</li>\n</ul>\n\n<p>The variable metadata file contains various information that can be of interest:</p>\n<ul>\n  <li>information about the m/z ratio of each ion (<code class=\"language-plaintext highlighter-rouge\">mz</code>, <code class=\"language-plaintext highlighter-rouge\">mzmin</code>, <code class=\"language-plaintext highlighter-rouge\">mzmax</code> columns);</li>\n  <li>information about the retention time of each ion (<code class=\"language-plaintext highlighter-rouge\">rt</code>, <code class=\"language-plaintext highlighter-rouge\">rtmin</code>, <code class=\"language-plaintext highlighter-rouge\">rtmax</code> columns);</li>\n  <li>the total number of peaks that were found for each ion (<code class=\"language-plaintext highlighter-rouge\">npeaks</code> column);</li>\n  <li>the number of samples in which each ion has been found, for each class (one column per class).</li>\n</ul>\n\n<p>The data matrix contains the intensities for each ion and each sample. When no peak was found in a sample for a specific ion, value is given as NA\n(you can choose to get a ‘0’ value instead, using the ‘If NA values remain, replace them by 0 in the dataMatrix’ option). You can get a summary of NA proportions\nusing the <strong>Intensity Check</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module.</p>\n\n<blockquote class=\"tip\">\n  <tip-title>Optional: Getting an overview of the proportion of NA in your data</tip-title>\n\n  <p>When you choose to export the peak list while using the <strong>xcms groupChromPeaks (group)</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module, you can have a first level of\ninformation regarding the proportion of NA by looking at the columns of classes you specified (or the <code class=\"language-plaintext highlighter-rouge\">.</code> column when no class were given) in\nthe variable metadata file (‘variableMetadata’).\nHowever, since the number of ions can be of hundreds or thousands, it can be difficult to evaluate the overall proportion in the dataset.\nThus, one way to go is to use the variableMetadata to check specific ions (ones you may have chosen <em>a priori</em> and/or ones you spotted due to\noutstanding behaviour), and to use the <strong>Intensity Check</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module to get an overview of the whole dataset.</p>\n\n  <blockquote class=\"hands_on\">\n    <hands-on-title>Intensity Check</hands-on-title>\n\n    <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/melpetera/intensity_checks/intens_check/1.2.8\" title=\"Intensity Check tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Intensity Check</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.2.8)</span> with the following parameters:</p>\n    <ul>\n      <li><em>“Data matrix file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.group.dataMatrix.tsv</code></li>\n      <li><em>“Sample metadata file”</em>: <code class=\"language-plaintext highlighter-rouge\">sampleMetadata_completed.tsv</code></li>\n      <li><em>“Variable metadata file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.group.variableMetadata.tsv</code></li>\n      <li><em>“Computation method”</em>: <code class=\"language-plaintext highlighter-rouge\">For each class of samples</code>\n        <ul>\n          <li><em>“Class column”</em>: <code class=\"language-plaintext highlighter-rouge\">c2: class</code></li>\n          <li><em>“Statistics”</em>: tick <code class=\"language-plaintext highlighter-rouge\">Missing values</code></li>\n          <li><em>“Calculate the mean fold change”</em>: tick <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n        </ul>\n      </li>\n    </ul>\n\n    <blockquote class=\"tip\">\n      <tip-title>Comment to W4M users</tip-title>\n\n      <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 62 and 63.</p>\n    </blockquote>\n\n  </blockquote>\n\n  <p>In the pdf file you will get as output, you can find a plot displaying proportions of NA for each class you specified.\nWith the example provided in this tutorial, you can notice that the blk class containing blanks has a high number of NA with 4394 ions\nthat have not been found, in any blank.</p>\n\n  <figure id=\"figure-4\" style=\"max-width: 90%;\"><img src=\"../../images/lcmspreproc_ICgp1.png\" alt=\"Picture representing the proportions of NA in the 3 groups of the class column (blk, QC and sample). It is displayed as number of ions having given proportions of NA - proportions being grouped from 0 to 100 percents by classes of 20 percents.\" width=\"912\" height=\"881\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/lcmspreproc_ICgp1.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 4</strong>:</span> Content of IC_Graphs.pdf</figcaption></figure>\n\n  <blockquote class=\"question\">\n    <question-title></question-title>\n\n    <p>How many ions in the table have been found in all the pools?</p>\n\n    <blockquote class=\"solution\">\n      <solution-title></solution-title>\n\n      <p>Knowing that there are 3 pools in the QC class, we can determine there are 4746 ions that have been found in all pools.</p>\n\n    </blockquote>\n\n  </blockquote>\n\n</blockquote>\n\n<p>When looking back at the plots from plotChromPeakDensity.pdf, we can notice that in some cases there seems to be a small drift of retention time for some samples.\nThis phenomenon is well known with LC-MS techniques. To be able to attribute correct groups for peaks, it may be needed to perform some retention time\ncorrection accross samples. Thus, the idea is (when needed) to apply a retention time strategy on the output of your grouping step, then to perform\na second grouping step on the corrected data.</p>\n\n<h1 id=\"optional-xcms-step-retention-time-correction\">Optional XCMS step: <em>retention time correction</em></h1>\n\n<p>Sometimes with LC-MS techniques, a deviation in retention time occurs from a sample to another. In particular, this is likely to be observed when you\ninject large sequences of samples.</p>\n\n<p>This optional step aims at correcting retention time drift for each peak among samples. The XCMS package provides two algorithms to do so.\n<a href=\"../../tutorials/lcms-preprocessing/slides.html#adjustrtime\">Check the next 4 slides</a>,\nyou will find additional material to help you understand the retention time correction algorithms.\nIn this training material we will focus on the “PeakGroups” method.</p>\n\n<p>This correction is based on what is called <em>well behaved peaks</em>.\nOne characteristic of these peaks is that they are found in all samples or at least in most of the samples.\nSometimes it is difficult to find enough peaks present in all samples. The user can define a percentage of the total number of samples in which\na peak should be found to be considered a well behaved peak. This parameter is called <em>minimum required fraction of samples</em>.</p>\n\n<p>On the contrary, you may have peak groups with more detected peaks than the total number of samples. Those peaks are called <em>additional peaks</em>.\nIf you do not want to consider peak groups with too much additional peaks as ‘well behaved peaks’, you can use the ‘maximal number of additional\npeaks’ parameter to put them aside.</p>\n\n<p>The algorithm uses statistical smoothing methods. You can choose between linear or loess regression.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms adjustRtime (retcor)</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_retcor/abims_xcms_retcor/3.12.0+galaxy0\" title=\"xcms adjustRtime (retcor) tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms adjustRtime (retcor)</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.groupChromPeaks.RData</code></li>\n    <li><em>“Method to use for retention time correction”</em>: <code class=\"language-plaintext highlighter-rouge\">PeakGroups - retention time correction based on aligment of features (peak groups) present in most/all samples.</code>\n      <ul>\n        <li><em>“Minimum required fraction of samples in which peaks for the peak group were identified”</em>: <code class=\"language-plaintext highlighter-rouge\">0.7</code></li>\n      </ul>\n    </li>\n  </ul>\n\n  <p>You can leave the other parameters to default values.</p>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>If you have a very large number of samples (<em>e.g.</em> a thousand), it might be impossible to find peaks that are present in 100% of your samples.\nIf that is the case and you still set a very high value for the minimum required fraction of samples, the tool can not complete successfully the retention\ntime correction.\nA special attention should also be given to this parameter when you expect a large number of peaks not to be present in part of your samples\n(<em>e.g.</em> when dealing with some blank samples).</p>\n  </blockquote>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 64 and 65.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>This tool generates a plot output that you can use to visualise how retention time correction was applied across the samples and along the chromatogram.\nIt also allows you to check whether the well behaved peaks were distributed homogeneously along the chromatogram.</p>\n\n<blockquote class=\"tip\">\n  <tip-title>Check the impact of RT correction using 'xcms plot chromatogram'</tip-title>\n\n  <p>Apart from the plots generated by the adjustRtime tool, you can check the impact of the retention time\ncorrection by comparing the chromatogram you obtained previously to a new one generated after correction.</p>\n\n  <blockquote class=\"hands_on\">\n    <hands-on-title>xcms plot chromatogram</hands-on-title>\n\n    <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_plot_chromatogram/xcms_plot_chromatogram/3.12.0+galaxy0\" title=\"xcms plot chromatogram tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms plot chromatogram</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n    <ul>\n      <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.groupChromPeaks.adjustRtime.RData</code></li>\n    </ul>\n\n    <blockquote class=\"comment\">\n      <comment-title></comment-title>\n\n      <p>As in the previous ‘plot chromatogram’, you can use your completed sampleMetadata file to get colours.</p>\n    </blockquote>\n\n    <blockquote class=\"tip\">\n      <tip-title>Comment to W4M users</tip-title>\n\n      <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 66 and 67.</p>\n    </blockquote>\n\n  </blockquote>\n\n</blockquote>\n\n<p>The retention time correction step is not mandatory. However, when it is used retention time values are modified.\nConsequently, applying this step on your data requires to complete it with an additional ‘grouping’ step using the\n<strong>xcms groupChromPeaks (group)</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool again.</p>\n\n<p>Parameters for this second group step are expected to be similar to the first group step. Nonetheless,\nsince retention times are supposed to be less variable inside a same peak group now, in some cases it can be relevant to\nlower a little the bandwidth parameter.</p>\n\n<p><a href=\"../../tutorials/lcms-preprocessing/slides.html#beforeafterrt\">Check the next slide</a>\nto get an illustration of grouping before/after retention time correction.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>second 'xcms groupChromPeaks (group)'</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_group/abims_xcms_group/3.12.0+galaxy0\" title=\"xcms groupChromPeaks (group) tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms groupChromPeaks (group)</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.groupChromPeaks.adjustRtime.RData</code></li>\n    <li><em>“Method to use for grouping”</em>: <code class=\"language-plaintext highlighter-rouge\">PeakDensity - peak grouping based on time dimension peak densities</code>\n      <ul>\n        <li><em>“Bandwidth”</em>: <code class=\"language-plaintext highlighter-rouge\">5.0</code></li>\n        <li><em>“Minimum fraction of samples”</em>: <code class=\"language-plaintext highlighter-rouge\">0.9</code></li>\n        <li><em>“Width of overlapping m/z slices”</em>: <code class=\"language-plaintext highlighter-rouge\">0.01</code></li>\n      </ul>\n    </li>\n    <li><em>“Get the Peak List”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code>\n      <ul>\n        <li><em>“Convert retention time (seconds) into minutes”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Number of decimal places for retention time values reported in ions’ identifiers.”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n        <li><em>“If NA values remain, replace them by 0 in the dataMatrix”</em>: <code class=\"language-plaintext highlighter-rouge\">No</code></li>\n      </ul>\n    </li>\n  </ul>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>When performing this second grouping, similarly to the first grouping you can take this opportunity to check how your peak table\nlooks at this point of the XCMS extraction, setting the ‘Get the Peak List’ option to <code class=\"language-plaintext highlighter-rouge\">Yes</code>. As previously explained, you can\nlook at your variableMetadata file as well as perform an NA diagnostic using the <strong>Intensity Check</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module.</p>\n  </blockquote>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets from number 68 to number 71.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>It is possible to use the retention time correction and grouping step in an iterative way if needed. Once you perform your\nlast adjustRtime step and thus your last grouping step, you will obtain your final peak list (<em>i.e.</em> final list of ions).</p>\n\n<blockquote class=\"question\">\n  <question-title></question-title>\n\n  <ol>\n    <li>How many ions did you obtained with the final grouping step?</li>\n    <li>Open the dataMatrix file you obtained with the final grouping. This table corresponds to intensities for each ion and each\nsample. What do you notice when looking at the intensity of the fourth ion regarding the first sample?</li>\n  </ol>\n\n  <blockquote class=\"solution\">\n    <solution-title></solution-title>\n\n    <ol>\n      <li>The final grouping step led to 5100 ions.</li>\n      <li>The fourth ion (M74T317) has a ‘NA’ value for the first sample (QC1_014). This is also the case for several other ions\nand samples.</li>\n    </ol>\n\n  </blockquote>\n\n</blockquote>\n\n<p>At this point of the XCMS extraction workflow, the peak list may contain NA when peaks were not considered peaks in only some\nof the samples in the first ‘findChromPeaks’ step. This does not necessary means that no peak exists for these samples. For example,\nsometimes peaks are of very low intensity for some samples and were not kept as peaks because of that in the first ‘findChromPeaks’\nstep.</p>\n\n<p>To be able to get the information that may actually exist behind NAs, there is an additional XCMS step that is called <em>fillChromPeaks</em>.</p>\n\n<blockquote class=\"comment\">\n  <comment-title></comment-title>\n\n  <p>Before performing the ‘fillChromPeaks’ step, it is highly recommended to first have a look at your data concerning the distribution\nof NAs in your data. Indeed, this will allow you to check whether your results are consistent with your expectations; if not you\nmay want to go back to some of your parameter choices in previous XCMS steps.\nTo perform your NA diagnosis, you can use the variableMetadata file and dataMatrix file that you obtained with the last grouping step\nwith the ‘Get the Peak List’ option to <code class=\"language-plaintext highlighter-rouge\">Yes</code>. The variableMetadata file contains information about your ions: you will find information\nabout the number of peaks detected for each ion. The dataMatrix files contains the intensities for each ion and each sample.\nAs suggested previously (after the first grouping step), you can use the <strong>Intensity Check</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module to get an overview\nof the proportion of NA in your dataset at this step.</p>\n</blockquote>\n\n<h1 id=\"final-xcms-step-integrating-areas-of-missing-peaks\">Final XCMS step: <em>integrating areas of missing peaks</em></h1>\n\n<p>The idea of this XCMS step is to integrate signal in the mz-rt area of an ion (chromatographic peak group) for samples in which no\nchromatographic peak for this ion was identified.\nTo do so, you can use the <em>xcms fillChromPeaks (fillPeaks)</em> tool\n(<a href=\"../../tutorials/lcms-preprocessing/slides.html#fillchrompeaks\">check the next slide</a>).</p>\n\n<p>However, before any automatic filling of missing values, you may be interested in an overview of the NA distribution in your data.\nIndeed, depending on you extraction parameters, you may have an unexpectedly high proportion of NAs in your data. If that is the case,\nyou may consider reviewing your previous extraction parameters and re-running previous steps to obtain consistant results before\nproceeding to the integration of missing peak areas.</p>\n\n<p>To get an overview of your missing data, as specified previously you can use the <strong>Intensity check</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module.</p>\n\n<p>Once you are satisfied with the optimisation of previous extraction parameters, you can proceed to the integration of missing peak areas.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms fillChromPeaks (fillPeaks)</hands-on-title>\n\n  <p><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_fillpeaks/abims_xcms_fillPeaks/3.12.0+galaxy0\" title=\"xcms fillChromPeaks (fillPeaks) tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms fillChromPeaks (fillPeaks)</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:</p>\n  <ul>\n    <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.groupChromPeaks.*.RData</code> (last step of your previous XCMS step)</li>\n    <li>In <em>“Peak List”</em>:\n      <ul>\n        <li><em>“Convert retention time (seconds) into minutes”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n        <li><em>“Number of decimal places for retention time values reported in ions’ identifiers.”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n      </ul>\n    </li>\n  </ul>\n\n  <blockquote class=\"comment\">\n    <comment-title></comment-title>\n\n    <p>The <em>“Reported intensity values”</em> parameter is important here. It defines how the intensity will be computed. You have three choices:</p>\n    <ul>\n      <li>into : integration of peaks (<em>i.e.</em> areas under the peaks)</li>\n      <li>maxo : maximum height of peaks</li>\n      <li>intb : integration of peaks with baseline subtraction</li>\n    </ul>\n  </blockquote>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 72 to 74.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>With this ‘fillChromPeaks’ step, you obtain your final intensity table. At this step, you have everything mandatory to begin analysing\nyour data:</p>\n<ul>\n  <li>A <em>sampleMetadata</em> file (if not done yet, to be completed with information about your samples)</li>\n  <li>A <em>dataMatrix</em> file (with the intensities)</li>\n  <li>A <em>variableMetadata</em> file (with information about ions such as retention times, m/z)</li>\n</ul>\n\n<p>Nonetheless, before proceeding with the next step in an untargeted metabolomic workflow (processing and filtering of your data), you can add an optional step\nwith the <strong>CAMERA.annotate</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module. This tool uses the CAMERA R package to perform a first annotation of your data based on XCMS outputs.</p>\n\n<h1 id=\"annotation-with-camera-optional\">Annotation with CAMERA [Optional]</h1>\n\n<p>This last step provides annotation of isotopes, adducts and neutral losses. It gives also some basic univariate statistics in case you\nconsidered several groups for your XCMS extraction.</p>\n\n<p>There is a huge number of parameters that will not be detailed in this short tutorial. However most of the default values can be kept here\nfor a first attempt to run this function. Nevertheless, a few parameters have to be set at each run:</p>\n<ul>\n  <li>The polarity has to be set since it affects annotation.</li>\n  <li>For statistical analysis, you have to define if you have two or more conditions to compare. These conditions had to be defined in the\n sample metadata uploaded previously and taken into account in the XCMS workflow.</li>\n  <li>You can define how many significant ions will be used for extracted ions chromatogram (EIC) plot. These plots will be included in a pdf file.</li>\n</ul>\n\n<p>Apart from the PDF file, the main three outcomes from <strong>CAMERA.annotate</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> are three columns added in the variableMetadata file:</p>\n<ul>\n  <li><strong>isotopes:</strong> the name says everything</li>\n  <li><strong>adduct:</strong> same here; this column is filled in the ‘All functions’ mode only</li>\n  <li><strong>pcgroup:</strong> this stands for Pearson’s correlation group; it corresponds to groups of ions that match regarding retention time and intensity\n correlations, leading to think that maybe they could come from the same original metabolite.</li>\n</ul>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>CAMERA.annotate</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/camera_annotate/abims_CAMERA_annotateDiffreport/2.2.6+camera1.48.0-galaxy0\" title=\"CAMERA.annotate tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>CAMERA.annotate</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.2.6+camera1.48.0-galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.groupChromPeaks.*.fillChromPeaks.RData</code></li>\n        <li>In <em>“Annotate Isotopes [findIsotopes]”</em>:\n          <ul>\n            <li><em>“Max. ion charge”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n          </ul>\n        </li>\n        <li><em>“Mode”</em>: <code class=\"language-plaintext highlighter-rouge\">Only groupFWHM and findIsotopes functions [quick]</code></li>\n        <li>In <em>“Export options”</em>:\n          <ul>\n            <li><em>“Convert retention time (seconds) into minutes”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Number of decimal places for retention time values reported in ions’ identifiers.”</em>: <code class=\"language-plaintext highlighter-rouge\">2</code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"comment\">\n        <comment-title></comment-title>\n\n        <p>As said previously, there are quite a few parameters in this tool, some of them having very high impact on your annotations.\nIn particular, the <strong>Mode</strong> parameter will influence a lot your results regarding pcgroups, and adducts (that will not be computed otherwise).</p>\n      </blockquote>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe datasets number 75 and 76.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>The information given by this tool is not mandatory for the next step of a metabolomic workflow. Commonly, annotation is considered a later\nstep in the pipeline, but since CAMERA uses the outputs of XCMS, if you want to use it you better do it at this step, allowing you to have the\ncorresponding information in your variableMetadata file for later use.</p>\n\n<h1 id=\"finalising-your-pre-processing\">Finalising your pre-processing</h1>\n\n<p>Pre-processing requires a significant number of parameters to set. To help you summarise your final XCMS workflow, the <strong>xcms process history</strong>\n<i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module enables the summary of all used XCMS parameters, along with the sample list and the final XCMS R object overview.\nWith only one single HTML file generated, you have access to all this information.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>xcms process history</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_summary/abims_xcms_summary/3.12.0+galaxy0\" title=\"xcms process history tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>xcms process history</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 3.12.0+galaxy0)</span> with the following parameters:\n      <ul>\n        <li><em>“xset RData file”</em>: <code class=\"language-plaintext highlighter-rouge\">xset.merged.[...].fillChromPeaks.RData</code></li>\n      </ul>\n\n      <blockquote class=\"comment\">\n        <comment-title></comment-title>\n\n        <p>This module can be used after any XCMS step using the generated .RData file.</p>\n      </blockquote>\n    </li>\n  </ol>\n\n  <blockquote class=\"tip\">\n    <tip-title>Comment to W4M users</tip-title>\n\n    <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a>, this step corresponds to\nthe dataset number 77.</p>\n  </blockquote>\n\n</blockquote>\n\n<p>At this step, you get all the data needed to proceed to any appropriate data processing and analysis using the 3 tables you obtained from\nthis pre-processing workflow.</p>\n\n<blockquote class=\"tip\">\n  <tip-title>Switch your identifiers with <b>ID choice</b></tip-title>\n\n  <p>You may have noticed the option provided in XCMS modules to specify a number of decimal places for m/z and RT values reported in\nions’ identifiers. This option, available for modules generating variableMetadata files, creates an additional column named <em>namecustom</em>.\nYou can use this column to switch automatic ion IDs to these customised ones, using the <strong>ID choice</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> tool.</p>\n\n  <blockquote class=\"hands_on\">\n    <hands-on-title>ID choice</hands-on-title>\n\n    <ol>\n      <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/melpetera/idchoice/idchoice/19.12\" title=\"ID choice tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>ID choice</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 19.12)</span> with the following parameters:\n        <ul>\n          <li><em>“Data matrix file”</em>: the <code class=\"language-plaintext highlighter-rouge\">xset.merged[...].dataMatrix.tsv</code> dataset from your last XCMS step</li>\n          <li><em>“Metadata file containing your new IDs”</em>: the <code class=\"language-plaintext highlighter-rouge\">xset.merged[...].variableMetadata.tsv</code> dataset from your last XCMS or CAMERA step</li>\n          <li><em>“Which ID do you want to change?”</em>: <code class=\"language-plaintext highlighter-rouge\">Variables</code></li>\n          <li><em>“Name of the column to consider as new ID”</em>: <code class=\"language-plaintext highlighter-rouge\">namecustom</code></li>\n        </ul>\n      </li>\n    </ol>\n\n    <blockquote class=\"tip\">\n      <tip-title>Comment to W4M users</tip-title>\n\n      <p>In the <a href=\"https://workflow4metabolomics.usegalaxy.fr/u/peteram/h/gtnlcmspreprocessingxcms\">GTN_LCMSpreprocessingXCMS</a> history,\nthis step corresponds to the datasets number 78 and 79.</p>\n    </blockquote>\n\n  </blockquote>\n\n  <p>Note that the <strong>ID choice</strong> <i class=\"fas fa-wrench\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tool</span> module can be used on sample identifiers too. This can be particularly useful when\nthe raw files (used to determine sample IDs in XCMS) have automatically-generated names that can be unfriendly and excessively long.</p>\n\n</blockquote>\n\n<p>The pre-processing part of a metabolomic analysis corresponds to quite a few number of steps, depending of your analysis.\nIt can generate several versions of your 3 tables, with only one of interest for each at the end of the extraction process.\nWe highly recommend, at this step of a metabolomic workflow, to split your analysis by beginning a new Galaxy history with only\nthe 3 tables you need. This will help you in limiting selecting the wrong datasets in further analyses, and bring a little tidiness\nfor future review of your analysis process.</p>\n\n<p>We also recommend you to rename your 3 tables before proceeding with further data processing and analysis.\nIndeed, you may have notice that the XCMS tools generate output names that contain the different XCMS steps you used,\nenabling easy traceability while browsing your history. However, knowing that the next steps of analysis are also going to extend\nthe 3 tables’ names, if you keep the original names it will become very long and thus may reduce the names’ readability.\nHence, we highly recommend you to rename them with something short, e.g. ‘sampleMetadata’, ‘variableMetadata’ and ‘dataMatrix’,\nor anything not too long that you may find convenient.</p>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>This tutorial allowed you to get a glance at what data pre-processing in Metabolomics could look like when dealing with LC-MS data.\nThe workflow used here as an example is only one glance at what you can construct using Galaxy.\nNow that you know that tools exist and are available in this accessible, reproducible and transparent resource\nthat Galaxy is, all that remains for you to make high level reproducible science is to develop and apply your expertise in Metabolomics,\nand create, run and share!</p>\n"],"ref_slides":["name:raw-to-matrix\n\n## From raw files to data matrix\n\n![Picture representing steps from the raw data to the peak table, each step being linked to the next one by an arrow. Step 1 is a graphic showing a TIC for on sample. Step 2 is a part of an XML file where fields as retention time, base peak m/z, and base peak intensity are noticeable. Step 3 is an example of MS spectrum with the mention that an MS spectrum can be found at each scan. Step 4 (last one) is a part of a spreadsheet table listing ions in lines with 2 \"retention time\" and \"mass\" columns, plus columns of intensities (one per sample).](../../images/lcmspreproc_slides_1.1.png)\n\n---\n\n## XCMS\n\n![Picture to introduce the XCMS R package by providing the reference to the main publications, providing a link to the web documentation https://bioconductor.org/packages/release/bioc/html/xcms.html and highlighting with happy/sad faces some characteristics. Happy face for \"R based\", \"free\" and \"sustainable\". Sad face for \"a lot of parameters to set\", \"no graphical interface\", and \"need to write an R script\". A picture from one a the publication is displayed, corresponding to a graphic showing many overlapping line graphs pointing to a single peak.](../../images/lcmspreproc_slides_1.2.png)\n\n---\nname:findchrompeaks\n\n## xcms - findChromPeaks\n\n![Two graphics are displayed, one representing a MS spectrum in profile mode and the second one representing a MS spectrum in centroid mode. Graphics are completed with the mention that XCMS provides 2 main algorithms for chromatographic peak detection: the \"matched filter\" one for profile or centroid low resolution MS data, and the \"centwave\" one for centroid high resolution MS data.](../../images/lcmspreproc_slides_2.1.png)\n\n---\n\n## xcms - findChromPeaks - CentWave algorithm\n\n![On the left, part of an xml file is shown with retention time, base peak m/z and base peak intensity highlighted. On the right there are three graphs having scans as abscissa for the three of them. From top to bottom: m/z values with the note \"looking for a region of interest\", delta ppm scan-to-scan with the label \"ppm parameter\", and then at the bottom an intensity graph specifying that a continuous wavelet transform is performed. References of Signal/Noise, Noise level, Pre-filter, Range of FWHM (peakwidth) and choice between integration and peak heigh are listed with the bottom graph. This example is given for 1 ion in 1 sample, defined by m/z, retention time and intensity.](../../images/lcmspreproc_slides_2.2.png)\n\n---\n\n## xcms - findChromPeaks - CentWave algorithm\n\n![Large blob of text next to two plots from one of XCMS publication. First blob: \"The algorithm aims to detect mass traces or regions of interest (ROI) which are defined as regions with less than a defined deviation of m/z in consecutive scans. The deviation must be lower than the value of the parameter ppm. The value (unit ppm) has to be set according to MS accuracy. The graph to the right shows a region with some points with low variation along the y axis, and as it goes to the sides of this central region, the variation increases.\" Second blob: \"ROI mass intensitites are then used to define the chromatographic peak with continuous wavelet transform algorithm. peakwidth(min, max) has to be set for this step. 20.50 for HPLC, 5.25 for UPLC\"](../../images/lcmspreproc_slides_2.3.png)\n\n---\n\n## xcms - findChromPeaks - CentWave algorithm\n\n![Figure titled \"Range of peak width allows to extract peaks with different shapes\". This is from a paper and shows three peaks. The chromatogram is shown as a jagged line, while a guassian fit shows three ideal guassian distributions overlayed on the chromatogram. Although the peaks are different in width, the three of them are accurately detected with Gaussian fit. ](../../images/lcmspreproc_slides_2.4.png)\n\n---\n\n## xcms - findChromPeaks - CentWave algorithm\n\n![Figure titled \"Centwave allows to detect peaks without return to the baseline\". This is from a paper and shows four peaks that indeed do not return to the baseline for three of them that are successive, and gaussian fit lines accurately cover the peaks.](../../images/lcmspreproc_slides_2.5.png)\n\n---\n\n## xcms - findChromPeaks - CentWave parameters\n\n![A reference to a question from the xcms forum, \"how to choose peak width?\". It says 'Important: do not choose the minimum peak width too small, it will not increase sensitivity but cause peaks to be split'. There are two example graphs of the same peak. The first one illustrates a peakwidth = c(10, 60), showing that the peak is split in three, each detected as short peaks. The second graph is using peakwidth=c(20,120), keeping the peak as one.](../../images/lcmspreproc_slides_2.6.png)\n\n---\n\n## xcms - findChromPeaks - Parameters summary\n\nxcms parameters | related to | description | examples\n--- | --- | --- | ---\nppm | m/z | fluctuation of m/z value (ppm) from scan to scan - depends on the mass spectrometer accuracy | 5…\npeakwidth | retention time | range of  chromatographic peak width (second) | UPLC 10,40  /  HPLC 20,120\nmzdiff | m/z and retention time | minimum difference of m/z for peaks with overlapping retention time (coeluting peak) - must be negative to allow overlap |  -0.001 or 0.05\nprefilter (k, I) | Intensity | a peak must be present in k scans with an intensity greater than I | k=3,I=1000\nsnthresh | Intensity | signal/noise ratio threshold | 5…\nnoise | Intensity | each centroid must be greater than the \"noise\" value | .\n\n---\nname:groupchrompeaks\n\n## xcms - groupChromPeaks\n\n![Large set of tables, in three groups, with each time 3 tables representing 3 pools. The top row is labelled \"independent peaklists\". The next row of tables is labelled \"group ions by m/z\", and the rows in the tables are coloured based on m/z values and lined up by their colours. The third row is labelled \"group by retention time\", and the coloured rows are now merged into one big table, each colour on its own row, with this time some blue in two shades (same m/z but different rt). The resulting matrix merges the above, and collapses columns to result in a median m/z, and median retention time, and then the intensity of each pool; \"NA\" are filled when the line (a given m/z with a given rt) was missing for some pools.](../../images/lcmspreproc_slides_3.1.png)\n\n---\n\n## xcms - groupChromPeaks - Alignment group\n\n![Another text blob and image combo. The text: \"First, a binning of mass domain is performed. The size of the bin defined by the width of overlapping m/z slices. Then for each m/z bin, all ions of all samples are taken into account on the whole. A kernel density estimator is used to detect regions of retention time with high density ions.\" Below, the graph shows an example of plot output from groupChromPeaks which represents peaks found in samples as points along the retention time for one m/z slice.](../../images/lcmspreproc_slides_3.2.png)\n\n---\n\n## xcms - groupChromPeaks - Alignment group\n\n![Similar text/image combo as the previous slide. The text: \"A guassian model groups together peaks with similar retention time, the inclusiveness of ions in a group defined by standard deviation of the model (bandwidth) corresponding to the xcms bw parameter.\" The graphic shows the previous plot with added information. A guassian density curve is drawn and vertical dot lines are plotted each time a peak is considered along the rt. A \"problem\" is highlighted showing an outlier point included in a peak because the bw parameter was too high.](../../images/lcmspreproc_slides_3.3.png)\n\n---\n\n## xcms - groupChromPeaks - Alignment group\n\n![The previous graph is duplicated, however the density curve of the second one is based on a lower bw value, excluding now the outlier point from the peak boundery. A note says: \"Decreasing bw allows to separate these 2 groups. The resulting m/z and retention time of the feature correspond to the median of m/z an RT of all ions groupes together as a single feature.\"](../../images/lcmspreproc_slides_3.4.png)\n\n---\n\n## xcms - groupChromPeaks - minFraction parameter\n\n![A text indicates: \"minfraction is the minimum number of samples detected in at least one class to be considered a valid group. A class is defined by the second column of the sample metadata if you uploaded individual sample files and merge in a dataset list, or by the sub folder of the zipfile.\" An illustration is provided using two plots modeling a peak from the type of output groupChromPeaks generates. It plots the points in two colours (red and blue), representing groups of samples. There are theoritically 4 samples in each class (=color) and the minFraction parameter is set to 0.5. On the first plot, there are 3 and 4 points in each color, so the peak is kept. On the second plot, there are 1 and 3 points in each color, but the peak is still kept since there are 3 points in at least one group.](../../images/lcmspreproc_slides_3.5.png)\n\n---\n\n## xcms - groupChromPeaks - Output\n\n![The picture recaps the groupChromPeaks output by showing the point plot where sometimes peaks are kept and sometimes not. It is written: \"Grey vertical strips tag groups ok; they include all samples that are grouped together as a single ion.\"](../../images/lcmspreproc_slides_3.6.png)\n\n---\n\n## xcms - groupChromPeaks - Output\n\n![A visual recap is done on the importance to set the right bw value not to pull distinct peaks together. Two graphs are shown, one with a large grey stripe labelled \"bandwidth = 10 seconds\". Two distinct ions are merged as one group, so the bandwidth is too large. In the right graph bandwidth is 5 seconds, and now two distinct ions are separated and correctly identified.](../../images/lcmspreproc_slides_3.7.png)\n\n---\n\n## xcms - groupChromPeaks - Parameters summary\n\nxcms parameters | related to | description | examples\n--- | --- | --- | ---\nbinSize | m/z | Size of m/z slices (bins). Range of m/z to be included in a group. Depends on mass spectrometer accuracy. |\nbw | retention time | Standart deviation of the gaussian metapeak that group peaks together. | HPLC 30s  /  UPLC 5s\nminFraction | samples | To be valid, a group must be found in at least minFraction*n samples, with n=number of samples **for each class of samples**. A minFraction=0.5 corresponds to 50%. | n=10, minFraction=0.5 => found in at least 5 samples\nmax | number of ions | Maximum number of groups detected in a single m/z slices. | 10 or 50\n\n---\nname:adjustrtime\n\n## xcms - adjustRtime\n\n![On the left there is a \"before/after\" plot showing several examples of a gausian peak, first all shifted, but then all aligned. On the right is an example of the graphical output from adjustRtime, representing samples as lines with retention time in abscissa and time deviation on ordinate.](../../images/lcmspreproc_slides_4.1.png)\n\n---\n\n## xcms - adjustRtime - PeakGroups algorithm\n\n![A \"blue/red\" plot model similar to the one explaining the groupChromPeak minfraction parameter is drawn. This time it shows that with missing=1, well-behaved peaks can be considered even if there are only 3 blue points. The second graph shows that with extra=1, well-behaved peaks can be consider even if there are 5 blue points.](../../images/lcmspreproc_slides_4.2.png)\n\n---\n\n## xcms - adjustRtime - PeakGroups - Parameters summary\n\nxcms parameters | related to | description | examples\n--- | --- | --- | ---\nsmooth method | retention time | Regression model to model time deviation among samples (linear or loess). | linear or loess\nspan |  | Degree of smoothing of the loess model. | 0.2 to 1\nextraPeaks | samples | Number of \"extra\" peaks used to define reference peaks (or well-behaved peaks) for modeling time deviation. Number of Peaks > number of samples. | default=1\nminFraction (previously missing) | samples | Minimum proportion of samples with reference peaks. If blank samples are used, minFraction < (1 - proportion of blanks). | 1 - proportion of blank samples\n\n---\n\n## xcms - adjustRtime - Obiwrap algorithm\n\n![A composed picture from the publication of the \"obiwarp\" algorithm.](../../images/lcmspreproc_slides_4.3.png)\n\n---\nname:beforeafterrt\n\n## xcms - adjustRtime - Output\n\n![A \"before/after\" picture related to the rt adjustment. In the first graph two messy lines of points are shown. It seems to be two ions, but because there are shifts in rt it is not possible to separate them, whatever the bw value. The graph is labelled with two boxes saying \"bandwith (bw) = 8 seconds\" and \"Effect of retention time correction and BW\". The second graph is after rt ajustment. Now the peaks points line up perfectly into two individual peaks and thus an appropriate bw value allows to separate the two peaks correctly. The graph is labelled with two boxes, saying \"Bandwith (bw) = 5 seconds\" and \"Two distinct ions are separated by decreasing bandwith value. And outliers are not taken into account\".](../../images/lcmspreproc_slides_5.png)\n\n---\nname:fillchrompeaks\n\n## xcms - fillChromPeaks\n\n![A montage of a table with some NA values in intensities and the fillChromPeaks Galaxy tool with a text: \"After grouping all ions are not detected in all samples. For each of those ions this step integrates the signal in the region where ions were detected in other samples and creates a new peak. Be careful, if you choose a low minfraction in the group step, you may have a lot of missing data and this can lead to crash this step.\" In addition to the text, formulas are represented in a mathematical form for each \"Advanced options\" of the Galaxy module. There is also a note about the intval parameter saying into=integration, maxo=maximum height and intb=integration with baseline correction.](../../images/lcmspreproc_slides_6.png)\n\n---\n"],"video_library":{"tutorial":null,"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":true,"mod_date":"2023-11-03 14:30:27 +0000","pub_date":"2020-02-04 08:04:53 +0000","version":31,"api":"https://training.galaxyproject.org/training-material/api/topics/metabolomics/tutorials/lcms-preprocessing/tutorial.json","tools":["toolshed.g2.bx.psu.edu/repos/lecorguille/camera_annotate/abims_CAMERA_annotateDiffreport/2.2.6+camera1.48.0-galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/msnbase_readmsdata/msnbase_readmsdata/2.16.1+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_export_samplemetadata/xcms_export_samplemetadata/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_fillpeaks/abims_xcms_fillPeaks/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_group/abims_xcms_group/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_merge/xcms_merge/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_plot_chromatogram/xcms_plot_chromatogram/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_retcor/abims_xcms_retcor/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_summary/abims_xcms_summary/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/lecorguille/xcms_xcmsset/abims_xcms_xcmsSet/3.12.0+galaxy0","toolshed.g2.bx.psu.edu/repos/melpetera/idchoice/idchoice/19.12","toolshed.g2.bx.psu.edu/repos/melpetera/intensity_checks/intens_check/1.2.8"],"supported_servers":{"exact":[{"url":"https://usegalaxy.fr/","name":"UseGalaxy.fr","usegalaxy":false},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.cz/","name":"UseGalaxy.cz","usegalaxy":false},{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true},{"url":"https://usegalaxy.no/","name":"UseGalaxy.no","usegalaxy":false}]},"topic_name_human":"Metabolomics","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"camera_annotate","owner":"lecorguille","revisions":"512c2b701d96","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"msnbase_readmsdata","owner":"lecorguille","revisions":"11ab2081bd4a","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_export_samplemetadata","owner":"lecorguille","revisions":"94eb263cfab4","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_fillpeaks","owner":"lecorguille","revisions":"26d77e9ceb49","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_group","owner":"lecorguille","revisions":"d45a786cbc40","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_merge","owner":"lecorguille","revisions":"5bd125a3f3b0","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_plot_chromatogram","owner":"lecorguille","revisions":"024974037c4e","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_retcor","owner":"lecorguille","revisions":"aa252eec9229","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_summary","owner":"lecorguille","revisions":"018a9771de28","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"xcms_xcmsset","owner":"lecorguille","revisions":"b02d1992a43a","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"idchoice","owner":"melpetera","revisions":"bb19b1d15732","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"intensity_checks","owner":"melpetera","revisions":"a31f3f802b2b","tool_panel_section_label":"Metabolomics","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: camera_annotate\n  owner: lecorguille\n  revisions: 512c2b701d96\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: msnbase_readmsdata\n  owner: lecorguille\n  revisions: 11ab2081bd4a\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_export_samplemetadata\n  owner: lecorguille\n  revisions: 94eb263cfab4\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_fillpeaks\n  owner: lecorguille\n  revisions: 26d77e9ceb49\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_group\n  owner: lecorguille\n  revisions: d45a786cbc40\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_merge\n  owner: lecorguille\n  revisions: 5bd125a3f3b0\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_plot_chromatogram\n  owner: lecorguille\n  revisions: '024974037c4e'\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_retcor\n  owner: lecorguille\n  revisions: aa252eec9229\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_summary\n  owner: lecorguille\n  revisions: '018a9771de28'\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: xcms_xcmsset\n  owner: lecorguille\n  revisions: b02d1992a43a\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: idchoice\n  owner: melpetera\n  revisions: bb19b1d15732\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: intensity_checks\n  owner: melpetera\n  revisions: a31f3f802b2b\n  tool_panel_section_label: Metabolomics\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}